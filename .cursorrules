# Cursor Rules - Roastr.ai

Este archivo consolida las reglas de CLAUDE.md y skills para uso en Cursor.

---

## üéØ POL√çTICA OBLIGATORIA: GDD, Agentes y Skills

**‚ö†Ô∏è CR√çTICO: Esta pol√≠tica es OBLIGATORIA para TODA tarea, sin excepciones.**

### FASE 0 - Assessment con GDD (SIEMPRE PRIMERO)

**ANTES de cualquier implementaci√≥n:**

1. **Detectar nodos GDD autom√°ticamente:**
   ```bash
   node scripts/cursor-agents/auto-gdd-activation.js [issue-number]
   # O desde rama:
   node scripts/cursor-agents/auto-gdd-activation.js --from-branch
   ```

2. **Resolver dependencias:**
   ```bash
   node scripts/resolve-graph.js <nodos-detectados>
   ```

3. **Leer SOLO nodos resueltos (NUNCA spec.md completo):**
   ```
   En Cursor Chat: @docs/nodes/roast.md @docs/nodes/shield.md
   ```

4. **Leer coderabbit-lessons.md:**
   ```
   @docs/patterns/coderabbit-lessons.md
   ```

**Mapeo autom√°tico Labels ‚Üí Nodos:**
- `area:shield` ‚Üí shield, multi-tenant
- `area:billing` ‚Üí cost-control, plan-features, multi-tenant
- `area:platforms` ‚Üí social-platforms, platform-constraints
- `area:workers` ‚Üí queue-system, multi-tenant
- `area:ui` ‚Üí roast, persona, tone
- `test:e2e` ‚Üí ALL nodes (cargar todos)
- `test:integration` ‚Üí depende de otros labels

**Si no hay labels, usar keywords en t√≠tulo o archivos modificados.**

### Detecci√≥n Autom√°tica de Agents

**ANTES de implementar, detectar qu√© agent usar:**
```bash
node scripts/cursor-agents/detect-triggers.js
```

**Output sugerir√°:**
- Qu√© agent usar (TestEngineer, FrontendDev, Guardian, etc.)
- C√≥mo usar Composer (Cmd+I ‚Üí @archivos)
- Prompt sugerido
- Receipt autom√°tico creado

### Workflow Est√°ndar

**FASE 0:** Assessment ‚Üí GDD ‚Üí Leer nodos ‚Üí Agentes ‚Üí coderabbit-lessons.md
**FASE 1:** Planning ‚Üí TaskAssessor (AC ‚â•3) ‚Üí docs/plan/ ‚Üí Explore
**FASE 2:** Implementation ‚Üí Agentes ‚Üí Skills/MCPs ‚Üí Receipts
**FASE 3:** Validation ‚Üí Tests + visual ‚Üí Guardian ‚Üí PR ‚Üí 0 conflictos + 0 CodeRabbit
**FASE 4:** Commit & PR ‚Üí Receipts ‚Üí CI ‚Üí Merge

### Reglas de Agents

**TestEngineer:**
- Triggers: Cambios en `src/`, `tests/`, nuevos features
- Workflow: Composer ‚Üí @tests/ @src/[archivo] ‚Üí "Generate tests following test-generation-skill"
- Receipt: docs/agents/receipts/cursor-test-engineer-[timestamp].md

**FrontendDev:**
- Triggers: Cambios en `*.jsx`, `*.tsx`, `*.css`
- Workflow: Composer ‚Üí @src/components/ @public/ ‚Üí Implement + visual validation
- Receipt: docs/agents/receipts/cursor-frontend-[timestamp].md

**Guardian:**
- Triggers: Cambios en `costControl.js`, `schema.sql`, `docs/nodes/`, billing, security
- Workflow: `node scripts/guardian-gdd.js --full` + manual audit
- Receipt: docs/agents/receipts/cursor-guardian-[timestamp].md

**TaskAssessor:**
- Triggers: AC ‚â•3, P0/P1, features complejas
- Workflow: Crear plan en docs/plan/<issue>.md
- Receipt: docs/agents/receipts/cursor-task-assessor-[timestamp].md

### Durante Desarrollo

**SIEMPRE:**
- ‚úÖ USAR SOLO ARTEFACTOS V2 (docs/SSOT-V2.md, docs/nodes-v2/, apps/backend-v2/, apps/frontend-v2/)
- ‚úÖ Leer nodos GDD, NO spec.md (excepto test:e2e)
- ‚úÖ Actualizar nodos afectados cuando c√≥digo cambia
- ‚úÖ A√±adir agents a "Agentes Relevantes" en nodos si se invocan
- ‚úÖ Ejecutar validaci√≥n antes de commits: `node scripts/validate-gdd-runtime.js --full`
- ‚úÖ Mantener docs sincronizadas con c√≥digo

**NUNCA:**
- ‚ùå NO Modificar o importar artefactos legacy V1 (src/, frontend/, docs/legacy/, spec.md)
- ‚ùå Cargar spec.md completo (excepto expl√≠citamente requerido)
- ‚ùå Saltar actualizaci√≥n de nodos despu√©s de cambios
- ‚ùå Olvidar a√±adir nuevos agents a "Agentes Relevantes"
- ‚ùå Commit sin validaci√≥n pasando

### üõ°Ô∏è Blindaje V2-only (ROA-538)

**Prop√≥sito:** Bloquear acceso a artefactos legacy V1 en desarrollo nuevo (Loop Aut√≥nomo).

**Validadores:**
- **Gate (Loop):** `scripts/loop/validators/v2-only.js` - Bloquea ejecuci√≥n si detecta violaciones
- **CI (Observability):** `scripts/ci/detect-legacy-v1.js` - Reporta violaciones en codebase

**Fuentes Permitidas (V2 ONLY):**
- ‚úÖ `docs/SSOT-V2.md`, `docs/nodes-v2/`, `docs/system-map-v2.yaml`
- ‚úÖ `apps/backend-v2/`, `apps/frontend-v2/`, `apps/shared/`
- ‚úÖ `scripts/loop/`, `scripts/ci/`

**Fuentes Prohibidas (LEGACY V1):**
- ‚ùå `docs/legacy/`, `docs/nodes/`, `spec.md`, `docs/system-map.yaml`
- ‚ùå `src/` (Backend V1), `frontend/` (Frontend V1)
- ‚ùå Workers: `GenerateReplyWorker`, `PublisherWorker`, `BillingWorker`
- ‚ùå IDs: `roast`, `shield`, `persona`, `free`, `basic`, `creator_plus`

**Errores comunes:**
```javascript
// ‚ùå PROHIBIDO
import { stripeService } from 'src/services/stripeService';
const plan = 'free'; // Legacy plan ID

// ‚úÖ CORRECTO
import { polarBilling } from 'apps/backend-v2/billing';
const plan = 'starter'; // V2 plan ID
```

**Ver:** `.cursor/rules/v2-only-strict.mdc`, `docs/plan/issue-ROA-538.md`

---

### Antes de Cerrar PR

**Validaci√≥n obligatoria:**
```bash
# 1. Tests pasando
npm test

# 2. Blindaje V2-only (ROA-538)
node scripts/loop/validators/v2-only.js --post-task
node scripts/ci/detect-legacy-v1.js --full

# 3. GDD validado
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci  # Debe >=87

# 4. Receipts presentes
ls docs/agents/receipts/cursor-*-[timestamp].md

# 5. Coverage >=90%
npm run test:coverage

# 5. CodeRabbit = 0 comentarios
npm run coderabbit:review
```

---

## Skills (Auto-Activadas)

### Test Generation Skill

**Triggers:** Modificaciones en `src/` sin tests correspondientes

**Workflow:**
1. Analizar archivos modificados en `src/` para identificar componentes/servicios
2. Generar tests unitarios usando Jest con mocks apropiados (sin datos reales)
3. Generar tests de integraci√≥n para flujos clave (auth, API, workers)
4. Generar tests E2E con Playwright para UI cuando aplique
5. Ejecutar `npm test -- --coverage` para validar cobertura
6. Verificar que Coverage Source es 'auto' en nodos GDD afectados
7. Asegurar cobertura >= 85% y 0 tests fallando
8. Generar reporte en `docs/test-evidence/issue-{id}/summary.md`

**Reglas:**
- ‚ùå NUNCA usar datos reales (siempre mock data)
- ‚úÖ Seguir patrones de tests existentes en `tests/`
- ‚úÖ Cada archivo de producci√≥n debe tener su contraparte de test
- ‚úÖ Tests deben ser aislados, reproducibles y auto-contenidos

**Output:** Tests + `docs/test-evidence/issue-{id}/summary.md`

### GDD Sync Skill

**Triggers:** Cambios en c√≥digo o arquitectura, "GDD", "spec update", "nodo", "graph", "coverage"

**Workflow:**
1. Detectar qu√© nodos en `docs/nodes/` son afectados por cambios recientes
2. Leer nodos relevantes para entender dependencias
3. Identificar qu√© m√©tricas necesitan actualizaci√≥n (coverage, health, dependencies)
4. Ejecutar: `node scripts/validate-gdd-runtime.js --full`
5. Actualizar cobertura en nodos afectados (Coverage Source: auto, NO manual)
6. Ejecutar: `node scripts/resolve-graph.js <nodos-afectados>`
7. Actualizar "Agentes Relevantes" en nodos si aplica
8. Validar: `node scripts/score-gdd-health.js --ci` (debe >=87)
9. Ejecutar: `node scripts/predict-gdd-drift.js --full` (<60 risk)
10. Generar reporte de sincronizaci√≥n

**Reglas CR√çTICAS:**
- ‚ùå NUNCA modificar cobertura manualmente en nodos
- ‚ùå NUNCA cargar spec.md completo, solo nodos relevantes
- ‚úÖ SIEMPRE actualizar "Agentes Relevantes" despu√©s de invocar agentes
- ‚úÖ SIEMPRE validar antes de commit
- ‚úÖ SIEMPRE mantener Coverage Source: auto

**Output:** Nodos actualizados + reporte de validaci√≥n + health score >=87

### Security Audit Skill

**Triggers:** "auth", "secret", "policy", "vulnerability", "security", "credential"

**Workflow:**
1. Revisar todos los archivos modificados con grep para detectar strings de credenciales
2. Buscar patrones: API_KEY, SECRET, PASSWORD, TOKEN, AUTH_TOKEN en c√≥digo
3. Validar que variables de entorno se cargan desde .env (NO hardcoded)
4. Revisar pol√≠ticas RLS en migraciones SQL (`database/migrations/`)
5. Verificar sanitizaci√≥n de inputs en endpoints (protecci√≥n XSS, SQL injection)
6. Revisar permisos de archivos y configuraci√≥n de CORS
7. Detectar uso seguro de .env vs exponer credenciales en logs
8. Generar reporte con hallazgos y recomendaciones

**Reglas CR√çTICAS:**
- ‚ùå CR√çTICO: Si se detectan credenciales hardcoded ‚Üí detener inmediatamente y reportar
- ‚ùå NUNCA commitear con secrets en logs o c√≥digo
- ‚úÖ SIEMPRE usar variables de entorno
- ‚úÖ Validar permisos RLS en cada cambio de DB
- ‚úÖ Sanitizar inputs de usuario antes de procesar

**Output:** `docs/audit/security-report-{id}.md` + lista de vulnerabilidades

### Visual Validation Skill

**Triggers:** "UI change", "frontend", "visual", "component", "screenshot"

**Workflow:**
1. Conectar a Playwright MCP server (ya configurado)
2. Identificar componentes/rutas afectadas por cambios
3. Lanzar navegaci√≥n a p√°ginas relevantes con `mcp.playwright.browse`
4. Capturar screenshots en m√∫ltiples viewports (desktop: 1920x1080, tablet: 768x1024, mobile: 375x667)
5. Ejecutar tests de accesibilidad autom√°ticos (a11y)
6. Simular interacciones de usuario (clicks, hovers, form submissions)
7. Revisar consola del navegador y network logs
8. Generar reporte visual con capturas y m√©tricas

**Reglas:**
- ‚úÖ SIEMPRE capturar en 3 viewports m√≠nimo
- ‚úÖ Incluir estados: loading, error, empty, success
- ‚úÖ Verificar a11y en cada captura
- ‚úÖ Documentar cualquier inconsistencia visual

**Output:** `docs/test-evidence/issue-{id}/screenshots/` + `ui-report.md` + logs a11y

### Writing Plans Skill

**Triggers:** AC ‚â•3, P0/P1, features complejas

**Workflow:**
1. Leer issue completo (t√≠tulo, body, labels, AC)
2. Resolver nodos GDD relevantes
3. Crear `docs/plan/issue-{id}.md` con estructura:
   - Estado Actual
   - Pasos de implementaci√≥n
   - Agentes a usar
   - Archivos afectados
   - Validaci√≥n requerida
4. Continuar autom√°ticamente (NO esperar confirmaci√≥n)

**Output:** `docs/plan/issue-{id}.md`

### Verification Before Completion Skill

**Triggers:** Antes de "complete", "done", "passing", "ready"

**Workflow:**
1. Ejecutar comandos de verificaci√≥n REALES (no asumir)
2. Verificar tests: `npm test` (debe exit 0)
3. Verificar coverage: `npm run test:coverage` (debe >=90%)
4. Verificar GDD: `node scripts/validate-gdd-runtime.js --full`
5. Verificar health: `node scripts/score-gdd-health.js --ci` (debe >=87)
6. Verificar CodeRabbit: `npm run coderabbit:review` (debe 0 comentarios)
7. Solo entonces marcar como completo

**Regla:** Evidence antes de claims. NUNCA decir "complete" sin ejecutar verificaciones.

### Anti-AI-Slop Review

**Triggers:** Antes de solicitar aprobaci√≥n de PR, autom√°ticamente al finalizar implementaci√≥n

**Objetivo:** Eliminar c√≥digo generado por IA de baja calidad que contamina la codebase.

**Qu√© es AI-Slop:**
- Comentarios superfluos o incongruentes
- Bloques `try/catch` que no tienen sentido en ese contexto
- Checks redundantes (validaciones innecesarias)
- Casteos a `any` para silenciar errores de TypeScript
- Patrones que rompen el estilo preexistente del proyecto
- C√≥digo hinchado o defensivo que la codebase nunca usa
- TODOs, FIXMEs o comentarios "// Add more logic here"
- Imports no utilizados
- Variables declaradas pero nunca usadas
- Comentarios obvios tipo `// Set the value` antes de `value = x`

**Workflow:**
1. Revisar TODO el diff de la PR l√≠nea por l√≠nea
2. Identificar patrones de AI-slop comparando con c√≥digo existente
3. Eliminar c√≥digo superfluo manteniendo funcionalidad
4. Verificar que el c√≥digo sigue el estilo del proyecto
5. Asegurar que no hay l√≥gica defensiva innecesaria
6. Confirmar que todos los imports y variables se usan
7. Ejecutar linter y tests despu√©s de limpieza
8. Generar resumen de limpieza

**Ejemplos de AI-Slop a Eliminar:**

```typescript
// ‚ùå AI-Slop: Comentario obvio
// Set the user name
user.name = 'John';

// ‚úÖ Limpio: Sin comentario innecesario
user.name = 'John';
```

```typescript
// ‚ùå AI-Slop: Try/catch innecesario en funci√≥n s√≠ncrona
function add(a: number, b: number): number {
  try {
    return a + b;
  } catch (error) {
    console.error('Error adding numbers', error);
    throw error;
  }
}

// ‚úÖ Limpio: Funci√≥n directa
function add(a: number, b: number): number {
  return a + b;
}
```

```typescript
// ‚ùå AI-Slop: Validaci√≥n redundante
if (user && user.id && user.id !== null && user.id !== undefined) {
  // La codebase ya valida esto en otro lugar
  processUser(user.id);
}

// ‚úÖ Limpio: Validaci√≥n apropiada seg√∫n contexto
if (user?.id) {
  processUser(user.id);
}
```

```typescript
// ‚ùå AI-Slop: Casteo a any para silenciar error
const result = (data as any).someProperty;

// ‚úÖ Limpio: Tipar correctamente
interface DataType {
  someProperty: string;
}
const result = (data as DataType).someProperty;
```

**Reglas CR√çTICAS:**
- ‚ùå NUNCA aprobar PR con AI-slop visible
- ‚ùå NUNCA a√±adir comentarios que no aportan valor
- ‚ùå NUNCA usar `any` como escape de tipos
- ‚úÖ SIEMPRE revisar si el patr√≥n existe en la codebase
- ‚úÖ SIEMPRE mantener el estilo del c√≥digo existente
- ‚úÖ SIEMPRE ejecutar tests despu√©s de limpieza

**Output Obligatorio:**

Al finalizar revisi√≥n, SIEMPRE incluir:

```
üßπ Resumen Anti-Slop:
[1-3 frases indicando qu√© se limpi√≥, ej:]
- Eliminados 15 comentarios superfluos y 3 try/catch innecesarios
- Removidos 2 casteos a 'any' y a√±adidos tipos apropiados
- Limpiados 4 checks redundantes que duplicaban validaciones existentes
```

Si NO se encontr√≥ slop:
```
üßπ Resumen Anti-Slop: ‚úÖ C√≥digo limpio, sin AI-slop detectado.
```

**Cu√°ndo Ejecutar:**
- Antes de cada commit importante
- Antes de solicitar code review
- Antes de marcar PR como "ready for review"
- Despu√©s de aplicar sugerencias de CodeRabbit (que pueden a√±adir slop)

---

## Comandos √ötiles

```bash
# GDD
node scripts/resolve-graph.js <nodos>
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci
node scripts/predict-gdd-drift.js --full
node scripts/auto-repair-gdd.js --auto-fix

# Auto-activaci√≥n
node scripts/cursor-agents/auto-gdd-activation.js [issue-number]
node scripts/cursor-agents/detect-triggers.js

# Tests
npm test
npm run test:coverage

# CodeRabbit
npm run coderabbit:review
npm run coderabbit:review:quick
```

---

## Referencias

- **GDD Guide:** `docs/GDD-ACTIVATION-GUIDE.md`
- **Agent Manifest:** `agents/manifest.yaml`
- **Skills:** `.claude/skills/`
- **Migration Guide:** `docs/CURSOR-MIGRATION-GUIDE.md`

