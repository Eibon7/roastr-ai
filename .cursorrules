# Cursor Rules - Roastr.ai

Este archivo consolida las reglas de CLAUDE.md y skills para uso en Cursor.

---

## üéØ POL√çTICA OBLIGATORIA: GDD, Agentes y Skills

**‚ö†Ô∏è CR√çTICO: Esta pol√≠tica es OBLIGATORIA para TODA tarea, sin excepciones.**

### FASE 0 - Assessment con GDD (SIEMPRE PRIMERO)

**ANTES de cualquier implementaci√≥n:**

1. **Detectar nodos GDD autom√°ticamente:**
   ```bash
   node scripts/cursor-agents/auto-gdd-activation.js [issue-number]
   # O desde rama:
   node scripts/cursor-agents/auto-gdd-activation.js --from-branch
   ```

2. **Resolver dependencias:**
   ```bash
   node scripts/resolve-graph.js <nodos-detectados>
   ```

3. **Leer SOLO nodos resueltos (NUNCA spec.md completo):**
   ```
   En Cursor Chat: @docs/nodes/roast.md @docs/nodes/shield.md
   ```

4. **Leer coderabbit-lessons.md:**
   ```
   @docs/patterns/coderabbit-lessons.md
   ```

**Mapeo autom√°tico Labels ‚Üí Nodos:**
- `area:shield` ‚Üí shield, multi-tenant
- `area:billing` ‚Üí cost-control, plan-features, multi-tenant
- `area:platforms` ‚Üí social-platforms, platform-constraints
- `area:workers` ‚Üí queue-system, multi-tenant
- `area:ui` ‚Üí roast, persona, tone
- `test:e2e` ‚Üí ALL nodes (cargar todos)
- `test:integration` ‚Üí depende de otros labels

**Si no hay labels, usar keywords en t√≠tulo o archivos modificados.**

### Detecci√≥n Autom√°tica de Agents

**ANTES de implementar, detectar qu√© agent usar:**
```bash
node scripts/cursor-agents/detect-triggers.js
```

**Output sugerir√°:**
- Qu√© agent usar (TestEngineer, FrontendDev, Guardian, etc.)
- C√≥mo usar Composer (Cmd+I ‚Üí @archivos)
- Prompt sugerido
- Receipt autom√°tico creado

### Workflow Est√°ndar

**FASE 0:** Assessment ‚Üí GDD ‚Üí Leer nodos ‚Üí Agentes ‚Üí coderabbit-lessons.md
**FASE 1:** Planning ‚Üí TaskAssessor (AC ‚â•3) ‚Üí docs/plan/ ‚Üí Explore
**FASE 2:** Implementation ‚Üí Agentes ‚Üí Skills/MCPs ‚Üí Receipts
**FASE 3:** Validation ‚Üí Tests + visual ‚Üí Guardian ‚Üí PR ‚Üí 0 conflictos + 0 CodeRabbit
**FASE 4:** Commit & PR ‚Üí Receipts ‚Üí CI ‚Üí Merge

### Reglas de Agents

**TestEngineer:**
- Triggers: Cambios en `src/`, `tests/`, nuevos features
- Workflow: Composer ‚Üí @tests/ @src/[archivo] ‚Üí "Generate tests following test-generation-skill"
- Receipt: docs/agents/receipts/cursor-test-engineer-[timestamp].md

**FrontendDev:**
- Triggers: Cambios en `*.jsx`, `*.tsx`, `*.css`
- Workflow: Composer ‚Üí @src/components/ @public/ ‚Üí Implement + visual validation
- Receipt: docs/agents/receipts/cursor-frontend-[timestamp].md

**Guardian:**
- Triggers: Cambios en `costControl.js`, `schema.sql`, `docs/nodes/`, billing, security
- Workflow: `node scripts/guardian-gdd.js --full` + manual audit
- Receipt: docs/agents/receipts/cursor-guardian-[timestamp].md

**TaskAssessor:**
- Triggers: AC ‚â•3, P0/P1, features complejas
- Workflow: Crear plan en docs/plan/<issue>.md
- Receipt: docs/agents/receipts/cursor-task-assessor-[timestamp].md

### Durante Desarrollo

**SIEMPRE:**
- ‚úÖ Leer nodos GDD, NO spec.md (excepto test:e2e)
- ‚úÖ Actualizar nodos afectados cuando c√≥digo cambia
- ‚úÖ A√±adir agents a "Agentes Relevantes" en nodos si se invocan
- ‚úÖ Ejecutar validaci√≥n antes de commits: `node scripts/validate-gdd-runtime.js --full`
- ‚úÖ Mantener docs sincronizadas con c√≥digo

**NUNCA:**
- ‚ùå Cargar spec.md completo (excepto expl√≠citamente requerido)
- ‚ùå Saltar actualizaci√≥n de nodos despu√©s de cambios
- ‚ùå Olvidar a√±adir nuevos agents a "Agentes Relevantes"
- ‚ùå Commit sin validaci√≥n pasando

### Antes de Cerrar PR

**Validaci√≥n obligatoria:**
```bash
# 1. Tests pasando
npm test

# 2. GDD validado
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci  # Debe >=87

# 3. Receipts presentes
ls docs/agents/receipts/cursor-*-[timestamp].md

# 4. Coverage >=90%
npm run test:coverage

# 5. CodeRabbit = 0 comentarios
npm run coderabbit:review
```

---

## üîê SINGLE SOURCES OF TRUTH ENFORCEMENT (SSOT)

**‚ö†Ô∏è CR√çTICO: Regla obligatoria para cualquier desarrollo en v2.**

### === NOTA TEMPORAL PARA TRANSICI√ìN SSOT ‚Üí V2 ===

Si la fuente de verdad referenciada por esta regla a√∫n no existe en backend-v2, **debes CREARLA como parte de la tarea**.

**Fuentes de verdad de v2:**
- `docs/architecture/sources-of-truth.md`
- `apps/backend-v2/src/config/admin-controlled.yaml`
- `apps/backend-v2/src/lib/loadSettings.ts`
- Tabla Supabase: `admin_settings` (din√°mica)

**üö´ No utilices ni referencies settings legacy de v1:**
- `organization_settings`
- `global_shield_settings`
- `shieldSettingsService.js`

Todas las configuraciones nuevas deben residir **SOLO en el sistema SSOT de v2**.

### 1. Obligaci√≥n de consultar SSOT antes de cualquier implementaci√≥n

Cuando generes, modifiques o revises c√≥digo en v2, debes:

- **Revisar SIEMPRE** el archivo de especificaci√≥n de SSOT:
  - `docs/architecture/sources-of-truth.md` (si existe)
  - O la documentaci√≥n equivalente en `docs/spec-v2.md`

- **Revisar** las fuentes de verdad existentes:
  - `admin_settings` (tabla Supabase) - Para settings din√°micos
  - `apps/backend-v2/src/config/admin-controlled.yaml` (si existe) - Para config est√°tica

Si el valor ya est√° definido en SSOT:
- Usa **√∫nicamente** esa fuente
- NO redefinas, NO dupliques, NO copies valores en el c√≥digo

### 2. Prohibici√≥n absoluta de valores hardcoded que existan en SSOT

**Ejemplos prohibidos:**
- L√≠mite de an√°lisis: `1000` ‚Üí ‚ùå
- Tonos permitidos: `["flanders","balanceado","canalla"]` ‚Üí ‚ùå
- Thresholds de shield: `0.9 / 0.98 / 1.0` ‚Üí ‚ùå
- Cadencias: `"5m", "10m"` ‚Üí ‚ùå
- L√≠mites por plan ‚Üí ‚ùå
- Tiers ‚Üí ‚ùå

**Si se detecta en legacy (v1), NO se replica en v2.**

Si debes usar un valor, **CARGA SIEMPRE** desde SSOT.

### 3. Si introduces un comportamiento, valor o par√°metro nuevo:

Debes crear o extender su fuente de verdad:

1. **Para valores din√°micos (cambian en runtime):**
   - A√±adirlo a `admin_settings` (Supabase)
   - O a tabla equivalente si es por organizaci√≥n

2. **Para valores est√°ticos (configuraci√≥n):**
   - A√±adirlo a `apps/backend-v2/src/config/admin-controlled.yaml`
   - O crear m√≥dulo SSOT en `docs/architecture/sources-of-truth.md`

3. **Documentar el campo:**
   - Nombre, tipo, descripci√≥n, rango v√°lido
   - Actualizar `docs/spec-v2.md` o documentaci√≥n SSOT

**Nunca introducir valores nuevos directamente en c√≥digo.**

### 4. Si falta una SSOT para un valor nuevo:

Debes:

1. **Crear la fuente** (BD o YAML)
2. **Actualizar documentaci√≥n SSOT** (`docs/architecture/sources-of-truth.md` o `docs/spec-v2.md`)
3. **Documentar el campo** (nombre, tipo, descripci√≥n, rango)
4. **Consumir ese valor** desde la nueva SSOT
5. **A√±adir tests** que aseguren que se carga desde SSOT

### 5. SSOT tiene prioridad sobre cualquier valor en c√≥digo

Si hay conflicto entre:
- Valor definido en c√≥digo
- Valor definido en SSOT

‚Üí **SSOT gana SIEMPRE**
‚Üí C√≥digo debe adaptarse al valor definido en SSOT

### 6. No generar nuevas constantes de configuraci√≥n en c√≥digo

Todos los par√°metros configurables deben residir:
- En `admin_settings` (BD) - Para valores din√°micos
- O en `/config/admin-controlled.yaml` - Para valores est√°ticos

**Ejemplo:**

‚ùå `const DEFAULT_SHIELD = 0.95`
‚úî `const shield = await loadSettings('shield.default_aggressiveness')`

### 7. C√≥digo que necesite par√°metros debe cargarlos v√≠a:

- **Config loader centralizado:**
  - `apps/backend-v2/src/lib/loadSettings.ts` (si existe)
  - O servicio equivalente que consulte SSOT

- **Patr√≥n recomendado:**
  ```typescript
  // ‚úÖ CORRECTO
  const settings = await settingsService.load('shield');
  const threshold = settings.default_aggressiveness;
  
  // ‚ùå INCORRECTO
  const threshold = 0.95;
  ```

### 8. SSOT tambi√©n se aplica al frontend

Para cualquier desarrollos de UI que dependan de:
- l√≠mites
- flags
- thresholds
- planes
- estados
- par√°metros din√°micos

El frontend debe:
- **Consultar store global** (settings API endpoint)
- **NO replicar valores** en componentes
- **Usar hooks** como `useSettings()` para cargar desde API

### 9. Cuando SSOT cambie, Cursor debe:

- Respetar que v2 carga settings desde el backend
- NO replicar l√≥gica en frontend
- NO usar valores fuera del store
- Actualizar tests si cambian los valores por defecto

### 10. Comentarios en PR:

Si Cursor genera un valor hardcoded que pertenece a SSOT:

- Debe emitir comentario de correcci√≥n autom√°tica:
  > "‚ö†Ô∏è This value must be loaded from the SSOT (admin settings). Hardcoded values are prohibited."
- Y corregirlo cargando desde settings

### 11. Excepciones documentadas (si aplica):

Solo valores que NO cambian nunca (constantes matem√°ticas, versiones de API, etc.) pueden estar hardcoded, pero deben estar:
- Documentados en SSOT como "static constants"
- Justificados en comentarios
- Revisados en PR

**Ejemplo de excepci√≥n v√°lida:**
```typescript
// ‚úÖ EXCEPCI√ìN V√ÅLIDA: Constante matem√°tica que nunca cambia
const MAX_SAFE_INTEGER = 9007199254740991; // Documentado en SSOT como static constant
```

### 12. Relaci√≥n con GDD:

Si un nodo GDD menciona valores configurables:
- Debe referenciar la SSOT correspondiente
- NO debe duplicar los valores en el nodo
- El nodo debe documentar: "Valores cargados desde admin_settings"

**Ejemplo en nodo GDD:**
```markdown
## Shield Thresholds

**Source of Truth:** `admin_settings.shield_thresholds` (Supabase)

Los thresholds se cargan din√°micamente desde la base de datos.
NO hardcodear valores en c√≥digo.
```

---

## Skills (Auto-Activadas)

### Test Generation Skill

**Triggers:** Modificaciones en `src/` sin tests correspondientes

**Workflow:**
1. Analizar archivos modificados en `src/` para identificar componentes/servicios
2. Generar tests unitarios usando Jest con mocks apropiados (sin datos reales)
3. Generar tests de integraci√≥n para flujos clave (auth, API, workers)
4. Generar tests E2E con Playwright para UI cuando aplique
5. Ejecutar `npm test -- --coverage` para validar cobertura
6. Verificar que Coverage Source es 'auto' en nodos GDD afectados
7. Asegurar cobertura >= 85% y 0 tests fallando
8. Generar reporte en `docs/test-evidence/issue-{id}/summary.md`

**Reglas:**
- ‚ùå NUNCA usar datos reales (siempre mock data)
- ‚úÖ Seguir patrones de tests existentes en `tests/`
- ‚úÖ Cada archivo de producci√≥n debe tener su contraparte de test
- ‚úÖ Tests deben ser aislados, reproducibles y auto-contenidos

**Output:** Tests + `docs/test-evidence/issue-{id}/summary.md`

### GDD Sync Skill

**Triggers:** Cambios en c√≥digo o arquitectura, "GDD", "spec update", "nodo", "graph", "coverage"

**Workflow:**
1. Detectar qu√© nodos en `docs/nodes/` son afectados por cambios recientes
2. Leer nodos relevantes para entender dependencias
3. Identificar qu√© m√©tricas necesitan actualizaci√≥n (coverage, health, dependencies)
4. Ejecutar: `node scripts/validate-gdd-runtime.js --full`
5. Actualizar cobertura en nodos afectados (Coverage Source: auto, NO manual)
6. Ejecutar: `node scripts/resolve-graph.js <nodos-afectados>`
7. Actualizar "Agentes Relevantes" en nodos si aplica
8. Validar: `node scripts/score-gdd-health.js --ci` (debe >=87)
9. Ejecutar: `node scripts/predict-gdd-drift.js --full` (<60 risk)
10. Generar reporte de sincronizaci√≥n

**Reglas CR√çTICAS:**
- ‚ùå NUNCA modificar cobertura manualmente en nodos
- ‚ùå NUNCA cargar spec.md completo, solo nodos relevantes
- ‚úÖ SIEMPRE actualizar "Agentes Relevantes" despu√©s de invocar agentes
- ‚úÖ SIEMPRE validar antes de commit
- ‚úÖ SIEMPRE mantener Coverage Source: auto

**Output:** Nodos actualizados + reporte de validaci√≥n + health score >=87

### Security Audit Skill

**Triggers:** "auth", "secret", "policy", "vulnerability", "security", "credential"

**Workflow:**
1. Revisar todos los archivos modificados con grep para detectar strings de credenciales
2. Buscar patrones: API_KEY, SECRET, PASSWORD, TOKEN, AUTH_TOKEN en c√≥digo
3. Validar que variables de entorno se cargan desde .env (NO hardcoded)
4. Revisar pol√≠ticas RLS en migraciones SQL (`database/migrations/`)
5. Verificar sanitizaci√≥n de inputs en endpoints (protecci√≥n XSS, SQL injection)
6. Revisar permisos de archivos y configuraci√≥n de CORS
7. Detectar uso seguro de .env vs exponer credenciales en logs
8. Generar reporte con hallazgos y recomendaciones

**Reglas CR√çTICAS:**
- ‚ùå CR√çTICO: Si se detectan credenciales hardcoded ‚Üí detener inmediatamente y reportar
- ‚ùå NUNCA commitear con secrets en logs o c√≥digo
- ‚úÖ SIEMPRE usar variables de entorno
- ‚úÖ Validar permisos RLS en cada cambio de DB
- ‚úÖ Sanitizar inputs de usuario antes de procesar

**Output:** `docs/audit/security-report-{id}.md` + lista de vulnerabilidades

### Visual Validation Skill

**Triggers:** "UI change", "frontend", "visual", "component", "screenshot"

**Workflow:**
1. Conectar a Playwright MCP server (ya configurado)
2. Identificar componentes/rutas afectadas por cambios
3. Lanzar navegaci√≥n a p√°ginas relevantes con `mcp.playwright.browse`
4. Capturar screenshots en m√∫ltiples viewports (desktop: 1920x1080, tablet: 768x1024, mobile: 375x667)
5. Ejecutar tests de accesibilidad autom√°ticos (a11y)
6. Simular interacciones de usuario (clicks, hovers, form submissions)
7. Revisar consola del navegador y network logs
8. Generar reporte visual con capturas y m√©tricas

**Reglas:**
- ‚úÖ SIEMPRE capturar en 3 viewports m√≠nimo
- ‚úÖ Incluir estados: loading, error, empty, success
- ‚úÖ Verificar a11y en cada captura
- ‚úÖ Documentar cualquier inconsistencia visual

**Output:** `docs/test-evidence/issue-{id}/screenshots/` + `ui-report.md` + logs a11y

### Writing Plans Skill

**Triggers:** AC ‚â•3, P0/P1, features complejas

**Workflow:**
1. Leer issue completo (t√≠tulo, body, labels, AC)
2. Resolver nodos GDD relevantes
3. Crear `docs/plan/issue-{id}.md` con estructura:
   - Estado Actual
   - Pasos de implementaci√≥n
   - Agentes a usar
   - Archivos afectados
   - Validaci√≥n requerida
4. Continuar autom√°ticamente (NO esperar confirmaci√≥n)

**Output:** `docs/plan/issue-{id}.md`

### Verification Before Completion Skill

**Triggers:** Antes de "complete", "done", "passing", "ready"

**Workflow:**
1. Ejecutar comandos de verificaci√≥n REALES (no asumir)
2. Verificar tests: `npm test` (debe exit 0)
3. Verificar coverage: `npm run test:coverage` (debe >=90%)
4. Verificar GDD: `node scripts/validate-gdd-runtime.js --full`
5. Verificar health: `node scripts/score-gdd-health.js --ci` (debe >=87)
6. Verificar CodeRabbit: `npm run coderabbit:review` (debe 0 comentarios)
7. Solo entonces marcar como completo

**Regla:** Evidence antes de claims. NUNCA decir "complete" sin ejecutar verificaciones.

---

## Comandos √ötiles

```bash
# GDD
node scripts/resolve-graph.js <nodos>
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci
node scripts/predict-gdd-drift.js --full
node scripts/auto-repair-gdd.js --auto-fix

# Auto-activaci√≥n
node scripts/cursor-agents/auto-gdd-activation.js [issue-number]
node scripts/cursor-agents/detect-triggers.js

# Tests
npm test
npm run test:coverage

# CodeRabbit
npm run coderabbit:review
npm run coderabbit:review:quick
```

---

## Referencias

- **GDD Guide:** `docs/GDD-ACTIVATION-GUIDE.md`
- **Agent Manifest:** `agents/manifest.yaml`
- **Skills:** `.claude/skills/`
- **Migration Guide:** `docs/CURSOR-MIGRATION-GUIDE.md`

