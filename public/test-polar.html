<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roastr â€” Planes (Test Polar)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0d10;
  --panel: #18181e;
  --text: #f9f9fb;
  --muted: #9ca3af;
  --accent: #8b5cf6;
  --accent-hover: #9a6eff;
  --radius: 16px;
  --shadow: 0 8px 24px rgba(0,0,0,0.25);
  --transition: 180ms cubic-bezier(.2,.8,.2,1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: radial-gradient(1000px 600px at -10% -10%, rgba(139,92,246,.12), transparent 60%), var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 20px;
}

.header {
  text-align: center;
  margin-bottom: 48px;
}

h1 {
  font-size: 32px;
  font-weight: 600;
  margin-bottom: 12px;
}

.subtitle {
  color: var(--muted);
  font-size: 16px;
}

.badge {
  display: inline-block;
  background: rgba(139,92,246,.2);
  color: var(--accent);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 24px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.plans {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  width: 100%;
  max-width: 900px;
}

.card {
  background: var(--panel);
  border-radius: var(--radius);
  padding: 32px 24px;
  text-align: center;
  box-shadow: var(--shadow);
  border: 1px solid rgba(255,255,255,0.1);
  transition: transform var(--transition), box-shadow var(--transition);
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent-hover));
  opacity: 0;
  transition: opacity var(--transition);
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(139,92,246,0.3);
}

.card:hover::before {
  opacity: 1;
}

.card.popular {
  border-color: var(--accent);
  box-shadow: 0 8px 24px rgba(139,92,246,0.2);
}

.popular-badge {
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--accent);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.card h2 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
}

.card p {
  color: var(--muted);
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 24px;
  min-height: 42px;
}

.price {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 8px;
  background: linear-gradient(135deg, var(--text), var(--muted));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.period {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 24px;
}

button {
  background: linear-gradient(180deg, var(--accent), var(--accent-hover));
  color: #fff;
  border: none;
  padding: 14px 28px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  transition: all var(--transition);
  width: 100%;
  position: relative;
  overflow: hidden;
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

button:hover::before {
  left: 100%;
}

button:hover {
  background: linear-gradient(180deg, var(--accent-hover), var(--accent));
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(139,92,246,0.4);
}

button:active {
  transform: translateY(0);
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

button.loading {
  pointer-events: none;
}

.spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.footer {
  margin-top: 48px;
  text-align: center;
  color: var(--muted);
  font-size: 13px;
}

.footer a {
  color: var(--accent);
  text-decoration: none;
}

.footer a:hover {
  text-decoration: underline;
}

.email-input {
  width: 100%;
  max-width: 400px;
  margin: 0 auto 32px;
  position: relative;
}

.email-input input {
  width: 100%;
  background: var(--panel);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text);
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 15px;
  font-family: 'Inter', sans-serif;
  transition: border-color var(--transition);
}

.email-input input:focus {
  outline: none;
  border-color: var(--accent);
}

.email-input input::placeholder {
  color: var(--muted);
}

@media (max-width: 768px) {
  .plans {
    grid-template-columns: 1fr;
  }

  h1 {
    font-size: 24px;
  }

  .price {
    font-size: 24px;
  }
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(239,68,68,0.9);
  color: #fff;
  padding: 12px 18px;
  border-radius: 10px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  opacity: 0;
  transform: translateY(20px);
  transition: all .3s ease;
  z-index: 9999;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}
</style>
</head>
<body>

<div class="header">
  <div class="badge">ğŸ§ª Test de Polar Checkout</div>
  <h1>Elige tu plan</h1>
  <p class="subtitle">Prueba el flujo de pago con Polar</p>
</div>

<div class="email-input">
  <input
    type="email"
    id="customerEmail"
    placeholder="Tu email (para testing)"
    value="test@roastr.ai"
    onfocus="if(this.value === 'test@roastr.ai') this.value = ''"
    onblur="if(this.value === '') this.value = 'test@roastr.ai'"
  >
</div>

<div class="plans">
  <!-- Starter Plan -->
  <div class="card">
    <h2>Starter</h2>
    <p>ProtecciÃ³n digital bÃ¡sica + 5 Roasts mensuales</p>
    <div class="price">5â‚¬</div>
    <div class="period">por mes</div>
    <button
      id="btn-starter"
      onclick="startCheckout('starter')"
    >
      Suscribirme al Starter
    </button>
  </div>

  <!-- Pro Plan -->
  <div class="card popular">
    <div class="popular-badge">MÃ¡s popular</div>
    <h2>Pro</h2>
    <p>ProtecciÃ³n avanzada + 20 Roasts + alertas extendidas</p>
    <div class="price">12â‚¬</div>
    <div class="period">por mes</div>
    <button
      id="btn-pro"
      onclick="startCheckout('pro')"
    >
      Suscribirme al Pro
    </button>
  </div>

  <!-- Plus Plan -->
  <div class="card">
    <h2>Plus</h2>
    <p>Todo incluido: protecciÃ³n total, 100 Roasts, IA personalizada</p>
    <div class="price">24â‚¬</div>
    <div class="period">por mes</div>
    <button
      id="btn-plus"
      onclick="startCheckout('plus')"
    >
      Suscribirme al Plus
    </button>
  </div>
</div>

<div class="footer">
  <p>ğŸ”’ Pago seguro procesado por <a href="https://polar.sh" target="_blank">Polar</a></p>
  <p style="margin-top: 8px;">
    <a href="/">â† Volver al dashboard</a> |
    <a href="/public/success.html?checkout_id=test_123">Ver pÃ¡gina de Ã©xito</a>
  </p>
</div>

<!-- Toast de error -->
<div id="toast" class="toast">âŒ Error al procesar el pago</div>

<script>
/**
 * CONFIGURACIÃ“N DE PRICE IDs DE POLAR
 *
 * IDs configurados para los planes de Roastr
 */
const POLAR_PRICE_IDS = {
  starter: 'e242580e-41df-4997-aebe-604492249f39',  // Starter - â‚¬5/mes
  pro: 'c1787586-00b7-4790-ba43-1f1e6a60b095',      // Pro - â‚¬12/mes
  plus: '176df9af-337f-4607-9524-48978eae8bea',     // Plus - â‚¬24/mes
};

/**
 * Mostrar toast de error
 */
function showToast(message = 'âŒ Error al procesar el pago') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 4000);
}

/**
 * Iniciar proceso de checkout con Polar
 *
 * @param {string} planName - Nombre del plan (starter, pro, plus)
 */
async function startCheckout(planName) {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸš€ [Polar Test] Iniciando checkout');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

  // Obtener email del input
  const emailInput = document.getElementById('customerEmail');
  const customerEmail = emailInput.value.trim();

  // Validar email
  if (!customerEmail || !customerEmail.includes('@')) {
    showToast('âš ï¸ Por favor, ingresa un email vÃ¡lido');
    emailInput.focus();
    return;
  }

  // Obtener Price ID del objeto de configuraciÃ³n
  const finalPriceId = POLAR_PRICE_IDS[planName];

  // Validar que exista el Price ID
  if (!finalPriceId) {
    showToast(`âŒ Error: Plan "${planName}" no configurado`);
    console.error(`Price ID no encontrado para plan: ${planName}`);
    return;
  }

  console.log('ğŸ“‹ Datos del checkout:');
  console.log('  Plan:', planName);
  console.log('  Email:', customerEmail);
  console.log('  Price ID:', finalPriceId);

  // Obtener botÃ³n para mostrar loading
  const button = document.getElementById(`btn-${planName}`);
  const originalText = button.innerHTML;

  // Mostrar estado de carga
  button.disabled = true;
  button.classList.add('loading');
  button.innerHTML = '<span class="spinner"></span> Creando checkout...';

  try {
    console.log('ğŸ“¡ Enviando request a /api/checkout...');
    console.log('ğŸŒ Browser:', navigator.userAgent);

    const requestBody = {
      customer_email: customerEmail,
      price_id: finalPriceId,
      metadata: {
        plan: planName,
        source: 'test-polar-html',
        timestamp: new Date().toISOString(),
      }
    };

    console.log('ğŸ“¤ Request body:', requestBody);

    // Usar URL absoluta con HTTP explÃ­cito para Safari
    // Safari a veces intenta forzar HTTPS en localhost
    const host = window.location.host;
    const apiUrl = `http://${host}/api/checkout`;
    console.log('ğŸ”— API URL:', apiUrl);

    // Crear timeout para Safari (30 segundos)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000);

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify(requestBody),
      credentials: 'same-origin',
      signal: controller.signal
    }).catch(err => {
      clearTimeout(timeoutId);
      if (err.name === 'AbortError') {
        console.error('ğŸš¨ Request timeout (30s)');
        throw new Error('Request timeout: El servidor tardÃ³ demasiado en responder');
      }
      console.error('ğŸš¨ Fetch error (network):', err);
      console.error('ğŸš¨ Error name:', err.name);
      console.error('ğŸš¨ Error stack:', err.stack);
      throw new Error(`Network error: ${err.message}`);
    });

    clearTimeout(timeoutId);
    console.log('âœ… Fetch completed successfully');

    console.log('ğŸ“¥ Response status:', response.status);
    console.log('ğŸ“¥ Response ok:', response.ok);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('ğŸ“¥ Response error text:', errorText);
      throw new Error(`Server error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    console.log('ğŸ“¦ Response data:', data);

    // Validar que tengamos el checkout URL
    if (!data.checkout || !data.checkout.url) {
      console.error('âŒ Invalid response structure:', data);
      throw new Error('No se recibiÃ³ URL de checkout del servidor');
    }

    console.log('âœ… Checkout creado exitosamente!');
    console.log('ğŸ”— Checkout URL:', data.checkout.url);
    console.log('ğŸ†” Checkout ID:', data.checkout.id);
    console.log('');
    console.log('ğŸŒ Redirigiendo a Polar en 1 segundo...');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    // PequeÃ±o delay para que el usuario vea el estado de Ã©xito
    setTimeout(() => {
      window.location.href = data.checkout.url;
    }, 1000);

  } catch (err) {
    console.error('âŒ Error en checkout:', err);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    // Restaurar botÃ³n
    button.disabled = false;
    button.classList.remove('loading');
    button.innerHTML = originalText;

    // Mostrar error al usuario con toast
    showToast(`âŒ Error: ${err.message}`);
  }
}

// Log de informaciÃ³n Ãºtil al cargar la pÃ¡gina
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸ§ª PÃ¡gina de Test de Polar Checkout cargada');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸ“‹ ConfiguraciÃ³n actual:');
console.log('  Price IDs configurados:', POLAR_PRICE_IDS);
console.log('');
console.log('âš ï¸  IMPORTANTE:');
console.log('  1. AsegÃºrate de reemplazar los Price IDs en el cÃ³digo');
console.log('  2. Verifica que el backend estÃ© corriendo en puerto 3000');
console.log('  3. Comprueba que POLAR_ACCESS_TOKEN estÃ© en el .env');
console.log('');
console.log('ğŸ”§ Para probar:');
console.log('  1. Ingresa un email de test');
console.log('  2. Haz clic en "Suscribirme"');
console.log('  3. Observa los logs en esta consola');
console.log('  4. SerÃ¡s redirigido a Polar para completar el pago');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
</script>

</body>
</html>
