<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>¬°Listo para Empezar! - Paso 4</title>
    <link rel="stylesheet" href="../css/style.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        .onboarding-container {
            max-width: 700px;
            margin: 50px auto;
            padding: 40px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .step.active {
            background: var(--color-blue);
            color: white;
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: #28a745;
            margin: 0 10px;
        }

        .completion-content {
            text-align: center;
            margin: 40px 0;
        }

        .completion-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .completion-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-black);
            margin-bottom: 16px;
        }

        .completion-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .summary-card {
            background: var(--color-white);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 32px;
            margin: 32px 0;
            text-align: left;
        }

        .summary-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-section {
            margin: 20px 0;
            padding: 16px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-section:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 16px;
            color: var(--color-black);
        }

        .platforms-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .platform-tag {
            background: rgba(0, 145, 255, 0.1);
            color: var(--color-blue);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .plan-info {
            background: linear-gradient(135deg, var(--color-blue), #0074CC);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
            text-align: center;
        }

        .plan-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .plan-features {
            font-size: 14px;
            opacity: 0.9;
        }

        .next-steps {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }

        .next-steps-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 16px;
        }

        .next-steps-list {
            list-style: none;
            padding: 0;
        }

        .next-steps-list li {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
            color: #666;
        }

        .next-steps-list li::before {
            content: '‚Üí';
            color: var(--color-blue);
            font-weight: bold;
            margin-right: 12px;
        }

        .loading-state {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-state.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .onboarding-actions {
            display: flex;
            gap: 16px;
            justify-content: space-between;
            margin-top: 40px;
        }

        .btn-back {
            background: transparent;
            color: #666;
            border: 1px solid var(--color-gray);
        }

        .btn-back:hover {
            background: var(--color-gray);
        }

        .btn-start {
            background: #28a745;
            border-color: #28a745;
            min-width: 160px;
            font-weight: 600;
        }

        .btn-start:hover {
            background: #218838;
            border-color: #1e7e34;
        }

        @media (max-width: 768px) {
            .onboarding-container {
                padding: 20px;
                margin: 20px auto;
            }

            .summary-card {
                padding: 24px;
            }

            .completion-title {
                font-size: 28px;
            }

            .onboarding-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="auth-bg">
    <div class="onboarding-container">
        <!-- Indicador de progreso -->
        <div class="step-indicator">
            <div class="step completed">1</div>
            <div class="step-line"></div>
            <div class="step completed">2</div>
            <div class="step-line"></div>
            <div class="step completed">3</div>
            <div class="step-line"></div>
            <div class="step active">4</div>
        </div>

        <!-- Estado normal -->
        <div id="normal-content">
            <!-- Contenido de finalizaci√≥n -->
            <div class="completion-content">
                <div class="completion-icon">üéâ</div>
                <h1 class="completion-title">¬°Todo listo!</h1>
                <p class="completion-subtitle">
                    Perfecto, hemos configurado tu cuenta de Roastr.ai. 
                    Aqu√≠ tienes un resumen de tu configuraci√≥n:
                </p>
            </div>

            <!-- Tarjeta de resumen -->
            <div class="summary-card">
                <h3 class="summary-title">Resumen de tu configuraci√≥n</h3>
                
                <div class="summary-section">
                    <div class="summary-label">Plataformas seleccionadas</div>
                    <div class="summary-value" id="platforms-summary">
                        <div class="platforms-list" id="platforms-list">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <div class="summary-section">
                    <div class="summary-label">Tono de humor</div>
                    <div class="summary-value" id="tone-summary">Sarc√°stico</div>
                </div>
                
                <div class="summary-section">
                    <div class="summary-label">Estilo de respuesta</div>
                    <div class="summary-value" id="style-summary">Ingenioso</div>
                </div>
                
                <div class="summary-section">
                    <div class="summary-label">Frecuencia de respuesta</div>
                    <div class="summary-value" id="frequency-summary">70%</div>
                </div>
            </div>

            <!-- Informaci√≥n del plan -->
            <div class="plan-info">
                <div class="plan-name">Plan B√°sico Activo</div>
                <div class="plan-features">
                    ‚úì Hasta 3 plataformas conectadas ‚Ä¢ ‚úì 100 respuestas/mes ‚Ä¢ ‚úì Soporte por email
                </div>
            </div>

            <!-- Pr√≥ximos pasos -->
            <div class="next-steps">
                <h4 class="next-steps-title">Pr√≥ximos pasos:</h4>
                <ul class="next-steps-list">
                    <li>Conecta tus cuentas de redes sociales en "Plataformas"</li>
                    <li>Revisa y ajusta tu configuraci√≥n cuando quieras</li>
                    <li>Monitorea las respuestas autom√°ticas desde tu dashboard</li>
                    <li>Upgrade a Pro para m√°s plataformas y respuestas ilimitadas</li>
                </ul>
            </div>
        </div>

        <!-- Estado de carga -->
        <div id="loading-content" class="loading-state">
            <div class="spinner"></div>
            <p>Guardando tu configuraci√≥n...</p>
        </div>

        <!-- Mensajes de estado -->
        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>

        <!-- Botones de navegaci√≥n -->
        <div class="onboarding-actions" id="action-buttons">
            <button class="btn-secondary btn-back" onclick="previousStep()">‚Üê Anterior</button>
            <button class="btn-primary btn-start" onclick="completeOnboarding()">¬°Empezar! üöÄ</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de nombres de plataformas
        const platformNames = {
            twitter: 'Twitter/X',
            instagram: 'Instagram',
            facebook: 'Facebook',
            youtube: 'YouTube',
            discord: 'Discord',
            twitch: 'Twitch',
            reddit: 'Reddit',
            tiktok: 'TikTok',
            bluesky: 'Bluesky'
        };

        const toneNames = {
            sarcastic: 'Sarc√°stico',
            subtle: 'Sutil',
            direct: 'Directo',
            playful: 'Juguet√≥n',
            witty: 'Ingenioso'
        };

        const styleNames = {
            witty: 'Ingenioso',
            clever: 'Astuto',
            dry: 'Humor seco',
            savage: 'Salvaje',
            friendly: 'Amigable'
        };

        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                window.location.href = '/auth.html';
                return;
            }

            loadAndDisplaySummary();
        });

        function loadAndDisplaySummary() {
            try {
                // Cargar datos del sessionStorage
                const selectedPlatforms = JSON.parse(sessionStorage.getItem('selected_platforms') || '[]');
                const config = JSON.parse(sessionStorage.getItem('onboarding_config') || '{}');

                // Mostrar plataformas
                const platformsList = document.getElementById('platforms-list');
                if (selectedPlatforms.length > 0) {
                    const platformsHTML = selectedPlatforms.map(platform => {
                        return `<span class="platform-tag">${platformNames[platform] || platform}</span>`;
                    }).join('');
                    platformsList.innerHTML = platformsHTML;
                } else {
                    platformsList.innerHTML = '<span style="color: #666; font-style: italic;">Ninguna seleccionada (puedes conectar despu√©s)</span>';
                }

                // Mostrar configuraci√≥n
                document.getElementById('tone-summary').textContent = toneNames[config.tone] || 'Sarc√°stico';
                document.getElementById('style-summary').textContent = styleNames[config.style] || 'Ingenioso';
                document.getElementById('frequency-summary').textContent = Math.round((config.frequency || 0.7) * 100) + '%';

            } catch (error) {
                console.error('Error loading summary:', error);
                showMessage('Error al cargar el resumen de configuraci√≥n');
            }
        }

        async function completeOnboarding() {
            showLoading(true);

            try {
                // Recopilar toda la configuraci√≥n
                const selectedPlatforms = JSON.parse(sessionStorage.getItem('selected_platforms') || '[]');
                const config = JSON.parse(sessionStorage.getItem('onboarding_config') || '{}');

                const preferences = {
                    preferred_platforms: selectedPlatforms,
                    humor_tone: config.tone || 'sarcastic',
                    humor_style: config.style || 'witty',
                    response_frequency: config.frequency || 0.7,
                    auto_respond: true,
                    shield_enabled: true
                };

                // Enviar al backend
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/user/preferences', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(preferences)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Actualizar datos del usuario en localStorage
                    const currentUserData = localStorage.getItem('user_data');
                    if (currentUserData) {
                        const userData = JSON.parse(currentUserData);
                        userData.onboarding_complete = true;
                        userData.preferences = result.data.user.preferences;
                        localStorage.setItem('user_data', JSON.stringify(userData));
                    }

                    // Limpiar sessionStorage
                    sessionStorage.removeItem('selected_platforms');
                    sessionStorage.removeItem('onboarding_config');

                    showMessage('¬°Configuraci√≥n guardada exitosamente! Redirigiendo al dashboard...', 'success');
                    
                    // Redirigir al dashboard despu√©s de un breve delay
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 2000);

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al guardar preferencias');
                }

            } catch (error) {
                console.error('Error completing onboarding:', error);
                showMessage('Error al completar la configuraci√≥n: ' + error.message);
                showLoading(false);
            }
        }

        function showLoading(show) {
            const normalContent = document.getElementById('normal-content');
            const loadingContent = document.getElementById('loading-content');
            const actionButtons = document.getElementById('action-buttons');

            if (show) {
                normalContent.style.display = 'none';
                actionButtons.style.display = 'none';
                loadingContent.classList.add('show');
            } else {
                normalContent.style.display = 'block';
                actionButtons.style.display = 'flex';
                loadingContent.classList.remove('show');
            }
        }

        function previousStep() {
            window.location.href = '/onboarding/step3.html';
        }

        function showMessage(message, type = 'error') {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            
            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
            } else {
                successDiv.textContent = message;
                successDiv.classList.add('show');
            }
            
            setTimeout(() => {
                errorDiv.classList.remove('show');
                successDiv.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>