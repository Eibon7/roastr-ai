<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrarse - Roastr.ai</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  </head>
  <body class="auth-bg">
    <div class="card">
      <h1>Crear cuenta</h1>

      <!-- Mensajes de error/√©xito -->
      <div id="error-message" class="error-message"></div>
      <div id="success-message" class="success-message"></div>

      <form id="register-form">
        <input class="input-text" type="text" name="name" id="name" placeholder="Nombre completo" />

        <input
          class="input-text"
          type="email"
          name="email"
          id="email"
          placeholder="Email"
          required
        />

        <div class="password-field">
          <input
            class="input-text"
            type="password"
            name="password"
            placeholder="Contrase√±a (m√≠nimo 8 caracteres)"
            id="password"
            required
            minlength="8"
          />
          <button type="button" class="toggle-password" onclick="togglePassword('password')">
            üëÅÔ∏è
          </button>
        </div>

        <div class="password-field">
          <input
            class="input-text"
            type="password"
            name="confirmPassword"
            placeholder="Confirmar contrase√±a"
            id="confirmPassword"
            required
            minlength="8"
          />
          <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
            üëÅÔ∏è
          </button>
        </div>

        <label class="checkbox">
          <input type="checkbox" name="acceptTerms" required />
          Acepto los t√©rminos y condiciones
        </label>

        <button type="submit" class="btn-primary" id="register-btn">Crear cuenta</button>
      </form>

      <div class="divider"></div>

      <button type="button" class="btn-secondary" id="google-register-btn">
        Registrarse con Google
      </button>

      <a class="link" href="auth.html">¬øYa tienes cuenta? Inicia sesi√≥n</a>
    </div>

    <script>
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;

        if (input.type === 'password') {
          input.type = 'text';
          button.textContent = 'üôà';
        } else {
          input.type = 'password';
          button.textContent = 'üëÅÔ∏è';
        }
      }

      function showMessage(message, type = 'error') {
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');

        // Hide both messages first
        errorDiv.classList.remove('show');
        successDiv.classList.remove('show');

        if (type === 'error') {
          errorDiv.textContent = message;
          errorDiv.classList.add('show');
        } else {
          successDiv.textContent = message;
          successDiv.classList.add('show');
        }

        // Auto-hide after 5 seconds
        setTimeout(() => {
          errorDiv.classList.remove('show');
          successDiv.classList.remove('show');
        }, 5000);
      }

      function setLoading(buttonId, isLoading = true) {
        const button = document.getElementById(buttonId);
        if (isLoading) {
          button.disabled = true;
          button.classList.add('loading');
        } else {
          button.disabled = false;
          button.classList.remove('loading');
        }
      }

      function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      // Handle registration form
      document.getElementById('register-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const name = formData.get('name');
        const email = formData.get('email');
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');
        const acceptTerms = formData.get('acceptTerms');

        // Validations
        if (!validateEmail(email)) {
          showMessage('Por favor ingresa un email v√°lido.');
          return;
        }

        if (password.length < 8) {
          showMessage('La contrase√±a debe tener al menos 8 caracteres.');
          return;
        }

        if (password !== confirmPassword) {
          showMessage('Las contrase√±as no coinciden.');
          return;
        }

        if (!acceptTerms) {
          showMessage('Debes aceptar los t√©rminos y condiciones.');
          return;
        }

        setLoading('register-btn', true);

        try {
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password, name })
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showMessage(
              '¬°Cuenta creada exitosamente! Revisa tu email para verificar tu cuenta.',
              'success'
            );

            // Clear form
            document.getElementById('register-form').reset();

            // Redirect to verification page after delay
            setTimeout(() => {
              window.location.href = `/email-verification.html?email=${encodeURIComponent(email)}`;
            }, 2000);
          } else {
            if (result.error && result.error.includes('already exists')) {
              showMessage('Ya existe una cuenta con este email.');
            } else {
              showMessage(result.error || 'Error al crear la cuenta. Int√©ntalo de nuevo.');
            }
          }
        } catch (error) {
          console.error('Error:', error);
          showMessage('Error de conexi√≥n. Int√©ntalo de nuevo.');
        } finally {
          setLoading('register-btn', false);
        }
      });

      // Handle Google registration
      document.getElementById('google-register-btn').addEventListener('click', function () {
        setLoading('google-register-btn', true);
        window.location.href = '/api/auth/google';
      });

      // Check if user is already logged in
      if (localStorage.getItem('auth_token')) {
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        if (userData.is_admin) {
          window.location.href = '/admin.html';
        } else {
          window.location.href = '/dashboard.html';
        }
      }
    </script>
  </body>
</html>
