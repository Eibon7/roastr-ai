#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Auto-format staged files with Prettier (only staged files, much faster)
# Uses null-terminated filenames to handle spaces/special chars safely
echo "üé® Auto-formatting staged files with Prettier..."
STAGED_FILES=$(git diff --cached --name-only -z --diff-filter=ACMR | tr '\0' '\n' | grep -E '\.(js|jsx|ts|tsx|json|css|md|yaml|yml)$' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | tr '\n' '\0' | xargs -0 npx prettier --write 2>/dev/null || true
  echo "$STAGED_FILES" | tr '\n' '\0' | xargs -0 git add  # Re-stage formatted files
  FILE_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
  echo "‚úÖ Formatted $FILE_COUNT file(s)"
else
  echo "‚ÑπÔ∏è  No formattable files staged"
fi

# Case sensitivity guard - basic frontend build check
echo "üîç Checking for case-sensitive import issues..."
(cd frontend && npm run build:ci --if-present) || exit 1

# CodeRabbit CLI review (automatic - runs if authenticated)
echo ""
echo "üê∞ Running CodeRabbit CLI review..."
# Try to find coderabbit binary dynamically
CODERABBIT_BIN=""
if command -v coderabbit >/dev/null 2>&1; then
  CODERABBIT_BIN=$(command -v coderabbit)
elif [ -f "$HOME/.local/bin/coderabbit" ]; then
  CODERABBIT_BIN="$HOME/.local/bin/coderabbit"
fi

if [ -n "$CODERABBIT_BIN" ]; then
  if $CODERABBIT_BIN auth status >/dev/null 2>&1; then
    echo "‚úÖ CodeRabbit authenticated - running review..."
    $CODERABBIT_BIN review --prompt-only || echo "‚ö†Ô∏è  CodeRabbit review had issues, continuing..."
  else
    echo "‚ö†Ô∏è  CodeRabbit not authenticated. Run: npm run coderabbit:login"
  fi
else
  echo "‚ö†Ô∏è  CodeRabbit CLI not installed. Skipping..."
fi

echo ""
echo "‚úÖ Pre-commit checks passed!"