name: System Map v2 Consistency Check

on:
  pull_request:
    branches:
      - main
    paths:
      - 'docs/system-map-v2.yaml'
      - 'docs/nodes-v2/**'
      - 'docs/SSOT-V2.md'
      - 'src/**'
      - 'scripts/validate-*.js'
      - 'scripts/detect-*.js'
  push:
    branches:
      - 'feature/**'
    paths:
      - 'docs/system-map-v2.yaml'
      - 'docs/nodes-v2/**'
      - 'docs/SSOT-V2.md'
      - 'src/**'
  workflow_dispatch:
    inputs:
      full_validation:
        description: 'Run full validation (including health score)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  pull-requests: write

jobs:
  system-map-v2-consistency:
    name: System Map v2 Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Node IDs
        id: validate_node_ids
        run: |
          echo "üîç Validating Node IDs..."
          set +e
          node scripts/validate-node-ids.js --ci
          NODE_IDS_EXIT=$?
          set -e
          
          # Exit code contract:
          # 0 = no issues ‚Üí OK
          # 1 = src/ only ‚Üí WARN, allow CI to continue
          # 2 = docs/ ‚Üí FAIL
          
          if [ "$NODE_IDS_EXIT" -eq 0 ]; then
            echo "‚úÖ No node ID issues detected"
            exit 0
          elif [ "$NODE_IDS_EXIT" -eq 1 ]; then
            echo "‚ö†Ô∏è Node ID issues in src/ (allowed as warnings for v2 PRs)"
            echo "::warning::Legacy node IDs in src/ will be addressed in separate cleanup task"
            exit 0
          elif [ "$NODE_IDS_EXIT" -eq 2 ]; then
            echo "::error::Node ID issues in docs/ ‚Äî must be fixed before merge"
            exit 1
          else
            echo "::error::Unexpected exit code $NODE_IDS_EXIT from validate-node-ids.js"
            exit 1
          fi
        continue-on-error: false

      - name: Validate Workers SSOT
        id: validate_workers_ssot
        run: |
          echo "üîç Validating Workers against SSOT..."
          node scripts/validate-workers-ssot.js --ci
          echo "‚úÖ Workers SSOT validation passed"
        continue-on-error: false

      - name: Validate Drift
        id: validate_drift
        run: |
          echo "üîç Validating drift between SSOT, nodes, and system-map..."
          node scripts/validate-drift.js --ci
          echo "‚úÖ Drift validation passed"
        continue-on-error: false

      - name: Validate Symmetry
        id: validate_symmetry
        run: |
          echo "üîç Validating system-map symmetry..."
          node scripts/validate-symmetry.js --ci
          echo "‚úÖ Symmetry validation passed"
        continue-on-error: false

      - name: Validate Strong Concepts
        id: validate_strong_concepts
        run: |
          echo "üîç Validating Strong Concepts..."
          node scripts/validate-strong-concepts.js --ci
          echo "‚úÖ Strong Concepts validation passed"
        continue-on-error: false

      - name: Check System Map Drift
        id: check_system_map_drift
        run: |
          echo "üîç Checking system-map drift..."
          node scripts/check-system-map-drift.js --ci
          echo "‚úÖ System-map drift check completed"
        continue-on-error: false

      - name: Validate v2 Doc Paths
        id: validate_doc_paths
        run: |
          echo "üîç Validating v2 doc paths..."
          node scripts/validate-v2-doc-paths.js --ci
          echo "‚úÖ v2 doc paths validation passed"
        continue-on-error: false

      - name: Detect Legacy IDs
        id: detect_legacy_ids
        run: |
          echo "üîç Detecting legacy IDs..."
          set +e
          node scripts/detect-legacy-ids.js --ci
          LEGACY_EXIT=$?
          set -e
          
          # Exit code contract:
          # 0 = no legacy IDs ‚Üí OK
          # 1 = src/ only ‚Üí WARN, allow CI to continue
          # 2 = docs/ ‚Üí FAIL
          
          if [ "$LEGACY_EXIT" -eq 0 ]; then
            echo "‚úÖ No legacy IDs detected"
            exit 0
          elif [ "$LEGACY_EXIT" -eq 1 ]; then
            echo "‚ö†Ô∏è Legacy IDs detected in src/ (allowed as warnings for v2 PRs)"
            echo "::warning::Legacy IDs in src/ will be addressed in separate cleanup task"
            exit 0
          elif [ "$LEGACY_EXIT" -eq 2 ]; then
            echo "::error::Legacy IDs detected in docs/ ‚Äî must be fixed before merge"
            exit 1
          else
            echo "::error::Unexpected exit code $LEGACY_EXIT from detect-legacy-ids.js"
            exit 1
          fi
        continue-on-error: false

      - name: Detect Guardian References
        id: detect_guardian
        run: |
          echo "üîç Detecting guardian references..."
          set +e
          node scripts/detect-guardian-references.js
          GUARDIAN_EXIT=$?
          set -e
          
          # Guardian references are deprecated but may exist in src/ (legacy code)
          # Exit codes: 0 = none, non-zero = found
          # For v2 PRs, treat as warning only (legacy cleanup is separate task)
          if [ "$GUARDIAN_EXIT" -eq 0 ]; then
            echo "‚úÖ No guardian references detected"
            exit 0
          else
            echo "‚ö†Ô∏è Guardian references detected (exit code: $GUARDIAN_EXIT)"
            echo "::warning::Guardian references detected in codebase (acceptable for v2 PRs - legacy cleanup is separate task)"
            # Don't fail CI for guardian references in src/
            exit 0
          fi
        continue-on-error: false

      - name: Compute GDD Health v2
        id: compute_health
        if: github.event.inputs.full_validation != 'false' || github.event_name == 'workflow_dispatch'
        run: |
          echo "üìä Computing GDD Health Score v2..."
          # Update SSOT with latest metrics
          node scripts/compute-health-v2-official.js --update-ssot || {
            echo "‚ö†Ô∏è Health calculation completed with warnings"
          }

      - name: Calculate GDD Health v2 (read from SSOT)
        id: calculate_health
        if: github.event.inputs.full_validation != 'false' || github.event_name == 'workflow_dispatch'
        run: |
          echo "üìä Reading GDD Health Score v2 from SSOT..."
          # Read health score from SSOT (secci√≥n 15) using calculate-gdd-health-v2.js
          node scripts/calculate-gdd-health-v2.js --json > gdd-health-v2.json 2>&1 || {
            echo "‚ö†Ô∏è Health score reading completed with warnings"
            echo '{"overall_score": 0, "status": "unknown"}' > gdd-health-v2.json
          }
          
          HEALTH_SCORE=$(jq -r '.overall_score // 0' gdd-health-v2.json 2>/dev/null || echo "0")
          HEALTH_STATUS=$(jq -r '.status // "unknown"' gdd-health-v2.json 2>/dev/null || echo "unknown")
          
          echo "score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
          echo "status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          
          echo "Health Score: $HEALTH_SCORE/100 ($HEALTH_STATUS)"
          
          # Check if health score meets threshold (‚â•95 required, 100 recommended for v2)
          # For PR runs, treat low health as warning (not fatal) to allow incremental improvements
          if (( $(echo "$HEALTH_SCORE < 95" | bc -l 2>/dev/null || echo "1") )); then
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "‚ö†Ô∏è Health score $HEALTH_SCORE is below 95 threshold ‚Äî treating as WARNING for PR"
              echo "::warning::Health score $HEALTH_SCORE/100 is below required threshold of 95 (non-fatal for PRs)"
              # Don't fail CI for PRs - allow incremental improvements
            else
              echo "‚ùå Health score $HEALTH_SCORE is below 95 threshold (required for v2)"
              echo "::error::Health score $HEALTH_SCORE/100 is below required threshold of 95"
              exit 1
            fi
          elif (( $(echo "$HEALTH_SCORE < 100" | bc -l 2>/dev/null || echo "0") )); then
            echo "‚ö†Ô∏è Health score $HEALTH_SCORE meets minimum threshold (‚â•95) but is below recommended 100"
            echo "::warning::Health score $HEALTH_SCORE/100 is below recommended threshold of 100"
          else
            echo "‚úÖ Health score $HEALTH_SCORE meets recommended threshold (100)"
          fi
        continue-on-error: false

      - name: Generate Validation Summary
        if: always()
        run: |
          echo "## üìä System Map v2 Consistency Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node IDs | ${{ steps.validate_node_ids.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workers SSOT | ${{ steps.validate_workers_ssot.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Drift | ${{ steps.validate_drift.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Symmetry | ${{ steps.validate_symmetry.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Strong Concepts | ${{ steps.validate_strong_concepts.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| System Map Drift | ${{ steps.check_system_map_drift.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| v2 Doc Paths | ${{ steps.validate_doc_paths.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Legacy IDs | ${{ steps.detect_legacy_ids.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Guardian References | ${{ steps.detect_guardian.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.calculate_health.outcome }}" != "skipped" ]; then
            echo "| Health Score | ${{ steps.calculate_health.outputs.score }}/100 (${{ steps.calculate_health.outputs.status }}) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** Health Score ‚â•95 required" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## üß† System Map v2 Consistency Check\n\n';
            comment += '### Validation Results\n\n';
            comment += '| Check | Status |\n';
            comment += '|-------|--------|\n';
            comment += `| Node IDs | ${{ steps.validate_node_ids.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| Workers SSOT | ${{ steps.validate_workers_ssot.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| Drift | ${{ steps.validate_drift.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| Symmetry | ${{ steps.validate_symmetry.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| Strong Concepts | ${{ steps.validate_strong_concepts.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| Legacy IDs | ${{ steps.detect_legacy_ids.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| Guardian References | ${{ steps.detect_guardian.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| System Map Drift | ${{ steps.check_system_map_drift.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            comment += `| v2 Doc Paths | ${{ steps.validate_doc_paths.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} |\n`;
            
            if (fs.existsSync('gdd-health-v2.json')) {
              const health = JSON.parse(fs.readFileSync('gdd-health-v2.json', 'utf8'));
              const score = health.overall_score || 0;
              const status = health.status || 'unknown';
              comment += `| Health Score | ${score}/100 (${status}) |\n`;
              
              if (score < 95) {
                comment += '\n‚ö†Ô∏è **Health score below threshold (‚â•95 required)**\n';
              } else {
                comment += '\n‚úÖ **Health score meets threshold**\n';
              }
            }
            
            comment += '\n---\n';
            comment += '**Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('System Map v2 Consistency Check')
            );
            
            // Create or update comment
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: system-map-v2-validation
          path: |
            gdd-health-v2.json
          retention-days: 30

