name: CI - PR Validation

on:
  pull_request:
    branches: [ main ]

jobs:
  coderabbit-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Check Coderabbit status (informative only)
        uses: actions/github-script@v8
        continue-on-error: true
        with:
          script: |
            const pr = context.payload.pull_request.number;
            
            // Get all reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr
            });

            // Find CodeRabbit review
            const rabbitReviews = reviews.filter(r =>
              r.user.login.includes("coderabbit") || r.user.login.includes("coderabbitai")
            );

            if (rabbitReviews.length === 0) {
              core.warning("‚ö†Ô∏è CodeRabbit review not found yet");
              console.log("‚ÑπÔ∏è This is informational only - merge decision is yours");
              return;
            }

            // Get latest CodeRabbit review
            const latestReview = rabbitReviews[rabbitReviews.length - 1];
            
            // Check if review is APPROVED
            if (latestReview.state === "APPROVED") {
              console.log("‚úÖ CodeRabbit approved the PR");
              return;
            }
            
            // Check for review comments
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr
            });
            
            const rabbitComments = reviewComments.filter(c => 
              c.user.login.includes("coderabbit") || c.user.login.includes("coderabbitai")
            );
            
            // Count unresolved comments
            const unresolvedComments = rabbitComments.filter(c => 
              c.body && !c.body.includes("‚úÖ") && !c.body.includes("resolved")
            );
            
            if (unresolvedComments.length > 0) {
              core.warning(`‚ö†Ô∏è CodeRabbit has ${unresolvedComments.length} unresolved comments`);
              console.log(`üìã Review comments: ${rabbitComments.length} total, ${unresolvedComments.length} unresolved`);
              console.log("‚ÑπÔ∏è This is informational only - you decide if PR is ready to merge");
              return;
            }
            
            // If state is not APPROVED but no unresolved comments
            if (latestReview.state !== "APPROVED") {
              core.warning(`‚ö†Ô∏è CodeRabbit review state: ${latestReview.state}`);
              console.log("‚ÑπÔ∏è This is informational only - merge decision is yours");
            }
