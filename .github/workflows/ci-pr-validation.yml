name: CI - PR Validation

# PR Validation Workflow
# Purpose: Informative CodeRabbit review status check
# Note: This is intentionally non-blocking (continue-on-error: true) per maintainer decision.
# The maintainer certifies CodeRabbit approval, not the CI gate.
# See: PR #1096 discussion - maintainer requested non-blocking behavior

on:
  pull_request:
    branches: [ main ]

jobs:
  coderabbit-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Coderabbit status (informative only)
        uses: actions/github-script@v8
        continue-on-error: true  # Intentionally non-blocking per maintainer decision
        with:
          script: |
            const pr = context.payload.pull_request.number;
            
            // Get all reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr
            });

            // Find CodeRabbit review
            const rabbitReviews = reviews.filter(r =>
              r.user.login.includes("coderabbit") || r.user.login.includes("coderabbitai")
            );

            if (rabbitReviews.length === 0) {
              core.warning("‚ö†Ô∏è CodeRabbit review not found yet");
              console.log("‚ÑπÔ∏è This is informational only - merge decision is yours");
              return;
            }

            // Get latest CodeRabbit review
            const latestReview = rabbitReviews[rabbitReviews.length - 1];
            
            // Check if review is APPROVED
            if (latestReview.state === "APPROVED") {
              console.log("‚úÖ CodeRabbit approved the PR");
              return;
            }
            
            // Check for review comments
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr
            });
            
            const rabbitComments = reviewComments.filter(c => 
              c.user.login.includes("coderabbit") || c.user.login.includes("coderabbitai")
            );
            
            // Count unresolved comments
            // Use GitHub API's resolved field instead of string matching
            const unresolvedComments = rabbitComments.filter(c => !c.resolved);
            
            if (unresolvedComments.length > 0) {
              core.warning(`‚ö†Ô∏è CodeRabbit has ${unresolvedComments.length} unresolved comments`);
              console.log(`üìã Review comments: ${rabbitComments.length} total, ${unresolvedComments.length} unresolved`);
              console.log("‚ÑπÔ∏è This is informational only - you decide if PR is ready to merge");
              return;
            }
            
            // If state is not APPROVED but no unresolved comments
            if (latestReview.state !== "APPROVED") {
              core.warning(`‚ö†Ô∏è CodeRabbit review state: ${latestReview.state}`);
              console.log("‚ÑπÔ∏è This is informational only - merge decision is yours");
            }

      - name: Verify Agent Receipts
        continue-on-error: true  # Informative only
        run: |
          if [ ! -d "docs/agents/receipts" ]; then
            echo "‚ö†Ô∏è Agent receipts directory not found"
            exit 0
          fi
          
          RECEIPT_COUNT=$(find docs/agents/receipts -name "*.md" -type f 2>/dev/null | wc -l | tr -d ' ')
          
          if [ "$RECEIPT_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è No agent receipt files found (expected for PRs with agent involvement)"
            exit 0
          else
            echo "‚úÖ Found $RECEIPT_COUNT agent receipt file(s)"
          fi

      - name: Verify Coverage Threshold (if available)
        continue-on-error: true  # Informative only
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            if command -v jq &> /dev/null; then
              COVERAGE=$(jq -r '.total.lines.pct' coverage/coverage-summary.json 2>/dev/null || echo "0")
              if [ "$COVERAGE" != "0" ] && [ "$COVERAGE" != "null" ]; then
                echo "üìä Current coverage: ${COVERAGE}%"
                COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
                if [ "$COVERAGE_INT" -lt 90 ]; then
                  echo "‚ö†Ô∏è Coverage ${COVERAGE}% is below 90% threshold (informative only)"
                else
                  echo "‚úÖ Coverage ${COVERAGE}% meets 90% threshold"
                fi
              else
                echo "‚ÑπÔ∏è Coverage data not available in expected format"
              fi
            else
              echo "‚ÑπÔ∏è jq not available, skipping coverage check"
            fi
          else
            echo "‚ÑπÔ∏è Coverage report not found (v2 pending or not generated)"
          fi
