name: Agent Receipt Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main
      - develop

jobs:
  validate-receipts:
    name: Verify Agent Receipts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for diff comparison

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify agent receipts
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: node scripts/ci/require-agent-receipts.js

      - name: Comment on PR (if validation failed)
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;

            const comment = `## ‚ùå Agent Receipt Validation Failed

            Some required agents are missing receipts. Please follow the protocol:

            ### üìã Required Steps:

            1. **Identify required agents** based on:
               - PR labels (e.g., \`area:frontend\`, \`test:*\`)
               - Changed files (e.g., \`*.jsx\`, \`src/services/\`)
               - See \`agents/manifest.yaml\` for trigger definitions

            2. **For each required agent:**
               - **If invoked:** Create \`docs/agents/receipts/${prNumber}-<AgentName>.md\`
                 - Use template: \`docs/agents/receipts/_TEMPLATE.md\`
               - **If skipped:** Create \`docs/agents/receipts/${prNumber}-<AgentName>-SKIPPED.md\`
                 - Use template: \`docs/agents/receipts/_TEMPLATE-SKIPPED.md\`
                 - Include justification and risk assessment

            3. **Commit and push receipts:**
               \`\`\`bash
               git add docs/agents/receipts/
               git commit -m "docs(agents): Add receipts for PR #${prNumber}"
               git push
               \`\`\`

            ### üìö Documentation:
            - **Agent rules:** \`CLAUDE.md\` ‚Üí "Lead Orchestrator Rules"
            - **Agent definitions:** \`agents/manifest.yaml\`
            - **Receipt guide:** \`docs/agents/receipts/README.md\`
            - **Quick reference:** \`docs/agents/INVENTORY.md\`

            ### üîç Debug:
            Check the CI logs above to see which agents are required and missing.
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Update check status
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const conclusion = '${{ job.status }}' === 'success' ? 'success' : 'failure';

            console.log(`‚úÖ Agent receipt validation: ${conclusion}`);
