name: GDD Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'docs/nodes/**'
      - 'system-map.yaml'
      - 'spec.md'
      - 'src/**'
      - 'scripts/**'
      - '.gddrc.json'
  workflow_dispatch:

jobs:
  validate-gdd:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check maintenance mode
        id: maintenance
        run: |
          if [ -f .gdd-maintenance ]; then
            MAINTENANCE=$(jq -r '.maintenance_mode' .gdd-maintenance)
            echo "maintenance_mode=$MAINTENANCE" >> $GITHUB_OUTPUT
            if [ "$MAINTENANCE" == "true" ]; then
              echo "🧊 GDD is in MAINTENANCE MODE (Read-Only Observer)"
              echo "   - Validation: ACTIVE ✓"
              echo "   - Auto-Repair: DISABLED"
              echo "   - Issue Creation: DISABLED"
            fi
          else
            echo "maintenance_mode=false" >> $GITHUB_OUTPUT
          fi

      - name: Load GDD configuration
        id: config
        run: |
          MIN_HEALTH=$(jq -r '.min_health_score' .gddrc.json)
          FAIL_ON_COVERAGE=$(jq -r '.validation.fail_on_coverage_integrity // true' .gddrc.json)
          echo "min_health=$MIN_HEALTH" >> $GITHUB_OUTPUT
          echo "fail_on_coverage_integrity=$FAIL_ON_COVERAGE" >> $GITHUB_OUTPUT
          echo "📋 Configuration loaded: min_health_score=$MIN_HEALTH, fail_on_coverage_integrity=$FAIL_ON_COVERAGE"

      - name: Run GDD validation
        id: validation
        run: |
          echo "🔍 Running GDD validation..."
          node scripts/validate-gdd-runtime.js --ci
          VALIDATION_STATUS=$?
          echo "status=$VALIDATION_STATUS" >> $GITHUB_OUTPUT

      - name: Run health scoring
        id: health
        run: |
          echo "📊 Running health scoring..."
          node scripts/score-gdd-health.js --ci
          HEALTH_SCORE=$(jq -r '.overall_score' gdd-health.json)
          HEALTH_STATUS=$(jq -r '.status' gdd-health.json)
          echo "score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          echo "Health Score: $HEALTH_SCORE/100 ($HEALTH_STATUS)"

      - name: Run drift prediction
        id: drift
        run: |
          echo "🔮 Running drift prediction..."
          node scripts/predict-gdd-drift.js --ci
          DRIFT_RISK=$(jq -r '.average_drift_risk' gdd-drift.json)
          HIGH_RISK=$(jq -r '.high_risk_count' gdd-drift.json)
          echo "drift_risk=$DRIFT_RISK" >> $GITHUB_OUTPUT
          echo "high_risk_count=$HIGH_RISK" >> $GITHUB_OUTPUT
          echo "Drift Risk: $DRIFT_RISK/100 (High-risk nodes: $HIGH_RISK)"

      - name: Check coverage authenticity (Phase 15.1)
        id: coverage_integrity
        run: |
          echo "🔢 Checking coverage authenticity..."
          COVERAGE_VIOLATIONS=$(jq -r '.coverage_integrity | length' gdd-status.json)
          CRITICAL_COVERAGE=$(jq -r '[.coverage_integrity[] | select(.severity == "critical")] | length' gdd-status.json)
          echo "violations=$COVERAGE_VIOLATIONS" >> $GITHUB_OUTPUT
          echo "critical_violations=$CRITICAL_COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage Integrity: $COVERAGE_VIOLATIONS violations ($CRITICAL_COVERAGE critical)"

          if [ "$CRITICAL_COVERAGE" -gt 0 ]; then
            echo "❌ Critical coverage integrity violations detected!"
            echo "::error::$CRITICAL_COVERAGE critical coverage authenticity violations found"
          fi

      - name: Check health threshold
        id: threshold
        run: |
          HEALTH_SCORE=${{ steps.health.outputs.score }}
          MIN_HEALTH=${{ steps.config.outputs.min_health }}

          echo "🎯 Checking health threshold..."
          echo "  Current: $HEALTH_SCORE"
          echo "  Required: $MIN_HEALTH"

          if (( $(echo "$HEALTH_SCORE < $MIN_HEALTH" | bc -l) )); then
            echo "result=fail" >> $GITHUB_OUTPUT
            echo "❌ Health score below threshold!"
            echo "⚠️ Job will fail after notifications are generated"
          else
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "✅ Health score meets threshold"
          fi

      - name: Generate PR comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Load results
            const health = JSON.parse(fs.readFileSync('gdd-health.json', 'utf8'));
            const drift = JSON.parse(fs.readFileSync('gdd-drift.json', 'utf8'));
            const status = JSON.parse(fs.readFileSync('gdd-status.json', 'utf8'));

            // Determine status emoji
            const healthEmoji = health.overall_score >= 95 ? '🟢' : health.overall_score >= 80 ? '🟡' : '🔴';
            const driftEmoji = drift.average_drift_risk <= 30 ? '🟢' : drift.average_drift_risk <= 60 ? '🟡' : '🔴';

            // Generate comment
            const comment = `## 🧠 GDD Validation Summary

            ### Overall Status: ${health.status === 'healthy' ? '✅ HEALTHY' : health.status === 'warning' ? '⚠️ WARNING' : '🔴 CRITICAL'}

            | Metric | Value | Status |
            |--------|-------|--------|
            | **Health Score** | ${health.overall_score.toFixed(1)}/100 | ${healthEmoji} |
            | **Drift Risk** | ${drift.average_drift_risk}/100 | ${driftEmoji} |
            | **Nodes Validated** | ${status.nodes_validated} | ✅ |
            | **Coverage Integrity** | ${status.coverage_integrity?.length || 0} violations | ${(status.coverage_integrity?.length || 0) === 0 ? '🟢' : '🔴'} |
            | **Coverage** | ${health.coverage_count || 0}% | ${health.coverage_count >= 80 ? '🟢' : '🟡'} |

            ### Health Breakdown

            - 🟢 Healthy nodes: ${health.healthy_count}
            - 🟡 Degraded nodes: ${health.degraded_count}
            - 🔴 Critical nodes: ${health.critical_count}

            ### Drift Analysis

            - 🟢 Low risk: ${drift.healthy_count}
            - 🟡 At risk: ${drift.at_risk_count}
            - 🔴 High risk: ${drift.high_risk_count}

            ${health.overall_score < ${{ steps.config.outputs.min_health }} ? '### ⚠️ Action Required\n\nHealth score is below the minimum threshold of ' + ${{ steps.config.outputs.min_health }} + '. Please review and fix the issues before merging.' : '### ✅ Safe to Merge\n\nAll GDD checks passed. Documentation is in sync with implementation.'}

            ---

            📊 **Detailed Reports:**
            - [System Validation](../blob/main/docs/system-validation.md)
            - [Health Report](../blob/main/docs/system-health.md)
            - [Drift Report](../blob/main/docs/drift-report.md)
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('GDD Validation Summary')
            );

            // Create or update comment
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload GDD artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gdd-validation-results
          path: |
            gdd-health.json
            gdd-drift.json
            gdd-status.json
            docs/system-validation.md
            docs/system-health.md
            docs/drift-report.md
          retention-days: 30

      - name: Create or update issue on failure
        if: steps.threshold.outputs.result == 'fail' && github.event_name == 'pull_request' && steps.maintenance.outputs.maintenance_mode != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const health = JSON.parse(fs.readFileSync('gdd-health.json', 'utf8'));

            // Find critical nodes
            const criticalNodes = Object.entries(health.nodes || {})
              .filter(([_, node]) => node.score < 50)
              .map(([name, node]) => `- **${name}**: ${node.score}/100`);

            const issueTitle = '[GDD] Validation Failed - PR #' + context.issue.number;
            const issueBody = `## 🔴 GDD Validation Failed

            PR #${{ github.event.pull_request.number }} failed GDD validation.

            ### Metrics
            - Health Score: ${health.overall_score}/100
            - Critical Nodes: ${health.critical_count}
            - Degraded Nodes: ${health.degraded_count}

            ### Critical Nodes
            ${criticalNodes.join('\n') || 'None'}

            ### Action Required
            1. Review the [validation report](../blob/${{ github.head_ref }}/docs/system-validation.md)
            2. Fix the issues listed above
            3. Re-run the validation

            ### Related PR
            - #${{ github.event.pull_request.number }}

            ---
            *Last updated: ${new Date().toISOString()}*
            `;

            // Check if issue already exists (use Search API for efficiency)
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:gdd in:title "${issueTitle}"`,
              per_page: 1
            });

            const existingIssue = searchResults.items[0];

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `🔄 **Revalidated on ${new Date().toISOString()}**\n\nHealth Score: ${health.overall_score}/100\n\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['documentation', 'gdd', 'tech-debt', 'priority:P1']
              });

              console.log(`Created new issue #${newIssue.number}`);
            }

      - name: Fail if health below threshold or coverage integrity violated
        if: steps.threshold.outputs.result == 'fail' || (steps.coverage_integrity.outputs.critical_violations > 0 && steps.config.outputs.fail_on_coverage_integrity == 'true')
        run: |
          if [ "${{ steps.threshold.outputs.result }}" == "fail" ]; then
            echo "❌ GDD validation failed: Health score below threshold"
          fi
          if [ "${{ steps.coverage_integrity.outputs.critical_violations }}" -gt 0 ] && [ "${{ steps.config.outputs.fail_on_coverage_integrity }}" == "true" ]; then
            echo "❌ GDD validation failed: Coverage integrity violations detected"
          fi
          exit 1
