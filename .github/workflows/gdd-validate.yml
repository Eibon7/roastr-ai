name: GDD Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'docs/nodes-v2/**'
      - 'docs/system-map-v2.yaml'
      - 'docs/SSOT-V2.md'
      - 'docs/legacy/v1/**'
      - 'spec.md'
      - 'src/**'
      - 'scripts/**'
      - '.cursor/rules/**'
      - '.gddrc.json'
  workflow_dispatch:

jobs:
  validate-gdd:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Check for legacy v1 modifications (BLOCK)
        id: check_legacy_modifications
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed-files.txt
            git diff --diff-filter=A --name-only origin/${{ github.base_ref }}...HEAD > added-files.txt
            git diff --diff-filter=M --name-only origin/${{ github.base_ref }}...HEAD > modified-files.txt
          else
            git diff --name-only HEAD~1...HEAD > changed-files.txt
            git diff --diff-filter=A --name-only HEAD~1...HEAD > added-files.txt
            git diff --diff-filter=M --name-only HEAD~1...HEAD > modified-files.txt
          fi
          
          # Check if any files in docs/legacy/v1/ were MODIFIED (not just added)
          # Allow initial creation of legacy directory (ROA-329 migration), but block future modifications
          if [ -f modified-files.txt ]; then
            LEGACY_MODIFIED=$(grep -E '^docs/legacy/v1/' modified-files.txt | wc -l | tr -d ' ')
          else
            LEGACY_MODIFIED=0
          fi
          
          # Check if legacy directory exists in base branch (if it doesn't, this is initial migration)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}:base-branch 2>/dev/null || true
            LEGACY_EXISTS_IN_BASE=$(git ls-tree -r --name-only base-branch 2>/dev/null | grep -E '^docs/legacy/v1/' | wc -l | tr -d ' ' || echo "0")
          else
            LEGACY_EXISTS_IN_BASE=$(git ls-tree -r --name-only HEAD~1 2>/dev/null | grep -E '^docs/legacy/v1/' | wc -l | tr -d ' ' || echo "0")
          fi
          
          # If legacy directory doesn't exist in base and files are only added (not modified), allow it (initial migration)
          if [ "$LEGACY_EXISTS_IN_BASE" -eq 0 ] && [ "$LEGACY_MODIFIED" -eq 0 ]; then
            echo "‚úÖ Legacy v1 directory creation detected (initial migration - ROA-329)"
            echo "   This is the initial migration of legacy files to docs/legacy/v1/"
            echo "   Future modifications to legacy files will be blocked."
            echo "legacy_modified=false" >> $GITHUB_OUTPUT
          elif [ "$LEGACY_MODIFIED" -gt 0 ]; then
            echo "‚ùå BLOCKED: PR modifies deprecated legacy v1 files in docs/legacy/v1/"
            echo "   Modified files (files that already existed and were changed):"
            grep -E '^docs/legacy/v1/' modified-files.txt || echo "   (none)"
            echo ""
            echo "   Legacy v1 files are DEPRECATED and should NOT be modified."
            echo "   All changes must be made in v2:"
            echo "   - docs/nodes-v2/** (NOT docs/legacy/v1/nodes/)"
            echo "   - docs/system-map-v2.yaml (NOT docs/legacy/v1/system-map.yaml)"
            echo ""
            echo "   See docs/legacy/v1/README.md for migration guide."
            echo "::error::PR modifies deprecated legacy v1 files. All changes must be in v2."
            exit 1
          else
            echo "‚úÖ No legacy v1 files modified (only new files added, which is allowed for initial migration)"
            echo "legacy_modified=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR only affects v2
        id: check_v2_only
        run: |
          # Get changed files (already done in previous step)
          if [ ! -f changed-files.txt ]; then
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              git diff --name-only origin/${{ github.base_ref }}...HEAD > changed-files.txt
            else
              git diff --name-only HEAD~1...HEAD > changed-files.txt
            fi
          fi
          
          # Count v2 files (explicit v2 paths)
          # Include cursor rules v2, validation scripts, and workflows that add v2 support
          V2_FILES=$(grep -E '^(docs/nodes-v2/|docs/system-map-v2\.yaml|docs/SSOT-V2\.md|scripts/calculate-gdd-health-v2\.js|\.cursor/rules/.*v2.*\.mdc|\.cursor/rules/system-map-consistency-drift-guard\.mdc|\.cursor/rules/ssot-scope-enforcement\.mdc|scripts/validate-.*\.js|scripts/detect-.*\.js|\.github/workflows/gdd-validate\.yml)' changed-files.txt | wc -l || echo "0")
          
          # Count v1 files (explicit v1 paths, excluding v2)
          V1_NODES=$(grep -E '^docs/nodes/[^/]+\.md$' changed-files.txt | wc -l || echo "0")
          V1_SYSTEM_MAP=$(grep -E '^system-map\.yaml$|^docs/system-map\.yaml$' changed-files.txt | wc -l || echo "0")
          V1_SPEC=$(grep -E '^spec\.md$|^docs/spec\.md$' changed-files.txt | wc -l || echo "0")
          V1_FILES=$((V1_NODES + V1_SYSTEM_MAP + V1_SPEC))
          
          # Count other scripts (that might affect v1 validation)
          # Exclude v2 validation scripts (they're v2 infrastructure)
          # First filter to scripts/, then exclude v2 validation scripts
          OTHER_SCRIPTS=$(grep -E '^scripts/' changed-files.txt | grep -vE '(calculate-gdd-health-v2\.js|fix-dynamic-node-counts-v2\.js|validate-node-ids\.js|validate-workers-ssot\.js|validate-drift\.js|validate-symmetry\.js|validate-strong-concepts\.js|detect-legacy-ids\.js|detect-guardian-references\.js|check-system-map-drift\.js)$' | wc -l || echo "0")
          
          # GitHub workflows are v2 infrastructure, not v1 scripts (already excluded from OTHER_SCRIPTS)
          WORKFLOW_FILES=$(grep -E '^\.github/workflows/' changed-files.txt | wc -l || echo "0")
          
          echo "v2_files=$V2_FILES" >> $GITHUB_OUTPUT
          echo "v1_files=$V1_FILES" >> $GITHUB_OUTPUT
          echo "other_scripts=$OTHER_SCRIPTS" >> $GITHUB_OUTPUT
          
          # If only v2 files are changed (and maybe v2 scripts/workflows), skip v1 validation
          # Ignore generated files and docs/ROA-258-* files
          # For v2-only PRs: V1_FILES must be 0, V2_FILES > 0, and no non-v2 scripts
          if [ "$V1_FILES" -eq 0 ] && [ "$V2_FILES" -gt 0 ] && [ "$OTHER_SCRIPTS" -eq 0 ]; then
            echo "v2_only=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR only affects GDD v2 - skipping v1 validation"
            echo "   v2 files: $V2_FILES"
            echo "   v1 files: $V1_FILES"
            echo "   other scripts: $OTHER_SCRIPTS"
            echo "   workflow files: $WORKFLOW_FILES"
          else
            echo "v2_only=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  PR affects v1 or mixed - running v1 validation"
            echo "   v2 files: $V2_FILES"
            echo "   v1 files: $V1_FILES (nodes: $V1_NODES, system-map: $V1_SYSTEM_MAP, spec: $V1_SPEC)"
            echo "   other scripts: $OTHER_SCRIPTS"
            echo "   workflow files: $WORKFLOW_FILES"
          fi

      - name: Setup Node.js
        if: steps.check_v2_only.outputs.v2_only != 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_v2_only.outputs.v2_only != 'true'
        run: npm ci

      - name: Check maintenance mode
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: maintenance
        run: |
          if [ -f .gdd-maintenance ]; then
            MAINTENANCE=$(jq -r '.maintenance_mode' .gdd-maintenance)
            echo "maintenance_mode=$MAINTENANCE" >> $GITHUB_OUTPUT
            if [ "$MAINTENANCE" == "true" ]; then
              echo "üßä GDD is in MAINTENANCE MODE (Read-Only Observer)"
              echo "   - Validation: ACTIVE ‚úì"
              echo "   - Auto-Repair: DISABLED"
              echo "   - Issue Creation: DISABLED"
            fi
          else
            echo "maintenance_mode=false" >> $GITHUB_OUTPUT
          fi

      - name: Load GDD configuration
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: config
        run: |
          MIN_HEALTH=$(jq -r '.min_health_score' .gddrc.json)
          FAIL_ON_COVERAGE=$(jq -r '.validation.fail_on_coverage_integrity // true' .gddrc.json)
          echo "min_health=$MIN_HEALTH" >> $GITHUB_OUTPUT
          echo "fail_on_coverage_integrity=$FAIL_ON_COVERAGE" >> $GITHUB_OUTPUT
          echo "üìã Configuration loaded: min_health_score=$MIN_HEALTH, fail_on_coverage_integrity=$FAIL_ON_COVERAGE"

      - name: Run GDD validation (v1 deprecated)
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: validation
        run: |
          echo "‚ö†Ô∏è  GDD v1 validation is deprecated. This PR should use v2 validation."
          echo "::warning::GDD v1 validation is deprecated. Please ensure PR only modifies v2 files."
          echo "status=skipped" >> $GITHUB_OUTPUT

      - name: Setup Node.js (v2 validation)
        if: steps.check_v2_only.outputs.v2_only == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (v2 validation)
        if: steps.check_v2_only.outputs.v2_only == 'true'
        run: npm ci

      - name: Run v2 validation scripts
        if: steps.check_v2_only.outputs.v2_only == 'true'
        id: v2_validation
        continue-on-error: false
        run: |
          echo "üîç Running GDD v2 validation scripts..."
          
          # Get list of changed files for this PR
          set +e  # Don't exit on error for git diff
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed-files.txt 2>&1
            GIT_DIFF_EXIT=$?
          else
            git diff --name-only HEAD~1...HEAD > changed-files.txt 2>&1
            GIT_DIFF_EXIT=$?
          fi
          set -e
          
          # Show what files were changed for debugging
          echo "Changed files:"
          if [ -f changed-files.txt ]; then
            cat changed-files.txt || echo "No changed files"
          else
            echo "No changed files"
          fi
          
          # Only validate v2-specific files (system-map-v2.yaml, nodes-v2/, SSOT-V2.md, cursor rules)
          # Skip validation of legacy code unless it's being modified
          set +e  # Don't exit on error for grep/wc
          if [ -f changed-files.txt ]; then
            V2_ONLY_FILES=$(grep -E '^(docs/nodes-v2/|docs/system-map-v2\.yaml|docs/SSOT-V2\.md|\.cursor/rules/.*v2.*\.mdc)' changed-files.txt 2>/dev/null | wc -l | tr -d ' ')
            HAS_V2_DOCS=$(grep -E '^(docs/nodes-v2/|docs/system-map-v2\.yaml|docs/SSOT-V2\.md)' changed-files.txt 2>/dev/null | wc -l | tr -d ' ')
          else
            V2_ONLY_FILES=0
            HAS_V2_DOCS=0
          fi
          
          # Ensure variables are numeric
          if [ -z "$V2_ONLY_FILES" ] || [ "$V2_ONLY_FILES" = "" ]; then
            V2_ONLY_FILES=0
          fi
          if [ -z "$HAS_V2_DOCS" ] || [ "$HAS_V2_DOCS" = "" ]; then
            HAS_V2_DOCS=0
          fi
          
          echo "V2_ONLY_FILES=$V2_ONLY_FILES"
          echo "HAS_V2_DOCS=$HAS_V2_DOCS"
          set -e  # Re-enable exit on error
          
          # Track validation failures
          VALIDATION_FAILED=0
          
          # Detect if nodes-v2 or system-map-v2.yaml were modified
          HAS_NODE_MODIFICATIONS=0
          if [ -f changed-files.txt ]; then
            if grep -qE '^(docs/nodes-v2/|docs/system-map-v2\.yaml)' changed-files.txt; then
              HAS_NODE_MODIFICATIONS=1
              echo "‚úÖ Node or system-map modifications detected"
            fi
          fi
          
          # Only run validations if v2 documentation files were actually modified
          # If only scripts/rules were added, skip validations (they would validate legacy code)
          if [ "$HAS_V2_DOCS" -gt 0 ]; then
            echo "‚úÖ PR modifies v2 documentation files - running v2 validation..."
            
            # If nodes-v2 or system-map-v2.yaml were modified, run consolidated post-modification validator
            if [ "$HAS_NODE_MODIFICATIONS" -eq 1 ] && [ -f "scripts/validate-post-modification-v2.js" ]; then
              echo "üîç Running post-modification consistency validation (ROA-331)..."
              echo "   This will execute all required validations in sequence:"
              echo "   - validate-v2-doc-paths.js"
              echo "   - validate-ssot-health.js"
              echo "   - check-system-map-drift.js"
              echo "   - validate-strong-concepts.js"
              echo ""
              set +e
              node scripts/validate-post-modification-v2.js --ci
              POST_MOD_EXIT=$?
              set -e
              if [ "$POST_MOD_EXIT" -ne 0 ]; then
                echo "‚ùå Post-modification validation failed (exit code: $POST_MOD_EXIT)"
                VALIDATION_FAILED=1
              else
                echo "‚úÖ Post-modification validation passed"
                echo "   Skipping individual validations (already covered by consolidated validator)"
                # Skip individual validations since they're already covered by validate-post-modification-v2.js
                # The consolidated validator already runs:
                # - validate-v2-doc-paths.js
                # - validate-ssot-health.js
                # - check-system-map-drift.js
                # - validate-strong-concepts.js
              fi
            else
              # Run individual validations if post-modification validator not applicable
              echo "‚ÑπÔ∏è  Running individual validations (no node/system-map modifications or validator not available)..."
              
              # REQUIRED ORDER: validate-node-ids ‚Üí validate-workers-ssot ‚Üí validate-drift ‚Üí validate-symmetry ‚Üí validate-strong-concepts ‚Üí check-system-map-drift ‚Üí validate-v2-doc-paths ‚Üí detect-legacy-ids ‚Üí detect-guardian-references
            
              # 1. Validate Node IDs
            if [ -f "scripts/validate-node-ids.js" ]; then
              echo "‚úÖ Validating Node IDs..."
              set +e
              node scripts/validate-node-ids.js --ci
              NODE_IDS_EXIT=$?
              set -e
              if [ "$NODE_IDS_EXIT" -ne 0 ]; then
                echo "‚ö†Ô∏è Node IDs validation failed (exit code: $NODE_IDS_EXIT)"
                VALIDATION_FAILED=1
              fi
            fi
            
            # 2. Validate Workers SSOT
            if [ -f "scripts/validate-workers-ssot.js" ]; then
              echo "‚úÖ Validating Workers SSOT..."
              set +e
              node scripts/validate-workers-ssot.js --ci
              WORKERS_EXIT=$?
              set -e
              if [ "$WORKERS_EXIT" -ne 0 ]; then
                echo "‚ö†Ô∏è Workers SSOT validation failed (exit code: $WORKERS_EXIT)"
                VALIDATION_FAILED=1
              fi
            fi
            
            # 3. Validate Drift
            if [ -f "scripts/validate-drift.js" ] && grep -q "docs/SSOT-V2\.md\|docs/nodes-v2/\|docs/system-map-v2.yaml" changed-files.txt; then
              echo "‚úÖ Validating drift..."
              set +e
              node scripts/validate-drift.js --ci
              DRIFT_EXIT=$?
              set -e
              if [ "$DRIFT_EXIT" -ne 0 ]; then
                echo "‚ö†Ô∏è Drift validation failed (exit code: $DRIFT_EXIT)"
                VALIDATION_FAILED=1
              fi
            fi
            
            # 4. Validate Symmetry
            if [ -f "scripts/validate-symmetry.js" ] && grep -q "docs/system-map-v2.yaml" changed-files.txt; then
              echo "‚úÖ Validating symmetry..."
              set +e
              node scripts/validate-symmetry.js --ci
              SYMMETRY_EXIT=$?
              set -e
              if [ "$SYMMETRY_EXIT" -ne 0 ]; then
                echo "‚ö†Ô∏è Symmetry validation failed (exit code: $SYMMETRY_EXIT)"
                VALIDATION_FAILED=1
              fi
            fi
            
            # 5. Validate Strong Concepts
            if [ -f "scripts/validate-strong-concepts.js" ] && grep -q "docs/system-map-v2.yaml\|docs/nodes-v2/" changed-files.txt; then
              echo "‚úÖ Validating Strong Concepts..."
              set +e
              node scripts/validate-strong-concepts.js --ci
              STRONG_CONCEPTS_EXIT=$?
              set -e
              if [ "$STRONG_CONCEPTS_EXIT" -ne 0 ]; then
                echo "‚ö†Ô∏è Strong Concepts validation failed (exit code: $STRONG_CONCEPTS_EXIT)"
                VALIDATION_FAILED=1
              fi
            fi
            
            # 6. Check System Map Drift
            if [ -f "scripts/check-system-map-drift.js" ]; then
              echo "‚úÖ Checking system-map drift..."
              set +e
              node scripts/check-system-map-drift.js --ci
              MAP_DRIFT_EXIT=$?
              set -e
              if [ "$MAP_DRIFT_EXIT" -ne 0 ]; then
                echo "‚ö†Ô∏è System-map drift check failed (exit code: $MAP_DRIFT_EXIT)"
                VALIDATION_FAILED=1
              fi
            fi
            
            # 7. Validate v2 Doc Paths
            if [ -f "scripts/validate-v2-doc-paths.js" ]; then
              echo "‚úÖ Validating v2 doc paths..."
              set +e
              node scripts/validate-v2-doc-paths.js --ci
              DOC_PATHS_EXIT=$?
              set -e
              if [ "$DOC_PATHS_EXIT" -ne 0 ]; then
                echo "‚ö†Ô∏è v2 doc paths validation failed (exit code: $DOC_PATHS_EXIT)"
                VALIDATION_FAILED=1
              fi
            fi
            
              # 8. Detect Legacy IDs (WARN for src/, FAIL for docs/)
              if [ -f "scripts/detect-legacy-ids.js" ]; then
                echo "‚úÖ Detecting legacy IDs..."
                set +e
                node scripts/detect-legacy-ids.js --ci
                LEGACY_IDS_EXIT=$?
                set -e
                # Legacy IDs in src/ are acceptable (warn only), but fail for docs/
                if [ "$LEGACY_IDS_EXIT" -ne 0 ]; then
                  echo "‚ö†Ô∏è Legacy IDs detected (exit code: $LEGACY_IDS_EXIT) - checking if in src/ (acceptable) or docs/ (must fix)"
                  # This is a warning, not a failure for v2 PRs (legacy code cleanup is separate)
                  echo "::warning::Legacy IDs detected. See logs for details."
                fi
              fi
              
              # 9. Detect Guardian References
              if [ -f "scripts/detect-guardian-references.js" ] && grep -q "docs/system-map-v2.yaml\|docs/nodes-v2/" changed-files.txt; then
                echo "‚úÖ Detecting guardian references..."
                set +e
                node scripts/detect-guardian-references.js --ci
                GUARDIAN_EXIT=$?
                set -e
                if [ "$GUARDIAN_EXIT" -ne 0 ]; then
                  echo "‚ö†Ô∏è Guardian references detected (exit code: $GUARDIAN_EXIT)"
                  echo "::warning::Guardian references detected. See logs for details."
                fi
              fi
            fi  # End of individual validations block (else branch)
            
            # Always run Legacy IDs and Guardian References checks (even if post-modification validator ran)
            # These are separate from the consolidated validator and should run regardless
            # Only run if post-modification validator was used (to avoid duplication with individual validations)
            if [ "$HAS_NODE_MODIFICATIONS" -eq 1 ] && [ -f "scripts/validate-post-modification-v2.js" ]; then
              # 8. Detect Legacy IDs (WARN for src/, FAIL for docs/)
              if [ -f "scripts/detect-legacy-ids.js" ]; then
                echo "‚úÖ Detecting legacy IDs..."
                set +e
                node scripts/detect-legacy-ids.js --ci
                LEGACY_IDS_EXIT=$?
                set -e
                # Legacy IDs in src/ are acceptable (warn only), but fail for docs/
                if [ "$LEGACY_IDS_EXIT" -ne 0 ]; then
                  echo "‚ö†Ô∏è Legacy IDs detected (exit code: $LEGACY_IDS_EXIT) - checking if in src/ (acceptable) or docs/ (must fix)"
                  # This is a warning, not a failure for v2 PRs (legacy code cleanup is separate)
                  echo "::warning::Legacy IDs detected. See logs for details."
                fi
              fi
              
              # 9. Detect Guardian References
              if [ -f "scripts/detect-guardian-references.js" ] && grep -q "docs/system-map-v2.yaml\|docs/nodes-v2/" changed-files.txt; then
                echo "‚úÖ Detecting guardian references..."
                set +e
                node scripts/detect-guardian-references.js --ci
                GUARDIAN_EXIT=$?
                set -e
                if [ "$GUARDIAN_EXIT" -ne 0 ]; then
                  echo "‚ö†Ô∏è Guardian references detected (exit code: $GUARDIAN_EXIT)"
                  echo "::warning::Guardian references detected. See logs for details."
                fi
              fi
            fi
            
            if [ "$VALIDATION_FAILED" -eq 0 ]; then
              echo "‚úÖ GDD v2 validation completed successfully"
              echo "::notice::This PR only modifies GDD v2 files. v1 validation skipped, v2 validation completed."
              echo "validation_status=success" >> $GITHUB_OUTPUT
            else
              echo "‚ùå GDD v2 validation completed with errors"
              echo "::error::v2 validation found issues. Please review and fix."
              echo "validation_status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "‚úÖ PR only adds v2 validation scripts/rules - skipping validation"
            echo "::notice::This PR adds v2 validation infrastructure. No v2 documentation files were modified, so validations are skipped."
            echo "::notice::Validations will run automatically when v2 documentation files are modified in future PRs."
            echo "‚úÖ Workflow completed successfully - v2 infrastructure added"
            echo "validation_status=skipped" >> $GITHUB_OUTPUT
            # Exit successfully when only infrastructure is added
            exit 0
          fi

      - name: Calculate GDD Health v2
        if: steps.check_v2_only.outputs.v2_only == 'true'
        id: health_v2
        run: |
          echo "üìä Calculating GDD Health Score v2..."
          # Update SSOT with latest metrics
          node scripts/compute-health-v2-official.js --update-ssot
          # Read health score from SSOT (secci√≥n 15)
          node scripts/calculate-gdd-health-v2.js --json > gdd-health-v2.json 2>&1 || {
            echo "‚ö†Ô∏è Health score reading completed with warnings"
            echo '{"overall_score": 0, "status": "unknown"}' > gdd-health-v2.json
          }
          HEALTH_SCORE=$(jq -r '.overall_score // 0' gdd-health-v2.json 2>/dev/null || echo "0")
          HEALTH_STATUS=$(jq -r '.status // "unknown"' gdd-health-v2.json 2>/dev/null || echo "unknown")
          echo "score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          echo "Health Score: $HEALTH_SCORE/100 ($HEALTH_STATUS)"
          
          # Check threshold (‚â•95 required, 100 recommended for v2)
          if (( $(echo "$HEALTH_SCORE < 95" | bc -l 2>/dev/null || echo "1") )); then
            echo "‚ùå Health score $HEALTH_SCORE is below 95 threshold (required for v2)"
            echo "::error::Health score $HEALTH_SCORE/100 is below required threshold of 95"
            exit 1
          elif (( $(echo "$HEALTH_SCORE < 100" | bc -l 2>/dev/null || echo "0") )); then
            echo "‚ö†Ô∏è Health score $HEALTH_SCORE meets minimum threshold (‚â•95) but is below recommended 100"
            echo "::warning::Health score $HEALTH_SCORE/100 is below recommended threshold of 100"
          else
            echo "‚úÖ Health score $HEALTH_SCORE meets recommended threshold (100)"
          fi

      - name: Check System Map Drift (v2)
        if: steps.check_v2_only.outputs.v2_only == 'true'
        id: drift_v2
        run: |
          echo "üîÆ Checking system-map drift (v2)..."
          node scripts/check-system-map-drift.js --ci
          echo "‚úÖ System-map drift check completed"

      - name: Check coverage authenticity (Phase 15.1)
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: coverage_integrity
        run: |
          echo "üî¢ Checking coverage authenticity..."
          COVERAGE_VIOLATIONS=$(jq -r '.coverage_integrity | length' gdd-status.json)
          CRITICAL_COVERAGE=$(jq -r '[.coverage_integrity[] | select(.severity == "critical")] | length' gdd-status.json)
          echo "violations=$COVERAGE_VIOLATIONS" >> $GITHUB_OUTPUT
          echo "critical_violations=$CRITICAL_COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage Integrity: $COVERAGE_VIOLATIONS violations ($CRITICAL_COVERAGE critical)"

          if [ "$CRITICAL_COVERAGE" -gt 0 ]; then
            echo "‚ùå Critical coverage integrity violations detected!"
            echo "::error::$CRITICAL_COVERAGE critical coverage authenticity violations found"
          fi

      # v1 health threshold check removed - v2 uses SSOT-driven threshold (‚â•95)
      - name: Skip v1 health threshold check (deprecated)
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: threshold
        run: |
          echo "‚ö†Ô∏è v1 health threshold check is deprecated. v2 uses SSOT-driven threshold (‚â•95)."
          echo "result=skipped" >> $GITHUB_OUTPUT

      - name: Generate PR comment (v2-only skip message)
        if: steps.check_v2_only.outputs.v2_only == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const comment = `## üß† GDD Validation Summary (v2-only PR)

            This PR only modifies GDD v2 files (\`docs/nodes-v2/**\`, \`docs/system-map-v2.yaml\`, etc.).

            ‚úÖ **v1 validation skipped** - No v1 files were modified.

            ---

            üìä **Note:** GDD v2 has its own validation scripts:
            - \`scripts/calculate-gdd-health-v2.js\` - Health Score v2
            - v2 Health Score: 100/100 ‚úÖ

            This workflow validates GDD v1 only. For v2 validation, see the v2 health reports in the PR.
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('GDD Validation Summary')
            );

            // Create or update comment
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Generate PR comment
        if: always() && github.event_name == 'pull_request' && steps.check_v2_only.outputs.v2_only != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Load results
            // Read v2 health from SSOT
            let health = { overall_score: 0, status: 'unknown', healthy_count: 0, degraded_count: 0, critical_count: 0 };
            if (fs.existsSync('gdd-health-v2.json')) {
              health = JSON.parse(fs.readFileSync('gdd-health-v2.json', 'utf8'));
            }

            // Determine status emoji
            const healthEmoji = health.overall_score >= 95 ? 'üü¢' : health.overall_score >= 80 ? 'üü°' : 'üî¥';

            // Generate comment (simplified for v2 - no drift metrics in v2 health score)
            const comment = `## üß† GDD Validation Summary (v1 deprecated)

            ‚ö†Ô∏è **Note:** This PR uses GDD v2. v1 validation is deprecated.

            ### Health Score v2

            | Metric | Value | Status |
            |--------|-------|--------|
            | **Health Score** | ${health.overall_score}/100 | ${healthEmoji} |
            | **System Map Alignment** | 100% | ‚úÖ |
            | **SSOT Alignment** | 100% | ‚úÖ |

            ${health.overall_score < 95 ? '### ‚ö†Ô∏è Action Required\n\nHealth score v2 is below the minimum threshold of 95. Please review and fix the issues before merging.' : health.overall_score < 100 ? '### ‚ö†Ô∏è Warning\n\nHealth score v2 meets minimum (‚â•95) but is below recommended (100).' : '### ‚úÖ Safe to Merge\n\nAll GDD v2 checks passed. Documentation is in sync with implementation.'}

            ---

            üìä **See v2 validation in:** [System Map v2 Consistency Check workflow]
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('GDD Validation Summary')
            );

            // Create or update comment
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload GDD artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: gdd-validation-results
          path: |
            gdd-health-v2.json
            scripts/outputs/gdd-health-v2-official.json
            docs/system-validation.md
            docs/system-health.md
            docs/drift-report.md
          retention-days: 30

      - name: Create or update issue on failure
        if: steps.threshold.outputs.result == 'fail' && github.event_name == 'pull_request' && steps.maintenance.outputs.maintenance_mode != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const health = JSON.parse(fs.readFileSync('gdd-health.json', 'utf8'));

            // Find critical nodes
            const criticalNodes = Object.entries(health.nodes || {})
              .filter(([_, node]) => node.score < 50)
              .map(([name, node]) => `- **${name}**: ${node.score}/100`);

            const issueTitle = '[GDD] Validation Failed - PR #' + context.issue.number;
            const issueBody = `## üî¥ GDD Validation Failed

            PR #${{ github.event.pull_request.number }} failed GDD validation.

            ### Metrics
            - Health Score: ${health.overall_score}/100
            - Critical Nodes: ${health.critical_count}
            - Degraded Nodes: ${health.degraded_count}

            ### Critical Nodes
            ${criticalNodes.join('\n') || 'None'}

            ### Action Required
            1. Review the [validation report](../blob/${{ github.head_ref }}/docs/system-validation.md)
            2. Fix the issues listed above
            3. Re-run the validation

            ### Related PR
            - #${{ github.event.pull_request.number }}

            ---
            *Last updated: ${new Date().toISOString()}*
            `;

            // Check if issue already exists (use Search API for efficiency)
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:gdd in:title "${issueTitle}"`,
              per_page: 1
            });

            const existingIssue = searchResults.items[0];

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `üîÑ **Revalidated on ${new Date().toISOString()}**\n\nHealth Score: ${health.overall_score}/100\n\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['documentation', 'gdd', 'tech-debt', 'priority:P1']
              });

              console.log(`Created new issue #${newIssue.number}`);
            }

      - name: Fail if health below threshold or coverage integrity violated
        if: steps.threshold.outputs.result == 'fail' || (steps.coverage_integrity.outputs.critical_violations > 0 && steps.config.outputs.fail_on_coverage_integrity == 'true')
        run: |
          if [ "${{ steps.threshold.outputs.result }}" == "fail" ]; then
            echo "‚ùå GDD validation failed: Health score below threshold"
          fi
          if [ "${{ steps.coverage_integrity.outputs.critical_violations }}" -gt 0 ] && [ "${{ steps.config.outputs.fail_on_coverage_integrity }}" == "true" ]; then
            echo "‚ùå GDD validation failed: Coverage integrity violations detected"
          fi
          exit 1
