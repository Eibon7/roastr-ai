name: GDD Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'docs/nodes/**'
      - 'docs/nodes-v2/**'
      - 'docs/system-map-v2.yaml'
      - 'docs/SSOT-V2.md'
      - 'system-map.yaml'
      - 'spec.md'
      - 'src/**'
      - 'scripts/**'
      - '.cursor/rules/**'
      - '.gddrc.json'
  workflow_dispatch:

jobs:
  validate-gdd:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if PR only affects v2
        id: check_v2_only
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed-files.txt
          else
            git diff --name-only HEAD~1...HEAD > changed-files.txt
          fi
          
          # Count v2 files (explicit v2 paths)
          # Include cursor rules v2, validation scripts, and workflows that add v2 support
          V2_FILES=$(grep -E '^(docs/nodes-v2/|docs/system-map-v2\.yaml|docs/SSOT-V2\.md|scripts/calculate-gdd-health-v2\.js|\.cursor/rules/.*v2.*\.mdc|\.cursor/rules/system-map-consistency-drift-guard\.mdc|\.cursor/rules/ssot-scope-enforcement\.mdc|scripts/validate-.*\.js|scripts/detect-.*\.js|\.github/workflows/gdd-validate\.yml)' changed-files.txt | wc -l || echo "0")
          
          # Count v1 files (explicit v1 paths, excluding v2)
          V1_NODES=$(grep -E '^docs/nodes/[^/]+\.md$' changed-files.txt | wc -l || echo "0")
          V1_SYSTEM_MAP=$(grep -E '^system-map\.yaml$|^docs/system-map\.yaml$' changed-files.txt | wc -l || echo "0")
          V1_SPEC=$(grep -E '^spec\.md$|^docs/spec\.md$' changed-files.txt | wc -l || echo "0")
          V1_FILES=$((V1_NODES + V1_SYSTEM_MAP + V1_SPEC))
          
          # Count other scripts (that might affect v1 validation)
          OTHER_SCRIPTS=$(grep -E '^scripts/' changed-files.txt | grep -vE '(calculate-gdd-health-v2\.js|fix-dynamic-node-counts\.js|validate-node-ids\.js|validate-workers-ssot\.js|validate-drift\.js|validate-symmetry\.js|validate-strong-concepts\.js|detect-legacy-ids\.js|detect-guardian-references\.js)' changed-files.txt | wc -l || echo "0")
          
          echo "v2_files=$V2_FILES" >> $GITHUB_OUTPUT
          echo "v1_files=$V1_FILES" >> $GITHUB_OUTPUT
          echo "other_scripts=$OTHER_SCRIPTS" >> $GITHUB_OUTPUT
          
          # If only v2 files are changed (and maybe v2 scripts), skip v1 validation
          # Ignore generated files and docs/ROA-258-* files
          if [ "$V1_FILES" -eq 0 ] && [ "$OTHER_SCRIPTS" -eq 0 ] && [ "$V2_FILES" -gt 0 ]; then
            echo "v2_only=true" >> $GITHUB_OUTPUT
            echo "âœ… PR only affects GDD v2 - skipping v1 validation"
            echo "   v2 files: $V2_FILES"
            echo "   v1 files: $V1_FILES"
            echo "   other scripts: $OTHER_SCRIPTS"
          else
            echo "v2_only=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  PR affects v1 or mixed - running v1 validation"
            echo "   v2 files: $V2_FILES"
            echo "   v1 files: $V1_FILES (nodes: $V1_NODES, system-map: $V1_SYSTEM_MAP, spec: $V1_SPEC)"
            echo "   other scripts: $OTHER_SCRIPTS"
          fi

      - name: Setup Node.js
        if: steps.check_v2_only.outputs.v2_only != 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_v2_only.outputs.v2_only != 'true'
        run: npm ci

      - name: Check maintenance mode
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: maintenance
        run: |
          if [ -f .gdd-maintenance ]; then
            MAINTENANCE=$(jq -r '.maintenance_mode' .gdd-maintenance)
            echo "maintenance_mode=$MAINTENANCE" >> $GITHUB_OUTPUT
            if [ "$MAINTENANCE" == "true" ]; then
              echo "ğŸ§Š GDD is in MAINTENANCE MODE (Read-Only Observer)"
              echo "   - Validation: ACTIVE âœ“"
              echo "   - Auto-Repair: DISABLED"
              echo "   - Issue Creation: DISABLED"
            fi
          else
            echo "maintenance_mode=false" >> $GITHUB_OUTPUT
          fi

      - name: Load GDD configuration
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: config
        run: |
          MIN_HEALTH=$(jq -r '.min_health_score' .gddrc.json)
          FAIL_ON_COVERAGE=$(jq -r '.validation.fail_on_coverage_integrity // true' .gddrc.json)
          echo "min_health=$MIN_HEALTH" >> $GITHUB_OUTPUT
          echo "fail_on_coverage_integrity=$FAIL_ON_COVERAGE" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Configuration loaded: min_health_score=$MIN_HEALTH, fail_on_coverage_integrity=$FAIL_ON_COVERAGE"

      - name: Run GDD validation
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: validation
        run: |
          echo "ğŸ” Running GDD validation..."
          node scripts/validate-gdd-runtime.js --ci
          VALIDATION_STATUS=$?
          echo "status=$VALIDATION_STATUS" >> $GITHUB_OUTPUT

      - name: Setup Node.js (v2 validation)
        if: steps.check_v2_only.outputs.v2_only == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (v2 validation)
        if: steps.check_v2_only.outputs.v2_only == 'true'
        run: npm ci

      - name: Run v2 validation scripts
        if: steps.check_v2_only.outputs.v2_only == 'true'
        run: |
          echo "ğŸ” Running GDD v2 validation scripts..."
          
          # Get list of changed files for this PR
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed-files.txt
          else
            git diff --name-only HEAD~1...HEAD > changed-files.txt
          fi
          
          # Only validate v2-specific files (system-map-v2.yaml, nodes-v2/, SSOT-V2.md, cursor rules)
          # Skip validation of legacy code unless it's being modified
          V2_ONLY_FILES=$(grep -E '^(docs/nodes-v2/|docs/system-map-v2\.yaml|docs/SSOT-V2\.md|\.cursor/rules/.*v2.*\.mdc)' changed-files.txt | wc -l || echo "0")
          
          if [ "$V2_ONLY_FILES" -gt 0 ]; then
            echo "âœ… PR modifies v2 documentation files - running v2 validation..."
            
            # Check if scripts exist before running
            if [ -f "scripts/validate-symmetry.js" ] && grep -q "docs/system-map-v2.yaml" changed-files.txt; then
              echo "âœ… Validating symmetry..."
              node scripts/validate-symmetry.js --ci || echo "âš ï¸ Symmetry validation failed (non-blocking)"
            fi
            
            if [ -f "scripts/validate-strong-concepts.js" ] && grep -q "docs/system-map-v2.yaml\|docs/nodes-v2/" changed-files.txt; then
              echo "âœ… Validating Strong Concepts..."
              node scripts/validate-strong-concepts.js --ci || echo "âš ï¸ Strong Concepts validation failed (non-blocking)"
            fi
            
            if [ -f "scripts/validate-drift.js" ] && grep -q "docs/SSOT-V2\.md\|docs/nodes-v2/\|docs/system-map-v2.yaml" changed-files.txt; then
              echo "âœ… Detecting drift..."
              node scripts/validate-drift.js --ci || echo "âš ï¸ Drift detection failed (non-blocking)"
            fi
            
            if [ -f "scripts/detect-guardian-references.js" ] && grep -q "docs/system-map-v2.yaml\|docs/nodes-v2/" changed-files.txt; then
              echo "âœ… Detecting guardian references..."
              node scripts/detect-guardian-references.js --ci || echo "âš ï¸ Guardian references detection failed (non-blocking)"
            fi
            
            echo "âœ… GDD v2 validation completed"
            echo "::notice::This PR only modifies GDD v2 files. v1 validation skipped, v2 validation completed."
          else
            echo "âœ… PR only adds v2 validation scripts/rules - skipping validation of legacy code"
            echo "::notice::This PR adds v2 validation infrastructure. Legacy code validation skipped."
            echo "âœ… Workflow completed successfully - v2 infrastructure added"
          fi
          
          # Always exit with success for v2-only PRs that add infrastructure
          exit 0

      - name: Run health scoring
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: health
        run: |
          echo "ğŸ“Š Running health scoring..."
          node scripts/score-gdd-health.js --ci
          HEALTH_SCORE=$(jq -r '.overall_score' gdd-health.json)
          HEALTH_STATUS=$(jq -r '.status' gdd-health.json)
          echo "score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
          echo "health_status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          echo "Health Score: $HEALTH_SCORE/100 ($HEALTH_STATUS)"

      - name: Run drift prediction
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: drift
        run: |
          echo "ğŸ”® Running drift prediction..."
          node scripts/predict-gdd-drift.js --ci
          DRIFT_RISK=$(jq -r '.average_drift_risk' gdd-drift.json)
          HIGH_RISK=$(jq -r '.high_risk_count' gdd-drift.json)
          echo "drift_risk=$DRIFT_RISK" >> $GITHUB_OUTPUT
          echo "high_risk_count=$HIGH_RISK" >> $GITHUB_OUTPUT
          echo "Drift Risk: $DRIFT_RISK/100 (High-risk nodes: $HIGH_RISK)"

      - name: Check coverage authenticity (Phase 15.1)
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: coverage_integrity
        run: |
          echo "ğŸ”¢ Checking coverage authenticity..."
          COVERAGE_VIOLATIONS=$(jq -r '.coverage_integrity | length' gdd-status.json)
          CRITICAL_COVERAGE=$(jq -r '[.coverage_integrity[] | select(.severity == "critical")] | length' gdd-status.json)
          echo "violations=$COVERAGE_VIOLATIONS" >> $GITHUB_OUTPUT
          echo "critical_violations=$CRITICAL_COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage Integrity: $COVERAGE_VIOLATIONS violations ($CRITICAL_COVERAGE critical)"

          if [ "$CRITICAL_COVERAGE" -gt 0 ]; then
            echo "âŒ Critical coverage integrity violations detected!"
            echo "::error::$CRITICAL_COVERAGE critical coverage authenticity violations found"
          fi

      - name: Check health threshold
        if: steps.check_v2_only.outputs.v2_only != 'true'
        id: threshold
        run: |
          HEALTH_SCORE=${{ steps.health.outputs.score }}
          MIN_HEALTH=${{ steps.config.outputs.min_health }}

          echo "ğŸ¯ Checking health threshold..."
          echo "  Current: $HEALTH_SCORE"
          echo "  Required: $MIN_HEALTH"

          if (( $(echo "$HEALTH_SCORE < $MIN_HEALTH" | bc -l) )); then
            echo "result=fail" >> $GITHUB_OUTPUT
            echo "âŒ Health score below threshold!"
            echo "âš ï¸ Job will fail after notifications are generated"
          else
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "âœ… Health score meets threshold"
          fi

      - name: Generate PR comment (v2-only skip message)
        if: steps.check_v2_only.outputs.v2_only == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const comment = `## ğŸ§  GDD Validation Summary (v2-only PR)

            This PR only modifies GDD v2 files (\`docs/nodes-v2/**\`, \`docs/system-map-v2.yaml\`, etc.).

            âœ… **v1 validation skipped** - No v1 files were modified.

            ---

            ğŸ“Š **Note:** GDD v2 has its own validation scripts:
            - \`scripts/calculate-gdd-health-v2.js\` - Health Score v2
            - v2 Health Score: 100/100 âœ…

            This workflow validates GDD v1 only. For v2 validation, see the v2 health reports in the PR.
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('GDD Validation Summary')
            );

            // Create or update comment
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Generate PR comment
        if: always() && github.event_name == 'pull_request' && steps.check_v2_only.outputs.v2_only != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Load results
            const health = JSON.parse(fs.readFileSync('gdd-health.json', 'utf8'));
            const drift = JSON.parse(fs.readFileSync('gdd-drift.json', 'utf8'));
            const status = JSON.parse(fs.readFileSync('gdd-status.json', 'utf8'));

            // Determine status emoji
            const healthEmoji = health.overall_score >= 95 ? 'ğŸŸ¢' : health.overall_score >= 80 ? 'ğŸŸ¡' : 'ğŸ”´';
            const driftEmoji = drift.average_drift_risk <= 30 ? 'ğŸŸ¢' : drift.average_drift_risk <= 60 ? 'ğŸŸ¡' : 'ğŸ”´';

            // Generate comment
            const comment = `## ğŸ§  GDD Validation Summary

            ### Overall Status: ${health.status === 'healthy' ? 'âœ… HEALTHY' : health.status === 'warning' ? 'âš ï¸ WARNING' : 'ğŸ”´ CRITICAL'}

            | Metric | Value | Status |
            |--------|-------|--------|
            | **Health Score** | ${health.overall_score.toFixed(1)}/100 | ${healthEmoji} |
            | **Drift Risk** | ${drift.average_drift_risk}/100 | ${driftEmoji} |
            | **Nodes Validated** | ${status.nodes_validated} | âœ… |
            | **Coverage Integrity** | ${status.coverage_integrity?.length || 0} violations | ${(status.coverage_integrity?.length || 0) === 0 ? 'ğŸŸ¢' : 'ğŸ”´'} |
            | **Coverage** | ${health.coverage_count || 0}% | ${health.coverage_count >= 80 ? 'ğŸŸ¢' : 'ğŸŸ¡'} |

            ### Health Breakdown

            - ğŸŸ¢ Healthy nodes: ${health.healthy_count}
            - ğŸŸ¡ Degraded nodes: ${health.degraded_count}
            - ğŸ”´ Critical nodes: ${health.critical_count}

            ### Drift Analysis

            - ğŸŸ¢ Low risk: ${drift.healthy_count}
            - ğŸŸ¡ At risk: ${drift.at_risk_count}
            - ğŸ”´ High risk: ${drift.high_risk_count}

            ${health.overall_score < ${{ steps.config.outputs.min_health }} ? '### âš ï¸ Action Required\n\nHealth score is below the minimum threshold of ' + ${{ steps.config.outputs.min_health }} + '. Please review and fix the issues before merging.' : '### âœ… Safe to Merge\n\nAll GDD checks passed. Documentation is in sync with implementation.'}

            ---

            ğŸ“Š **Detailed Reports:**
            - [System Validation](../blob/main/docs/system-validation.md)
            - [Health Report](../blob/main/docs/system-health.md)
            - [Drift Report](../blob/main/docs/drift-report.md)
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('GDD Validation Summary')
            );

            // Create or update comment
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Upload GDD artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: gdd-validation-results
          path: |
            gdd-health.json
            gdd-drift.json
            gdd-status.json
            docs/system-validation.md
            docs/system-health.md
            docs/drift-report.md
          retention-days: 30

      - name: Create or update issue on failure
        if: steps.threshold.outputs.result == 'fail' && github.event_name == 'pull_request' && steps.maintenance.outputs.maintenance_mode != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const health = JSON.parse(fs.readFileSync('gdd-health.json', 'utf8'));

            // Find critical nodes
            const criticalNodes = Object.entries(health.nodes || {})
              .filter(([_, node]) => node.score < 50)
              .map(([name, node]) => `- **${name}**: ${node.score}/100`);

            const issueTitle = '[GDD] Validation Failed - PR #' + context.issue.number;
            const issueBody = `## ğŸ”´ GDD Validation Failed

            PR #${{ github.event.pull_request.number }} failed GDD validation.

            ### Metrics
            - Health Score: ${health.overall_score}/100
            - Critical Nodes: ${health.critical_count}
            - Degraded Nodes: ${health.degraded_count}

            ### Critical Nodes
            ${criticalNodes.join('\n') || 'None'}

            ### Action Required
            1. Review the [validation report](../blob/${{ github.head_ref }}/docs/system-validation.md)
            2. Fix the issues listed above
            3. Re-run the validation

            ### Related PR
            - #${{ github.event.pull_request.number }}

            ---
            *Last updated: ${new Date().toISOString()}*
            `;

            // Check if issue already exists (use Search API for efficiency)
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:gdd in:title "${issueTitle}"`,
              per_page: 1
            });

            const existingIssue = searchResults.items[0];

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ğŸ”„ **Revalidated on ${new Date().toISOString()}**\n\nHealth Score: ${health.overall_score}/100\n\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['documentation', 'gdd', 'tech-debt', 'priority:P1']
              });

              console.log(`Created new issue #${newIssue.number}`);
            }

      - name: Fail if health below threshold or coverage integrity violated
        if: steps.threshold.outputs.result == 'fail' || (steps.coverage_integrity.outputs.critical_violations > 0 && steps.config.outputs.fail_on_coverage_integrity == 'true')
        run: |
          if [ "${{ steps.threshold.outputs.result }}" == "fail" ]; then
            echo "âŒ GDD validation failed: Health score below threshold"
          fi
          if [ "${{ steps.coverage_integrity.outputs.critical_violations }}" -gt 0 ] && [ "${{ steps.config.outputs.fail_on_coverage_integrity }}" == "true" ]; then
            echo "âŒ GDD validation failed: Coverage integrity violations detected"
          fi
          exit 1
