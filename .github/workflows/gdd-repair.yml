name: GDD Auto-Repair

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'docs/nodes/**'
      - 'system-map.yaml'
      - 'spec.md'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show fixes without applying)'
        required: false
        default: 'false'
        type: boolean

# Prevent race conditions when multiple runs try to push to same branch
concurrency:
  group: gdd-repair-${{ github.head_ref || github.ref }}
  cancel-in-progress: false

jobs:
  auto-repair:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Load GDD configuration
        id: config
        run: |
          AUTO_FIX=$(jq -r '.auto_repair.enabled' .gddrc.json)
          COMMIT_FIXES=$(jq -r '.auto_repair.commit_fixes' .gddrc.json)
          echo "auto_fix=$AUTO_FIX" >> $GITHUB_OUTPUT
          echo "commit_fixes=$COMMIT_FIXES" >> $GITHUB_OUTPUT
          echo "üìã Configuration: auto_fix=$AUTO_FIX, commit_fixes=$COMMIT_FIXES"

      - name: Run auto-repair (dry-run)
        id: dry_run
        run: |
          echo "üîç Running auto-repair in dry-run mode..."
          node scripts/auto-repair-gdd.js --dry-run

          # Count potential fixes (check if file exists first)
          if [ -f gdd-repair.json ]; then
            FIXES=$(jq -r '.fixes_would_apply // 0' gdd-repair.json)
          else
            FIXES=0
          fi
          echo "fixes_count=$FIXES" >> $GITHUB_OUTPUT
          echo "Found $FIXES potential fixes"

      - name: Run auto-repair (apply fixes)
        id: repair
        continue-on-error: true
        if: steps.config.outputs.auto_fix == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "üîß Running auto-repair with fixes..."
          node scripts/auto-repair-gdd.js --auto-fix --ci
          EXIT_CODE=$?

          # Count applied fixes (check if file exists first)
          if [ -f gdd-repair.json ]; then
            FIXES=$(jq -r '.fixes_applied // 0' gdd-repair.json)
            ERRORS=$(jq -r '.errors // 0' gdd-repair.json)
          else
            FIXES=0
            ERRORS=0
          fi

          # Check exit code for rollback (exit code 2 = rollback)
          if [ $EXIT_CODE -eq 2 ]; then
            echo "rollback=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Rollback detected (exit code 2) - fixes would decrease health score"
          else
            echo "rollback=false" >> $GITHUB_OUTPUT
          fi

          echo "fixes_applied=$FIXES" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "Applied $FIXES fixes, encountered $ERRORS errors, exit code: $EXIT_CODE"

          # Pass through the exit code
          exit $EXIT_CODE

      - name: Re-validate after repair
        id: revalidate
        if: steps.repair.outputs.fixes_applied > 0
        run: |
          echo "üîç Re-validating after repair..."
          node scripts/validate-gdd-runtime.js --ci
          node scripts/score-gdd-health.js --ci

          # Guard: Check if gdd-health.json exists
          if [ -f gdd-health.json ]; then
            NEW_HEALTH=$(jq -r '.overall_score // 0' gdd-health.json)
          else
            NEW_HEALTH=0
          fi
          echo "new_health=$NEW_HEALTH" >> $GITHUB_OUTPUT
          echo "New health score: $NEW_HEALTH"

      - name: Commit fixes
        id: commit
        if: steps.repair.outputs.fixes_applied > 0 && steps.config.outputs.commit_fixes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add .

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Commit changes
          git commit -m "fix(docs): Auto-repair GDD documentation issues

          Applied ${{ steps.repair.outputs.fixes_applied }} automated fixes:
          - Missing agent sections
          - Broken bidirectional links
          - Outdated timestamps
          - Missing node references

          Health score: ${{ steps.revalidate.outputs.new_health }}/100

          ü§ñ Generated by GDD Auto-Repair"

          # Check commit success
          if [ $? -ne 0 ]; then
            echo "‚ùå Commit failed"
            exit 1
          fi

          # Push changes
          TARGET_BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          if [ -z "$TARGET_BRANCH" ]; then
            echo "‚ùå Cannot determine target branch for push"
            exit 1
          fi
          git push origin HEAD:"$TARGET_BRANCH"
          echo "committed=true" >> $GITHUB_OUTPUT

      - name: Generate repair summary
        id: summary
        run: |
          cat > repair-summary.md << 'EOF'
          ## üîß GDD Auto-Repair Summary

          ### Fixes Applied
          - **Total fixes**: ${{ steps.repair.outputs.fixes_applied || steps.dry_run.outputs.fixes_count }}
          - **Errors**: ${{ steps.repair.outputs.errors || 0 }}
          - **Committed**: ${{ steps.commit.outputs.committed || 'false' }}

          ### Health Impact
          ${{ steps.revalidate.outputs.new_health && format('- **New health score**: {0}/100', steps.revalidate.outputs.new_health) }}

          ### Actions Taken
          EOF

          # Add details from repair report (check if file exists first)
          if [ -f gdd-repair.json ]; then
            jq -r '.details.fixes[]? | "- \(.type): \(.node) - \(.action)"' gdd-repair.json >> repair-summary.md 2>/dev/null || echo "- No repair details available" >> repair-summary.md
          else
            echo "- No repairs needed" >> repair-summary.md
          fi

          cat repair-summary.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Check if repair file exists
            let repair = { fixes_applied: 0, fixes_would_apply: 0, errors: 0, details: {} };
            if (fs.existsSync('gdd-repair.json')) {
              repair = JSON.parse(fs.readFileSync('gdd-repair.json', 'utf8'));
            }

            const summary = fs.readFileSync('repair-summary.md', 'utf8');

            const fixesApplied = repair.fixes_applied || 0;
            const fixesWouldApply = repair.fixes_would_apply || 0;
            const errors = repair.errors || 0;

            let comment = `## üîß GDD Auto-Repair Report

            `;

            if (fixesApplied > 0) {
              comment += `‚úÖ **${fixesApplied} fixes applied automatically**

            `;
            } else if (fixesWouldApply > 0) {
              comment += `‚ÑπÔ∏è **${fixesWouldApply} fixes available** (dry-run mode)

            `;
            } else {
              comment += `‚úÖ **No fixes needed**

            `;
            }

            if (errors > 0) {
              comment += `‚ö†Ô∏è **${errors} errors encountered** - manual review required

            `;
            }

            // Add fix details
            if (repair.details && repair.details.fixes) {
              comment += `### Fixes Applied\n\n`;
              repair.details.fixes.slice(0, 10).forEach(fix => {
                comment += `- **${fix.type}** (${fix.node}): ${fix.action}\n`;
              });

              if (repair.details.fixes.length > 10) {
                comment += `\n_... and ${repair.details.fixes.length - 10} more_\n`;
              }
            }

            comment += `\n---\n\n`;
            comment += `üìä View detailed report in workflow artifacts`;

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Create or update issue for manual review
        if: (failure() || steps.repair.outputs.errors > 0 || (steps.repair.outputs.exit_code != '0' && steps.repair.outputs.exit_code != '2')) && steps.repair.outputs.rollback != 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Check if repair file exists
            let repair = { details: { errors: [] } };
            if (fs.existsSync('gdd-repair.json')) {
              repair = JSON.parse(fs.readFileSync('gdd-repair.json', 'utf8'));
            }

            const errors = repair.details?.errors || [];
            const errorList = errors.map(e => `- **${e.type}** (${e.node}): ${e.error}`).join('\n');

            const issueTitle = '[GDD] Auto-Repair Failed - PR #' + context.issue.number;
            const issueBody = `## üî¥ GDD Auto-Repair Failed

            Automated repair encountered errors that require manual intervention.

            ### Errors
            ${errorList || 'See workflow logs for details'}

            ### PR Context
            - PR: #${{ github.event.pull_request.number }}
            - Branch: ${{ github.head_ref }}

            ### Next Steps
            1. Review the errors above
            2. Apply manual fixes
            3. Re-run the validation workflow

            ### Related Links
            - [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [PR #${{ github.event.pull_request.number }}](../pull/${{ github.event.pull_request.number }})

            ---
            *Last updated: ${new Date().toISOString()}*
            `;

            // Check if issue already exists (use Search API for efficiency)
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue is:open label:gdd label:manual-review in:title "${issueTitle}"`,
              per_page: 1
            });

            const existingIssue = searchResults.items[0];

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `üîÑ **Revalidated on ${new Date().toISOString()}**\n\nErrors: ${errors.length}\n\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['documentation', 'gdd', 'manual-review', 'priority:P2']
              });

              console.log(`Created new issue #${newIssue.number}`);
            }

      - name: Upload repair artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: gdd-repair-results
          path: |
            gdd-repair.json
            repair-summary.md
            gdd-health.json
            gdd-status.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Fail if errors occurred
        if: (steps.repair.outputs.errors > 0 || (steps.repair.outputs.exit_code != '0' && steps.repair.outputs.exit_code != '2')) && steps.repair.outputs.rollback != 'true'
        run: |
          echo "‚ùå Auto-repair completed with errors"
          exit 1

      - name: Report rollback (non-critical)
        if: steps.repair.outputs.rollback == 'true'
        run: |
          echo "‚ÑπÔ∏è Auto-repair rolled back changes due to health score degradation"
          echo "This is normal behavior - fixes would have decreased system health"
          echo "No manual action required"
