name: Runner JSON Demo

on:
  push:
    branches:
      - feat/issues-276-281-277-287
      - feat/issue-281-mocks-runner-docs
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

env:
  TEST_PLATFORM: 'bluesky' # Platform to validate exists in platforms.json

jobs:
  runner-json:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: List platforms (JSON)
        run: |
          node scripts/test/runner.js list-platforms --json | tee platforms.json
          echo '### Platforms (from runner --json)' >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat platforms.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # Use jq in exit-on-false mode to test platform existence with proper error handling
          if ! jq -e --arg platform "$TEST_PLATFORM" '.platforms | contains([$platform])' platforms.json > /dev/null; then
            echo "Platform '$TEST_PLATFORM' not found in platforms.json"
            exit 1
          fi

      - name: Lint + Typecheck (JSON)
        run: |
          set -euo pipefail
          # Write stdout directly to check.json and stderr to check.stderr
          # Use timeout to prevent hanging (10 minutes max)
          timeout 600 node scripts/test/runner.js check --json > check.json 2> check.stderr || true

          # Verify check.json was created and is valid JSON
          if [ ! -s check.json ]; then
            echo "❌ Error: check.json is empty or missing"
            if [ -s check.stderr ]; then
              echo "Stderr output:"
              cat check.stderr
            fi
            exit 1
          fi

          # Verify it's valid JSON
          if ! jq empty check.json 2>/dev/null; then
            echo "❌ Error: check.json is not valid JSON"
            echo "Content:"
            cat check.json
            exit 1
          fi

          echo '### Check summary (from runner --json)' >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat check.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Append stderr if non-empty for quick visibility
          if [ -s check.stderr ]; then
            echo '### Error output' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat check.stderr >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # Parse exit code from our new check command format with numeric coercion
          if ! CHECK_EXIT=$(jq -r '(.exitCode // 0) | tonumber' check.json 2>/dev/null); then
            echo "⚠️  Warning: Failed to parse check.json for exit code, defaulting to 0"
            CHECK_EXIT=0
          fi

          # Parse command that was run
          if ! CHECK_COMMAND=$(jq -r '.command // "unknown"' check.json 2>/dev/null); then
            echo "⚠️  Warning: Failed to parse check.json for command"
            CHECK_COMMAND="unknown"
          fi

          echo "Check command: $CHECK_COMMAND"
          echo "Check exit code: $CHECK_EXIT"

          # For this demo workflow, we only verify that the JSON output is valid
          # We don't fail if tests fail (that's handled by other workflows)
          # We only fail if the command itself couldn't run or produce valid JSON
          if [ "$CHECK_EXIT" -ne 0 ]; then
            echo "ℹ️  Note: Tests returned exit code $CHECK_EXIT (this is expected if some tests fail)"
            echo "✅ JSON output is valid - workflow check passed"
          else
            echo "✅ Check passed successfully (exit code 0)"
          fi
