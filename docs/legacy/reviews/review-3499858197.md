# CodeRabbit Review #3499858197 - Plan

**PR:** #983  
**Issue:** #948  
**Date:** 2025-11-24  
**Reviewer:** CodeRabbit AI

---

## Análisis

**Summary:**

- Critical: 1 - OAuth error callback handling blocked by Zod validation
- Major: 0
- Minor: 1 - console.log usage in DEBUG_OAUTH paths

**Issues Detail:**

1. **CRITICAL** - `src/routes/oauth.js:269-307`
   - **Tipo:** Architecture/UX regression
   - **Impacto:** OAuth provider error callbacks (e.g., `?error=access_denied`) will return 400 JSON instead of redirecting to `/connections`
   - **Root Cause:** `validateQuery(OAuthCodeSchema)` runs before handler, requires `code` and `state` even when `error` is present

2. **MINOR** - `src/routes/oauth.js:42-44, 237-243, etc.`
   - **Tipo:** Code quality/logging consistency
   - **Impacto:** Inconsistent logging (console.log/console.error vs logger)
   - **Root Cause:** DEBUG_OAUTH paths still use console.\* instead of logger utility

---

## GDD

**Nodos relevantes:**

- `social-platforms.md` - OAuth flows para 9 plataformas
- NO actualizar (cambios no afectan arquitectura documentada)

**Actualizar:**

- N/A - fixes son implementación, no cambios arquitecturales

**Agentes Relevantes:**

- NO agregar (fixes menores, no invocación de agentes)

---

## Agentes

**Invocar:**

- **TestEngineer** - Para tests de OAuth error callbacks (CRÍTICO)
  - Test case: `?error=access_denied` debe redirect, no 400
  - Test case: `?error=user_cancelled&error_description=...` debe redirect
  - Receipt: `docs/agents/receipts/cursor-test-engineer-review-3499858197.md`

**SKIP:**

- Guardian - No security issues, solo UX regression
- FrontendDev - Backend changes only
- TaskAssessor - Solo 2 issues, ambos claros

---

## Archivos

**Mencionados en review:**

- `src/routes/oauth.js` (líneas 269-307, múltiples console.\*)
- `src/validators/zod/social.schema.js` (revisar si necesita extend)

**Dependientes (buscar):**

```bash
# OAuth error flows en tests
grep -rn "error_description" tests/
grep -rn "access_denied" tests/

# Otros usos de validateQuery
grep -rn "validateQuery" src/routes/

# DEBUG_OAUTH usage
grep -rn "DEBUG_OAUTH" src/
```

**Tests:**

- Integration: `tests/integration/routes/oauth-zod-validation.test.js` (actualizar)
- Añadir: OAuth error callback scenarios

---

## Estrategia

### 1. CRITICAL - OAuth Error Callbacks (Priority 1)

**Solución elegida:** Extend schema to allow error-only shape (union)

**Rationale:**

- Más limpio que bifurcar lógica antes de middleware
- Mantiene validación centralizada en Zod
- Compatible con tests existentes

**Implementación:**

1. Crear `OAuthErrorCallbackSchema` en `social.schema.js`:

   ```typescript
   const OAuthErrorCallbackSchema = z.object({
     error: z.string().min(1),
     error_description: z.string().optional(),
     state: z.string().optional()
   });

   const OAuthCallbackSchema = z.union([
     OAuthCodeSchema, // Success: code + state + redirect_uri?
     OAuthErrorCallbackSchema // Error: error + error_description? + state?
   ]);
   ```

2. Actualizar `oauth.js`:

   ```javascript
   router.get(
     '/:platform/callback',
     validateQuery(OAuthCallbackSchema), // ← Union schema
     async (req, res) => {
       const { error, code, state } = req.query;

       if (error) {
         // Existing redirect logic works
       }

       // Existing success logic works
     }
   );
   ```

3. Tests:
   - Añadir `tests/integration/routes/oauth-error-callbacks.test.js`
   - Casos: access_denied, user_cancelled, server_error
   - Verificar: status 302 (redirect), no 400

### 2. MINOR - Logger Consistency (Priority 2)

**Solución:** Replace all `console.*` in DEBUG_OAUTH with `logger.*`

**Implementación:**

1. Buscar todos: `grep -n "console\.\(log\|error\|warn\)" src/routes/oauth.js`
2. Reemplazar:
   - `console.log` → `logger.debug` (DEBUG_OAUTH es debug level)
   - `console.error` → `logger.error`
3. Verificar: 0 console.\* en oauth.js (excepto comentarios)

**Commits:**

```
1. fix(oauth): Support OAuth provider error callbacks in Zod validation
2. refactor(oauth): Replace console.* with logger in DEBUG_OAUTH paths
3. test(oauth): Add integration tests for OAuth error callbacks
```

---

## Éxito

**Criteria:**

- [x] **Conflicts:** PR-DESCRIPTION.md resuelto
- [ ] **CRITICAL resolved:** OAuth error callbacks redirect (no 400)
- [ ] **MINOR resolved:** 0 console.\* en oauth.js
- [ ] **Tests:** 3 nuevos tests (error callbacks) passing
- [ ] **Coverage:** ≥90% mantenido
- [ ] **GDD health:** ≥87
- [ ] **CodeRabbit:** 0 comentarios pendientes

**Exit Criteria (FASE 3):**

```bash
npm test                                          # 0 failures
npm run test:coverage                             # ≥90%
node scripts/validate-gdd-runtime.js --full       # HEALTHY
node scripts/score-gdd-health.js --ci             # ≥87
npm run coderabbit:review                         # 0 comments
```

---

## Referencias

- **CodeRabbit Review:** #3499858197
- **PR:** #983
- **Issue:** #948
- **Related Pattern:** coderabbit-lessons.md #1 (console.log usage)
- **OAuth Providers:** Twitter, YouTube, Discord, etc. (9 platforms)

---

**Plan Status:** ✅ READY FOR IMPLEMENTATION  
**Next Step:** FASE 2 - Aplicación
