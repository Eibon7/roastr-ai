# Implementation Plan: CodeRabbit Review #3295440971

## Review Information
- **Review ID**: 3295440971
- **PR**: #447 - docs: Reconcile roast limits in spec.md - Issue #446
- **Date**: 2025-10-02
- **Status**: Planning

## Problem Statement

CodeRabbit has identified a critical inconsistency between `spec.md` documentation and actual code implementation in `entitlementsService.js`:

### Current State

**spec.md (after user-requested changes):**
- Free: 100 análisis, 10 roasts/month
- Starter: 1,000 análisis, 10 roasts/month
- Pro: 10,000 análisis, 1,000 roasts/month
- Plus: 100,000 análisis, 5,000 roasts/month

**entitlementsService.js (actual implementation):**
- Free: 100 análisis, 100 roasts/month
- Starter: 500 análisis, 500 roasts/month
- Pro: 2,000 análisis, 1,000 roasts/month
- Plus: -1 (unlimited for both)

### Root Cause Analysis

The user provided specific limit values that differ from the code implementation. This creates two possible interpretations:

1. **User values represent PRICING/MARKETING limits** (what customers see/purchase)
2. **Code values represent IMPLEMENTATION limits** (actual technical enforcement)

CodeRabbit is flagging this as a spec/code mismatch that needs resolution.

## Decision: Align Code with Spec

Based on the user's explicit instruction "te adjunto los niveles correctos para que hagas los cambios", we will update the code to match the spec values provided by the user.

## CodeRabbit Feedback Summary

### Primary Issue
**File**: `spec.md`
**Lines**: 131-134, 2626-2630
**Severity**: Critical
**Issue**: Roast limit values don't match `entitlementsService.js`

### Recommended Actions by CodeRabbit

**Option A (SELECTED)**: Update all service/config files to match spec
- Update `entitlementsService.js`
- Update `tierConfig.js`
- Update `creditsService.js`
- Update `planService.js`
- Update `costControl.js`
- Update `routes/plan.js`
- Update test files

**Option B**: Revert spec.md changes (REJECTED - user explicitly provided correct values)

## Implementation Strategy

### Phase 1: Code Updates
Update all service files to use the spec values:

#### 1.1 entitlementsService.js
**File**: `src/services/entitlementsService.js`
**Lines**: 405-454 (_getPlanDefaults method)
**Changes**:
```javascript
// Free Plan
analysis_limit_monthly: 100,  // unchanged
roast_limit_monthly: 10,       // 100 → 10

// Starter Plan
analysis_limit_monthly: 1000,  // 500 → 1000
roast_limit_monthly: 10,       // 500 → 10

// Pro Plan
analysis_limit_monthly: 10000, // 2000 → 10000
roast_limit_monthly: 1000,     // unchanged

// Plus Plan
analysis_limit_monthly: 100000, // -1 → 100000
roast_limit_monthly: 5000,      // -1 → 5000
```

#### 1.2 Search for other limit configurations
Check for hardcoded limits in:
- `tierConfig.js` (if exists)
- `creditsService.js` (if exists)
- `planService.js` (if exists)
- `costControl.js`
- `routes/plan.js` (if exists)

### Phase 2: Test Updates
Update test files to expect new limit values:
- Search for tests that validate plan limits
- Update assertions to match new values

### Phase 3: Documentation Verification
- Verify `spec.md` is consistent across all sections
- Update changelog with complete changes

## Files Affected

### Service Files (Code Changes)
1. `src/services/entitlementsService.js` - PRIMARY
2. `src/services/costControl.js` (if it has hardcoded limits)
3. Other service files (TBD based on search)

### Test Files (Expected Updates)
- Any tests that validate plan limits
- Integration tests for entitlements
- API endpoint tests for plan features

### Documentation Files
1. `spec.md` - Already updated, verify consistency
2. `docs/CHANGELOG_ISSUE_443.md` or PR changelog - Update with full context

## Subagents Required

1. **General-purpose agent**: Search for all references to plan limits across codebase
2. **Test Engineer**: Update test assertions after code changes

## Success Criteria

- [ ] All service files use consistent limit values from spec.md
- [ ] No hardcoded limit values that contradict the spec
- [ ] All tests pass with updated limit values
- [ ] spec.md remains consistent across all sections
- [ ] Changelog documents complete scope of changes
- [ ] CodeRabbit review is satisfied (no spec/code mismatch)

## Risk Assessment

**Low Risk**: Changes are configuration values only, not logic changes
**Testing Required**: Comprehensive test runs to ensure no regressions
**Rollback Plan**: Revert commit if tests fail or business logic breaks

## Timeline

1. Code search and updates: 10 minutes
2. Test updates: 5 minutes
3. Verification and commit: 5 minutes

**Total Estimated Time**: 20 minutes

## Notes

- User explicitly stated "los niveles correctos" when providing spec values
- This indicates the spec values are the source of truth, not the code
- Implementation limits were likely placeholders or outdated
- This PR resolves Issue #446 by ensuring complete consistency

---

**Plan Status**: ✅ Complete - Ready for Implementation
**Next Step**: Execute Phase 1 (Code Updates)
