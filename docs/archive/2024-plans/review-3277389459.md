# Plan: Resolución de Conflictos - Issue #406 Ingestor (PR #430)

## Análisis de Conflictos

He analizado los 12 archivos con conflictos y he identificado patrones claros en las diferencias:

### Archivos con Conflictos:

1. `spec.md` - Documentación general
2. `src/config/mockMode.js` - Implementación de modo mock
3. `src/services/autoApprovalService.js` - Servicio de auto-aprobación
4. `src/workers/GenerateReplyWorker.js` - Worker de generación de respuestas
5. `tests/fixtures/ingestor-comments.json` - Fixtures de test
6. `tests/helpers/ingestor-test-utils.js` - Utilidades de test
7. `tests/integration/ingestor-acknowledgment.test.js` - Tests de acknowledgment
8. `tests/integration/ingestor-deduplication.test.js` - Tests de deduplicación
9. `tests/integration/ingestor-error-handling.test.js` - Tests de manejo de errores
10. `tests/integration/ingestor-mock-test.test.js` - Tests de mock
11. `tests/integration/ingestor-order-processing.test.js` - Tests de orden
12. `tests/integration/ingestor-retry-backoff.test.js` - Tests de retry/backoff

## Estrategia de Resolución

### 1. Principios de Resolución

- **HEAD** (feat/issue-406): Contiene la implementación básica de Issue #406
- **origin/main**: Contiene mejoras mejoradas de CodeRabbit y refinamientos
- **Criterio**: Mantener la funcionalidad de Issue #406 pero adoptar las mejoras de calidad de origin/main

### 2. Archivos por Prioridad

#### Prioridad ALTA (Arquitectura Core)

1. **`src/config/mockMode.js`**
   - Problema: Diferencias en implementación de storage global
   - Solución: Adoptar version origin/main (más robusta con query capture)
   - Razón: Better stateful testing support

2. **`src/services/autoApprovalService.js`**
   - Problema: HEAD básico vs origin/main con circuit breakers
   - Solución: Adoptar origin/main completo
   - Razón: Security patterns, GDPR compliance, configurable timeout handling
   - Timeouts: Configurable via `RATE_LIMIT_QUERY_TIMEOUT` (default: 5000ms)
   - Security: Implements timing-safe digest comparison to prevent timing attacks

3. **`src/workers/GenerateReplyWorker.js`**
   - Problema: Línea 185 - diferencia en conditional check
   - Solución: Adoptar origin/main (`integrationConfig.config.auto_post`)
   - Razón: Más seguro, evita optional chaining innecesario

#### Prioridad MEDIA (Test Infrastructure)

4. **`tests/helpers/ingestor-test-utils.js`**
   - Problema: HEAD básico vs origin/main con métodos adicionales
   - Solución: Merger ambos - mantener estructura HEAD + agregar métodos origin/main
   - Razón: Compatibilidad con tests existentes de Issue #406

5. **`tests/fixtures/ingestor-comments.json`**
   - Problema: Estructuras de comentarios diferentes
   - Solución: Adoptar origin/main como base + agregar fixtures específicos de HEAD
   - Razón: Mejor cobertura de casos de test

#### Prioridad BAJA (Test Cases)

6. **Tests de integración (6 archivos)**
   - Problema: Enfoques diferentes para acknowledgment, deduplication, etc.
   - Solución: Adoptar structure origin/main pero mantener test cases específicos de HEAD
   - Razón: origin/main tiene mejor arquitectura de tests

7. **`spec.md`**
   - Problema: Documentación desactualizada
   - Solución: Merger cambios manteniendo Issue #406 como feature completada
   - Razón: Documentación debe reflejar estado actual

## Plan de Ejecución

### Fase 1: Core Architecture (src/)

1. Resolver `src/config/mockMode.js` - adoptar origin/main
   - Implementar timeoutPromise helper para operaciones con timeout configurable
   - Añadir timing-safe comparison utilities para seguridad
2. Resolver `src/services/autoApprovalService.js` - adoptar origin/main
   - Configurar timeouts via environment variables (RATE_LIMIT_QUERY_TIMEOUT)
   - Implementar timing-safe digest comparison
3. Resolver `src/workers/GenerateReplyWorker.js` - fix minor conditional

### Fase 2: Test Infrastructure

4. Resolver `tests/helpers/ingestor-test-utils.js` - merge approach
5. Resolver `tests/fixtures/ingestor-comments.json` - merge fixtures

### Fase 3: Test Cases

6. Resolver 6 archivos de integration tests - adopt origin/main structure
7. Resolver `spec.md` - merge documentation

### Fase 4: Validation

8. Verificar que no hay más conflictos con `git status`
9. Ejecutar tests para validar que todo funciona
10. Commit final con mensaje descriptivo

## Criterios de Éxito

- [ ] Todos los conflictos resueltos
- [ ] Tests de Issue #406 siguen funcionando
- [ ] Mejoras de CodeRabbit integradas
- [ ] No hay regresiones en funcionalidad existente
- [ ] Documentación actualizada

## Riesgos y Mitigación

- **Riesgo**: Romper tests existentes al cambiar fixtures
- **Mitigación**: Validar cada paso con `npm test`

- **Riesgo**: Perder funcionalidad específica de Issue #406
- **Mitigación**: Revisar cada test case antes de adoptar origin/main

- **Riesgo**: Incompatibilidad entre mock mode y tests
- **Mitigación**: Priorizar mockMode.js para que sea base sólida

## Siguiente Paso

Comenzar con Fase 1: `src/config/mockMode.js` - el componente más crítico para el funcionamiento del sistema de tests.
