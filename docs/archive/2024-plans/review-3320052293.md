# Implementation Plan - CodeRabbit Review #3320052293

**PR:** #515 - Guardian Agent (Phase 16)
**Review URL:** https://github.com/Eibon7/roastr-ai/pull/515#pullrequestreview-3320052293
**Created:** 2025-10-09
**Status:** 🚧 IN PROGRESS

---

## 1. Análisis de Comentarios por Severidad

### 🔴 CRITICAL (3 issues)

#### C1: Missing Coverage Data (gdd-status.json)
**File:** `gdd-status.json` (lines 2-4)
**Issue:** Coverage fields are `null`, coverage_integrity shows 13 missing_coverage_data warnings
**Root Cause:** Tests not run with `--coverage` flag
**Impact:** Cannot validate coverage authenticity (Phase 15.1), health scoring incomplete
**CodeRabbit Comment:**
```
"Tests failed (jest not installed) and validation script errored (missing yaml),
so coverage wasn't generated. Add jest as a devDependency and ensure yaml is
available (or fix imports), then rerun..."
```

**Resolution:**
1. Verify `jest` and `yaml` packages are installed
2. Run `npm test -- --coverage` to generate coverage report
3. Run `node scripts/validate-gdd-runtime.js --full` to update gdd-status.json
4. Verify `coverage_integrity` populated with actual values

---

#### C2: Starter Plan Roast Quota Mismatch (spec.md)
**File:** `spec.md` (lines 707-710)
**Issue:** Starter plan shows `10 roasts/month` but code has `100 roasts/month`
**Root Cause:** Spec not updated after plan limits refactor
**Impact:** **CRITICAL** - Documentation lies about product pricing/quotas
**CodeRabbit Comment:**
```
"spec.md (lines 707–710) lists Starter as 10 roasts/month, but planDefaults.js
and tierValidationService.simple tests use 100 roasts/month. Update spec to
100 roasts/month."
```

**Evidence from Code:**
- `src/config/planDefaults.js`: Starter = 100 roasts/month
- `tests/integration/tierValidationService.simple.test.js`: Starter = 100 roasts/month
- `spec.md`: Starter = **10 roasts/month** (WRONG)

**Resolution:**
1. Update spec.md line 708: `10 roasts/month` → `100 roasts/month`
2. Verify all other plan limits match code (Free, Pro, Plus)
3. Cross-check with `src/services/entitlementsService.js`
4. Update Guardian protected domain `quotas` with correct limits

---

#### C3: Guardian Artifacts and CI Behavior (spec.md, Guardian section)
**File:** `spec.md` (lines 7812-7888)
**Issues:**
1. `docs/guardian/cases` directory missing (referenced but not created)
2. CI workflows don't document exit code behavior (0=safe, 1=review, 2=block)
3. Missing domain→glob patterns mapping table
4. Case ID collision risk (milliseconds precision, parallel runs)

**CodeRabbit Comment:**
```
"docs/guardian/cases directory is missing; add the case-files folder or update
the spec references. Confirm in your CI workflows that exit code 2 blocks merges
on protected branches and exit code 1 triggers mandatory review. Optional: include
a table mapping protected domains → glob patterns; consider ULID/UUIDv7 for case
IDs to prevent millisecond collisions."
```

**Resolution:**
1. Create `docs/guardian/cases/` directory with `.gitkeep` or sample case
2. Create `docs/guardian/cases/README.md` explaining case file format
3. Add domain→glob mapping table to spec.md Guardian section
4. Document CI behavior in spec.md (exit codes)
5. **Decision on Case ID**: Keep milliseconds (sufficient for current scale) or upgrade to ULID
6. Add note in guardian.md about parallel run limitations if keeping milliseconds

---

### 🟡 NITPICKS (8 issues)

#### N1: Plan Features Node - Align Wording/Formatting (spec.md)
**File:** `spec.md` (lines 7671-7674)
**Issue:** Order and phrasing inconsistent with earlier section (lines 707-710)
**Resolution:** Reorder bullets (análisis first, roasts second), consistent thousands separator

---

#### N2: Code Fence Languages (docs/sync-reports/pr-515-sync.md)
**File:** `docs/sync-reports/pr-515-sync.md` (lines 166-176, 169-175)
**Issue:** MD040 - Fenced code blocks missing language tags
**Resolution:** Add `bash`, `yaml`, `json`, or `text` to all code fences

---

#### N3: Bold as Headings (docs/sync-reports/pr-515-sync.md)
**File:** `docs/sync-reports/pr-515-sync.md` (lines 203-214, 209-214)
**Issue:** MD036 - Emphasis used instead of headings
**Resolution:** Convert `**Section:**` to `### Section`

---

#### N4: Markdown Hygiene (docs/test-evidence/review-3319707172/SECURITY-REPORT.md)
**File:** `docs/test-evidence/review-3319707172/SECURITY-REPORT.md` (lines 371-376, 393-399, 415-468)
**Issues:** MD040 (fence languages), MD036 (bold as headings)
**Resolution:** Add languages to fences, convert bold to headings

---

#### N5: Bold as Heading (docs/test-evidence/review-3319707172/EXECUTIVE-SUMMARY.md)
**File:** `docs/test-evidence/review-3319707172/EXECUTIVE-SUMMARY.md` (line 288-293)
**Issue:** MD036 - "Issue: Complete Remaining MD040 Fixes" should be heading
**Resolution:** Change to `### Issue: Complete Remaining MD040 Fixes`

---

#### N6: Agentes Relevantes - Sync and Alphabetize (docs/nodes/guardian.md)
**File:** `docs/nodes/guardian.md` (lines 628-636)
**Issue:** Agentes Relevantes section incomplete and not alphabetized
**Current:** Only "Test Engineer" listed
**Missing:** Documentation Agent, Orchestrator Agent, Product Owner
**Resolution:** Add all relevant agents, alphabetize list

---

#### N7: ASCII Output Fence Language (docs/nodes/guardian.md)
**File:** `docs/nodes/guardian.md` (line 212-229)
**Issue:** MD040 - ASCII art table missing `text` language tag
**Resolution:** Change ` ``` ` to ` ```text `

---

#### N8: Bold Labels as Headings (docs/nodes/guardian.md)
**File:** `docs/nodes/guardian.md` (lines 68-88, 100-107, 212-229, 434-466)
**Issue:** MD036 - Bold labels ("Constructor", "Public Methods", "Output") should be headings
**Resolution:** Convert to `#### Constructor`, `#### Public Methods`, etc.

---

## 2. Diseño GDD

### Nodos Afectados

1. **guardian** (`docs/nodes/guardian.md`)
   - Updates: Agentes Relevantes, markdown fixes
   - Impact: Documentation quality, no architecture changes

2. **cost-control** (`docs/nodes/cost-control.md`)
   - Related: Starter plan quota fix affects entitlements service
   - Impact: No changes needed (spec.md fix only)

3. **plan-features** (`docs/nodes/plan-features.md`)
   - Related: Plan limits consistency
   - Impact: No changes needed (spec.md fix only)

### Dependency Validation

**Guardian Node:**
- Dependencies: None (leaf node)
- Used By: None (Phase 17 will add CI/CD)
- **No edge changes** → No bidirectional validation needed

**Quota Changes:**
- Affects: `cost-control`, `plan-features`, `billing`
- **Spec-only change** → No code/node updates needed
- Validation: Cross-check with `src/services/entitlementsService.js`

### Architecture Changes

**None.** All changes are documentation fixes with one spec data correction (Starter quota).

---

## 3. Subagentes a Usar

### Documentation Agent
**Tasks:**
- Fix markdownlint violations (MD040, MD036)
- Update spec.md with accurate plan limits
- Add domain→glob mapping table
- Create docs/guardian/cases/README.md

### Test Engineer Agent
**Tasks:**
- Run `npm test -- --coverage` to generate coverage report
- Validate no regressions after spec updates
- Create test evidence for review-3320052293

### Product Owner (Consultation)
**Tasks:**
- Confirm Starter plan quota: 100 roasts/month (from code) is correct
- Approve spec.md changes (pricing documentation)

### Orchestrator Agent (Self)
**Tasks:**
- Coordinate fixes by priority
- Validate GDD coherence
- Generate final report
- Commit and push

---

## 4. Archivos Afectados

### Modified Files (9)

| File | Lines | Changes | Type | Impact |
|------|-------|---------|------|--------|
| `spec.md` | 1 | Starter quota: 10→100 | **CRITICAL** | Pricing docs |
| `spec.md` | +20 | Add domain→glob table | Major | Documentation |
| `spec.md` | +5 | Document CI exit codes | Major | CI/CD behavior |
| `spec.md` | 4 | Align plan limits order | Minor | Consistency |
| `docs/nodes/guardian.md` | 4 | Add agents, alphabetize | Minor | Completeness |
| `docs/nodes/guardian.md` | 10 | Fix MD040, MD036 | Minor | Lint compliance |
| `docs/sync-reports/pr-515-sync.md` | 6 | Fix MD040, MD036 | Minor | Lint compliance |
| `docs/test-evidence/review-3319707172/SECURITY-REPORT.md` | 12 | Fix MD040, MD036 | Minor | Lint compliance |
| `docs/test-evidence/review-3319707172/EXECUTIVE-SUMMARY.md` | 1 | Fix MD036 | Minor | Lint compliance |

### Created Files (2)

| File | Purpose | Type |
|------|---------|------|
| `docs/guardian/cases/.gitkeep` | Ensure directory exists | Infrastructure |
| `docs/guardian/cases/README.md` | Document case file format | Documentation |

### Coverage Files (Auto-generated)

| File | Purpose | Generated By |
|------|---------|--------------|
| `coverage/coverage-summary.json` | Test coverage data | `npm test -- --coverage` |
| `gdd-status.json` | Updated validation status | `validate-gdd-runtime.js` |

---

## 5. Estrategia de Aplicación

### Orden de Ejecución (Por Dependencias)

#### Phase 1: CRITICAL Fixes (Blocking)

**Step 1.1: Fix Starter Plan Quota (C2)**
- File: `spec.md` (line 708)
- Change: `10 roasts/month` → `100 roasts/month`
- Validation: Cross-check with `src/config/planDefaults.js`
- No tests needed (documentation fix)

**Step 1.2: Create Guardian Cases Directory (C3.1)**
- Create: `docs/guardian/cases/.gitkeep`
- Create: `docs/guardian/cases/README.md` (case file format)
- Example: Add sample case JSON if time permits

**Step 1.3: Add Domain→Glob Mapping (C3.3)**
- File: `spec.md` (Guardian section)
- Add table after "Protected Domains" list
- Source: `config/product-guard.yaml`

**Step 1.4: Document CI Exit Code Behavior (C3.2)**
- File: `spec.md` (Guardian section)
- Add subsection "### CI/CD Integration"
- Document: Exit 0 (safe), Exit 1 (review required), Exit 2 (blocked)

**Step 1.5: Generate Coverage Data (C1)**
- Run: `npm test -- --coverage`
- Run: `node scripts/validate-gdd-runtime.js --full`
- Verify: `gdd-status.json` coverage_integrity populated
- Commit: Updated `gdd-status.json`

---

#### Phase 2: NITPICK Fixes (Quality)

**Step 2.1: Fix Guardian Node (N6, N7, N8)**
- File: `docs/nodes/guardian.md`
- N6: Add agents to "Agentes Relevantes", alphabetize
- N7: Add `text` to ASCII fence (line 212)
- N8: Convert bold labels to headings (#### Constructor, etc.)

**Step 2.2: Fix Sync Report (N2, N3)**
- File: `docs/sync-reports/pr-515-sync.md`
- N2: Add languages to code fences (bash, yaml, json, text)
- N3: Convert `**Section:**` to `### Section`

**Step 2.3: Fix Test Evidence Files (N4, N5)**
- Files: `docs/test-evidence/review-3319707172/*.md`
- N4: Add fence languages, convert bold to headings (SECURITY-REPORT.md)
- N5: Convert bold to heading (EXECUTIVE-SUMMARY.md, line 288)

**Step 2.4: Align Plan Features Section (N1)**
- File: `spec.md` (lines 7671-7674)
- Reorder: análisis first, roasts second
- Consistent: thousands separator

---

#### Phase 3: Validation & Evidence

**Step 3.1: Run Tests**
```bash
npm run lint                     # Verify markdownlint passing
npm test                         # Verify no regressions
npm test -- --coverage           # Generate coverage (already done in Phase 1)
npm run build                    # Ensure builds
```

**Step 3.2: Generate Evidence**
- Directory: `docs/test-evidence/review-3320052293/`
- Files:
  - `SUMMARY.md` - Executive summary
  - `spec-diff-before-after.md` - Starter quota fix
  - `coverage-before-after.json` - Coverage data comparison
  - `markdownlint-results.txt` - Lint results

**Step 3.3: Validate GDD**
```bash
node scripts/validate-gdd-runtime.js --full
node scripts/predict-gdd-drift.js --full
```

---

### Agrupación de Commits

**Commit 1: Critical - Fix Starter Plan Quota**
```
fix(spec): Correct Starter plan roast quota - CodeRabbit #3320052293

Fixes CRITICAL mismatch between spec and code.

- Starter: 10 roasts/month → 100 roasts/month (align with planDefaults.js)
- Cross-checked: entitlementsService.js, tierValidationService tests
- Impact: Pricing documentation now accurate

Related: CodeRabbit Review #3320052293 (C2)
```

**Commit 2: Critical - Guardian Artifacts & CI Documentation**
```
docs(guardian): Add missing artifacts and CI behavior - CodeRabbit #3320052293

Addresses CRITICAL missing documentation and directory structure.

Created:
- docs/guardian/cases/ (with README.md, case file format)
- Domain→glob mapping table in spec.md
- CI/CD integration section (exit code semantics)

Related: CodeRabbit Review #3320052293 (C3)
```

**Commit 3: Fix - Generate and Update Coverage Data**
```
chore(gdd): Generate test coverage and update validation - CodeRabbit #3320052293

Addresses CRITICAL missing coverage data.

- Ran: npm test -- --coverage
- Updated: gdd-status.json with actual coverage values
- Cleared: 13 missing_coverage_data warnings
- Validated: coverage_integrity checks passing

Related: CodeRabbit Review #3320052293 (C1)
```

**Commit 4: Style - Fix Markdownlint Violations**
```
style(docs): Fix markdownlint violations - CodeRabbit #3320052293

Resolves 8 nitpick issues (MD040, MD036) across 4 files.

Fixed:
- MD040: Added languages to 15 code fences (bash, yaml, json, text)
- MD036: Converted 18 bold labels to proper headings

Files:
- docs/nodes/guardian.md (N6, N7, N8)
- docs/sync-reports/pr-515-sync.md (N2, N3)
- docs/test-evidence/review-3319707172/*.md (N4, N5)
- spec.md Plan Features section (N1)

Related: CodeRabbit Review #3320052293 (N1-N8)
```

---

## 6. Plan de Testing

### Test Coverage

**No new tests needed.** All changes are documentation fixes except:

1. **Starter Quota Fix (C2)**
   - Existing tests: `tests/integration/tierValidationService.simple.test.js`
   - Already expect: Starter = 100 roasts/month
   - **No code change** → Tests should still pass

2. **Coverage Generation (C1)**
   - Action: Run `npm test -- --coverage`
   - Expected: All existing tests pass
   - Expected: Coverage report generated
   - Expected: gdd-status.json updated

### Validation Tests

```bash
# Lint validation
npm run lint                              # Expect: 0 errors (MD040, MD036 fixed)

# Unit tests
npm test                                  # Expect: All passing

# Coverage
npm test -- --coverage                    # Expect: Coverage report generated
                                          # Expect: guardian.test.js ~80% coverage

# Build
npm run build                             # Expect: Success

# GDD validation
node scripts/validate-gdd-runtime.js --full   # Expect: HEALTHY, 14 nodes, 0 warnings
node scripts/predict-gdd-drift.js --full      # Expect: Low drift risk
```

### Regression Prevention

**Files to Monitor:**
- `src/config/planDefaults.js` - Ensure Starter quota unchanged
- `src/services/entitlementsService.js` - Verify plan limits consistent
- `config/product-guard.yaml` - Guardian domains unchanged
- `docs/nodes/guardian.md` - Coverage metadata intact

---

## 7. Criterios de Éxito

### ✅ Completion Checklist

- [ ] **C1:** Coverage data generated and gdd-status.json updated (13 warnings cleared)
- [ ] **C2:** Starter plan quota fixed (10→100 roasts/month in spec.md)
- [ ] **C3:** Guardian artifacts created (cases dir, README, domain→glob table, CI docs)
- [ ] **N1-N8:** All 8 nitpick issues resolved (markdownlint violations fixed)
- [ ] **Tests:** 100% passing (no regressions)
- [ ] **Coverage:** Coverage report generated, guardian node ~80%
- [ ] **Lint:** 0 markdownlint errors (MD040, MD036 cleared)
- [ ] **Build:** `npm run build` succeeds
- [ ] **GDD:** Validation HEALTHY, 14 nodes, 0 cycles, 0 orphans
- [ ] **Drift:** Low drift risk (<10/100)
- [ ] **Evidence:** Test evidence generated in `docs/test-evidence/review-3320052293/`
- [ ] **Documentation:** spec.md, guardian.md, sync-reports updated
- [ ] **Commits:** 4 commits pushed to `feat/gdd-phase-16-guardian`

### Quality Metrics

| Metric | Before | After | Target | Status |
|--------|--------|-------|--------|--------|
| **Markdownlint Errors** | 25+ | 0 | 0 | ⏳ Pending |
| **Coverage Data Availability** | 0/13 nodes | 13/13 nodes | 13/13 | ⏳ Pending |
| **Spec Accuracy (Starter)** | ❌ 10 roasts | ✅ 100 roasts | 100% | ⏳ Pending |
| **Guardian Artifacts** | ❌ Missing | ✅ Complete | 100% | ⏳ Pending |
| **Test Pass Rate** | 100% | 100% | 100% | ✅ Expected |
| **GDD Validation** | HEALTHY | HEALTHY | HEALTHY | ✅ Expected |

---

## 8. Risks and Mitigations

### Risk 1: Coverage Generation Fails
**Probability:** Low
**Impact:** High (blocks C1 resolution)
**Mitigation:**
- Verify `jest` and `yaml` packages installed
- Check `package.json` scripts for coverage command
- Fallback: Set coverage to "TBD" and create issue to fix later

### Risk 2: Starter Quota Change Has Code Dependencies
**Probability:** Very Low
**Impact:** Medium
**Mitigation:**
- Cross-check `planDefaults.js`, `entitlementsService.js`, all tests
- Verify code already uses `100 roasts/month` (confirmed by CodeRabbit)
- If code has `10`, update code instead (but evidence says code is correct)

### Risk 3: Markdownlint Fixes Break Rendering
**Probability:** Very Low
**Impact:** Low
**Mitigation:**
- Preview markdown in GitHub after commit
- Test with `markdownlint-cli2` locally before push
- Rollback if rendering breaks (unlikely for MD040, MD036)

---

## 9. Time Estimate

| Phase | Tasks | Estimate | Dependencies |
|-------|-------|----------|--------------|
| **Phase 1** | CRITICAL fixes (C1-C3) | 30 min | None |
| **Phase 2** | NITPICK fixes (N1-N8) | 20 min | Phase 1 complete |
| **Phase 3** | Validation & Evidence | 15 min | Phase 2 complete |
| **Phase 4** | Commits & Push | 10 min | Phase 3 complete |
| **Total** | Full implementation | **75 min** | Linear |

---

## 10. Sign-off

**Created:** 2025-10-09
**By:** Orchestrator Agent (Claude Code)
**Review:** CodeRabbit #3320052293
**Status:** 🚧 READY FOR EXECUTION

**Pre-Flight Check:**
- ✅ Plan complete (10 sections)
- ✅ Prioritized by severity (Critical → Nitpick)
- ✅ GDD nodes identified (guardian, cost-control, plan-features)
- ✅ Subagents assigned (Documentation, Test Engineer, Product Owner, Orchestrator)
- ✅ Files mapped (9 modified, 2 created)
- ✅ Strategy defined (4 phases, 4 commits)
- ✅ Success criteria clear (11 checkboxes)

**Approval:** Proceeding with implementation following maximum quality protocol.

---

**Next Step:** Execute Phase 1 - CRITICAL Fixes
