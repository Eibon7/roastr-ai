# Plan de Implementación - CodeRabbit Review #3294004904 + Issue #446

**Issue:** #446 - Post-Triage System Improvements
**Branch:** feat/issue-446-post-triage-improvements
**Fecha:** 2025-10-02

## Resumen

Esta implementación aborda los comentarios de CodeRabbit Review #3294004904 y la Issue #446, que son mejoras post-merge de la PR #444 (Triage System Implementation).

## Cambios a Implementar

### 1. Markdown Linting - CHANGELOG_ISSUE_443.md

**Problema:** Code block sin language identifier.

**Solución:**
- Añadir `text` o lenguaje apropiado a code fences
- Ya fue parcialmente resuelto en commit anterior, verificar completitud

**Archivos afectados:**
- `docs/CHANGELOG_ISSUE_443.md`

**Prioridad:** Baja

---

### 2. Roast Limits Reconciliation (CRÍTICO)

**Problema:** Valores conflictivos de límites de roasts en diferentes secciones de `spec.md`:

| Plan | Sección 1 | Sección 2 | Discrepancia |
|------|-----------|-----------|--------------|
| Starter | 500 roasts | 10 roasts | ❌ 490 diferencia |
| Pro | 2,500 roasts | 1,000 roasts | ❌ 1,500 diferencia |
| Plus | 10,000 roasts | 5,000 roasts | ❌ 5,000 diferencia |

**Investigación necesaria:**
1. Revisar `database/schema.sql` para valores reales en BD
2. Revisar `src/services/costControl.js` para límites implementados
3. Verificar `src/config/index.js` para configuración de planes

**Solución:**
- Determinar valores correctos basados en implementación real
- Actualizar `spec.md` con valores consistentes en todas las secciones
- Documentar decisión en changelog

**Archivos afectados:**
- `spec.md`
- `docs/plan/review-3294004904.md`

**Prioridad:** Media-Alta

---

### 3. Division by Zero - Batch Performance Metrics

**Problema:** Posible división por cero en `src/routes/triage.js` al calcular métricas de batch.

**Ubicación:** Cálculo de hit ratio en batch performance metrics

**Solución:**
```javascript
// Antes:
const hitRatio = cacheHits / (cacheHits + cacheMisses);

// Después:
const hitRatio = (cacheHits + cacheMisses) > 0
  ? cacheHits / (cacheHits + cacheMisses)
  : 0;
```

**Archivos afectados:**
- `src/routes/triage.js`

**Prioridad:** Media

---

### 4. Metadata Handling - Batch Requests

**Problema:** Posible metadata `undefined` en batch requests causando errores.

**Ubicación:** Batch processing loop en POST /batch

**Solución:**
```javascript
// Antes:
{...commentData.metadata, batch_index: i}

// Después:
{...(commentData.metadata || {}), batch_index: i}
```

**Archivos afectados:**
- `src/routes/triage.js`

**Prioridad:** Media

---

### 5. Correlation ID Top-Level Response

**Problema:** `correlation_id` está anidado en metadata, debería estar en raíz del response para facilitar debugging.

**Ubicación:** POST /api/triage/analyze response

**Solución:**
```javascript
// Response structure
{
  correlation_id: "abc123",  // ✨ Nuevo - top level
  action: "roast",
  reasoning: "...",
  metadata: {
    correlation_id: "abc123",  // Mantener también aquí por backward compatibility
    // ...
  }
}
```

**Archivos afectados:**
- `src/routes/triage.js`

**Prioridad:** Baja (Enhancement)

---

## Subagentes a Utilizar

1. **Front-end Dev**: Para correcciones de código en triage.js
2. **Test Engineer**: Para validar cambios y asegurar no regression
3. **GitHub Guardian**: Para review final antes de crear PR

## Orden de Ejecución

1. ✅ Crear este plan
2. ⏳ Crear rama `feat/issue-446-post-triage-improvements` desde `main`
3. ⏳ Investigar y reconciliar roast limits (spec.md + código)
4. ⏳ Fix division by zero en triage.js
5. ⏳ Fix metadata handling en triage.js
6. ⏳ Añadir correlation_id top-level en responses
7. ⏳ Verificar markdown linting en CHANGELOG
8. ⏳ Ejecutar tests completos
9. ⏳ Actualizar spec.md con roast limits correctos
10. ⏳ Crear PR #446 y push

## Criterios de Validación

### Tests
- [ ] Todos los tests de triage deben pasar
- [ ] Tests de batch processing deben pasar
- [ ] No regression en otros módulos

### Documentación
- [ ] Roast limits consistentes en spec.md
- [ ] Markdown lint pasa sin errores
- [ ] Changelog actualizado

### Código
- [ ] No división por cero en metrics
- [ ] Metadata handling robusto
- [ ] Correlation ID en top-level de responses

## Archivos a Modificar

```text
src/routes/triage.js          - Division by zero, metadata, correlation_id
spec.md                        - Roast limits reconciliation
docs/CHANGELOG_ISSUE_443.md   - Markdown linting (verificar)
docs/plan/review-3294004904.md - Este archivo (nuevo)
```

## Notas Importantes

- Esta PR se crea desde `main` porque PR #444 está pendiente de merge
- **Los cambios de código en triage.js NO SE APLICAN AÚN** porque el archivo no existe en main
- Esta PR se enfoca en:
  ✅ Reconciliar roast limits en spec.md (aplicado)
  ⏸️ Cambios de triage.js quedan pendientes hasta que #444 se mergee
- Una vez #444 esté mergeada, se puede crear una PR adicional para aplicar los fixes de triage.js

## Changelog para PR #446

```text
### Issue #446 - Roast Limits Reconciliation

**Documentation Improvements:**
- ✅ Reconciled roast limit values across spec.md based on actual code implementation
- ✅ Updated section "Rate Limiting by Plan" with correct values
- ✅ Updated section "Tier Configuration" with correct values

**Corrected Values (from entitlementsService.js):**
- Free: 100 roasts/month (was incorrectly documented as 10 or 50)
- Starter: 500 roasts/month (was incorrectly documented as 100)
- Pro: 1,000 roasts/month (was incorrectly documented as 2,500)
- Plus: Unlimited (was incorrectly documented as 5,000 or 10,000)

**Files Modified:**
- spec.md (roast limits corrected in 2 sections)
- docs/plan/review-3294004904.md (new - implementation plan)

**Pending for Future PR (after #444 merge):**
- Division by zero fix in triage.js batch metrics
- Metadata handling fix in triage.js batch requests
- Correlation ID top-level response enhancement
```
