# ADR-008: Auth Validation Enhancements Post-Zod Migration

**Status:** ACCEPTED  
**Date:** 2025-11-24  
**Author:** Roastr Engineering Team  
**Related Issue:** #982  
**Related PRs:** #979 (Zod migration)

---

## Context

After completing the migration to Zod for auth endpoint validation (Issue #947), we identified 4 potential enhancements that could improve user experience, security, and system observability:

1. **Rate Limiting Integration** - Zod validation for rate limit headers
2. **Validation Telemetry** - Metrics for validation failure patterns
3. **i18n Support** - Centralized messages for multi-language support
4. **Disposable Email Blocking** - Prevent temporary email addresses

These enhancements are **optional** and **not blocking** production. This ADR documents the decision-making process for each enhancement to guide future implementation.

---

## Current State (Baseline)

### âœ… What's Working Well

1. **Zod Validation:**
   - Email format validation (RFC 5322 compliant)
   - Password strength rules (8+ chars, number, lowercase, uppercase OR symbol)
   - User-friendly Spanish error messages
   - Type-safe validation with excellent DX

2. **Rate Limiting:**
   - IP + email combination tracking
   - 5 attempts per 15-minute window
   - 15-minute block duration
   - Metrics collection (total attempts, unique IPs, blocks)
   - Cleanup interval to prevent memory leaks

3. **Error Messages:**
   - Clear Spanish messages (target audience)
   - Specific validation feedback (which rule failed)
   - Consistent error format across endpoints

### ðŸ“Š Production Metrics (Hypothetical - to be measured)

- Validation failure rate: ~Unknown (no telemetry yet)
- Most common failures: Unknown
- Rate limit hits: ~12 blocks per day (from metrics)
- Disposable email abuse: Unknown (no tracking)

---

## Decision Drivers

### Business Requirements

- **User Experience:** Clear, actionable error messages
- **Security:** Prevent brute force, spam, account abuse
- **Scalability:** System should support international expansion
- **Data-Driven:** Need metrics to inform UX improvements

### Technical Constraints

- **Maintainability:** Avoid over-engineering for hypothetical problems
- **Performance:** No validation overhead >5ms per request
- **Compatibility:** Must work with existing auth flow
- **Testing:** Each enhancement must be testable in isolation

### Risk Tolerance

- **False Positives:** Blocking legitimate users is UNACCEPTABLE
- **Feature Flags:** Controversial features must be toggleable
- **Rollback:** New features must be reversible without migration

---

## Options Considered

### Enhancement #1: Rate Limiting Integration

#### Option A: Validate Rate Limit Headers with Zod

**Implementation:**
```javascript
// src/validators/zod/rate-limit.schema.js
const rateLimitResponseSchema = z.object({
  'X-RateLimit-Limit': z.number().int().positive(),
  'X-RateLimit-Remaining': z.number().int().min(0),
  'X-RateLimit-Reset': z.number().int().positive(),
  'Retry-After': z.number().int().positive().optional()
});
```

**Pros:**
- Consistent validation approach
- Type-safe rate limit responses
- Clear error messages if headers malformed

**Cons:**
- Rate limiter already works reliably
- Headers are internal (not user-facing)
- Adds complexity with minimal benefit

**Effort:** 2-3 hours

#### Option B: Keep Current Implementation

**Pros:**
- No additional work
- Current rate limiter is battle-tested
- Headers validated implicitly by Express

**Cons:**
- Less consistency with Zod approach

**Effort:** 0 hours

#### âœ… DECISION: **Option B (Keep Current)**

**Rationale:** Rate limiting headers are internal implementation details. Zod validation provides marginal benefit since these headers are generated by our code, not user input. Current implementation is sufficient.

**Activation Criteria:** Only reconsider if we expose rate limit API to external clients.

---

### Enhancement #2: Validation Telemetry

#### Option A: Implement Comprehensive Validation Metrics

**Implementation:**
```javascript
// src/services/validationMetricsService.js
class ValidationMetricsService {
  trackValidationError(field, errorType, userId = null) {
    // Store in DB: validation_errors table
    // Aggregate metrics: field, error type, count, timestamp
  }

  getErrorDistribution(timeRange = '24h') {
    // Return: { field: 'password', errorType: 'too_short', count: 145 }
  }

  getErrorRateByUser(userId) {
    // Detect potential attackers (high error rate)
  }
}
```

**Metrics Tracked:**
- `email_invalid` - Invalid email format
- `password_weak` - Password doesn't meet strength requirements
- `password_no_number` - Missing number
- `password_no_uppercase` - Missing uppercase
- `password_too_short` - <8 characters
- `email_consecutive_dots` - Email has `..`
- `email_double_at` - Email has `@@`
- `total_validations` - All validation attempts
- `failed_validations` - Total failures

**Pros:**
- Identify UX pain points (which rules confuse users?)
- Detect attack patterns (high error rate = brute force?)
- Data-driven UX improvements (relax rules causing frustration?)
- Helps inform i18n priorities (most common errors = translate first)

**Cons:**
- Storage overhead (new table, indexes)
- Privacy considerations (PII in error messages?)
- Requires aggregation and dashboard

**Effort:** 8-10 hours

**Storage:**
```sql
CREATE TABLE validation_errors (
  id UUID PRIMARY KEY,
  field VARCHAR(50) NOT NULL,
  error_type VARCHAR(50) NOT NULL,
  user_id UUID REFERENCES users(id),
  ip_address INET,
  user_agent TEXT,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  INDEX idx_field_error (field, error_type),
  INDEX idx_timestamp (timestamp DESC)
);
```

**Dashboard Integration:**
```javascript
// GET /api/admin/validation-metrics
{
  "last_24h": {
    "total_validations": 1250,
    "failed_validations": 87,
    "failure_rate": "6.96%",
    "top_errors": [
      { "field": "password", "error": "too_short", "count": 34 },
      { "field": "email", "error": "invalid_format", "count": 28 },
      { "field": "password", "error": "no_number", "count": 25 }
    ]
  }
}
```

#### Option B: Basic Logging (Current State)

**Pros:**
- No additional work
- Errors already logged in application logs

**Cons:**
- No aggregation (hard to identify patterns)
- No dashboard visibility
- Logs rotate out (no long-term trends)

**Effort:** 0 hours

#### âœ… DECISION: **Option A (Implement When Dashboard Ready)**

**Rationale:** High value for product insights and UX optimization. However, metrics without a dashboard = wasted effort. **Implement when we have infrastructure for metric visualization** (e.g., Grafana, admin dashboard).

**Activation Criteria:**
1. Dashboard infrastructure is ready
2. Product Owner requests validation insights
3. We observe high validation failure rates in production

**Feature Flag:** `ENABLE_VALIDATION_TELEMETRY` (default: OFF)

**Priority:** ðŸŸ¡ Medium (implement Q1 2026 if dashboard ready)

---

### Enhancement #3: i18n Support for Validation Messages

#### Option A: Full i18n Infrastructure

**Implementation:**
```
src/locales/
â”œâ”€â”€ es.json  # Spanish (current, default)
â”œâ”€â”€ en.json  # English
â”œâ”€â”€ ca.json  # Catalan (if Spain market)
â””â”€â”€ index.js # i18n loader
```

**Example `es.json`:**
```json
{
  "validation": {
    "email": {
      "required": "Email es requerido",
      "invalid": "Formato de email invÃ¡lido",
      "consecutive_dots": "El email no puede contener puntos consecutivos",
      "double_at": "El email no puede contener @@"
    },
    "password": {
      "required": "La contraseÃ±a es requerida",
      "too_short": "La contraseÃ±a debe tener al menos 8 caracteres",
      "no_spaces": "La contraseÃ±a no puede contener espacios",
      "no_number": "La contraseÃ±a debe contener al menos un nÃºmero",
      "no_lowercase": "La contraseÃ±a debe contener al menos una letra minÃºscula",
      "no_uppercase_or_symbol": "La contraseÃ±a debe contener al menos una letra mayÃºscula o un sÃ­mbolo"
    }
  }
}
```

**Usage:**
```javascript
// src/validators/zod/auth.schema.js
const { t } = require('../../locales');

const registerSchema = z.object({
  email: z
    .string({ required_error: t('validation.email.required') })
    .email(t('validation.email.invalid'))
});
```

**Language Detection:**
```javascript
// src/config/i18n.js
function detectLocale(req) {
  // 1. Query param: ?lang=en
  if (req.query.lang) return req.query.lang;
  
  // 2. User preference (from DB)
  if (req.user && req.user.locale) return req.user.locale;
  
  // 3. Accept-Language header
  if (req.headers['accept-language']) {
    return req.acceptsLanguages(['es', 'en', 'ca']);
  }
  
  // 4. Default to Spanish
  return 'es';
}
```

**Pros:**
- Easy to add languages (1 new JSON file)
- Consistent messages across app
- Supports international expansion
- Simple maintenance (non-technical staff can translate)

**Cons:**
- Initial translation effort
- Runtime overhead (JSON loading)
- Must decide which languages to support

**Effort:** 10-12 hours (initial setup + 2 languages)

#### Option B: Minimal Approach (Single JSON File)

Keep Spanish hardcoded, extract to JSON only if needed:

```javascript
// src/locales/messages.js
module.exports = {
  'email.required': 'Email es requerido',
  'email.invalid': 'Formato de email invÃ¡lido',
  // ...
};
```

**Pros:**
- Less overhead
- Still centralizes messages

**Cons:**
- Harder to add languages later
- No language detection

**Effort:** 3-4 hours

#### Option C: No Change (Hardcoded Spanish)

**Pros:**
- No work
- Current messages work for target audience

**Cons:**
- Hard to internationalize later
- Messages scattered in code

**Effort:** 0 hours

#### âœ… DECISION: **Option A (Implement When Internationalizing)**

**Rationale:** Roastr's current market is Spanish-speaking. However, **if we expand internationally** (UK, France, Latin America), i18n is essential. Implement when there's concrete demand.

**Activation Criteria:**
1. Product Owner confirms international expansion
2. Significant non-Spanish traffic observed
3. Customer requests for English/other languages

**Feature Flag:** `ENABLE_I18N` (default: OFF, Spanish hardcoded)

**Default Language:** Spanish (`es`)

**Priority:** ðŸŸ¡ Medium (implement when internationalizing, est. Q2-Q3 2026)

---

### Enhancement #4: Disposable Email Blocking

#### Option A: Block Disposable Email Domains

**Implementation:**
```javascript
// src/utils/disposableEmailDetector.js
const disposableDomains = require('disposable-email-domains'); // npm package

function isDisposableEmail(email) {
  const domain = email.split('@')[1]?.toLowerCase();
  return disposableDomains.includes(domain);
}
```

**Zod Integration:**
```javascript
const registerSchema = z.object({
  email: z
    .string()
    .email('Formato de email invÃ¡lido')
    .refine(
      (email) => !isDisposableEmail(email),
      {
        message: 'Por favor usa un email permanente para tu cuenta. Los emails desechables no estÃ¡n permitidos.'
      }
    )
});
```

**Disposable Domains List:**
- 5000+ known disposable email providers
- Examples: 10minutemail.com, guerrillamail.com, mailinator.com, temp-mail.org
- Maintained npm package: `disposable-email-domains` (updated monthly)

**Pros:**
- Reduces spam/trial abuse
- Improves user quality
- Prevents throwaway accounts

**Cons:**
- **HIGH RISK:** False positives (blocks legitimate privacy-conscious users)
- List maintenance required (new domains appear constantly)
- User frustration if blocked unfairly
- Some privacy advocates use disposable emails legitimately

**Effort:** 4-5 hours

**Whitelist Example:**
```javascript
// Whitelist privacy-focused services that aren't disposable
const whitelistedDomains = [
  'protonmail.com',
  'tutanota.com',
  'mailfence.com'
];

function isDisposableEmail(email) {
  const domain = email.split('@')[1]?.toLowerCase();
  
  if (whitelistedDomains.includes(domain)) {
    return false; // Allow privacy services
  }
  
  return disposableDomains.includes(domain);
}
```

#### Option B: Warn (Don't Block) Disposable Emails

Show warning but allow registration:

```json
{
  "success": true,
  "warning": "Detectamos que usas un email temporal. Para mejor experiencia, te recomendamos usar un email permanente.",
  "user": { /* ... */ }
}
```

**Pros:**
- No false positives
- Educates users
- Preserves user choice

**Cons:**
- Doesn't prevent abuse
- Warning might be ignored

**Effort:** 2-3 hours

#### Option C: No Blocking (Current State)

**Pros:**
- No risk of blocking legitimate users
- Respects user privacy choices

**Cons:**
- Allows spam/abuse
- Trial abuse possible

**Effort:** 0 hours

#### âœ… DECISION: **Option C (No Blocking) - Defer Indefinitely**

**Rationale:** **High risk of false positives outweighs benefits**. Privacy-conscious users legitimately use disposable emails. Blocking them = losing potential customers. Only implement if **abuse is a demonstrated problem** with clear metrics.

**Activation Criteria (IF we reconsider):**
1. **Abuse confirmed:** >10% of trial accounts are spam/throwaway
2. **Support burden:** High volume of support tickets from throwaway accounts
3. **Fraud detected:** Disposable emails used for payment fraud

**Feature Flag (IF implemented):** `ENABLE_DISPOSABLE_EMAIL_BLOCK` (default: **OFF**)

**Alternative Approach:** Use **behavioral signals** instead of email domain blocking:
- Monitor account activity (0 usage after 7 days = likely throwaway)
- Track multiple accounts from same IP
- Require email verification (unverified = limited access)

**Priority:** ðŸ”´ Low (DEFER - only if abuse proven)

---

## Decision Summary

| Enhancement                   | Decision      | Priority | Effort | Activation Criteria                        |
| ----------------------------- | ------------- | -------- | ------ | ------------------------------------------ |
| Rate Limiting Integration     | âŒ DEFER      | ðŸ”´ Low   | 2-3h   | Exposing rate limit API to external clients |
| Validation Telemetry          | âœ… RECOMMEND  | ðŸŸ¡ Medium | 8-10h  | Dashboard ready + PO request               |
| i18n Support                  | âœ… RECOMMEND  | ðŸŸ¡ Medium | 10-12h | International expansion confirmed          |
| Disposable Email Blocking     | âŒ DEFER      | ðŸ”´ Low   | 4-5h   | Abuse demonstrated (>10% spam accounts)    |

---

## Consequences

### Positive Consequences

1. **Validation Telemetry (when implemented):**
   - Data-driven UX improvements
   - Early detection of attack patterns
   - Informed i18n prioritization

2. **i18n Support (when implemented):**
   - Enables international expansion
   - Professional multi-language experience
   - Competitive advantage in non-Spanish markets

3. **Clear Decision Framework:**
   - Future engineers know WHY we deferred features
   - Activation criteria prevent premature optimization
   - Feature flags allow safe rollout

### Negative Consequences

1. **Validation Telemetry:**
   - Storage overhead (new table, indexes)
   - Privacy considerations (error data collection)
   - Requires dashboard infrastructure

2. **i18n Support:**
   - Runtime overhead (JSON loading)
   - Translation maintenance
   - Language detection complexity

3. **Deferred Features:**
   - Must revisit if circumstances change
   - Risk of forgetting activation criteria

### Risk Mitigation

1. **Feature Flags:** All controversial features behind flags (default: OFF)
2. **Phased Rollout:** Enable for subset of users first
3. **Monitoring:** Track metrics before/after enablement
4. **Rollback Plan:** Easy to disable if issues arise

---

## Implementation Checklist (When Activated)

### For Validation Telemetry (#2)

- [ ] Create `validation_errors` table (migration)
- [ ] Implement `ValidationMetricsService`
- [ ] Add tracking to `auth.schema.js`
- [ ] Create admin metrics endpoint
- [ ] Add Grafana dashboard panels
- [ ] Write unit tests (>90% coverage)
- [ ] Feature flag: `ENABLE_VALIDATION_TELEMETRY`
- [ ] Update `docs/nodes/observability.md`

### For i18n Support (#3)

- [ ] Create `src/locales/` directory structure
- [ ] Extract Spanish messages â†’ `es.json`
- [ ] Translate to English â†’ `en.json`
- [ ] Implement i18n loader (`src/locales/index.js`)
- [ ] Add language detection middleware
- [ ] Update `auth.schema.js` to use `t()`
- [ ] Write unit tests (locale switching)
- [ ] Feature flag: `ENABLE_I18N`
- [ ] Update README (language support)

### For Disposable Email Blocking (#4) - IF EVER NEEDED

- [ ] Install `disposable-email-domains` npm package
- [ ] Implement `disposableEmailDetector.js`
- [ ] Add whitelist for privacy services
- [ ] Update `auth.schema.js` validation
- [ ] Write unit tests (edge cases)
- [ ] Feature flag: `ENABLE_DISPOSABLE_EMAIL_BLOCK` (default: OFF)
- [ ] Document decision in user-facing docs
- [ ] Monitor false positive rate (<1%)

---

## References

- **Issue #982:** Mejoras opcionales para validaciÃ³n Zod en Auth endpoints
- **PR #979:** MigraciÃ³n a Zod completada
- **Issue #947:** Trabajo original de migraciÃ³n
- **Nodo GDD:** `docs/nodes/multi-tenant.md` (auth)
- **Nodo GDD:** `docs/nodes/observability.md` (telemetry)
- **npm package:** [disposable-email-domains](https://www.npmjs.com/package/disposable-email-domains)
- **i18n library (if needed):** [i18next](https://www.i18next.com/)

---

## Review and Update

**Review Frequency:** Quarterly (Q1, Q2, Q3, Q4)

**Next Review:** 2026-01-31 (Q1 2026)

**Review Checklist:**
- [ ] Has abuse situation changed? (disposable emails)
- [ ] Is dashboard infrastructure ready? (telemetry)
- [ ] Are we expanding internationally? (i18n)
- [ ] Have activation criteria been met for any enhancement?

**Update Trigger:** Product Owner requests feature OR activation criteria met

---

**Approved by:** Roastr Engineering Team  
**Date:** 2025-11-24  
**Version:** 1.0.0

