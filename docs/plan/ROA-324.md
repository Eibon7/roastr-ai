# Plan ROA-324: Limpieza y Normalización Final de Workers/Queues No Oficiales

**Issue:** ROA-324  
**Branch:** feature/ROA-324-auto  
**Fecha:** 2025-12-15  
**Status:** En Progreso

---

## 1. Estado Actual - Análisis

### 1.1 Workers en SSOT-V2.md (Sección 8.1)

**Workers Oficiales v2:**
```ts
type WorkerName =
  | 'FetchComments'
  | 'AnalyzeToxicity'
  | 'GenerateRoast'
  | 'GenerateCorrectiveReply'
  | 'ShieldAction'
  | 'SocialPosting'
  | 'BillingUpdate'
  | 'CursorReconciliation'
  | 'StrikeCleanup';
```

### 1.2 Workers en Código (`src/workers/`)

| Archivo | Clase | Mapeo WorkerManager | Estado SSOT |
|---------|-------|---------------------|-------------|
| FetchCommentsWorker.js | FetchCommentsWorker | fetch_comments | ✅ Oficial |
| AnalyzeToxicityWorker.js | AnalyzeToxicityWorker | analyze_toxicity | ✅ Oficial |
| GenerateReplyWorker.js | GenerateReplyWorker | generate_roast | ✅ Oficial (como GenerateRoast) |
| ShieldActionWorker.js | ShieldActionWorker | shield_action | ✅ Oficial |
| BillingWorker.js | BillingWorker | billing_update | ✅ Oficial (como BillingUpdate) |
| PublisherWorker.js | PublisherWorker | social_posting | ✅ Oficial (como SocialPosting) |
| AccountDeletionWorker.js | AccountDeletionWorker | - | ⚠️ No oficial |
| AlertNotificationWorker.js | AlertNotificationWorker | - | ⚠️ No oficial |
| ExportCleanupWorker.js | ExportCleanupWorker | - | ⚠️ No oficial |
| GDPRRetentionWorker.js | GDPRRetentionWorker | - | ⚠️ No oficial |
| ModelAvailabilityWorker.js | ModelAvailabilityWorker | - | ⚠️ No oficial |

### 1.3 Workers Faltantes en SSOT

| Worker SSOT | Implementado | Notas |
|-------------|--------------|-------|
| CursorReconciliation | ❌ No existe | Worker planificado para reconciliación de cursores |
| StrikeCleanup | ❌ No existe | Worker planificado para limpieza de strikes |
| GenerateCorrectiveReply | ❌ Parcial | Funcionalidad dentro de GenerateReplyWorker |

### 1.4 Nombres de Colas Actuales

**En `queueService.js`:**
```javascript
this.queuePrefix = 'roastr:jobs';    // ❌ Debe ser 'v2_' según SSOT
this.dlqPrefix = 'roastr:dlq';       // ❌ Debe ser 'v2_dlq'
this.metricsPrefix = 'roastr:metrics'; // ❌ Debe ser 'v2_metrics'
```

**En nodo 08-workers.md:**
> "Colas prefijadas `v2_*`"

---

## 2. Cambios Requeridos

### 2.1 Fase A: Normalizar SSOT-V2.md

**Acción:** Añadir workers auxiliares a SSOT como categoría separada.

```ts
// Sección 8.1 - Workers oficiales core
type WorkerName = 
  | 'FetchComments'
  | 'AnalyzeToxicity'
  | 'GenerateRoast'
  | 'GenerateCorrectiveReply'
  | 'ShieldAction'
  | 'SocialPosting'
  | 'BillingUpdate'
  | 'CursorReconciliation'
  | 'StrikeCleanup';

// Sección 8.5 - Workers auxiliares (internos)
type AuxiliaryWorkerName =
  | 'AccountDeletion'      // GDPR: Eliminación de cuentas
  | 'AlertNotification'    // Observabilidad: Notificaciones de alertas
  | 'ExportCleanup'        // GDPR: Limpieza de exports
  | 'GDPRRetention'        // GDPR: Retención y purga de datos
  | 'ModelAvailability';   // Infraestructura: Health check de modelos
```

### 2.2 Fase B: Normalizar Prefijos de Colas

**Archivo:** `src/services/queueService.js`

```diff
- this.queuePrefix = 'roastr:jobs';
+ this.queuePrefix = 'v2_jobs';
- this.dlqPrefix = 'roastr:dlq';
+ this.dlqPrefix = 'v2_dlq';
- this.metricsPrefix = 'roastr:metrics';
+ this.metricsPrefix = 'v2_metrics';
```

**Impacto:** 
- No hay datos en producción que migrar (cambio solo de prefijos)
- Tests deben actualizarse para esperar nuevos prefijos

### 2.3 Fase C: Documentar Workers Auxiliares

**Archivo:** `docs/nodes-v2/08-workers.md`

Añadir sección para workers auxiliares con sus responsabilidades.

---

## 3. Archivos a Modificar

1. `docs/SSOT-V2.md` - Sección 8 (workers)
2. `src/services/queueService.js` - Prefijos de colas
3. `docs/nodes-v2/08-workers.md` - Documentación de workers auxiliares
4. `scripts/validate-workers-ssot.js` - Actualizar lista de workers válidos

---

## 4. Validación

```bash
# Validar workers contra SSOT
node scripts/validate-workers-ssot.js --ci

# Validar documentación v2
node scripts/validate-v2-doc-paths.js --ci

# Ejecutar tests
npm test -- --testPathPattern="worker"
```

---

## 5. Criterios de Aceptación

- [x] Análisis de discrepancias completado
- [x] SSOT-V2.md incluye workers auxiliares
- [x] Prefijos de colas normalizados a `v2_*`
- [x] validate-workers-ssot.js pasa sin errores
- [x] Tests existentes actualizados y pasando
- [x] Documentación actualizada

---

## 6. Notas

- **CursorReconciliation y StrikeCleanup** son workers planificados en SSOT pero no implementados. Se mantienen como "planificados" en documentación.
- **Workers auxiliares** (GDPR, alerting) se categorizan separadamente ya que soportan funcionalidades internas y no el flujo core de roasting.

