# Plan de Implementaci√≥n - ROA-524: Session Refresh and Health Check Completion

**Issue:** ROA-524  
**T√≠tulo:** Session Refresh and Health Check Completion  
**Fecha:** 2025-01-08  
**Owner:** Backend Dev  
**Priority:** P1 (inferred from auth/observability criticality)

---

## üìã Estado Actual

### Session Refresh - ‚úÖ Implementado

**Archivos existentes:**
- `src/middleware/sessionRefresh.js` - Middleware completo de session refresh
- `public/js/auth.js` - Cliente frontend con auto-refresh
- `src/routes/auth.js` - Endpoint `/api/auth/refresh`

**Funcionalidades actuales:**
- ‚úÖ Middleware autom√°tico de refresh (5 min antes de expirar)
- ‚úÖ Endpoint expl√≠cito de refresh
- ‚úÖ Integraci√≥n con Supabase (service client + anon client)
- ‚úÖ Soporte para mock mode (tests)
- ‚úÖ Headers de respuesta con nuevos tokens
- ‚úÖ Cliente frontend con coalescing de peticiones concurrentes
- ‚úÖ Sliding expiration

**Feature Flag:**
- `ENABLE_SESSION_REFRESH` - Actualmente controla la funcionalidad

### Health Checks - ‚úÖ Implementado

**Endpoints existentes:**
1. `/health` - Health check b√°sico (uptime, version, environment)
2. `/api/health` - Health check comprehensivo (monitoringService)
3. `/api/dashboard/health` - Health check de dashboard (flags + services)
4. `/api/workers/health` - Health check de workers
5. `/api/persona/health` - Health check de persona service

**Servicio:**
- `MonitoringService` - Tracking de health status, response times, requests

**Tests:**
- `tests/smoke/api-health.test.js` - Tests de smoke para health endpoints

---

## üéØ Acceptance Criteria (Inferidos)

Dado que la issue se titula "Completion", asumo que los AC son:

### AC1: Session Refresh Completion
- [ ] Validar que session refresh funciona end-to-end
- [ ] Asegurar que el feature flag est√° documentado
- [ ] Tests de integraci√≥n completos
- [ ] Logging estructurado seg√∫n GDPR

### AC2: Health Check Completion
- [ ] Consolidar health check endpoints (evitar duplicaci√≥n)
- [ ] Asegurar consistency en formato de respuesta
- [ ] Health checks respetan HTTP status codes correctos
- [ ] Tests de smoke para todos los endpoints

### AC3: Observability Integration
- [ ] Session refresh events loggeados con correlation IDs
- [ ] Health check failures alertan seg√∫n criticidad
- [ ] M√©tricas agregadas en dashboard

### AC4: Documentation
- [ ] Actualizar AUTH_GUIDE.md con session refresh completo
- [ ] Documentar health check endpoints
- [ ] Actualizar nodos GDD (observabilidad, billing-integration, infraestructura)

---

## üîç An√°lisis de Gaps

### 1. Session Refresh

**Gaps detectados:**

‚ùå **Tests incompletos:**
- No hay tests unitarios espec√≠ficos de `sessionRefreshMiddleware`
- Tests E2E de session refresh (`tests/e2e/auth-complete-flow.test.js`) podr√≠an estar incompletos
- Falta test de race conditions (aunque el cliente tiene coalescing)

‚ùå **Logging GDPR:**
- Verificar que los logs de session refresh NO incluyen datos personales
- Asegurar correlation IDs en todos los logs

‚ùå **Error handling:**
- Verificar error codes consistentes
- Documentar error codes en AUTH_GUIDE.md

‚úÖ **Funcionalidad core:** Completa

### 2. Health Checks

**Gaps detectados:**

‚ö†Ô∏è **Duplicaci√≥n de endpoints:**
- `/health` (b√°sico)
- `/api/health` (comprehensivo)
- `/api/dashboard/health` (dashboard-specific)
‚Üí Evaluar si deben consolidarse o mantenerse separados

‚ùå **Consistency:**
- Formato de respuesta inconsistente entre endpoints
- HTTP status codes podr√≠an estar m√°s estandarizados

‚ùå **Monitoring integration:**
- Health checks no est√°n alertando seg√∫n criticidad
- Falta integraci√≥n con error budget

‚úÖ **Funcionalidad core:** Implementada pero necesita refinamiento

### 3. Observability Integration

‚ùå **Correlation tracking:**
- Session refresh podr√≠a no estar generando correlation IDs
- Health checks podr√≠an no estar tracking requests

‚ùå **Alertas:**
- Health check failures no est√°n conectados a sistema de alertas
- No hay error budget enforcement

---

## üìù Plan de Implementaci√≥n

### FASE 1: Session Refresh Completion

#### 1.1 Tests Completos

**Archivos a crear/modificar:**
- `tests/unit/middleware/sessionRefresh.test.js` (crear)
- `tests/integration/auth-session-refresh.test.js` (crear)
- `tests/e2e/auth-complete-flow.test.js` (verificar cobertura)

**Casos de prueba:**
- ‚úÖ Token cerca de expirar ‚Üí auto-refresh
- ‚úÖ Token v√°lido ‚Üí no refresh
- ‚úÖ Sin refresh token ‚Üí continuar sin error
- ‚úÖ Refresh token inv√°lido ‚Üí error manejado
- ‚úÖ Mock mode ‚Üí usar supabaseAnonClient
- ‚úÖ Feature flag disabled ‚Üí skip middleware
- ‚úÖ Race conditions ‚Üí coalescing

#### 1.2 Logging GDPR-Compliant

**Archivos a modificar:**
- `src/middleware/sessionRefresh.js`

**Cambios:**
- A√±adir correlation IDs a todos los logs
- Verificar que NO se loggean: emails, nombres, tokens
- Solo loggear: timestamps, correlation_id, organization_id, success/error

**Ejemplo:**
```javascript
logger.info('Session refreshed', {
  correlation_id: req.correlationId,
  organization_id: req.user?.organizationId,
  timestamp: new Date().toISOString()
});
```

#### 1.3 Error Codes Documentados

**Archivos a modificar:**
- `AUTH_GUIDE.md`

**A√±adir secci√≥n:**
```markdown
### Session Refresh Error Codes

| Code | Description | Action |
|------|-------------|--------|
| `SESSION_REFRESH_DISABLED` | Feature flag off | Enable flag or contact admin |
| `MISSING_REFRESH_TOKEN` | No refresh token provided | Re-authenticate |
| `SESSION_REFRESH_FAILED` | Invalid refresh token | Re-authenticate |
```

### FASE 2: Health Check Consolidation

#### 2.1 Estandarizar Formato de Respuesta

**Decisi√≥n:**
- Mantener m√∫ltiples endpoints (cada uno tiene su prop√≥sito)
- Estandarizar formato de respuesta

**Formato est√°ndar:**
```json
{
  "status": "healthy|degraded|unhealthy",
  "timestamp": "ISO-8601",
  "services": {
    "api": "ok|degraded|down",
    "db": "ok|degraded|down",
    "workers": "ok|degraded|down"
  },
  "metadata": {}
}
```

**HTTP Status Codes:**
- `200` - healthy/degraded (operational)
- `503` - unhealthy (service unavailable)
- `500` - error (internal server error)

#### 2.2 Tests de Smoke Completos

**Archivo a modificar:**
- `tests/smoke/api-health.test.js`

**Casos de prueba:**
- ‚úÖ `/health` returns 200
- ‚úÖ `/api/health` returns comprehensive status
- ‚úÖ `/api/dashboard/health` returns dashboard status
- ‚úÖ `/api/workers/health` returns workers status
- ‚úÖ `/api/persona/health` returns persona status
- ‚úÖ Formato de respuesta consistente
- ‚úÖ HTTP status codes correctos

### FASE 3: Observability Integration

#### 3.1 Correlation Tracking

**Archivos a modificar:**
- `src/middleware/sessionRefresh.js`
- `src/routes/dashboard.js`
- `src/routes/workers.js`
- `src/routes/persona.js`

**Cambios:**
- A√±adir correlation ID middleware ANTES de session refresh
- Pasar correlation ID a todos los logs
- A√±adir correlation ID a response headers

#### 3.2 Alertas & Error Budget

**Archivos a crear/modificar:**
- `src/services/monitoringService.js` (modificar)

**Integraci√≥n:**
- Health check failures ‚Üí alertas seg√∫n criticidad
- Session refresh failures ‚Üí alertas P2 (medium)
- Error budget tracking ‚Üí alertas P1 (high) si excede threshold

### FASE 4: Documentation

#### 4.1 Actualizar AUTH_GUIDE.md

**Secciones a a√±adir/actualizar:**
- Session Refresh Error Codes
- Health Check Endpoints
- Observability Integration

#### 4.2 Actualizar Nodos GDD

**Archivos a modificar:**
- `docs/nodes-v2/observabilidad.md`
- `docs/nodes-v2/14-infraestructura.md`
- `docs/nodes-v2/billing.md` (si aplica)

**Cambios:**
- A√±adir session refresh a observabilidad
- Actualizar health checks en infraestructura
- Actualizar "Agentes Relevantes" si aplica

---

## üß™ Validaci√≥n

### Pre-commit Checks

```bash
# 1. Tests pasando
npm test -- tests/unit/middleware/sessionRefresh.test.js
npm test -- tests/integration/auth-session-refresh.test.js
npm test -- tests/smoke/api-health.test.js

# 2. GDD validation
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci  # Debe >=87

# 3. SSOT compliance
grep -r "ENABLE_SESSION_REFRESH" src/ --exclude-dir=node_modules
# Debe venir de SettingsLoader o flags
```

### Pre-PR Checks

```bash
# 1. Coverage >=90%
npm run test:coverage

# 2. CodeRabbit = 0 comentarios
npm run coderabbit:review

# 3. Linter pasando
npm run lint

# 4. No hay IDs legacy
node scripts/detect-legacy-ids.js
```

---

## üì¶ Archivos Afectados

**Modificaciones:**
- `src/middleware/sessionRefresh.js` - Logging GDPR + correlation IDs
- `src/routes/dashboard.js` - Estandarizar formato de respuesta
- `src/routes/workers.js` - Estandarizar formato de respuesta
- `src/routes/persona.js` - Estandarizar formato de respuesta
- `src/services/monitoringService.js` - Integraci√≥n con alertas
- `AUTH_GUIDE.md` - Documentaci√≥n completa
- `docs/nodes-v2/observabilidad.md` - Actualizaci√≥n de nodo
- `docs/nodes-v2/14-infraestructura.md` - Actualizaci√≥n de nodo

**Nuevos archivos:**
- `tests/unit/middleware/sessionRefresh.test.js`
- `tests/integration/auth-session-refresh.test.js`

**Tests existentes a verificar:**
- `tests/e2e/auth-complete-flow.test.js`
- `tests/smoke/api-health.test.js`

---

## üîó Referencias

- **SSOT v2:** `docs/SSOT-V2.md` (secci√≥n 3 - Feature Flags)
- **Nodo Observabilidad:** `docs/nodes-v2/observabilidad.md`
- **Nodo Infraestructura:** `docs/nodes-v2/14-infraestructura.md`
- **AUTH_GUIDE:** `AUTH_GUIDE.md`
- **Issue:** ROA-524 (Linear)

---

## ‚ö†Ô∏è Notas Importantes

1. **No inventar AC:** Este plan asume AC basados en el t√≠tulo "Completion". Si hay AC espec√≠ficos en Linear, ajustar el plan.
2. **GDPR Compliance:** CR√çTICO - Verificar que NO se loggean datos personales.
3. **Feature Flag:** `ENABLE_SESSION_REFRESH` debe venir de SSOT (verificar si ya est√°).
4. **Tests:** M√≠nimo 90% coverage.
5. **CodeRabbit:** 0 comentarios antes de merge.

---

**Status:** ‚úÖ Plan creado - Esperando confirmaci√≥n de AC desde Linear

