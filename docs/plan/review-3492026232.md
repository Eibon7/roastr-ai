# CodeRabbit Review #3492026232 - Plan

**PR:** #902  
**Review URL:** https://github.com/Eibon7/roastr-ai/pull/902#pullrequestreview-3492026232  
**Date:** 2025-11-21

---

## Análisis

**Critical:** 0  
**Major:** 5 (code quality, consistency, maintainability)  
**Minor:** 12 (documentation, markdown linting)

### Issues por Archivo

| Archivo                            | Línea    | Tipo  | Impacto                            | Root Cause                                                       |
| ---------------------------------- | -------- | ----- | ---------------------------------- | ---------------------------------------------------------------- |
| `tests/helpers/tenantTestUtils.js` | 16-19    | Major | Confusion in mock toggle semantics | Env var naming inconsistency (`USE_MOCK` vs `USE_REAL_SUPABASE`) |
| `tests/helpers/tenantTestUtils.js` | 85-114   | Major | Docs clarity                       | Synthetic users not documented for real mode                     |
| `tests/helpers/tenantTestUtils.js` | 131-159  | Major | Code duplication                   | Synthetic user generation logic repeated                         |
| `tests/helpers/tenantTestUtils.js` | 604-671  | Major | Noisy logs                         | Auth admin cleanup runs in mock mode (throws errors)             |
| `tests/helpers/tenantTestUtils.js` | 227-235  | Major | Potential schema mismatch          | Hardcoded `plan_id: 'free'` may not exist                        |
| `tests/helpers/supabaseMock.js`    | 364-417  | Minor | Inconsistency                      | DELETE returns `data: null`, UPDATE returns `data: []`           |
| Various `.md` files                | Multiple | Minor | Markdown linting                   | Fenced code blocks without language tags                         |

---

## GDD

**Nodos:**

- `multi-tenant` (ya actualizado en main)
- `observability` (dependency, no changes needed)

**Actualizar:**

- N/A (Issue #894 ya documentado en multi-tenant.md)
- "Agentes Relevantes": Añadir TestEngineer si no está (ya está)

---

## Agentes

**Invocar:**

- ❌ Guardian - No necesario (no security issues)
- ❌ TaskAssessor - No necesario (fixes menores, no architecture)
- ✅ TestEngineer - Verificar que tests siguen pasando después de refactors

**Receipts:**

- `docs/agents/receipts/cursor-test-engineer-20251121.md` (si tests cambian)
- SKIP: Guardian, TaskAssessor - Solo refactors menores, no security/architecture

---

## Archivos

**Mencionados:**

- `tests/helpers/tenantTestUtils.js` (5 issues)
- `tests/helpers/supabaseMock.js` (1 issue)
- `docs/testing/SUPABASE-MOCK-SETUP.md` (nitpicks)
- `docs/agents/receipts/issue-894-*.md` (nitpicks)
- `ISSUE-894-SUMMARY.md` (nitpicks)
- `docs/investigation/issue-894-egress-analysis.md` (nitpicks)

**Dependientes:**

- `tests/integration/multi-tenant-rls-issue-801-crud.test.js` (usa tenantTestUtils, verificar que pasa)
- `.env.example` (verificar que documenta `USE_SUPABASE_MOCK`)

**Tests:**

- Unit: N/A (no lógica nueva)
- Integration: `npm test -- tests/integration/multi-tenant-rls-issue-801-crud.test.js` (35/35 debe seguir pasando)
- E2E: N/A

---

## Estrategia

### Orden

1. **Major (Code Quality - `tenantTestUtils.js`):**
   - Fix 1: Clarificar env var semantics (USE_MOCK vs USE_REAL_SUPABASE)
   - Fix 2: Skip auth.admin cleanup in mock mode (reduce noise)
   - Fix 3: DRY up synthetic user generation
   - Fix 4: Document synthetic users for real mode
   - Fix 5: Update `plan_id` to current schema default

2. **Minor (Consistency - `supabaseMock.js`):**
   - Fix 6: Normalize DELETE error response (`data: []` like UPDATE)

3. **Minor (Documentation):**
   - Fix 7: Add language tags to fenced code blocks in `.md` files

### Commits

1. `refactor(tests): Clarify mock toggle semantics + reduce cleanup noise`
   - Fixes 1, 2, 5
2. `refactor(tests): DRY up synthetic user generation`
   - Fix 3
3. `fix(tests): Normalize DELETE RLS error response shape`
   - Fix 6
4. `docs: Add language tags to fenced code blocks`
   - Fix 7
5. `docs(tests): Document synthetic auth users behavior`
   - Fix 4

### Tests

Ejecutar después de cada commit:

```bash
npm test -- tests/integration/multi-tenant-rls-issue-801-crud.test.js
# Expected: 35/35 passing
```

---

## Éxito

- [ ] 100% comentarios resueltos (17/17)
- [ ] Tests: 35/35 passing (0 regressions)
- [ ] Coverage: ≥94% (mantener actual)
- [ ] GDD health: ≥87 (mantener actual)
- [ ] CodeRabbit: 0 comentarios nuevos
- [ ] Logs limpios (no TypeError en mock mode cleanup)
- [ ] Documentación actualizada con .env semantics

---

**Estimated Effort:** 30 minutes  
**Priority:** P2 (code quality improvements, no blockers)
