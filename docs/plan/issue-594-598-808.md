# Plan de Implementaci√≥n: Issues #594 y #808 (Polar Payment Integration)

**Created:** 2025-11-11
**Issues:** #594 (Payment Flow con Polar), #808 (Migrar tests Polar)
**Estimated Time:** 8-10 horas
**Priority:** P1 (Critical para monetizaci√≥n)

---

## üéØ Objetivo

Completar la integraci√≥n de Polar como proveedor de pagos y asegurar 100% de cobertura en tests de billing.

---

## üìã Estado Actual (Assessment)

### Issue #594: ‚úÖ 70-80% IMPLEMENTADO

**‚úÖ Ya funciona:**

- Webhook handlers completos (`src/routes/polarWebhook.js`)
- Checkout flow (`src/routes/checkout.js`)
- Plan mapping (`src/utils/polarHelpers.js`, `src/config/planMappings.js`)
- Tests de seguridad y business logic (100+ tests)

**‚ùå Pendiente:**

1. Tablas de DB: `polar_subscriptions` y `polar_webhook_events`
2. EntitlementsService con Polar (actualmente solo Stripe)
3. Documentaci√≥n actualizada
4. Variables de entorno en `.env.example`

### Issue #808: ‚ö†Ô∏è 4/67 tests fallando

**Tests fallando:**

1. `should create checkout session with lookupKey parameter`
2. `should handle existing customer retrieval`
3. `should handle invalid lookup key validation`
4. `should handle subscription route catch block errors`

**Estrategia:** Opci√≥n B - Consolidar tests existentes (2-4h) en lugar de migrar todo

---

## üîß Plan de Implementaci√≥n

### FASE 1: Database Schema (#594)

**Archivos:**

- `database/migrations/027_polar_subscriptions.sql`
- `database/migrations/028_polar_webhook_events.sql`

**Tareas:**

1. Crear tabla `polar_subscriptions`:

   ```sql
   CREATE TABLE polar_subscriptions (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
     polar_subscription_id TEXT UNIQUE NOT NULL,
     plan TEXT NOT NULL CHECK (plan IN ('starter_trial', 'pro', 'creator_plus')),
     status TEXT NOT NULL CHECK (status IN ('active', 'trialing', 'past_due', 'canceled', 'unpaid')),
     current_period_start TIMESTAMPTZ NOT NULL,
     current_period_end TIMESTAMPTZ NOT NULL,
     trial_end TIMESTAMPTZ,
     cancel_at_period_end BOOLEAN DEFAULT FALSE,
     canceled_at TIMESTAMPTZ,
     created_at TIMESTAMPTZ DEFAULT NOW(),
     updated_at TIMESTAMPTZ DEFAULT NOW()
   );
   ```

2. Crear tabla `polar_webhook_events`:

   ```sql
   CREATE TABLE polar_webhook_events (
     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
     polar_event_id TEXT UNIQUE NOT NULL,
     event_type TEXT NOT NULL,
     payload JSONB NOT NULL,
     processed BOOLEAN DEFAULT FALSE,
     processed_at TIMESTAMPTZ,
     created_at TIMESTAMPTZ DEFAULT NOW()
   );
   ```

3. Crear √≠ndices y pol√≠ticas RLS
4. Ejecutar migraciones en Supabase

**Validaci√≥n:**

```bash
# Verificar migraci√≥n
node scripts/deploy-supabase-schema.js
```

---

### FASE 2: EntitlementsService con Polar (#594)

**Archivos:**

- `src/services/entitlementsService.js`

**Tareas:**

1. A√±adir m√©todo `setEntitlementsFromPolarPrice(userId, polarPriceId)`:
   - Similar a `setEntitlementsFromStripePrice` pero usando Polar
   - Usar `getPlanFromPriceId` de `polarHelpers.js`
   - Actualizar `account_entitlements` table

2. Actualizar constructor para soportar Polar:

   ```javascript
   constructor() {
     this.stripeWrapper = null;
     this.polarClient = null;

     if (flags.isEnabled('ENABLE_BILLING')) {
       // Mantener Stripe temporalmente
       this.stripeWrapper = new StripeWrapper(process.env.STRIPE_SECRET_KEY);

       // A√±adir Polar
       if (process.env.POLAR_ACCESS_TOKEN) {
         this.polarClient = new Polar({ accessToken: process.env.POLAR_ACCESS_TOKEN });
       }
     }
   }
   ```

3. Adaptar plan limits seg√∫n nuevo mapping:
   - `starter_trial` (Free) ‚Üí 0 persona fields, nivel fijo
   - `pro` ‚Üí Features completos
   - `creator_plus` ‚Üí Features premium

**Tests:**

```bash
npm test -- tests/unit/services/entitlementsService.test.js
```

---

### FASE 3: Arreglar Tests Fallando (#808)

**Archivo:**

- `tests/unit/routes/billing-coverage-issue502.test.js`

**Test 1: lookupKey parameter**

- **Problema:** Mock no configurado para `prices.list` con lookup_keys
- **Fix:** A√±adir mock response para Polar price lookup

**Test 2: existing customer retrieval**

- **Problema:** Mock customer retrieval no funciona con Polar
- **Fix:** Actualizar mock para usar email como customer_id (Polar usa email, no customer object)

**Test 3: invalid lookup key validation**

- **Problema:** Validaci√≥n no implementada para Polar
- **Fix:** A√±adir validaci√≥n en checkout route

**Test 4: subscription route catch block**

- **Problema:** Error handling no cubierto
- **Fix:** A√±adir test case espec√≠fico

**Validaci√≥n:**

```bash
npm test -- tests/unit/routes/billing-coverage-issue502.test.js --verbose
# Debe mostrar: 67/67 tests passing
```

---

### FASE 4: Consolidaci√≥n de Tests (#808)

**Objetivo:** Unificar cobertura entre billing-coverage-issue502.test.js, polarWebhook.business.test.js, checkout.security.test.js

**Tareas:**

1. Ejecutar cobertura completa:

   ```bash
   npm run test:coverage -- --collectCoverageFrom="src/routes/billing.js"
   npm run test:coverage -- --collectCoverageFrom="src/routes/checkout.js"
   npm run test:coverage -- --collectCoverageFrom="src/routes/polarWebhook.js"
   ```

2. Identificar gaps de cobertura
3. A√±adir tests faltantes si coverage <90%
4. Documentar qu√© archivo de tests cubre qu√© funcionalidad

**Target:** ‚â•90% cobertura en todos los archivos de billing/Polar

---

### FASE 5: Documentaci√≥n (#594)

**Archivos a actualizar:**

1. **`.env.example`** - A√±adir variables Polar completas:

   ```bash
   # Polar Integration
   POLAR_ACCESS_TOKEN=your_token_here
   POLAR_WEBHOOK_SECRET=your_webhook_secret
   POLAR_STARTER_PRICE_ID=your_starter_price_id
   POLAR_PRO_PRICE_ID=your_pro_price_id
   POLAR_PLUS_PRICE_ID=your_plus_price_id
   POLAR_ALLOWED_PRICE_IDS=comma,separated,list
   POLAR_SUCCESS_URL=https://yourapp.com/success
   ```

2. **`docs/flows/payment-polar.md`** - Actualizar con:
   - Estado real: "80% implementado"
   - C√≥digo completo de webhook handlers
   - Diagramas actualizados
   - Referencia a archivos existentes

3. **`docs/nodes/billing.md`** - Actualizar:
   - Cambiar "Stripe" a "Polar + Stripe (legacy)"
   - Actualizar cobertura real
   - A√±adir "Agentes Relevantes": BackendDev, TestEngineer, Guardian

4. **`docs/issues/issue-payment-polar.md`** - Marcar items completados

5. **`CLAUDE.md`** - A√±adir secci√≥n Polar:

   ```markdown
   ## Polar Integration (Issue #594)

   **Status:** Production Ready (80% complete)

   **Environment Variables:**

   - POLAR_ACCESS_TOKEN
   - POLAR_WEBHOOK_SECRET
   - POLAR\_\*\_PRICE_ID

   **Files:**

   - src/routes/polarWebhook.js - Webhook handlers
   - src/routes/checkout.js - Checkout flow
   - src/utils/polarHelpers.js - Plan mapping
   ```

---

### FASE 6: Validaci√≥n Completa

**GDD Validation:**

```bash
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci  # Must be ‚â•87
node scripts/predict-gdd-drift.js --full  # Must be <60
```

**Test Suite:**

```bash
# Todos los tests deben pasar
npm test

# Cobertura ‚â•90%
npm run test:coverage
```

**CodeRabbit:**

```bash
npm run coderabbit:review
# Debe retornar 0 comentarios
```

---

## üìÅ Archivos Afectados

### Nuevos archivos:

- `database/migrations/027_polar_subscriptions.sql`
- `database/migrations/028_polar_webhook_events.sql`

### Archivos a modificar:

- `src/services/entitlementsService.js` (a√±adir Polar support)
- `tests/unit/routes/billing-coverage-issue502.test.js` (arreglar 4 tests)
- `.env.example` (a√±adir variables Polar)
- `docs/flows/payment-polar.md` (actualizar estado)
- `docs/nodes/billing.md` (a√±adir Polar, actualizar Agentes Relevantes)
- `CLAUDE.md` (documentar Polar)

### Sin cambios (ya completos):

- `src/routes/polarWebhook.js` ‚úÖ
- `src/routes/checkout.js` ‚úÖ
- `src/utils/polarHelpers.js` ‚úÖ
- `src/config/planMappings.js` ‚úÖ
- `tests/unit/routes/polarWebhook.business.test.js` ‚úÖ
- `tests/unit/routes/checkout.security.test.js` ‚úÖ

---

## üéØ Criterios de Aceptaci√≥n

### Issue #594:

- [x] Webhook handlers completos (YA HECHO)
- [x] Checkout flow funcional (YA HECHO)
- [x] Plan mapping implementado (YA HECHO)
- [ ] Tablas DB creadas y migradas
- [ ] EntitlementsService con Polar
- [ ] Documentaci√≥n actualizada
- [ ] Variables de entorno documentadas
- [ ] Tests ‚â•90% cobertura

### Issue #808:

- [ ] 4 tests fallando arreglados
- [ ] Todos los tests pasan (0 failing)
- [ ] Cobertura ‚â•90% en billing/checkout/polarWebhook
- [ ] Documentaci√≥n de cobertura actualizada

### General:

- [ ] GDD health ‚â•87
- [ ] GDD drift <60
- [ ] CodeRabbit = 0 comentarios
- [ ] CI/CD passing
- [ ] Receipts generados (TestEngineer, Guardian, BackendDev)

---

## üöÄ Orden de Ejecuci√≥n

1. **FASE 1:** Database Schema (30 min)
2. **FASE 3:** Arreglar tests fallando (1-2h) ‚Üê Prioridad para quick win
3. **FASE 4:** Consolidar cobertura (1h)
4. **FASE 2:** EntitlementsService (1-2h)
5. **FASE 5:** Documentaci√≥n (1h)
6. **FASE 6:** Validaci√≥n completa (30 min)

**Total estimado:** 5-8 horas

---

## üìä Agentes Relevantes

- **BackendDev** - Database schema, EntitlementsService
- **TestEngineer** - Arreglar tests, validar cobertura
- **Guardian** - Validar security, GDD compliance
- **Documentation** - Actualizar docs, .env.example

---

**Siguiente paso:** Empezar con FASE 3 (arreglar tests) para quick win, luego FASE 1 (DB schema).
