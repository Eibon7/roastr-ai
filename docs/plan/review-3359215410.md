# CodeRabbit Review Plan - #3359215410

**PR:** #621 - Auto-generate GDD metrics from JSON files
**Review URL:** https://github.com/Eibon7/roastr-ai/pull/621#pullrequestreview-3359215410
**Date:** 2025-10-21

---

## Estado Actual

**C√≥digo afectado:** `scripts/sync-gdd-metrics.js`

**Comentarios recibidos:** 1 total

- **Major:** 1 comentario

**An√°lisis inicial:**

- Help documentation menciona `--metric=<name>` pero no est√° implementado
- CLI siempre sincroniza todas las m√©tricas, ignorando la opci√≥n
- Funcionalidad anunciada pero no entregada (broken promise)

---

## Comentarios por Severidad

### üü† Major - Feature Implementation

**Issue 1: Implement the advertised --metric filter**

- **Location:** `scripts/sync-gdd-metrics.js:412` (also applies to lines 470-476, 507-529, 531-551)
- **Type:** Bug - Missing feature implementation
- **Severity:** Major
- **Impact:** Users can't filter specific metrics, misleading documentation

**Problem:**

```javascript
// Line 412 - Always collects ALL metrics
const metrics = await collector.collectAll();

// Lines 470-551 - Uses all metrics, ignores --metric option
const updater = new DocumentUpdater(this.rootDir, { dryRun: true });
const issues = await updater.validate(metrics); // All metrics
const results = await updater.updateAll(metrics); // All metrics
```

**Root cause:**

1. Help text advertises `--metric=<name>` option
2. Option is parsed in `parseArgs()` but never used
3. No filtering logic between collection and usage
4. Broken contract: documentation promises feature that doesn't exist

**Fix required:**

- Add filtering logic after `collectAll()`
- Support aliases: `lighthouse`, `node/nodecount/nodes`, `health/healthscore`, `coverage`
- Set unused metrics to `null` in filtered object
- Use filtered metrics in validate() and updateAll()
- Update help text with accepted values

---

## GDD Nodes Affected

**Primary:**

- `docs/nodes/system-health.md` (health scoring uses this script)

**Secondary:**

- `docs/nodes/testing-quality.md` (affects test reliability)

**Validation:** Run `node scripts/resolve-graph.js --validate` after changes

**Updates needed:**

- None (no architectural changes, only feature implementation)

---

## Subagentes

**Test Engineer Agent:**

- Create tests for --metric filtering (each metric type)
- Verify filtered metrics contain only requested metric
- Test invalid metric names (should sync all or error?)
- Ensure existing tests still pass

**No other agents needed** (pure feature implementation, no architecture/UI/security changes)

---

## Archivos Afectados

**Code:**

1. `scripts/sync-gdd-metrics.js` (add filtering logic after line 412)

**Tests:** 2. `tests/unit/scripts/sync-gdd-metrics.test.js` (add filtering tests)

**Dependencies:**

- None (no new imports)

**Total:** 2 files

---

## Estrategia de Implementaci√≥n

**Order:**

1. Add filtering logic in CLI.run() after collectAll()
2. Support aliases (lighthouse, node, health, coverage)
3. Apply filtered metrics to validate() and updateAll()
4. Update help text with accepted values
5. Add tests for each metric filter
6. Test invalid metric names
7. Run full test suite

**Commits:**

- Single commit with feature implementation + tests
- Commit message: `feat: Implement --metric filter - CodeRabbit #3359215410`

**Testing plan:**

1. Unit test: `--metric=lighthouse` filters correctly
2. Unit test: `--metric=node` (alias for nodeCount)
3. Unit test: `--metric=health` (alias for healthScore)
4. Unit test: `--metric=coverage` filters correctly
5. Unit test: No --metric syncs all (existing behavior)
6. Integration test: Verify filtered update only affects target metric
7. Test invalid metric name behavior

---

## Criterios de √âxito

**Functional:**

- ‚úÖ `--metric=lighthouse` syncs only Lighthouse score
- ‚úÖ `--metric=node` syncs only node count
- ‚úÖ `--metric=health` syncs only health score
- ‚úÖ `--metric=coverage` syncs only coverage
- ‚úÖ Aliases work (node/nodecount/nodes, health/healthscore)
- ‚úÖ No --metric syncs all (backward compatible)

**Quality:**

- ‚úÖ 100% tests passing
- ‚úÖ Coverage maintained or improved
- ‚úÖ Help text updated with accepted values
- ‚úÖ No regressions (existing tests still pass)

**GDD:**

- ‚úÖ GDD validation passes
- ‚úÖ Health score ‚â•87
- ‚úÖ No drift introduced

---

## Validation Commands

```bash
# Run updated tests
npm test tests/unit/scripts/sync-gdd-metrics.test.js

# Test filtering manually
node scripts/sync-gdd-metrics.js --metric=lighthouse --dry-run
node scripts/sync-gdd-metrics.js --metric=node --dry-run
node scripts/sync-gdd-metrics.js --metric=health --dry-run
node scripts/sync-gdd-metrics.js --metric=coverage --dry-run

# Test without filter (should sync all)
node scripts/sync-gdd-metrics.js --dry-run

# GDD validation
node scripts/validate-gdd-runtime.js --full
node scripts/compute-gdd-health.js --threshold=87
```

---

## Risk Assessment

**Low Risk:**

- Localized changes (1 file, ~20 lines added)
- Pure feature addition, no breaking changes
- Backward compatible (no --metric = sync all)
- Existing tests cover happy path

**Mitigation:**

- Add comprehensive tests before applying feature
- Test each metric filter manually
- Verify backward compatibility (no --metric)

---

## Design Decisions

**Aliases:**

- `lighthouse` ‚Üí `lighthouse`
- `node`, `nodecount`, `nodes` ‚Üí `nodeCount`
- `health`, `healthscore` ‚Üí `healthScore`
- `coverage` ‚Üí `coverage`

**Rationale:** User-friendly, case-insensitive, multiple forms accepted

**Filtered Object:**

- Set unused metrics to `null`
- Preserve timestamp
- Structure: `{ lighthouse: null, nodeCount: X, healthScore: null, coverage: null, timestamp: ... }`

**Invalid metric:**

- Option 1: Sync all metrics (lenient, backward compatible)
- Option 2: Error and exit 1 (strict, clear feedback)
- **Decision:** Option 1 (lenient) - matches current behavior, user-friendly

---

## Timeline

1. **Plan created** ‚úÖ (docs/plan/review-3359215410.md)
2. **Implement filtering logic** ‚Üí 15 min
3. **Update help text** ‚Üí 5 min
4. **Write filter tests** ‚Üí 25 min
5. **Run full suite** ‚Üí 5 min
6. **Manual testing** ‚Üí 10 min
7. **Create evidence** ‚Üí 10 min
8. **Commit & push** ‚Üí 5 min

**Total estimated:** ~75 minutes

---

## Next Steps

1. ‚úÖ Plan saved
2. ‚è≥ Implement filtering logic after collectAll()
3. ‚è≥ Add alias mapping
4. ‚è≥ Apply filtered metrics to validate/updateAll
5. ‚è≥ Update help text
6. ‚è≥ Add comprehensive filter tests
7. ‚è≥ Run tests and verify
8. ‚è≥ Manual testing of each filter
9. ‚è≥ Create evidence documentation
10. ‚è≥ Commit with proper message
11. ‚è≥ Push and verify CI

**Status:** READY TO EXECUTE

---

**Prepared by:** Orchestrator
**Approved by:** [Awaiting user approval]
**Start time:** 2025-10-21T07:50:00Z
