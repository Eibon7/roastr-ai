# CodeRabbit Review Implementation Plan - #3438504879

**PR:** #756
**Review ID:** 3438504879
**Date:** 2025-11-08
**Branch:** `claude/work-on-issues-011CUu8p8q5FGKti8WseVqbw`
**Status:** âœ… READY FOR IMPLEMENTATION

---

## 1. Executive Summary

CodeRabbit has escalated the M1 integration tests (previously deferred in review #3438481794) to **CRITICAL** severity. The review flags that 3 integration tests identified in the plan document were never created:

- `tests/integration/trial-expiry.integration.test.js` - MISSING
- `tests/integration/early-upgrade.integration.test.js` - MISSING
- `tests/integration/worker-enforcement.integration.test.js` - MISSING

**Root Cause:** M1 was deferred to "FASE 2 - PR separado" in commit 85bb49d3, but CodeRabbit requires these tests within the current PR scope for completion validation.

**Resolution:** Implement all 3 integration tests NOW to satisfy the CRITICAL requirement.

---

## 2. Issue Analysis by Severity

### ðŸ”´ CRITICAL (1 issue)

#### C1: Missing M1 Integration Tests
- **File:** `docs/plan/review-3438481794.md` (lines 103-106, 148-166)
- **Severity:** ðŸ”´ CRITICAL (escalated from MAJOR)
- **Description:** Plan document identifies 3 integration tests as needed, but they were never created
- **Impact:**
  - Incomplete test coverage for trial model business logic
  - Potential undetected regressions in trial expiry, early upgrade, worker enforcement
  - PR cannot be considered complete without verification tests
- **Required Action:** Create 3 missing integration test files with comprehensive test cases

**Test Requirements (from plan lines 148-166):**

1. **trial-expiry.integration.test.js**
   - Signup with starter_trial
   - Mock time advance (30 days)
   - Trigger worker job / subscription check
   - Assert: `subscription_status = 'expired'`, access revoked
   - Assert: `plan` unchanged (still `starter_trial`)

2. **early-upgrade.integration.test.js**
   - User on starter_trial (day 10/30)
   - Upgrade to `pro` via Stripe/Polar webhook
   - Assert: Plan switches to `pro`, trial canceled
   - Assert: Billing reflects pro pricing

3. **worker-enforcement.integration.test.js**
   - Mock worker scheduler
   - Test `isPlanActive()` at trial expiry
   - Test tier limit enforcement (roasts/comments/Shield)
   - Assert: Access disabled for expired plans

---

## 3. Affected GDD Nodes

| Node | Why Affected | Update Required |
|------|--------------|-----------------|
| `docs/nodes/testing.md` | New integration tests added | Update test inventory + coverage |
| `docs/nodes/trial-system.md` | Trial business logic validation | Reference new test files |
| `docs/nodes/billing.md` | Webhook + early upgrade tests | Link to early-upgrade test |
| `docs/nodes/workers.md` | Worker enforcement logic validated | Reference worker-enforcement test |

**Node-Agent Matrix Update:**
- Testing node: Add "Test Engineer" to "Agentes Relevantes"
- Trial System node: Add "Test Engineer"

---

## 4. Implementation Strategy

### Priority Order
1. **C1 - Trial Expiry Test** (Core business logic - highest risk)
2. **C1 - Early Upgrade Test** (Revenue critical - payment flow)
3. **C1 - Worker Enforcement Test** (System stability - worker behavior)

### Test Design Principles
- **Mock Time Manipulation:** Use Jest fake timers for 30-day advance
- **Supabase Mocking:** Use `tests/helpers/supabaseMockFactory.js` pattern
- **Integration Level:** Test interactions between services (not isolated units)
- **Realistic Fixtures:** Use production-like data structures
- **Cleanup:** Proper teardown to avoid test pollution
- **Assertions:** Verify both positive and negative cases

### Pattern to Follow
Based on `tests/integration/plan-change-flow.test.js`:
```javascript
// 1. Mock all dependencies BEFORE requiring modules
jest.mock('../../src/config/supabase');
jest.mock('../../src/utils/logger');

// 2. Create comprehensive mock Supabase
const mockSupabase = { from: jest.fn(...), rpc: jest.fn(...) };

// 3. Configure beforeEach/afterEach for test isolation
beforeEach(() => {
  jest.clearAllMocks();
  mockSupabase._reset();
});

// 4. Test cases with clear AAA structure (Arrange-Act-Assert)
```

---

## 5. Test Specifications

### Test File 1: trial-expiry.integration.test.js

**Purpose:** Verify trial expiration enforcement per TRIAL-MODEL.md Section 2

**Test Cases:**
1. âœ… `should expire trial after 30 days and revoke access`
   - Create user with `starter_trial`, `trial_end = NOW() + 30 days`
   - Advance time 30 days (Jest fake timers)
   - Call `isPlanActive(userId)` or trigger BillingWorker
   - Assert: `subscription_status = 'expired'`
   - Assert: `plan` still `starter_trial` (unchanged)
   - Assert: Worker rejects roast generation job

2. âœ… `should maintain read-only access after expiry`
   - User with expired trial
   - Attempt to access analytics dashboard
   - Assert: UI visible, no 403 error
   - Attempt to trigger roast generation
   - Assert: 403 Forbidden or proper error message

3. âœ… `should send expiry notification email`
   - Mock emailService
   - Trigger trial expiry
   - Assert: Email sent to user.email with "Trial expired" subject

**Mocks Required:**
- `supabaseServiceClient` (user_subscriptions, users tables)
- `emailService` (for expiry notifications)
- `logger` (to prevent winston errors)
- Jest fake timers (`jest.useFakeTimers()`)

---

### Test File 2: early-upgrade.integration.test.js

**Purpose:** Verify early upgrade workflow per TRIAL-MODEL.md Section 3

**Test Cases:**
1. âœ… `should upgrade from starter_trial to pro mid-trial`
   - Create user: `plan = 'starter_trial'`, `trial_end = NOW() + 20 days`
   - Simulate Stripe webhook: `checkout.session.completed` for Pro plan
   - Assert: `plan = 'pro'`
   - Assert: `trial_end = null` (trial canceled)
   - Assert: `subscription_status = 'active'`

2. âœ… `should start billing immediately on early upgrade`
   - User at day 10/30 of trial
   - Upgrade to Pro via Polar webhook
   - Assert: `current_period_start = NOW()` (billing starts immediately)
   - Assert: Trial no longer counted in usage limits

3. âœ… `should handle webhook idempotency`
   - Send `order.created` webhook twice (duplicate)
   - Assert: Only one subscription record created
   - Assert: No duplicate charges or double upgrades

**Mocks Required:**
- `supabaseServiceClient` (users, user_subscriptions)
- Stripe/Polar webhook payloads (realistic fixtures)
- `workerNotificationService` (plan change notifications)

---

### Test File 3: worker-enforcement.integration.test.js

**Purpose:** Verify worker-level enforcement per TRIAL-MODEL.md Section 2

**Test Cases:**
1. âœ… `should reject roast generation for expired trial`
   - User: `plan = 'starter_trial'`, `subscription_status = 'expired'`
   - Enqueue roast generation job
   - Worker: Call `isPlanActive(userId)`
   - Assert: Job rejected with "Trial expired" reason
   - Assert: No OpenAI API call made

2. âœ… `should enforce tier limits during trial`
   - User: `plan = 'starter_trial'` (limit: 10 roasts/month)
   - Generate 10 roasts successfully
   - Attempt 11th roast
   - Assert: Rejected with "Limit exceeded" (not "Trial expired")

3. âœ… `should allow Shield moderation during trial`
   - User: `plan = 'starter_trial'`, `subscription_status = 'active'`
   - Trigger Shield action (block user)
   - Assert: Action executed successfully
   - Assert: Shield enabled during trial

4. âœ… `should disable all processing on trial expiry`
   - Expired trial user attempts:
     - Roast generation â†’ Rejected
     - Comment analysis â†’ Rejected
     - Shield action â†’ Rejected
   - Assert: All 3 operations fail with "Trial expired"

**Mocks Required:**
- Queue service (job enqueuing)
- Worker methods (`isPlanActive`, tier limit checks)
- OpenAI API (verify NOT called for expired users)
- Shield service

---

## 6. Files to Create

### New Files (3)
- âœ… `tests/integration/trial-expiry.integration.test.js` (~150 lines)
- âœ… `tests/integration/early-upgrade.integration.test.js` (~120 lines)
- âœ… `tests/integration/worker-enforcement.integration.test.js` (~180 lines)

**Total LOC:** ~450 lines

---

## 7. Validation Strategy

### Phase 1: Syntax Check
```bash
node -c tests/integration/trial-expiry.integration.test.js
node -c tests/integration/early-upgrade.integration.test.js
node -c tests/integration/worker-enforcement.integration.test.js
```

### Phase 2: Run New Tests Isolated
```bash
npm test -- tests/integration/trial-expiry.integration.test.js
npm test -- tests/integration/early-upgrade.integration.test.js
npm test -- tests/integration/worker-enforcement.integration.test.js
```

**Expected:** 10+ tests passing (3-4 per file)

### Phase 3: Full Integration Suite
```bash
npm test -- tests/integration/
```

**Expected:** No regressions, all existing + new tests passing

---

## 8. Commit Strategy

### Single Commit (all 3 tests together)

**Message Template:**
```
test(trial): Add M1 integration tests for trial expiry, early upgrade, and worker enforcement

Resolves CodeRabbit Review #3438504879 (CRITICAL - M1 integration tests missing)

This commit creates the 3 integration tests identified in review #3438481794 plan
(lines 103-106, 148-166) that were deferred but are now required for PR completion.

## New Test Files

### 1. trial-expiry.integration.test.js
- Tests 30-day trial expiration enforcement (TRIAL-MODEL.md Section 2)
- Verifies subscription_status = 'expired', plan unchanged
- Validates read-only access maintained post-expiry
- Confirms expiry notification emails sent

### 2. early-upgrade.integration.test.js
- Tests mid-trial upgrade to paid plan (TRIAL-MODEL.md Section 3)
- Verifies immediate trial cancellation on upgrade
- Validates billing cycle starts immediately
- Tests webhook idempotency for duplicate events

### 3. worker-enforcement.integration.test.js
- Tests worker-level trial enforcement
- Verifies isPlanActive() rejects expired trials
- Tests tier limit enforcement during active trial
- Validates Shield/roast/analysis disabled on expiry

## Test Coverage

- **Trial expiry:** 3 test cases (expiry enforcement, read-only, notifications)
- **Early upgrade:** 3 test cases (upgrade flow, billing, idempotency)
- **Worker enforcement:** 4 test cases (roast rejection, limits, Shield, expiry)

Total: 10 integration tests covering all TRIAL-MODEL.md workflows

## Implementation Details

- Follows pattern from tests/integration/plan-change-flow.test.js
- Uses supabaseMockFactory.js for consistent mocking
- Jest fake timers for 30-day time manipulation
- Realistic webhook fixtures (Stripe + Polar)
- Proper cleanup in afterEach blocks

## Related

- CodeRabbit Review: #3438504879 (CRITICAL)
- Previous Review: #3438481794 (M1 deferred, now implemented)
- Business Spec: docs/TRIAL-MODEL.md
- Plan Document: docs/plan/review-3438481794.md (lines 148-166)

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## 9. Risk Analysis

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Tests fail on first run | High | Medium | TDD approach: Write failing tests first, verify they fail for right reason |
| Mock complexity breaks tests | Medium | High | Use supabaseMockFactory.js helper, copy patterns from existing tests |
| Time manipulation causes flaky tests | Medium | Medium | Use Jest fake timers consistently, avoid real setTimeout |
| Webhook fixtures incorrect | Low | High | Copy actual webhook payloads from Stripe/Polar docs |
| Integration test too slow | Low | Low | Mock external services, no real API calls |

**Mitigation Summary:** Follow existing patterns rigorously, use test helpers, validate mocks match production behavior.

---

## 10. Success Criteria

### âœ… Definition of Done
- [ ] All 3 test files created in `tests/integration/`
- [ ] Syntax validation passes for all 3 files
- [ ] Each file has 3-4 test cases (10+ total)
- [ ] All new tests passing (npm test isolated + full suite)
- [ ] No regressions in existing integration tests
- [ ] Code follows coderabbit-lessons.md patterns:
  - [ ] Mocks created BEFORE jest.mock() calls
  - [ ] Logger destructured: `const { logger } = require(...)`
  - [ ] Proper cleanup in afterEach
  - [ ] AAA structure (Arrange-Act-Assert)
- [ ] GDD nodes updated (testing.md, trial-system.md)
- [ ] Commit message follows template
- [ ] Push successful to PR #756

**Acceptance:** CodeRabbit review #3438504879 RESOLVED (no pending comments)

---

## 11. References

### Related Files
- `docs/TRIAL-MODEL.md` - Business specification for trial model
- `docs/plan/review-3438481794.md` - Original plan identifying M1 gap
- `tests/integration/plan-change-flow.test.js` - Pattern reference
- `tests/integration/trial-management.test.js` - Existing trial tests (skipped, needs real DB)
- `tests/helpers/supabaseMockFactory.js` - Mock factory helper

### Related Issues
- PR #756 - Free â†’ starter_trial migration
- Issue #484 - Trial system implementation
- CodeRabbit #3438481794 - Previous review (M1 deferred)
- CodeRabbit #3438504879 - Current review (M1 escalated to CRITICAL)

---

**Plan Author:** Orchestrator (Claude Code)
**Plan Reviewer:** (Awaiting User Approval)
**Implementation Start:** 2025-11-08
**Estimated Completion:** 2025-11-08 (same day)
