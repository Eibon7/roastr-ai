# Implementation Plan: CodeRabbit Review #3302088539

**Date:** 2025-10-05
**PR:** #459 (Complete Billing DI Refactor with Full Test Coverage - Issue #413)
**Review URL:** [PR #459 Review #3302088539](https://github.com/Eibon7/roastr-ai/pull/459#pullrequestreview-3302088539)
**Priority:** P0 (Critical lint errors + Major correctness issues)

---

## FASE 0: Análisis de Comentarios

### Comentarios por Severidad

#### 🔴 Critical (1 comentario - BLOCKING)

**1. Switch Case Declarations Violate noSwitchDeclarations**
- **File:** `src/routes/billingController.js` (lines 62-156)
- **Category:** Code Correctness - Lint Violation (Biome)
- **Issue:** Each switch case declares `const` bindings at top level, which leak into sibling cases. Biome lint rule `noSwitchDeclarations` fails.
- **Impact:** CRITICAL - Blocks CI pipeline, prevents merge
- **Risk:** HIGH - Code won't pass lint checks

**CodeRabbit Comment:**
```text
🔴 Critical

Wrap each switch case body in braces to satisfy `noSwitchDeclarations`

Biome flags every case block because `const` declarations live directly under
the `switch`, so they leak into sibling cases and fail the lint pipeline.
Enclose each case body in its own block so the bindings stay scoped and the
linter stops erroring.
```

**Affected Cases:**
- `payment_failed` (lines 68-72)
- `subscription_cancelled` (lines 84-88)
- `subscription_updated` (lines 99-103, 106-106)
- `payment_succeeded` (lines 128-132)
- `invoice_payment_action_required` (lines 143-147)

**Fix Required:**
Add `{ }` braces around each case body to scope declarations.

#### 🟠 Major (3 comentarios)

**2. Service Getters Lost on module.exports Reassignment**
- **File:** `src/routes/billing.js` (lines 33-44)
- **Category:** Code Correctness - Export Pattern
- **Issue:** Lazy getters defined on `exports`, but `module.exports = router` reassignment severs them. Callers like `require('./billing').webhookService` get `undefined`.
- **Impact:** MAJOR - Breaking change for backward compatibility
- **Risk:** HIGH - Runtime errors in dependent modules

**CodeRabbit Comment:**
```text
🟠 Major

Service getters are dropped by the final `module.exports`

You add lazy getters on `exports`, but later overwrite `module.exports = router`.
That reassignment severs the getters (and the legacy helpers defined below), so
callers like `require('./billing').webhookService` suddenly get `undefined`.
Bind the getters directly on `router` (and attach the legacy functions before
exporting) to keep backward compatibility.
```

**Affected Getters:**
- `stripeWrapper`
- `queueService`
- `entitlementsService`
- `webhookService`

**Fix Required:**
Define getters on `router` object instead of `exports`.

**3. Test Evidence Claims 17/17 Passing (Actual: 6/16)**
- **File:** `docs/test-evidence/issue-413/SUMMARY.md` (lines 12-219)
- **Category:** Documentation Accuracy - Test Results
- **Issue:** Summary advertises "17/17 passing (100%)" and completed DI refactor, but PR only has 6/16 tests passing.
- **Impact:** MAJOR - Misleads stakeholders about completion status
- **Risk:** MEDIUM - False sense of completion, blocks accurate roadmap

**CodeRabbit Comment:**
```text
🟠 Major

Correct the test evidence.

Summary advertises 17/17 passing and completed DI refactor, but this PR only
gets 6/16 passing so far. Please rewrite the evidence to reflect the actual
Jest run; otherwise it gives a false sense of completion.
```

**Fix Required:**
- Update headline to "6/16 passing (37.5%)"
- Reword completion claims as "in progress"
- List actual passing/failing tests from Jest output
- Update achievements to reflect current state
- Document remaining work in "Next Steps"

**4. Test Webhook Secret Triggers Gitleaks**
- **File:** `tests/integration/stripeWebhooksFlow.test.js` (line 88)
- **Category:** Security - Secret Detection
- **Issue:** Literal `whsec_test123456789abcdef` matches Stripe's secret format, triggering gitleaks scanner at high severity.
- **Impact:** MAJOR - Blocks CI pipeline (security scan failure)
- **Risk:** MEDIUM - False positive but blocks merge

**CodeRabbit Comment:**
```text
🟠 Major

Replace the test webhook secret to avoid gitleaks block

The literal `whsec_…` value matches Stripe's secret format and is tripping
gitleaks at high severity, even though it's only a fixture. Swap it for
something obviously fake (e.g. `whsec_test_placeholder`) or load from an env
var so the scanner stops failing the pipeline.
```

**Fix Required:**
Replace with `whsec_test_placeholder` or similar obviously-fake value.

#### 🟡 Minor (4 comentarios - Documentation Quality)

**5. Billing Node Status Inconsistency**
- **Files:** `docs/nodes/billing.md` vs `docs/system-map.yaml` (lines 126-137)
- **Category:** Documentation Consistency
- **Issue:** nodes/billing.md says "✅ Completado (DI refactor v2.0)" but system-map.yaml says `status: refactoring`
- **Impact:** LOW - Confuses roadmap consumers
- **Risk:** LOW - Documentation only

**6. Test Progress Stale in billing-refactor-di.md**
- **File:** `docs/plan/billing-refactor-di.md` (lines 3-23)
- **Category:** Documentation Accuracy
- **Issue:** Plan says "12/16 tests pasando (75%)" but actual is 6/16 (37.5%)
- **Impact:** LOW - Outdated metrics
- **Risk:** LOW - Documentation only

**7. Test Progress Stale in issue-413-final-fixes.md**
- **File:** `docs/plan/issue-413-final-fixes.md` (lines 3-23)
- **Category:** Documentation Accuracy
- **Issue:** Plan says "12/16 tests pasando" but actual is 6/16
- **Impact:** LOW - Outdated metrics
- **Risk:** LOW - Documentation only

**8. Markdown Lint Violation in billing.md**
- **File:** `docs/nodes/billing.md` (line 94)
- **Category:** Documentation Quality - Markdown Linting
- **Issue:** Fenced code block missing language specifier (MD040)
- **Impact:** VERY LOW - Linting warning only
- **Risk:** VERY LOW - Documentation quality

### Categorización

| Type | Count | Severity | Files Affected |
|------|-------|----------|----------------|
| Code Correctness - Lint Violation | 1 | Critical | billingController.js |
| Code Correctness - Export Pattern | 1 | Major | billing.js |
| Documentation Accuracy - Test Results | 1 | Major | test-evidence/issue-413/SUMMARY.md |
| Security - Secret Detection | 1 | Major | stripeWebhooksFlow.test.js |
| Documentation Consistency | 1 | Minor | billing.md, system-map.yaml |
| Documentation Accuracy - Metrics | 2 | Minor | 2 planning documents |
| Documentation Quality - Markdown | 1 | Minor | billing.md |
| **TOTAL** | **8** | - | **7** |

**Priority Order:**
1. 🔴 Critical: Fix switch case declarations (blocks CI)
2. 🟠 Major: Fix service getters export (breaks backward compatibility)
3. 🟠 Major: Fix test webhook secret (blocks CI)
4. 🟠 Major: Update test evidence to accurate state
5. 🟡 Minor: Fix documentation inconsistencies and markdown linting

---

## FASE 1: Diseño GDD

### Nodos Afectados

**Primary Node:** `billing`
- **Impacto:** Critical bug fixes in billing webhook processing
- **Cambios:**
  - Fix switch case scoping in billingController.js
  - Fix export pattern in billing.js routes
  - Update documentation to reflect actual state
- **Archivo:** `docs/nodes/billing.md`

**Secondary Nodes:** NONE
- Changes are isolated to billing module

### Validación de Dependencias

**Edges Afectados:**
```text
billing depends on:
  - cost-control (no changes)
  - queue-system (no changes)
  - multi-tenant (no changes)
  - plan-features (no changes)

No downstream impacts - billing is a leaf node in usage graph
```

**Resultado:** ✅ No dependencies broken

---

## FASE 2: Subagentes

**Back-end Dev** (Asignado - Critical fixes)
- Fix switch case declarations in billingController.js
- Fix export pattern in billing.js
- Replace test webhook secret

**Documentation Agent** (Asignado - Accuracy)
- Update test evidence to reflect 6/16 passing
- Sync billing node status across files
- Update test progress in planning documents
- Fix markdown linting

**Test Engineer** (Review)
- Verify lint passes after switch case fix
- Confirm no regressions in test suite

**Other Agents:** NO requerido

---

## FASE 3: Archivos Afectados

### Archivos Modificados

**1. `src/routes/billingController.js`** (~20 líneas modificadas)

**Critical Fix: Wrap switch cases in braces**

```diff
    try {
      // Extract common data from webhook
      let jobData = {};

      switch (jobType) {
-       case 'payment_failed':
+       case 'payment_failed': {
          const { data: failedUserSub } = await this.supabaseClient
            .from('user_subscriptions')
            .select('user_id')
            .eq('stripe_customer_id', webhookData.customer)
            .single();

          jobData = {
            userId: failedUserSub?.user_id,
            customerId: webhookData.customer,
            invoiceId: webhookData.id,
            amount: webhookData.amount_due,
            attemptCount: 0
          };
          break;
+       }

-       case 'subscription_cancelled':
+       case 'subscription_cancelled': {
          const { data: cancelledUserSub } = await this.supabaseClient
            .from('user_subscriptions')
            .select('user_id')
            .eq('stripe_customer_id', webhookData.customer)
            .single();

          jobData = {
            userId: cancelledUserSub?.user_id,
            customerId: webhookData.customer,
            subscriptionId: webhookData.id,
            cancelReason: webhookData.cancellation_details?.reason || 'user_requested'
          };
          break;
+       }

        // ... same pattern for other 3 cases
      }
```

**Rationale:**
- Biome `noSwitchDeclarations` requires block scoping
- Prevents variable leakage between cases
- Standard JavaScript best practice

**2. `src/routes/billing.js`** (~10 líneas modificadas)

**Major Fix: Define getters on router instead of exports**

```diff
- Object.defineProperty(exports, 'stripeWrapper', {
+ Object.defineProperty(router, 'stripeWrapper', {
    get: () => getController().stripeWrapper
  });
- Object.defineProperty(exports, 'queueService', {
+ Object.defineProperty(router, 'queueService', {
    get: () => getController().queueService
  });
- Object.defineProperty(exports, 'entitlementsService', {
+ Object.defineProperty(router, 'entitlementsService', {
    get: () => getController().entitlementsService
  });
- Object.defineProperty(exports, 'webhookService', {
+ Object.defineProperty(router, 'webhookService', {
    get: () => getController().webhookService
  });

  // Also attach legacy helper functions to router before final export
+ router.queueBillingJob = queueBillingJob;
+ router.processWebhookManually = processWebhookManually;

  module.exports = router;
```

**Rationale:**
- `module.exports = router` overwrites `exports` object
- Getters must be on the final exported object
- Maintains backward compatibility for callers

**3. `tests/integration/stripeWebhooksFlow.test.js`** (~1 línea modificada)

**Major Fix: Replace realistic-looking test secret**

```diff
- const testWebhookSecret = 'whsec_test123456789abcdef';
+ const testWebhookSecret = 'whsec_test_placeholder';
```

**Rationale:**
- Gitleaks scanner flags realistic-looking secrets
- Obviously fake value prevents false positives
- Maintains test functionality

**4. `docs/test-evidence/issue-413/SUMMARY.md`** (~50 líneas modificadas)

**Major Fix: Update test evidence to reflect actual state**

**Changes:**
- Headline: "17/17 passing (100%)" → "6/16 passing (37.5%)"
- Status: "✅ Completado" → "🟡 En Progreso (37.5% complete)"
- Remove claims of "completed DI refactor"
- List actual passing tests:
  ```text
  ✅ Passing (6/16):
  1. Should handle valid webhook signature
  2. Should reject invalid webhook signatures
  3. Should process checkout.session.completed events
  4. Should handle idempotent event processing
  5. Should queue billing jobs when queue available
  6. Should fallback to direct processing when queue unavailable

  ❌ Failing (10/16):
  1. Should handle checkout events with missing user_id
  2. Should handle payment_succeeded events
  3. Should handle subscription_updated events
  4. Should handle subscription_cancelled events
  5. Should handle invoice.payment_failed events
  6. Should handle invoice.payment_action_required events
  7. Should validate event types
  8. Should handle database errors gracefully
  9. Should log webhook processing metrics
  10. Should cleanup stale webhook events
  ```
- Update "Next Steps" with remaining work

**5. `docs/nodes/billing.md`** (~10 líneas modificadas)

**Minor Fixes:**
- Status: Change header "✅ Completado (DI refactor v2.0)" → "🟡 En Progreso (DI Refactor v2.0 - 37.5% tests passing)"
- Timeline: Update "Fase 1: EN PROGRESO" with current status
- Markdown: Add language tag to fenced block (line 94)

```diff
- ```
+ ```javascript
  const billingController = new BillingController({ ... });
```

**6. `docs/system-map.yaml`** (~1 línea modificada)

**Minor Fix: Keep status as refactoring (accurate)**

```diff
  billing:
    description: Stripe integration for subscriptions, webhooks, and plan management
    depends_on:
      - cost-control
      - queue-system
      - multi-tenant
      - plan-features
    docs:
      - docs/nodes/billing.md
    owner: Back-end Dev
    priority: critical
    status: refactoring  # ✅ Already correct
```

**Note:** No change needed - system-map.yaml is already accurate.

**7. `docs/plan/billing-refactor-di.md`** (~5 líneas modificadas)

**Minor Fix: Update test progress**

```diff
- Estado Actual: 12/16 tests pasando (75%)
+ Estado Actual: 6/16 tests pasando (37.5%)
```

**8. `docs/plan/issue-413-final-fixes.md`** (~5 líneas modificadas)

**Minor Fix: Update test progress**

```diff
- Estado Actual: 12/16 tests pasando (75%)
+ Estado Actual: 6/16 tests pasando (37.5%)
```

---

## FASE 4: Estrategia de Commit

### Commit 1: Critical Lint Fix (Separate - URGENT)

**Rationale:** Blocks CI pipeline, must be fixed immediately

**Files:**
- `src/routes/billingController.js`

**Commit Message:**
```text
fix: Wrap switch case bodies in braces - CodeRabbit #3302088539

### Critical Issue Addressed
- 🔴 [Critical] Switch case declarations violate noSwitchDeclarations (billingController.js:62-156)

### Changes

**src/routes/billingController.js (+10/-5):**

Wrapped each switch case body in braces to scope const declarations:
- payment_failed case (lines 67-82)
- subscription_cancelled case (lines 84-98)
- subscription_updated case (lines 100-126)
- payment_succeeded case (lines 128-142)
- invoice_payment_action_required case (lines 144-158)

### Why This Matters

**Problem:**
Biome lint rule `noSwitchDeclarations` fails when const/let declarations
live at switch case top level. Variables leak into sibling cases creating
potential bugs and violating scoping rules.

**Solution:**
Add `{ }` braces around each case body to create block scope for all
declarations. Standard JavaScript best practice.

**Impact:**
- ✅ Biome lint passes
- ✅ CI pipeline unblocked
- ✅ Proper variable scoping
- ✅ No functional changes

### Validation

```bash
npx biome check src/routes/billingController.js
# Expected: No errors
```

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### Commit 2: Major Fixes (Grouped - Related to runtime correctness)

**Rationale:** All affect runtime behavior or CI pipeline

**Files:**
- `src/routes/billing.js`
- `tests/integration/stripeWebhooksFlow.test.js`

**Commit Message:**
```text
fix: Correct export pattern and test secret - CodeRabbit #3302088539

### Issues Addressed
- 🟠 [Major] Service getters lost on module.exports reassignment (billing.js:33-44)
- 🟠 [Major] Test webhook secret triggers gitleaks (stripeWebhooksFlow.test.js:88)

### Changes

**src/routes/billing.js (+10/-4):**

Fixed lazy getter pattern to survive module.exports reassignment:
- Moved getters from `exports` to `router` object
- Added legacy helper functions to router before export
- Maintains backward compatibility for require('./billing').webhookService

Before:
```javascript
Object.defineProperty(exports, 'webhookService', { ... });
module.exports = router; // Overwrites exports!
```

After:
```javascript
Object.defineProperty(router, 'webhookService', { ... });
router.queueBillingJob = queueBillingJob;
module.exports = router; // Getters preserved
```

**tests/integration/stripeWebhooksFlow.test.js (+1/-1):**

Replaced realistic-looking test secret with obviously fake placeholder:
- Before: `whsec_test123456789abcdef` (triggers gitleaks)
- After: `whsec_test_placeholder` (clearly fake)

### Why This Matters

**Export Pattern Fix:**
- Prevents `undefined` when accessing service getters
- Maintains DI pattern while preserving backward compatibility
- Critical for modules that import billing services

**Test Secret Fix:**
- Stops gitleaks scanner from blocking CI
- Clearly indicates test fixture (not real secret)
- Maintains test functionality

### Validation

```bash
# Test export pattern
node -e "const b = require('./src/routes/billing'); console.log(typeof b.webhookService)"
# Expected: "object" (not "undefined")

# Test gitleaks
gitleaks detect --source . --no-git
# Expected: No high-severity Stripe secret detections
```

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### Commit 3: Documentation Accuracy (Grouped - All docs updates)

**Rationale:** All documentation updates together, separate from code changes

**Files:**
- `docs/test-evidence/issue-413/SUMMARY.md`
- `docs/nodes/billing.md`
- `docs/plan/billing-refactor-di.md`
- `docs/plan/issue-413-final-fixes.md`

**Commit Message:**
```text
docs: Update test evidence and status to reflect actual state - CodeRabbit #3302088539

### Issues Addressed
- 🟠 [Major] Test evidence claims 17/17 passing (actual: 6/16) (test-evidence/issue-413/SUMMARY.md:12-219)
- 🟡 [Minor] Billing node status inconsistency (billing.md vs system-map.yaml)
- 🟡 [Minor] Test progress stale in planning documents (2 files)
- 🟡 [Minor] Markdown lint violation (billing.md:94)

### Changes

**docs/test-evidence/issue-413/SUMMARY.md (+60/-40):**

Updated to reflect actual Jest test results:
- Headline: "17/17 passing (100%)" → "6/16 passing (37.5%)"
- Status: "✅ Completado" → "🟡 En Progreso (37.5% complete)"
- Removed claims of completed DI refactor
- Listed actual passing tests (6) and failing tests (10)
- Updated achievements to current state
- Documented remaining work in Next Steps

**docs/nodes/billing.md (+5/-3):**

Aligned status with actual progress:
- Header: "✅ Completado" → "🟡 En Progreso (37.5% tests passing)"
- Timeline: Updated Fase 1 status
- Fixed markdown lint: Added `javascript` language tag to fenced block (line 94)
- Note: system-map.yaml already correct with `status: refactoring`

**docs/plan/billing-refactor-di.md (+1/-1):**
- Updated "Estado Actual: 12/16 tests pasando (75%)" → "6/16 tests pasando (37.5%)"

**docs/plan/issue-413-final-fixes.md (+1/-1):**
- Updated "Estado Actual: 12/16 tests pasando (75%)" → "6/16 tests pasando (37.5%)"

### Why This Matters

**Transparency:**
- Stakeholders see accurate progress (37.5% not 100%)
- Roadmap reflects realistic completion estimates
- No false sense of completion

**Documentation Quality:**
- Consistent status across all documents
- Markdown linting passes
- Clear remaining work identified

### Current Test Status (6/16 passing - 37.5%)

**✅ Passing:**
1. Valid webhook signature handling
2. Invalid signature rejection
3. checkout.session.completed processing
4. Idempotent event processing
5. Queue-based billing job creation
6. Direct processing fallback

**❌ Failing (10 tests):**
- Missing user_id handling
- payment_succeeded events
- subscription_updated events
- subscription_cancelled events
- payment_failed events
- payment_action_required events
- Event type validation
- Database error handling
- Metrics logging
- Stale event cleanup

### Validation

```bash
markdownlint docs/nodes/billing.md
# Expected: No MD040 violations
```

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

---

## FASE 5: Criterios de Validación

### Implementación

- [ ] Switch cases wrapped in braces (billingController.js)
- [ ] Biome lint passes for billingController.js
- [ ] Service getters defined on router object (billing.js)
- [ ] Legacy helpers attached to router before export
- [ ] Backward compatibility verified (require('./billing').webhookService works)
- [ ] Test webhook secret replaced with obviously fake value
- [ ] Gitleaks scanner passes

### Documentación

- [ ] Test evidence updated to 6/16 passing (37.5%)
- [ ] Status claims removed or updated to "in progress"
- [ ] Actual passing/failing tests listed
- [ ] Billing node status synced (nodes/billing.md updated)
- [ ] Test progress updated in 2 planning documents
- [ ] Markdown linting passes (billing.md)

### Tests

- [ ] All existing tests still pass (no regressions)
- [ ] Lint passes: `npm run lint`
- [ ] Build passes: `npm run build`
- [ ] Security scan passes: gitleaks

### Validación de Exports

```bash
# Test that service getters work after fix
node -e "const billing = require('./src/routes/billing'); \
  console.log('webhookService:', typeof billing.webhookService); \
  console.log('stripeWrapper:', typeof billing.stripeWrapper); \
  console.log('queueService:', typeof billing.queueService); \
  console.log('entitlementsService:', typeof billing.entitlementsService);"

# Expected output:
# webhookService: object
# stripeWrapper: object
# queueService: object
# entitlementsService: object
```

---

## FASE 6: Estimación de Esfuerzo

| Fase | Duración | Descripción |
|------|----------|-------------|
| Análisis | 30min | Fetch review, analyze comments, understand issues |
| Planning | 45min | Write this comprehensive plan |
| Fix Critical | 10min | Add braces to 5 switch cases |
| Fix Major (code) | 15min | Export pattern + test secret |
| Fix Major (docs) | 20min | Update test evidence accurately |
| Fix Minor | 10min | Update planning docs + markdown lint |
| Validation | 15min | Run lint, tests, verify exports |
| Commit 1 | 5min | Critical fix commit |
| Commit 2 | 5min | Major fixes commit |
| Commit 3 | 5min | Documentation commit |
| Push | 5min | Push to remote |
| **TOTAL** | **2h 45min** | Complete CodeRabbit review application |

---

## FASE 7: Riesgos y Mitigación

| Riesgo | Probabilidad | Impacto | Mitigación |
|--------|--------------|---------|------------|
| Export pattern breaks imports | Baja | Alto | Test with require() before commit |
| Switch braces break logic | Muy Baja | Alto | No logic changes, only scoping |
| Tests still fail after fixes | Baja | Medio | These fixes are lint/docs only, not test fixes |
| Gitleaks still flags secret | Muy Baja | Medio | "placeholder" is clearly fake |
| Documentation still inconsistent | Muy Baja | Bajo | Comprehensive grep for all occurrences |

---

## FASE 8: Búsqueda de Patrón

**Regla 1:** Buscar otros switch statements sin case braces

```bash
# Search for switch statements that might have same issue
grep -r "switch (" src/ --include="*.js" | grep -v "node_modules"
```

**Regla 2:** Buscar otros lugares donde module.exports sobrescribe exports

```bash
# Search for module.exports reassignments after Object.defineProperty
grep -r "module.exports = " src/routes/ --include="*.js" -A 5 -B 5
```

**Regla 3:** Buscar otros test secrets que puedan trigger gitleaks

```bash
# Search for potential test secrets with realistic formats
grep -r "whsec_" tests/ --include="*.js"
grep -r "sk_test_" tests/ --include="*.js"
grep -r "pk_test_" tests/ --include="*.js"
```

---

## FASE 9: Próximos Pasos

1. ✅ **Planning completo** (este archivo)
2. ⏭️ **Pattern search** (buscar issues similares)
3. ⏭️ **Fix Critical** (switch case braces)
4. ⏭️ **Fix Major (code)** (export pattern + test secret)
5. ⏭️ **Fix Major (docs)** (test evidence accuracy)
6. ⏭️ **Fix Minor** (docs consistency + markdown lint)
7. ⏭️ **Validate** (lint, tests, exports)
8. ⏭️ **Commit 1** (Critical fix)
9. ⏭️ **Commit 2** (Major fixes)
10. ⏭️ **Commit 3** (Documentation)
11. ⏭️ **Push** (to remote)
12. ⏭️ **Verify** (CI passes, CodeRabbit approves)

---

**Plan aprobado. Proceder a FASE 2: Búsqueda de Patrón + Implementación.**
