# Plan: CodeRabbit Review #3385832244 - PR #676

**Review ID:** 3385832244  
**PR:** #676  
**Date:** 2025-10-27  
**Status:** In Progress  

---

## üìä An√°lisis de Severidad

### Critical (2)
1. **ShieldService category checks case-sensitive** - `src/services/shieldService.js:169-180`
   - **Issue:** Perspective categories are uppercase, lowercase before includes() fails
   - **Impact:** False negatives in toxicity detection
   - **Fix:** Normalize to lowercase before comparison

2. **ShieldService schema mismatch** - `src/services/shieldService.js:1834-1845`
   - **Issue:** Uses `user_id` instead of `platform_user_id` in upsert
   - **Impact:** Database schema mismatch, RPC failures
   - **Fix:** Correct composite key + onConflict handler

### Major (4)
3. **ShieldService: prefer maybeSingle()** - `src/services/shieldService.js:196-209`
   - **Issue:** Using `.single()` throws on not-found, inconsistent error handling
   - **Impact:** Unnecessary error handling complexity
   - **Fix:** Use `.maybeSingle()` for optional queries

4. **Test: incorrect expectedAction** - `tests/integration/shield-escalation-logic.test.js:127-133`
   - **Issue:** Uses 'escalate' as primary action instead of concrete action
   - **Impact:** Test doesn't verify actual business logic
   - **Fix:** Change to 'block' + verify escalate flag separately

5. **Test brittleness from call-order** - `tests/integration/roast.test.js:227-263`
   - **Issue:** Using `callCount` ties tests to implementation order
   - **Impact:** Brittle tests that break on refactors
   - **Fix:** Use mockImplementationOnce chains or per-table builders

6. **Mock factory: order() comparator only handles numbers** - `tests/helpers/mockSupabaseFactory.js:162-188`
   - **Issue:** Sorting by timestamps/strings produces NaN-based results
   - **Impact:** Incorrect sorting in tests
   - **Fix:** Add string/date-safe compare with localeCompare

### Minor (15+)
- Markdown formatting issues (MD007, MD040) across .claude/skills/ files
- Missing trailing newlines in guardian case JSON files
- Language identifiers missing in code blocks throughout docs
- Grammar refinements in Spanish agent descriptions
- Minor type and variable cleanup

---

## üéØ Agentes Relevantes

- **Back-end Dev** - ShieldService fixes (Critical 1, 2, 3)
- **Test Engineer** - Fix test expectations (Critical 4), reduce brittleness (Major 5)
- **Documentation Agent** - Markdown formatting fixes (Minor)

---

## üìÅ Archivos Afectados

### Core Changes
- `src/services/shieldService.js` (3 critical fixes)
- `tests/integration/shield-escalation-logic.test.js` (1 fix)
- `tests/integration/roast.test.js` (1 major fix)
- `tests/helpers/mockSupabaseFactory.js` (1 major fix)

### Docs/Formatting
- `.claude/skills/*.md` (multiple formatting fixes)
- `docs/guardian/cases/*.json` (trailing newlines)
- Multiple markdown files (MD007, MD040 issues)

---

## üîß Estrategia de Implementaci√≥n

### Fase 1: Critical Fixes (ShieldService)
**Order:** Fix the root cause, then update dependent code

1. **Fix category normalization** (lines 169-180)
   - Lowercase categories before includes() check
   - Test with various case combinations

2. **Fix maybeSingle() usage** (lines 196-209)
   - Replace `.single()` with `.maybeSingle()` where appropriate
   - Remove unnecessary error code checks

3. **Fix schema mismatch** (lines 1834-1845)
   - Correct composite key to `organization_id,platform,platform_user_id`
   - Add onConflict handler

### Fase 2: Test Fixes
4. **Update escalation test** (line 127-133)
   - Change expectedAction to 'block'
   - Add separate assertion for escalate flag

5. **Reduce test brittleness** (roast.test.js)
   - Replace callCount with explicit chains or per-table builders

6. **Fix mock factory sorting** (mockSupabaseFactory.js)
   - Add localeCompare for strings, date-safe compare

### Fase 3: Documentation/Formatting
7. **Markdown fixes**
   - Fix MD007 (list indentation)
   - Add MD040 (language specifiers)
   - Apply across all .claude/skills/ files

8. **JSON consistency**
   - Add trailing newlines to guardian case files
   - Fix domains array inconsistency

### Fase 4: Validation
- Run test suite: `npm test -- --coverage`
- Verify GDD health: `node scripts/score-gdd-health.js --ci`
- Check for regressions

---

## ‚úÖ Criterios de √âxito

- [ ] 100% comentarios resueltos (21/21)
- [ ] All tests passing (0 failures)
- [ ] Coverage mantiene o sube
- [ ] 0 regresiones en funcionalidad Shield
- [ ] GDD health ‚â•87
- [ ] Production-ready code quality

---

## üîç Testing Plan

### ShieldService Changes
```bash
npm test -- shieldService.test.js
npm test -- shield-escalation-logic.test.js
```

### Mock Factory Changes
```bash
npm test -- mockSupabaseFactory.test.js
```

### Integration Tests
```bash
npm test -- roast.test.js
```

### Full Suite
```bash
npm test -- --coverage
```

---

## üìù Commit Strategy

**Commits por severidad:**
1. `fix(shield): Normalize category checks (case-insensitive)` - Critical
2. `fix(shield): Use maybeSingle() for optional queries` - Critical  
3. `fix(shield): Correct composite key in upsert` - Critical
4. `fix(tests): Update escalation test expectations` - Major
5. `fix(tests): Reduce brittleness in roast.test.js` - Major
6. `fix(tests): Add proper sorting to mock factory` - Major
7. `fix(docs): Markdown formatting across skills/` - Minor
8. `fix(json): Add trailing newlines to guardian cases` - Minor

**Total:** 8 commits minimum for clean history

