# CodeRabbit Review Plan - #3398199357

**Review:** https://github.com/Eibon7/roastr-ai/pull/690#pullrequestreview-3398199357
**PR:** #690 - Documentation sync for PRs #689-672 + CI fixes
**Date:** 2025-10-30
**Agent:** Orchestrator + Security Audit + Documentation

---

## 1. AnÃ¡lisis por Severidad

### ðŸ”´ CRITICAL (2)

#### C1: Health Score Discrepancy (90.4 vs 91.3)
**File:** `docs/investigations/issue-677-resolution.md`
**Lines:** 77, 85-90, 190
**Type:** Documentation accuracy / Data integrity
**Issue:** Reported 90.4 but all authoritative sources say 91.3
**Impact:** Misleading metrics, documentation inconsistency
**Root Cause:** Stale data or manual typo
**Fix:** Update all instances to 91.3, adjust delta to +4.9

#### C2: Hardcoded Developer Username in Backup Paths
**File:** `gdd-write-signatures.json`
**Lines:** 15, 27, 111, 174, 186, 270, 333, 345, 429
**Type:** Security / PII exposure
**Issue:** `/Users/emiliopostigo/` in backupPath fields
**Impact:** PII leak, non-portable paths, security risk
**Root Cause:** Absolute paths not sanitized before commit
**Fix:** Replace with relative paths (./.gdd-backups/)

### ðŸŸ  MAJOR (1)

#### M1: Duplicate Guardian Cases
**Files:** Multiple in `docs/guardian/cases/`
**Type:** Data deduplication / System integrity
**Issue:**
- 4 identical SAFE cases for test.js
- 2 identical CRITICAL cases for costControl.js
**Impact:** Cluttered case files, confusing audit trail
**Root Cause:** Guardian case generation logic doesn't deduplicate
**Fix:** Consolidate duplicates, add deduplication key logic

### ðŸŸ¡ MINOR (1)

#### N1: Inconsistent Guardian Case Structure
**File:** `docs/guardian/cases/2025-10-29-19-53-56-501.json`
**Lines:** 16-20
**Type:** Schema consistency
**Issue:** Missing `domains`, `lines_added`, `lines_removed` fields
**Impact:** Inconsistent case structure
**Fix:** Add missing fields or document why omitted

---

## 2. GDD Nodes Affected

### guardian.md
**Changes Required:**
- Deduplication logic for case generation
- Schema consistency validation
- Case structure documentation

**Testing:**
- Guardian case generation tests
- Deduplication tests
- Schema validation tests

**Coverage Impact:** Maintain 0% (expected for scripts)

### Documentation (virtual node)
**Changes Required:**
- Fix health score in issue-677-resolution.md
- Remove PII from gdd-write-signatures.json
- Clean up duplicate Guardian cases

**Coverage Impact:** N/A (documentation)

---

## 3. Subagentes Asignados

### C1 & C2: Security Audit Agent
**Responsibility:**
- Review all files for PII exposure
- Sanitize backup paths
- Validate data accuracy (health scores)
- Ensure no other username/path leaks

### M1 & N1: Documentation Agent
**Responsibility:**
- Deduplicate Guardian cases
- Fix Guardian case schema
- Update investigation docs with correct metrics
- Ensure consistency across all docs

### Test Engineer (validation)
**Responsibility:**
- Add tests for Guardian deduplication
- Verify schema validation
- Test path sanitization logic

---

## 4. Archivos Completos

### Archivos a Modificar (5)

1. **docs/investigations/issue-677-resolution.md** (C1)
   - Lines: 77, 85-90, 190
   - Change: 90.4 â†’ 91.3, delta +4.0 â†’ +4.9

2. **gdd-write-signatures.json** (C2)
   - Lines: 15, 27, 111, 174, 186, 270, 333, 345, 429
   - Change: `/Users/emiliopostigo/roastr-ai/` â†’ `./`

3. **docs/guardian/cases/2025-10-29-19-53-56-501.json** (N1)
   - Lines: 16-20
   - Add: `domains`, `lines_added`, `lines_removed` fields

4. **docs/guardian/cases/*** (M1 - Deduplication)
   - Remove: Duplicate SAFE cases for test.js (keep 1 of 4)
   - Remove: Duplicate CRITICAL cases for costControl.js (keep 1 of 2)

5. **scripts/guardian-gdd.js** (M1 - Prevention)
   - Add: Deduplication logic using deterministic keys
   - Key format: `${file}:${severity}:${action}:${domain}:${summary_hash}`

### Archivos de Tests Nuevos (3)

1. **tests/unit/scripts/guardian-deduplication.test.js**
   - Test deduplication logic
   - Test deterministic key generation
   - Test case consolidation

2. **tests/unit/scripts/path-sanitization.test.js**
   - Test backup path sanitization
   - Test relative path conversion
   - Test PII removal

3. **tests/unit/guardian-schema-validation.test.js**
   - Test Guardian case schema
   - Test required fields validation
   - Test field consistency

---

## 5. Estrategia de AplicaciÃ³n

### Phase 1: CRITICAL Security Fixes (C2)
**Order:** Highest priority - PII exposure
1. Sanitize all backup paths in `gdd-write-signatures.json`
2. Update generator script to prevent future PII leaks
3. Add tests for path sanitization
4. Scan entire codebase for other PII leaks

**Commits:** 1 commit for security fix

### Phase 2: CRITICAL Data Accuracy (C1)
**Order:** High priority - documentation integrity
1. Fix health score in `issue-677-resolution.md` (3 locations)
2. Verify against all authoritative sources
3. Add validation check to prevent future discrepancies

**Commits:** 1 commit for data accuracy

### Phase 3: MAJOR Deduplication (M1)
**Order:** Medium priority - system integrity
1. Analyze duplicate Guardian cases
2. Consolidate duplicates (merge metadata if needed)
3. Update Guardian generation logic with deduplication
4. Add tests for deduplication
5. Delete duplicate files

**Commits:** 2 commits (consolidation + prevention)

### Phase 4: MINOR Schema Consistency (N1)
**Order:** Low priority - schema consistency
1. Add missing fields to inconsistent case
2. Document schema requirements
3. Add schema validation to Guardian logic

**Commits:** 1 commit for schema fix

### Testing Plan
```bash
# After each phase
npm test -- guardian
npm test -- path-sanitization
npm test -- schema-validation

# Final validation
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci
```

---

## 6. Criterios de Ã‰xito

### Completion Criteria

âœ… **All CRITICAL issues resolved:**
- [ ] Health score corrected to 91.3 in all locations
- [ ] All `/Users/emiliopostigo/` paths replaced with relative paths
- [ ] No other PII leaks in codebase
- [ ] Data accuracy verified against authoritative sources

âœ… **MAJOR issues resolved:**
- [ ] Duplicate Guardian cases consolidated
- [ ] Deduplication logic implemented in generator
- [ ] Tests added for deduplication

âœ… **MINOR issues resolved:**
- [ ] Guardian case schema consistent
- [ ] Missing fields added or omission documented
- [ ] Schema validation tests added

âœ… **Quality Checks:**
- [ ] All tests passing (0 failures)
- [ ] Coverage maintained or improved
- [ ] GDD health â‰¥87 (currently 91.3)
- [ ] 0 CodeRabbit comments remaining
- [ ] Documentation coherent

âœ… **Evidence Generated:**
- [ ] Test evidence in `docs/test-evidence/review-3398199357/`
- [ ] SUMMARY.md with patterns identified
- [ ] Guardian receipts for security changes

---

## 7. Risks & Mitigation

### Risk 1: Breaking Guardian Case Generation
**Mitigation:**
- Add deduplication flag (opt-in first)
- Test with existing cases
- Backward compatibility check

### Risk 2: Missing Other PII Leaks
**Mitigation:**
- Full codebase scan for username
- Search for other absolute paths
- Add pre-commit hook for PII detection

### Risk 3: Health Score Formula Change
**Mitigation:**
- Verify calculation in `score-gdd-health.js`
- Cross-reference with `gdd-health.json`
- Document correct formula

---

## 8. Execution Checklist

### Pre-Implementation
- [x] Plan created and saved
- [x] GDD nodes identified (guardian, documentation)
- [ ] Security scan ready
- [ ] Tests planned

### Implementation
- [ ] CRITICAL C2: Sanitize backup paths
- [ ] CRITICAL C1: Fix health score
- [ ] MAJOR M1: Deduplicate Guardian cases
- [ ] MINOR N1: Fix schema consistency
- [ ] Add all planned tests

### Validation
- [ ] All tests passing
- [ ] GDD validation: HEALTHY
- [ ] Security scan: No PII
- [ ] CodeRabbit: 0 comments
- [ ] Evidence generated

### Completion
- [ ] Commit with correct format
- [ ] Push to branch
- [ ] Update PR description
- [ ] Request re-review

---

**Created:** 2025-10-30
**Status:** ðŸŸ¡ PLANNING COMPLETE - Ready for implementation
**Next:** Execute Phase 1 (CRITICAL Security Fixes)
