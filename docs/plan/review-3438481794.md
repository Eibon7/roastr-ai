# CodeRabbit Review #3438481794 - Implementation Plan

**PR**: #756
**Date**: 2025-11-08
**Review URL**: https://github.com/Eibon7/roastr-ai/pull/756#pullrequestreview-3438481794

---

## 1. AnÃ¡lisis por Severidad

### ðŸ”´ CRITICAL (4 issues)

#### C1: polarWebhook.js - Cancellation MUST NOT reset plan to trial
- **File**: `src/routes/polarWebhook.js`
- **Lines**: 319, 352
- **Type**: Logic Bug (contradicts TRIAL-MODEL.md)
- **Impact**: Violates documented business model
- **Root Cause**: Cancellation handler downgrades plan to `starter_trial` when spec says plan should remain unchanged
- **Fix**: Remove plan field update, only set `subscription_status = 'canceled'`
- **Documentation**: TRIAL-MODEL.md Section 4 (lines 118-125)

#### C2: autoApprovalService.js - Plan config mismatch
- **File**: `src/services/autoApprovalService.js`
- **Lines**: 667-670 (usage), 699-701 (fallback), 31-37 (config)
- **Type**: Configuration Gap
- **Impact**: `starter_trial` falls back to undefined â†’ uses `free` â†’ incorrect limits
- **Root Cause**: `planLimits` object missing `starter_trial` key
- **Fix**: Add `starter_trial: { hourly: 10, daily: 25 }` to config
- **Also**: Update fallback from `'free_fallback'` to `'starter_trial_fallback'`

#### C3: costControl.js - Inconsistent plan identifier
- **File**: `src/services/costControl.js`
- **Lines**: 27-28 (plans.free), 924 (planLimits.free), references in creditsService.js:370, autoApprovalService.js:670, 699-700
- **Type**: Architectural Inconsistency
- **Impact**: `plans.free.id === 'starter_trial'` but `planLimits.free` exists separately
- **Root Cause**: Incomplete migration - mixed semantic aliasing
- **Fix**: Complete migration by renaming both `plans.free` â†’ `plans.starter_trial` AND `planLimits.free` â†’ `planLimits.starter_trial`
- **Cascade**: Update 4 references in creditsService and autoApprovalService

#### C4: workerNotificationService.js - Inconsistent fallback
- **File**: `src/services/workerNotificationService.js`
- **Lines**: 134-177 (getFallbackLimits method), specifically 166, 169-173
- **Type**: Configuration Inconsistency
- **Impact**: Database path uses `starter_trial`, hardcoded fallback uses `free`
- **Root Cause**: FALLBACK_LIMITS object not updated
- **Fix**: Rename `FALLBACK_LIMITS.free` â†’ `FALLBACK_LIMITS.starter_trial` + update 2 references

---

### ðŸŸ  MAJOR (2 issues)

#### M1: TRIAL-MODEL.md - Testing gap
- **File**: `docs/TRIAL-MODEL.md`
- **Lines**: 264-282 (checklist)
- **Type**: Missing Tests
- **Impact**: Integration/E2E coverage incomplete
- **Root Cause**: Only 3/5 tests from Issue #484 passing (RLS + tierLimitsEnforcement not addressed)
- **Fix**: Create 3 new integration tests:
  1. `trial-expiry.integration.test.js` - Signup â†’ time advance â†’ subscription expired â†’ access revoked
  2. `early-upgrade.integration.test.js` - Upgrade during trial â†’ billing switch â†’ trial cancellation
  3. Worker enforcement tests - `isPlanActive()` checks at expiry + tier limits

#### M2: stripeWebhookService.js - Hardcoded reset plan
- **File**: `src/services/stripeWebhookService.js`
- **Line**: 560
- **Type**: Tight Coupling
- **Impact**: Response doesn't reflect actual transaction result
- **Root Cause**: `planName: 'starter_trial'` hardcoded instead of derived from transaction
- **Fix**: `planName: transactionResult?.new_plan || 'starter_trial'`

---

## 2. GDD Context

### Nodos Afectados

- **billing.md** - Polar/Stripe webhook handling
- **plans.md** - Plan definitions and transitions
- **trial-model.md** - Business rules (if exists)
- **testing.md** - Integration test coverage

### Agentes Relevantes

- **Guardian Agent** - Protected domains (billing, auth, plans)
- **Test Engineer** - Integration/E2E test creation
- **Backend Dev** - Service fixes

---

## 3. Archivos Impactados

### Core Changes (6 files)

1. âœ… `src/routes/polarWebhook.js` - Remove plan downgrade on cancellation (C1)
2. âœ… `src/services/autoApprovalService.js` - Add starter_trial config (C2)
3. âœ… `src/services/costControl.js` - Complete plan migration (C3)
4. âœ… `src/services/workerNotificationService.js` - Update fallback limits (C4)
5. âœ… `src/services/stripeWebhookService.js` - Derive plan from transaction (M2)
6. âœ… `src/services/creditsService.js` - Update planLimits.free references (C3 cascade)

### Tests (3 new files)

7. ðŸ†• `tests/integration/trial-expiry.integration.test.js` (M1)
8. ðŸ†• `tests/integration/early-upgrade.integration.test.js` (M1)
9. ðŸ†• `tests/integration/worker-enforcement.integration.test.js` (M1)

### Documentation

10. âœ… `docs/TRIAL-MODEL.md` - Update test checklist (M1)

---

## 4. Estrategia de ImplementaciÃ³n

### Orden de EjecuciÃ³n

**FASE 1: CRITICAL Fixes (C1-C4)** - Arquitectura primero
1. C3 - costControl.js - Complete plan migration (affects C2, C4)
2. C2 - autoApprovalService.js - Add config + update references
3. C4 - workerNotificationService.js - Update fallback
4. C1 - polarWebhook.js - Remove plan downgrade

**Rationale**: C3 is root cause for C2/C4. Fix architecture before patching symptoms.

**FASE 2: MAJOR Fixes (M1-M2)** - Decouple & Test
5. M2 - stripeWebhookService.js - Derive plan dynamically
6. M1 - Create 3 integration tests
7. M1 - Update TRIAL-MODEL.md checklist

**FASE 3: Validation**
8. Run full test suite
9. GDD validation (runtime, health â‰¥87, drift <60)
10. Generate test evidence

---

## 5. Testing Plan

### Unit Tests (existing, verify no regressions)

- âœ… `plan-consistency.test.js` - 13/13 passing
- âœ… `plan-limits-integration.test.js` - 12/12 passing
- âœ… `credits-api.test.js` - 15/15 passing
- âœ… `stripeWebhooksFlow.test.js` - 17/17 passing

### Integration Tests (new, to create)

- ðŸ†• `trial-expiry.integration.test.js`
  - Signup with starter_trial
  - Mock time advance (30 days)
  - Trigger worker job / subscription check
  - Assert: `subscription_status = 'expired'`, access revoked
  - Assert: `plan` unchanged (still `starter_trial`)

- ðŸ†• `early-upgrade.integration.test.js`
  - User on starter_trial (day 10/30)
  - Upgrade to `pro` via Stripe/Polar webhook
  - Assert: Plan switches to `pro`, trial canceled
  - Assert: Billing reflects pro pricing

- ðŸ†• `worker-enforcement.integration.test.js`
  - Mock worker scheduler
  - Test `isPlanActive()` at trial expiry
  - Test tier limit enforcement (roasts/comments/Shield)
  - Assert: Access disabled for expired plans

### E2E Tests (existing, verify coverage)

- âŒ `multi-tenant-rls-issue-412.test.js` - NOT ADDRESSED (out of scope? create separate issue)
- âŒ `tierLimitsEnforcement.integration.test.js` - NOT ADDRESSED (covered by new worker test?)

---

## 6. Commit Strategy

### Single Commit (all fixes together)

**Rationale**: C1-C4 are tightly coupled architectural fixes. Breaking into separate commits risks intermediate broken states.

**Message Template**:

```
fix: Apply CodeRabbit Review #3438481794 - Complete starter_trial migration

## Issues Addressed

### CRITICAL (4)
- [C1] polarWebhook.js:319,352 - Remove plan downgrade on cancellation (violates TRIAL-MODEL.md)
- [C2] autoApprovalService.js:31-37,667,699 - Add missing starter_trial config entry
- [C3] costControl.js:27-28,924 - Complete plan migration (remove plans.free aliasing)
- [C4] workerNotificationService.js:166,169-173 - Update FALLBACK_LIMITS to starter_trial

### MAJOR (2)
- [M1] TRIAL-MODEL.md:264-282 - Add 3 integration tests (trial-expiry, early-upgrade, worker-enforcement)
- [M2] stripeWebhookService.js:560 - Derive plan from transaction result (no hardcoding)

## Changes

### Services (6 files)
- costControl.js: Renamed plans.free â†’ plans.starter_trial, planLimits.free â†’ planLimits.starter_trial
- autoApprovalService.js: Added starter_trial: { hourly: 10, daily: 25 } to planLimits, updated fallback to starter_trial_fallback
- workerNotificationService.js: Renamed FALLBACK_LIMITS.free â†’ FALLBACK_LIMITS.starter_trial
- creditsService.js: Updated planLimits.free â†’ planLimits.starter_trial
- polarWebhook.js: Removed plan field update on cancellation (only set subscription_status)
- stripeWebhookService.js: planName derived from transactionResult?.new_plan

### Tests (3 new)
- trial-expiry.integration.test.js: Signup â†’ expiry â†’ access revoked
- early-upgrade.integration.test.js: Upgrade during trial â†’ billing switch
- worker-enforcement.integration.test.js: isPlanActive() checks + tier limits

### Documentation
- TRIAL-MODEL.md: Updated test checklist (lines 264-282)

## Testing

- Unit: 40/40 passing (plan-consistency, plan-limits, credits-api, stripeWebhooksFlow)
- Integration: 3/3 new tests passing (trial-expiry, early-upgrade, worker-enforcement)
- Coverage: X% â†’ Y% (+Z%)

## GDD

- Updated nodes: billing.md, plans.md
- Health: â‰¥87 (validated)
- Drift: <60 (validated)
```

---

## 7. Criterios de Ã‰xito

### Functional

- âœ… All 6 CRITICAL + MAJOR issues resolved
- âœ… Cancellation flow matches TRIAL-MODEL.md (plan unchanged, status='canceled')
- âœ… starter_trial config exists in all services (autoApproval, costControl, workerNotification)
- âœ… No more `plans.free` or `planLimits.free` aliases (complete migration)
- âœ… stripeWebhookService derives plan dynamically

### Testing

- âœ… 100% existing tests passing (no regressions)
- âœ… 3 new integration tests created and passing
- âœ… Coverage maintains or increases
- âœ… Test checklist in TRIAL-MODEL.md updated

### Quality

- âœ… 0 CodeRabbit comments pending
- âœ… GDD health â‰¥87
- âœ… GDD drift <60
- âœ… No architectural debt introduced
- âœ… SOLID principles maintained

### Documentation

- âœ… TRIAL-MODEL.md test checklist updated
- âœ… Test evidence generated in `docs/test-evidence/review-3438481794/`
- âœ… SUMMARY.md with pattern analysis (not chronology)

---

## 8. Risk Analysis

### High Risk

- **C3 (costControl.js)**: Cascade effect - 4 references in 2 other files
  - **Mitigation**: Update all references atomically, grep verification

### Medium Risk

- **M1 (Integration tests)**: Time-dependent tests may be flaky
  - **Mitigation**: Use deterministic time mocking, avoid real delays

### Low Risk

- **C1, C2, C4, M2**: Localized changes with clear boundaries
  - **Mitigation**: Standard unit test coverage

---

## 9. Next Steps

1. âœ… Plan saved â†’ Proceed with FASE 1 (CRITICAL fixes)
2. Read `docs/patterns/coderabbit-lessons.md` for known patterns
3. Invoke Guardian Agent for protected domains review
4. Apply fixes in order (C3 â†’ C2 â†’ C4 â†’ C1 â†’ M2 â†’ M1)
5. Validate â†’ Commit â†’ Push

---

**Planning Complete** âœ…
**Ready to Execute**: YES
**Estimated Time**: 45-60 minutes
**Complexity**: Medium-High (architectural migration + new tests)
