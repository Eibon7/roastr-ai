# CodeRabbit Review #3302408711 - Planning Document

**PR:** #461 - test: Add comprehensive kill-switch integration tests - Issue #414
**Branch:** test/issue-414-killswitch-integration
**Review URL:** <https://github.com/Eibon7/roastr-ai/pull/461#pullrequestreview-3302408711>
**Date:** October 5, 2025
**Total Issues:** 1 Major, 2 Minor
**Status:** üîÑ Planning

---

## FASE 0: Analysis of CodeRabbit Comments

### Review Summary

**Total Comments:** 3 (1 Major, 2 Minor)
**Files Affected:** 3
**Categories:** 1 Test Architecture (Major), 2 Style/Documentation (Minor)

### Issue Breakdown by Severity

#### üü† Major #1: Fail-closed test doesn't simulate actual database outage

**File:** tests/integration/killSwitch-issue-414.test.js
**Lines:** 421-436
**Severity:** Major
**Category:** Test Architecture / Correctness

**Issue Description:**
The fail-closed test (AC5, line 407-436) does not properly simulate a Supabase database outage. Instead of using `mockRejectedValue()` to simulate connection failures, it uses `mockResolvedValue({ data: null, error: {...} })` which represents a successful query with no results (flag not found).

This means the test validates "missing flag" behavior (which triggers `handleMissingFlag()`) but does NOT validate "database connection failure" behavior (which should trigger fail-closed error handling).

**CodeRabbit Comment:**
> **Fail-closed path never simulates a Supabase outage** ‚Äî The test uses `mockResolvedValue({ data: null, error: { message: 'Not found' } })`, which simulates "flag not found" but not an actual DB connection failure. For a true fail-closed scenario, use:
> ```javascript
> const dbFailure = new Error('Database connection failed');
> mockEq.mockReturnValue({
>   single: jest.fn().mockRejectedValue(dbFailure)
> });
> mockIn.mockRejectedValue(dbFailure);
> ```
> Then verify the middleware returns 503 with code 'KILL_SWITCH_ERROR' or similar.

**Current Code (Lines 421-436):**
```javascript
it('should fail closed (block) when no cache available and DB fails', async () => {
  // Ensure no cache exists
  const cacheFile = path.join(process.cwd(), '.cache', 'kill-switch-state.json');
  try {
    await fs.unlink(cacheFile);
  } catch (error) {
    // Ignore if doesn't exist
  }

  // Clear in-memory cache
  killSwitchService.cache.clear();
  killSwitchService.lastCacheUpdate = 0;
  killSwitchService.isInitialized = false;

  // Simulate complete DB failure - getFlag will call handleMissingFlag
  // which returns {is_enabled: false, flag_value: false} by default
  mockEq.mockReturnValue({
    single: jest.fn().mockResolvedValue({ data: null, error: { message: 'Not found' } })
  });
  mockIn.mockResolvedValue({ data: null, error: { message: 'Not found' } });

  // Test via HTTP middleware (proper integration test)
  const response = await request(app).post('/api/autopost');

  // With missing flags, handleMissingFlag returns is_enabled=false
  // This means: kill switch OFF, autopost DISABLED
  // Expected: 503 AUTOPOST_DISABLED
  expect(response.status).toBe(503);
  expect(response.body.code).toBe('AUTOPOST_DISABLED');
});
```

**Expected Fix:**
```javascript
it('should fail closed (block) when no cache available and DB fails', async () => {
  // Ensure no cache exists
  const cacheFile = path.join(process.cwd(), '.cache', 'kill-switch-state.json');
  try {
    await fs.unlink(cacheFile);
  } catch (error) {
    // Ignore if doesn't exist
  }

  // Clear in-memory cache
  killSwitchService.cache.clear();
  killSwitchService.lastCacheUpdate = 0;
  killSwitchService.isInitialized = false;

  // Simulate ACTUAL database connection failure (not "flag not found")
  const dbFailure = new Error('Database connection failed');
  mockEq.mockReturnValue({
    single: jest.fn().mockRejectedValue(dbFailure)
  });
  mockIn.mockRejectedValue(dbFailure);

  // Test via HTTP middleware (proper integration test)
  const response = await request(app).post('/api/autopost');

  // With actual DB failure and no cache, should fail closed
  // Expected: 503 with KILL_SWITCH_ERROR or AUTOPOST_DISABLED (depends on implementation)
  expect(response.status).toBe(503);
  expect(response.body.code).toMatch(/KILL_SWITCH_ERROR|KILL_SWITCH_ACTIVE|AUTOPOST_DISABLED/);
});
```

**Impact:**
- **Severity:** Major (test doesn't validate actual fail-closed behavior)
- **Scope:** Test correctness - critical AC5 validation missing
- **Risk:** High (database outage scenario untested)
- **Urgency:** High (P0 test coverage gap)

**Analysis:**
This is a critical distinction:
1. **Current test:** `mockResolvedValue({ data: null, error: {...} })` ‚Üí Query succeeds, flag not found ‚Üí handleMissingFlag ‚Üí returns default `is_enabled: false` ‚Üí AUTOPOST_DISABLED
2. **Expected test:** `mockRejectedValue(new Error(...))` ‚Üí Query fails (DB outage) ‚Üí catch block ‚Üí fail-closed behavior ‚Üí KILL_SWITCH_ERROR

The test MUST validate scenario #2 to ensure fail-closed works during actual database outages.

---

#### üü¢ Minor #2: Bare URL in planning document

**File:** docs/plan/review-3302103120.md
**Line:** 5
**Severity:** Minor
**Category:** Style (markdown linting MD034)

**Status:** ‚úÖ **ALREADY FIXED** (Commit 22d48d7b)

**Issue Description:**
Bare URL without markdown link syntax.

**Resolution:**
This was already resolved in commit 22d48d7b ("test: Apply CodeRabbit Review #3302403814"). CodeRabbit is showing this because it reviewed an earlier commit.

**Current State:** URL wrapped in angle brackets `<url>`

**No Action Required.**

---

#### üü¢ Minor #3: Missing language tag in SUMMARY.md

**File:** docs/test-evidence/issue-414/SUMMARY.md
**Line:** 14
**Severity:** Minor
**Category:** Style (markdown linting MD040)

**Status:** ‚úÖ **ALREADY FIXED** (Commit 79a941d3)

**Issue Description:**
Fenced code block lacks language identifier.

**Resolution:**
This was already resolved in commit 79a941d3 ("docs: Fix markdown linting in Issue #414 test evidence - Review #3302103120"). CodeRabbit is showing this because it reviewed an earlier commit.

**Current State:** Code fence has `text` language tag

**No Action Required.**

---

## FASE 1: Quality Rules Assessment

### Rule 1: Planning Obligatorio ‚úÖ
- Planning document created: docs/plan/review-3302408711.md
- Comprehensive analysis completed

### Rule 2: Soluciones de Producci√≥n ‚úÖ
- Major issue requires architectural fix (proper DB outage simulation)
- No shortcuts - must test actual exception scenarios
- Minor issues already resolved in previous commits

### Rule 3: Refactor Over Patches ‚úÖ
- **Major #1:** Requires refactor from "flag not found" to "DB connection failure"
- Must verify middleware fail-closed error handling exists
- May need to implement fail-closed error handling if missing

### Rule 4: Tests Obligatorios ‚úÖ
- Major #1 IS a test correction (improving test accuracy)
- After fix, validate middleware actually handles DB exceptions correctly
- May need to add error handling in middleware if missing

### Rule 5: Update GDD if Architectural Changes ‚ö†Ô∏è
- **Potential:** If middleware lacks fail-closed error handling, must implement
- **shield.md** may need update if error handling added
- **queue-system.md** may need update if worker behavior changes
- spec.md may need update if new error codes added

---

## FASE 2: Impact Analysis

### Files Affected

1. **tests/integration/killSwitch-issue-414.test.js** (Major - test architecture)
2. **src/middleware/killSwitch.js** (Potential - if fail-closed handling missing)
3. **docs/plan/review-3302103120.md** (Minor - ALREADY FIXED)
4. **docs/test-evidence/issue-414/SUMMARY.md** (Minor - ALREADY FIXED)

### Dependencies

**Major #1 (Test Refactor + Potential Middleware Fix):**
- Depends on: Middleware error handling implementation
- Affects: AC5 test suite ("Fallback to local cache when DB fails")
- Related: src/middleware/killSwitch.js error handling
- May require: Middleware refactor to handle exceptions

**Critical Question:** Does `checkKillSwitch` middleware properly handle exceptions from database queries?

**Investigation Required:**
1. Read src/middleware/killSwitch.js
2. Verify try/catch blocks exist for DB queries
3. Check if exceptions trigger fail-closed behavior (503 response)
4. If missing, implement proper error handling

### GDD Nodes

**Potentially affected:**
- **shield.md** (if middleware error handling added)
- **queue-system.md** (if worker fail-closed behavior changes)

**Action:** Read middleware implementation first to determine if GDD updates needed.

### Tests Affected

**Major #1:**
- Test: AC5 "should fail closed when no cache available and DB fails"
- Current: Tests "flag not found" scenario (handleMissingFlag)
- Expected: Test "DB connection failure" scenario (exception handling)
- Impact: May expose missing error handling in middleware

**Pattern Search Required:**
- Check if other tests have same issue (using mockResolvedValue for DB failures)
- Verify all fail-closed tests use mockRejectedValue for exception scenarios

### CI/CD Impact

- ‚úÖ Tests will be more accurate (proper exception testing)
- ‚ö†Ô∏è Test may fail after fix if middleware lacks error handling
- ‚ö†Ô∏è May require middleware implementation before test passes
- ‚úÖ More robust fail-closed validation

---

## FASE 3: Risk Assessment

### Major Risk (Issue #1) ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

**Test Accuracy Risk:**
- Current test validates wrong scenario (flag not found vs DB outage)
- After fix, test may expose **missing error handling in middleware**
- **This is CRITICAL** - if middleware doesn't handle exceptions, production will crash on DB outages

**Mitigation Strategy:**
1. **FIRST:** Read src/middleware/killSwitch.js to verify error handling exists
2. **IF MISSING:** Implement proper try/catch with fail-closed behavior
3. **THEN:** Update test to use mockRejectedValue
4. **VALIDATE:** Test passes, middleware handles DB outages gracefully

**Potential Middleware Fix Required:**
```javascript
// Current (if missing try/catch):
async function checkKillSwitch(req, res, next) {
  const isActive = await killSwitchService.isKillSwitchActive(); // May throw!
  if (isActive) {
    return res.status(503).json({ error: 'KILL_SWITCH_ACTIVE' });
  }
  next();
}

// Expected (with error handling):
async function checkKillSwitch(req, res, next) {
  try {
    const isActive = await killSwitchService.isKillSwitchActive();
    if (isActive) {
      return res.status(503).json({ error: 'KILL_SWITCH_ACTIVE' });
    }
    next();
  } catch (error) {
    logger.error('Kill switch check failed', error);
    // FAIL CLOSED: block operations on error
    return res.status(503).json({
      success: false,
      code: 'KILL_SWITCH_ERROR',
      error: 'Kill switch check failed - blocking for safety'
    });
  }
}
```

### Low Risk (Issues #2, #3) ‚úÖ

- Already fixed in previous commits
- No action required

### Validation Strategy

1. **Investigation Phase:**
   - Read src/middleware/killSwitch.js
   - Check for try/catch blocks
   - Verify error handling exists

2. **Implementation Phase (if needed):**
   - Add try/catch to middleware
   - Implement fail-closed behavior (503 on error)
   - Update test to use mockRejectedValue
   - Run test to validate

3. **Validation Phase:**
   - Run AC5 tests: `npm test -- killSwitch-issue-414.test.js -t "should fail closed"`
   - Run full test suite: `npm test -- killSwitch-issue-414.test.js`
   - Verify 20/20 passing
   - Verify no regressions

---

## FASE 4: Implementation Strategy

### Option 1: Update Test + Add Middleware Error Handling (RECOMMENDED) ‚úÖ

**Approach:**
1. Investigate middleware implementation
2. Add error handling if missing
3. Update test to use mockRejectedValue

**Pros:**
- Production-ready (handles DB outages)
- Test validates actual fail-closed behavior
- Robust error handling

**Cons:**
- More work (middleware changes + test changes)
- May require GDD updates

**Decision:** Proceed with Option 1 - this is the correct approach per quality rules

### Option 2: Update Test Only (CONDITIONAL) ‚ö†Ô∏è

**Approach:** Update test to use mockRejectedValue, rely on existing error handling

**Pros:**
- Less work
- Test becomes accurate

**Cons:**
- **ONLY VALID if middleware already has error handling**
- Must verify error handling exists first

**Decision:** Use this only if investigation shows error handling already exists

### Option 3: Leave Test As-Is (REJECTED) ‚ùå

**Approach:** Ignore CodeRabbit comment

**Pros:**
- No work required

**Cons:**
- **Violates quality rules** (no shortcuts)
- Test doesn't validate DB outage scenario
- Production vulnerability (untested fail-closed path)
- **NOT ACCEPTABLE** per instructions

---

## FASE 5: Change Categorization

### Major #1: Test Architecture + Potential Middleware Enhancement
- **Type:** Integration test accuracy + Fail-closed error handling
- **Scope:** AC5 fail-closed validation + Middleware robustness
- **Impact:** High (test accuracy + production reliability)
- **Priority:** P0 (critical test coverage + safety)

### Minor #2, #3: Documentation Quality
- **Status:** Already resolved
- **No action required**

---

## FASE 6: Detailed Implementation Plan

### Step 1: Investigation (CRITICAL)

**Read middleware implementation:**

```bash
# Read kill switch middleware
cat src/middleware/killSwitch.js | grep -A 20 "async function checkKillSwitch"
```

**Verify:**
1. Does `checkKillSwitch` have try/catch block?
2. Does it handle exceptions from `isKillSwitchActive()`?
3. Does it fail closed on error (return 503)?

**Outcomes:**
- **IF error handling exists:** Proceed to Step 2 (test-only fix)
- **IF error handling missing:** Proceed to Step 3 (middleware fix + test fix)

### Step 2: Test-Only Fix (IF middleware has error handling)

**File:** tests/integration/killSwitch-issue-414.test.js
**Lines:** 421-436

**Change:**
```diff
  // Simulate complete DB failure - getFlag will call handleMissingFlag
- // which returns {is_enabled: false, flag_value: false} by default
- mockEq.mockReturnValue({
-   single: jest.fn().mockResolvedValue({ data: null, error: { message: 'Not found' } })
- });
- mockIn.mockResolvedValue({ data: null, error: { message: 'Not found' } });
+ // Simulate ACTUAL database connection failure (exception thrown)
+ const dbFailure = new Error('Database connection failed');
+ mockEq.mockReturnValue({
+   single: jest.fn().mockRejectedValue(dbFailure)
+ });
+ mockIn.mockRejectedValue(dbFailure);

  // Test via HTTP middleware (proper integration test)
  const response = await request(app).post('/api/autopost');

- // With missing flags, handleMissingFlag returns is_enabled=false
- // This means: kill switch OFF, autopost DISABLED
- // Expected: 503 AUTOPOST_DISABLED
+ // With DB failure and no cache, middleware should fail closed
+ // Expected: 503 with error code indicating failure
  expect(response.status).toBe(503);
- expect(response.body.code).toBe('AUTOPOST_DISABLED');
+ expect(response.body.code).toMatch(/KILL_SWITCH_ERROR|KILL_SWITCH_ACTIVE|AUTOPOST_DISABLED/);
});
```

### Step 3: Middleware Fix + Test Fix (IF error handling missing)

**File:** src/middleware/killSwitch.js

**Add error handling to checkKillSwitch:**
```javascript
async function checkKillSwitch(req, res, next) {
  try {
    const isActive = await isKillSwitchActive();
    if (isActive) {
      return res.status(503).json({
        success: false,
        code: 'KILL_SWITCH_ACTIVE',
        error: 'Autopost operations are currently disabled'
      });
    }
    next();
  } catch (error) {
    logger.error('Kill switch check failed - failing closed', { error: error.message });
    return res.status(503).json({
      success: false,
      code: 'KILL_SWITCH_ERROR',
      error: 'Kill switch check failed - blocking operations for safety'
    });
  }
}
```

**Then apply test fix from Step 2.**

### Step 4: Pattern Search

**Check other fail-closed tests:**
```bash
# Find all tests that should simulate DB failures
grep -n "mockResolvedValue.*error.*message" tests/integration/killSwitch-issue-414.test.js
```

**Verify:**
- AC5 test 2 ("should use local cache when database is unavailable") - check if needs same fix

### Step 5: Update Documentation (IF middleware changed)

**IF middleware error handling added:**
- Update docs/nodes/shield.md (error handling added)
- Update docs/test-evidence/issue-414/SUMMARY.md (AC5 behavior clarified)
- Update spec.md if new error code `KILL_SWITCH_ERROR` added

---

## FASE 7: Pre-Implementation Checklist

- [x] Planning document created
- [x] CodeRabbit comments analyzed (1 Major, 2 Minor already fixed)
- [x] Impact assessed (test + potential middleware)
- [x] Risk evaluated (may expose missing error handling)
- [x] Implementation strategy defined
- [x] Investigation plan established
- [ ] Middleware investigation completed (pending)
- [ ] Error handling status determined (pending)
- [ ] Fixes applied (pending FASE 9)
- [ ] Validation completed (pending FASE 10)
- [ ] Commit created (pending FASE 11)

---

## FASE 8: Expected Outcomes

### Immediate Outcomes

**IF middleware has error handling:**
1. ‚úÖ Test validates actual DB outage scenario
2. ‚úÖ Test uses mockRejectedValue (proper exception testing)
3. ‚úÖ Test may pass immediately (if error handling works)

**IF middleware lacks error handling:**
1. ‚ö†Ô∏è Test exposes missing error handling (GOOD - catches bug)
2. ‚úÖ Middleware enhanced with try/catch + fail-closed
3. ‚úÖ Production becomes more robust
4. ‚úÖ Test validates new error handling

### Long-term Outcomes

1. ‚úÖ Integration tests accurately validate exception scenarios
2. ‚úÖ Middleware handles database outages gracefully
3. ‚úÖ Production fail-closed behavior verified
4. ‚úÖ No crashes on DB connection failures

### Potential Middleware Enhancements

**IF error handling added:**
- New error code: `KILL_SWITCH_ERROR`
- Error logging for DB failures
- Fail-closed guarantee (503 on any error)
- GDD updates: shield.md, spec.md

---

## FASE 9: Implementation (PENDING)

### Implementation Order

1. **Investigation** (read middleware code)
2. **Middleware Fix** (if needed)
3. **Test Fix** (update to mockRejectedValue)
4. **Pattern Search** (check other tests)
5. **Documentation** (if middleware changed)
6. **Validation** (all tests pass)

### Fixes to Apply (PENDING INVESTIGATION)

**Definite:**
- Test fix: mockResolvedValue ‚Üí mockRejectedValue

**Conditional (IF middleware lacks error handling):**
- Middleware: Add try/catch to checkKillSwitch
- Documentation: Update shield.md, spec.md
- Test: Update expected error code

---

## FASE 10: Validation Plan

### Step 1: Middleware Investigation

```bash
# Read middleware implementation
cat src/middleware/killSwitch.js
```

**Checklist:**
- [ ] checkKillSwitch has try/catch?
- [ ] Handles exceptions from isKillSwitchActive()?
- [ ] Returns 503 on error?
- [ ] Logs errors appropriately?

### Step 2: Test Validation

```bash
# Run specific test
npm test -- killSwitch-issue-414.test.js -t "should fail closed when no cache available and DB fails"

# Expected outcomes:
# PASS: Middleware handles exceptions correctly
# FAIL: Middleware lacks error handling (must fix middleware first)
```

### Step 3: Full Test Suite

```bash
# Run all kill-switch tests
npm test -- killSwitch-issue-414.test.js

# Expected: 20/20 passing (or identify bugs to fix)
```

### Step 4: Coverage Check

```bash
# Ensure coverage maintained
npm run test:coverage

# Expected: No decrease in coverage %
```

### Success Criteria

- [ ] Middleware investigation completed
- [ ] Error handling verified OR implemented
- [ ] Test uses mockRejectedValue (proper exception testing)
- [ ] Test validates actual DB outage scenario
- [ ] 20/20 tests passing (100%)
- [ ] Coverage maintained or increased
- [ ] 0 regressions
- [ ] GDD updated if middleware changed

---

## FASE 11: Commit Strategy

### Commit Message Template (Test-Only Fix)

```text
test: Apply CodeRabbit Review #3302408711 - Simulate actual DB outage in fail-closed test

### Issues Addressed
- üü† Major: Fail-closed test doesn't simulate DB outage (killSwitch-issue-414.test.js:421-436)
- üü¢ Minor: Bare URL (ALREADY FIXED in 22d48d7b)
- üü¢ Minor: Language tag (ALREADY FIXED in 79a941d3)

### Changes

**Integration Test Accuracy:**
- Replaced mockResolvedValue with mockRejectedValue in AC5 test
- Now simulates ACTUAL database connection failure (exception thrown)
- BEFORE: `mockResolvedValue({ data: null, error: {...} })` (flag not found)
- AFTER: `mockRejectedValue(new Error('Database connection failed'))` (DB outage)
- Test now validates middleware exception handling (fail-closed behavior)

**Test Details:**
- AC5 test 3 "should fail closed when no cache available and DB fails"
- Scenario: Database throws exception + no local cache available
- Expected: Middleware catches exception, fails closed with 503 response
- Validates production robustness during database outages

### Testing
- Tests: 20/20 passing (100%)
- Coverage: maintained
- Fail-closed behavior: validated via actual exception scenario
- Pattern search: verified no other tests have same issue

### Files Modified
- tests/integration/killSwitch-issue-414.test.js (+6/-6 lines)
  - AC5 test 3: mockResolvedValue ‚Üí mockRejectedValue
  - Comments updated to reflect DB outage simulation
  - Expected response code updated (regex match for error codes)
- docs/plan/review-3302408711.md (+850 new - comprehensive planning doc)

### Context
- CodeRabbit Review #3302408711 (1 Major, 2 Minor already fixed)
- PR #461 (Kill-switch integration tests - Issue #414)
- Branch: test/issue-414-killswitch-integration
- Follow-up to commits 79a941d3, 22d48d7b

### Quality Assurance
- ‚úÖ 100% CodeRabbit comments resolved
- ‚úÖ Proper exception testing (mockRejectedValue)
- ‚úÖ Validates actual DB outage scenario
- ‚úÖ 0 regressions (20/20 tests passing)
- ‚úÖ Test accuracy improved (exception handling verified)
- ‚úÖ Production-ready code

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### Commit Message Template (Middleware Fix + Test Fix)

```text
feat: Add fail-closed error handling + Apply CodeRabbit Review #3302408711

### Issues Addressed
- üü† Major: Missing fail-closed error handling in middleware
- üü† Major: Fail-closed test doesn't simulate DB outage (killSwitch-issue-414.test.js:421-436)
- üü¢ Minor: Bare URL (ALREADY FIXED in 22d48d7b)
- üü¢ Minor: Language tag (ALREADY FIXED in 79a941d3)

### Changes

**Middleware Enhancement:**
- Added try/catch error handling to checkKillSwitch middleware
- Implements fail-closed behavior on database exceptions
- Returns 503 KILL_SWITCH_ERROR when DB check fails
- Logs errors for observability
- Ensures production doesn't crash on DB connection failures

**Integration Test Accuracy:**
- Updated AC5 test to simulate actual DB outage (mockRejectedValue)
- Test now validates middleware exception handling
- Verifies fail-closed behavior works correctly

### Testing
- Tests: 20/20 passing (100%)
- Coverage: increased (new error handling path covered)
- Fail-closed: validated via exception scenario
- Middleware: handles DB outages gracefully

### Files Modified
- src/middleware/killSwitch.js (+12/-2 lines)
  - Added try/catch to checkKillSwitch
  - Fail-closed error handling implemented
- tests/integration/killSwitch-issue-414.test.js (+6/-6 lines)
  - AC5 test: mockResolvedValue ‚Üí mockRejectedValue
- docs/nodes/shield.md (+15 lines)
  - Documented error handling behavior
- docs/plan/review-3302408711.md (+850 new)

### GDD
- Updated nodes: shield.md (error handling added)
- Updated spec.md: Error codes section (KILL_SWITCH_ERROR added)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### Git Operations

```bash
# Add modified files
git add tests/integration/killSwitch-issue-414.test.js \
        src/middleware/killSwitch.js \
        docs/plan/review-3302408711.md \
        docs/nodes/shield.md \
        spec.md

# Commit with appropriate message (test-only OR middleware+test)
git commit -m "$(cat <<'EOF'
[Use appropriate template from above]
EOF
)"

# Push to remote
git push origin test/issue-414-killswitch-integration
```

---

## FASE 12: Post-Implementation

### CodeRabbit Resolution

- Comment on PR #461 referencing fixes
- Tag CodeRabbit review #3302408711 as resolved
- Note: Issues #2, #3 already fixed in previous commits

### Documentation Updates

**IF middleware changed:**
- Update shield.md (error handling added)
- Update spec.md (error codes section)
- Update SUMMARY.md (AC5 behavior clarified)

**IF test-only change:**
- Update SUMMARY.md (AC5 test description)

### Quality Checklist

- [x] Planning document complete (850+ lines)
- [ ] Middleware investigation completed
- [ ] Error handling verified/implemented
- [ ] Test updated to mockRejectedValue
- [ ] All tests passing (20/20)
- [ ] Coverage maintained/increased
- [ ] Commit created with detailed message
- [ ] Changes pushed to remote branch
- [ ] CodeRabbit comments resolved
- [ ] GDD updated if needed

---

## FASE 13: Subagents Assignment

### Test Engineer Agent (Primary)

**Scope:** Major #1 (test refactor + middleware validation)

**Tasks:**
- Investigate middleware error handling
- Determine if middleware fix needed
- Update test to use mockRejectedValue
- Validate fail-closed behavior
- Ensure coverage maintained

**Deliverables:**
- Middleware analysis report
- Updated integration test
- Test execution evidence (20/20 passing)
- Coverage report

### Back-end Dev Agent (Conditional)

**Scope:** Middleware error handling (IF missing)

**Tasks:**
- Implement try/catch in checkKillSwitch
- Add fail-closed error response
- Add error logging
- Ensure SOLID principles

**Deliverables:**
- Enhanced middleware with error handling
- Unit tests for error handling
- Documentation updates

### Documentation Agent (Secondary)

**Scope:** GDD updates (IF middleware changed)

**Tasks:**
- Update shield.md (error handling)
- Update spec.md (error codes)
- Update SUMMARY.md (AC5 clarification)

**Deliverables:**
- Updated GDD nodes
- Synchronized documentation

---

## Summary

**Issue Severity Breakdown:**
- üü† Major: 1 (test accuracy + potential middleware enhancement)
- üü¢ Minor: 2 (already fixed in previous commits)

**Complexity Assessment:**
- Major #1: High (requires investigation + potential middleware fix)
- Requires: Middleware code review + error handling implementation
- Impact: Test accuracy + production robustness

**Risk Level:**
- **HIGH:** Test may expose missing error handling (GOOD - catches production bug)
- **CRITICAL:** Must verify middleware handles exceptions or implement it
- **SAFE:** Test-only fix if error handling already exists

**Implementation Strategy:**
1. **Investigate** middleware (read code, verify error handling)
2. **Decide** path: test-only OR middleware+test
3. **Implement** fixes according to investigation results
4. **Validate** all tests pass + coverage maintained
5. **Document** changes in GDD if middleware changed

**Estimated Effort:**
- Investigation: 10-15 minutes
- Test-only fix: 15-20 minutes (if error handling exists)
- Middleware+test fix: 60-90 minutes (if error handling missing)
- Total: 25 minutes to 2 hours (depends on middleware state)

**Recommendation:** Start with investigation (FASE 9 Step 1) to determine correct path, then proceed accordingly.

---

**Status:** ‚úÖ Planning Complete - Ready for Investigation
**Next Step:** Read src/middleware/killSwitch.js to verify error handling exists
**Priority:** P0 (critical test coverage + production safety)
**Confidence:** 90% (clear fix path, contingent on middleware state)
