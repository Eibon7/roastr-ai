# Guardian Case Files

**Purpose:** This directory stores JSON case files generated by Guardian Agent for every scan that detects changes to protected domains.

---

## Case File Format

**Filename:** `<case-id>.json` (e.g., `2025-10-09-14-30-25-123.json`)
**Case ID Format:** `YYYY-MM-DD-HH-MM-SS-mmm` (23 characters, includes milliseconds)

---

## JSON Schema

```json
{
  "case_id": "2025-10-09-14-30-25-123",
  "timestamp": "2025-10-09T14:30:25.123Z",
  "actor": "github-actions",
  "domains": ["pricing", "quotas"],
  "files_changed": ["src/services/costControl.js"],
  "severity": "CRITICAL | SENSITIVE | SAFE",
  "action": "BLOCKED | REVIEW | APPROVED",
  "violations": {
    "critical": 1,
    "sensitive": 0,
    "safe": 0
  },
  "details": [
    {
      "file": "src/services/costControl.js",
      "domains": ["pricing", "quotas"],
      "severity": "CRITICAL",
      "lines_added": 10,
      "lines_removed": 5
    }
  ],
  "approval_required": true,
  "approved_by": null,
  "notes": "Requires Product Owner approval"
}
```

---

## Field Descriptions

| Field | Type | Description |
|-------|------|-------------|
| `case_id` | string | Unique case identifier (YYYY-MM-DD-HH-MM-SS-mmm format) |
| `timestamp` | string | ISO 8601 timestamp of scan |
| `actor` | string | Who initiated change (GITHUB_ACTOR, USER, USERNAME, or "unknown") |
| `domains` | array | List of protected domains affected (pricing, quotas, auth_policies, ai_models, public_contracts) |
| `files_changed` | array | List of file paths modified |
| `severity` | enum | Highest severity detected: CRITICAL, SENSITIVE, or SAFE |
| `action` | enum | Guardian action: BLOCKED (exit 2), REVIEW (exit 1), or APPROVED (exit 0) |
| `violations` | object | Count of violations by severity level |
| `details` | array | Per-file violation details (file, domains, severity, line counts) |
| `approval_required` | boolean | Whether manual approval is needed (true for CRITICAL/SENSITIVE) |
| `approved_by` | string\|null | User ID who approved (null until approved) |
| `notes` | string | Human-readable notes about required actions |

---

## Severity Levels

### 🔴 CRITICAL
**Protected Domains:** pricing, quotas, auth_policies
**Action:** BLOCKED (exit code 2)
**Approval Required:** Product Owner + Tech Lead + Backend Dev (3 approvers, 48h SLA)
**Examples:**
- Changes to subscription tiers (€5/€15/€50 plans)
- Modifications to usage limits (roasts/month, análisis/month)
- RLS policy changes (Row Level Security)

### 🟡 SENSITIVE
**Protected Domains:** ai_models, public_contracts
**Action:** REVIEW (exit code 1)
**Approval Required:** Tech Lead + Domain Owner (2 approvers, 24h SLA)
**Examples:**
- AI prompt template changes
- Model selection changes (GPT-4, Claude, etc.)
- API endpoint signature changes
- Webhook contract modifications

### 🟢 SAFE
**Protected Domains:** None (no protected domains matched)
**Action:** APPROVED (exit code 0)
**Approval Required:** None (auto-approved)
**Examples:**
- Documentation updates
- Test file changes
- Comments and formatting
- Non-protected code changes

---

## Case ID Generation

**Format:** `YYYY-MM-DD-HH-MM-SS-mmm`
**Example:** `2025-10-09-14-30-25-123`
**Length:** 23 characters
**Precision:** Milliseconds

**Implementation:**
```javascript
const timestamp = new Date().toISOString();
const caseId = timestamp.replace(/[:.]/g, '-').split('T').join('-').substring(0, 23);
```

**Collision Prevention:**
- Millisecond precision provides 1000 unique IDs per second
- Sufficient for sequential scans (CI/CD pipelines)
- **Limitation:** Parallel scans within same millisecond may collide
- **Future Enhancement:** Consider ULID/UUIDv7 for high-concurrency environments

---

## Approval Workflow

### Step 1: Scan Detects Violation
Guardian generates case file with `approval_required: true` and `approved_by: null`

### Step 2: Notification Sent (Phase 17)
- CRITICAL: Email + Slack #critical-alerts + GitHub issue
- SENSITIVE: Slack #dev-alerts + GitHub issue
- SAFE: Log only (no notification)

### Step 3: Manual Review
- Reviewers examine case file and diff
- Verify changes align with business requirements
- Check for security implications

### Step 4: Approval
- Approver updates case file: `"approved_by": "user_id"`
- Guardian validates approver has required role
- Merge unblocked once all required approvers sign off

### Step 5: Audit Trail
- Case files provide immutable audit log
- Compliance reports query case files
- SOC 2 / GDPR evidence

---

## File Retention

**Policy:** Indefinite retention for compliance
**Storage:** Git repository (version controlled)
**Backup:** Included in repository backups
**Archive:** No archival policy (all case files retained)

**Rationale:**
- Case files are small (typically <5KB each)
- Critical for audit trails and compliance
- Version control provides historical record
- No PII stored (only file paths and domains)

---

## Example Case Files

### Example 1: CRITICAL - Pricing Change

**File:** `2025-10-09-14-30-25-123.json`
```json
{
  "case_id": "2025-10-09-14-30-25-123",
  "timestamp": "2025-10-09T14:30:25.123Z",
  "actor": "developer",
  "domains": ["pricing"],
  "files_changed": ["src/config/plans.js"],
  "severity": "CRITICAL",
  "action": "BLOCKED",
  "violations": {
    "critical": 1,
    "sensitive": 0,
    "safe": 0
  },
  "details": [
    {
      "file": "src/config/plans.js",
      "domains": ["pricing"],
      "severity": "CRITICAL",
      "lines_added": 1,
      "lines_removed": 1
    }
  ],
  "approval_required": true,
  "approved_by": null,
  "notes": "Requires Product Owner approval - pricing change detected"
}
```

**Analysis:**
- Pricing domain change (CRITICAL)
- Merge blocked (exit code 2)
- Requires 3 approvers (Product Owner, Tech Lead, Backend Dev)
- 48-hour SLA for approval

### Example 2: SENSITIVE - AI Model Change

**File:** `2025-10-09-15-45-10-456.json`
```json
{
  "case_id": "2025-10-09-15-45-10-456",
  "timestamp": "2025-10-09T15:45:10.456Z",
  "actor": "github-actions",
  "domains": ["ai_models"],
  "files_changed": ["src/services/roastPromptTemplate.js"],
  "severity": "SENSITIVE",
  "action": "REVIEW",
  "violations": {
    "critical": 0,
    "sensitive": 1,
    "safe": 0
  },
  "details": [
    {
      "file": "src/services/roastPromptTemplate.js",
      "domains": ["ai_models"],
      "severity": "SENSITIVE",
      "lines_added": 15,
      "lines_removed": 8
    }
  ],
  "approval_required": true,
  "approved_by": null,
  "notes": "Requires Tech Lead review - AI prompt template modified"
}
```

**Analysis:**
- AI models domain change (SENSITIVE)
- Manual review required (exit code 1)
- Requires 2 approvers (Tech Lead, AI Engineer)
- 24-hour SLA for approval

### Example 3: SAFE - Documentation Update

**File:** `2025-10-09-16-20-35-789.json`
```json
{
  "case_id": "2025-10-09-16-20-35-789",
  "timestamp": "2025-10-09T16:20:35.789Z",
  "actor": "developer",
  "domains": [],
  "files_changed": ["README.md", "docs/api.md"],
  "severity": "SAFE",
  "action": "APPROVED",
  "violations": {
    "critical": 0,
    "sensitive": 0,
    "safe": 2
  },
  "details": [
    {
      "file": "README.md",
      "domains": [],
      "severity": "SAFE",
      "lines_added": 5,
      "lines_removed": 2
    },
    {
      "file": "docs/api.md",
      "domains": [],
      "severity": "SAFE",
      "lines_added": 10,
      "lines_removed": 3
    }
  ],
  "approval_required": false,
  "approved_by": null,
  "notes": "Auto-approved - safe changes"
}
```

**Analysis:**
- No protected domains affected (SAFE)
- Auto-approved (exit code 0)
- No approval required
- Merge allowed immediately

---

## Integration with CI/CD (Phase 17)

### GitHub Actions Workflow

```yaml
- name: Run Guardian Scan
  run: node scripts/guardian-gdd.js --ci
  id: guardian

- name: Check Exit Code
  if: steps.guardian.outputs.exit_code == 2
  run: |
    echo "CRITICAL: Merge blocked by Guardian"
    exit 1

- name: Require Manual Review
  if: steps.guardian.outputs.exit_code == 1
  uses: actions/create-approval-request@v1
  with:
    reviewers: tech-lead, domain-owner
```

### Pre-commit Hook

```bash
# .husky/pre-commit
node scripts/guardian-gdd.js --check
exit_code=$?

if [ $exit_code -eq 2 ]; then
  echo "❌ CRITICAL: Commit blocked by Guardian"
  exit 1
elif [ $exit_code -eq 1 ]; then
  echo "⚠️  SENSITIVE: Manual review required"
  # Allow commit but warn
fi
```

---

## Querying Case Files

### CLI Examples

```bash
# List all CRITICAL cases
find docs/guardian/cases -name "*.json" -exec jq 'select(.severity=="CRITICAL")' {} \;

# Count cases by severity
jq -s 'group_by(.severity) | map({severity: .[0].severity, count: length})' docs/guardian/cases/*.json

# Find unapproved cases
jq 'select(.approval_required==true and .approved_by==null)' docs/guardian/cases/*.json

# Cases by actor
jq -s 'group_by(.actor) | map({actor: .[0].actor, count: length})' docs/guardian/cases/*.json

# Cases by domain
jq -s '[.[] | .domains[]] | group_by(.) | map({domain: .[0], count: length})' docs/guardian/cases/*.json
```

### Node.js Script Example

```javascript
const fs = require('fs');
const path = require('path');

// Load all case files
const casesDir = 'docs/guardian/cases';
const caseFiles = fs.readdirSync(casesDir)
  .filter(f => f.endsWith('.json'))
  .map(f => JSON.parse(fs.readFileSync(path.join(casesDir, f), 'utf8')));

// Filter CRITICAL unapproved cases
const criticalUnapproved = caseFiles.filter(c =>
  c.severity === 'CRITICAL' &&
  c.approval_required &&
  c.approved_by === null
);

console.log(`Found ${criticalUnapproved.length} CRITICAL unapproved cases`);
```

---

## Related Documentation

- **Guardian Engine:** `scripts/guardian-gdd.js`
- **Configuration:** `config/product-guard.yaml`
- **Ignore Patterns:** `config/guardian-ignore.yaml`
- **Audit Log:** `docs/guardian/audit-log.md`
- **GDD Node:** `docs/nodes/guardian.md`
- **spec.md Section:** Guardian Node (lines 7812-7888)

---

**Last Updated:** 2025-10-09
**Version:** 1.0.0
**Owner:** Product Owner (governance layer)
