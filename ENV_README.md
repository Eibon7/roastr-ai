# üîß Sistema de Variables de Entorno

Documentaci√≥n completa del sistema robusto de carga y validaci√≥n de variables de entorno para Roastr.ai.

## üìã Resumen

Este sistema detecta autom√°ticamente el entorno (`development` vs `production`) y carga las variables correspondientes:

- **Desarrollo**: `.env.local` (autom√°tico cuando `NODE_ENV=development`)
- **Producci√≥n**: `.env.production` (autom√°tico cuando `NODE_ENV=production`)  
- **Cloud (Vercel/Netlify)**: Variables del sistema (autom√°tico cuando `VERCEL=1`)

## üóÇÔ∏è Archivos de Configuraci√≥n

### `.env.local` - Desarrollo Local

```env
# üîß DESARROLLO LOCAL
# Se carga autom√°ticamente cuando NODE_ENV=development

NODE_ENV=development
PORT=3000
DEBUG=true

# Variables M√çNIMAS OBLIGATORIAS en desarrollo:
SUPABASE_URL=https://tu-proyecto.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
OPENAI_API_KEY=sk-proj-tu-openai-key-aqui
STRIPE_SECRET_KEY=sk_test_51... # ‚ö†Ô∏è DEBE ser clave TEST
STRIPE_WEBHOOK_SECRET=whsec_... # Del comando: stripe listen
STRIPE_SUCCESS_URL=http://localhost:3000/billing-success.html?session_id={CHECKOUT_SESSION_ID}
STRIPE_CANCEL_URL=http://localhost:3000/billing-cancel.html
STRIPE_PORTAL_RETURN_URL=http://localhost:3000/billing.html
```

### `.env.production` - Producci√≥n (Servidor Propio)

```env
# üöÄ PRODUCCI√ìN SERVIDOR PROPIO
# Se carga autom√°ticamente cuando NODE_ENV=production

NODE_ENV=production
PORT=3000
DEBUG=false

# Variables OBLIGATORIAS en producci√≥n:
SUPABASE_URL=https://tu-proyecto-prod.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... # ‚ö†Ô∏è Solo en producci√≥n
OPENAI_API_KEY=sk-proj-tu-openai-key-produccion
STRIPE_SECRET_KEY=sk_live_51... # ‚ö†Ô∏è DEBE ser clave LIVE
STRIPE_WEBHOOK_SECRET=whsec_... # Del Stripe Dashboard
STRIPE_SUCCESS_URL=https://tu-dominio.com/billing-success.html?session_id={CHECKOUT_SESSION_ID}
STRIPE_CANCEL_URL=https://tu-dominio.com/billing-cancel.html
STRIPE_PORTAL_RETURN_URL=https://tu-dominio.com/billing.html
ROASTR_API_KEY=tu-api-key-segura-produccion
PERSPECTIVE_API_KEY=tu-perspective-api-key-produccion

# APIs sociales (OBLIGATORIAS en producci√≥n):
TWITTER_BEARER_TOKEN=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
YOUTUBE_API_KEY=tu-youtube-api-key-produccion
```

### Cloud (Vercel/Netlify) - Panel de Control

```
# üåê CLOUD DEPLOYMENT
# NO usar archivos .env - configurar en el panel

Variable                      | Valor
------------------------------|----------------------------------
NODE_ENV                     | production
VERCEL                       | 1 (autom√°tico)
SUPABASE_URL                 | https://tu-proyecto-prod.supabase.co
SUPABASE_SERVICE_KEY         | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
STRIPE_SECRET_KEY            | sk_live_51...
STRIPE_WEBHOOK_SECRET        | whsec_...
APP_BASE_URL                 | https://tu-dominio.com
# ... resto de variables
```

## ‚úÖ Validaci√≥n por Entorno

### Variables Cr√≠ticas - Desarrollo

**M√çNIMAS OBLIGATORIAS** para arrancar en local:

| Variable | Descripci√≥n | Ejemplo |
|----------|-------------|---------|
| `SUPABASE_URL` | URL del proyecto Supabase | `https://abc123.supabase.co` |
| `SUPABASE_ANON_KEY` | Clave an√≥nima de Supabase | `eyJhbGciOiJIUzI1NiI...` |
| `OPENAI_API_KEY` | API key de OpenAI | `sk-proj-abc123...` |
| `STRIPE_SECRET_KEY` | Clave **TEST** de Stripe | `sk_test_51...` |
| `STRIPE_WEBHOOK_SECRET` | Secret del webhook local | `whsec_abc123...` |
| `STRIPE_SUCCESS_URL` | URL de √©xito local | `http://localhost:3000/billing-success.html?session_id={CHECKOUT_SESSION_ID}` |
| `STRIPE_CANCEL_URL` | URL de cancelaci√≥n local | `http://localhost:3000/billing-cancel.html` |
| `STRIPE_PORTAL_RETURN_URL` | URL de retorno portal | `http://localhost:3000/billing.html` |

### Variables Cr√≠ticas - Producci√≥n  

**TODAS LAS DE DESARROLLO** m√°s estas adicionales:

| Variable | Descripci√≥n | Nota |
|----------|-------------|------|
| `SUPABASE_SERVICE_KEY` | Clave de servicio para admin | ‚ö†Ô∏è Solo en producci√≥n |
| `ROASTR_API_KEY` | API key propia del servicio | Para autenticaci√≥n |
| `PERSPECTIVE_API_KEY` | Google Perspective API | Para moderaci√≥n |
| `TWITTER_BEARER_TOKEN` | Token de Twitter API | Obligatorio en prod |
| `YOUTUBE_API_KEY` | API key de YouTube | Obligatorio en prod |
| URLs con dominio real | Todas las URLs de Stripe | `https://` real |

## üöÄ Configuraci√≥n Inicial

### 1. Desarrollo Local

```bash
# 1. Copiar archivo de ejemplo
cp .env.local.example .env.local

# 2. Rellenar con tus credenciales reales
nano .env.local

# 3. Configurar Stripe CLI para webhooks
stripe login
stripe listen --forward-to localhost:3000/webhooks/stripe
# Copiar el webhook secret que aparece en consola

# 4. Iniciar aplicaci√≥n
npm run dev

# 5. Verificar configuraci√≥n
curl http://localhost:3000/api/diagnostics/env
```

### 2. Producci√≥n (Servidor Propio)

```bash
# 1. Copiar archivo de ejemplo
cp .env.production.example .env.production

# 2. Configurar con credenciales LIVE
nano .env.production

# 3. Configurar webhook en Stripe Dashboard
# URL: https://tu-dominio.com/webhooks/stripe
# Eventos: todos los de billing

# 4. Desplegar
NODE_ENV=production npm start
```

### 3. Cloud (Vercel)

```bash
# 1. En el dashboard de Vercel, ir a Settings > Environment Variables
# 2. A√±adir todas las variables una por una
# 3. VERCEL=1 se detecta autom√°ticamente
# 4. NO subir archivos .env al repositorio
```

## üîç Mensajes de Error

### Errores Cr√≠ticos (App no arranca)

```
‚ùå ERRORES CR√çTICOS DE CONFIGURACI√ìN:
   ‚ùå Falta SUPABASE_URL en .env.local
   ‚ùå Falta OPENAI_API_KEY en .env.local
   ‚ùå Debe usar clave LIVE de Stripe en producci√≥n

üö´ La aplicaci√≥n no puede arrancar con estos errores.
```

### Advertencias (App arranca pero con funcionalidad limitada)

```
‚ö†Ô∏è  ADVERTENCIAS DE CONFIGURACI√ìN:
   ‚ö†Ô∏è  TWITTER_BEARER_TOKEN no configurado en producci√≥n
   ‚ö†Ô∏è  Usando clave LIVE de Stripe en desarrollo
```

### √âxito

```
‚úÖ Configuraci√≥n validada correctamente para: development
```

## üß™ Testing del Sistema

### Tests Unitarios

```bash
# Ejecutar tests del sistema de entorno
npm test tests/unit/config/env.test.js

# Test que simulan diferentes escenarios:
# - ‚úÖ Carga correcta en development
# - ‚úÖ Carga correcta en production  
# - ‚ùå Falla si falta variable cr√≠tica
# - ‚úÖ Detecta Vercel autom√°ticamente
# - ‚úÖ Valida formato de claves Stripe
```

### Simulaci√≥n Manual

```bash
# Test 1: Desarrollo sin variables (debe fallar)
NODE_ENV=development node -e "require('./src/config/env')"

# Test 2: Desarrollo con variables correctas
cp .env.local.example .env.local
# Rellenar .env.local
NODE_ENV=development node -e "require('./src/config/env')"

# Test 3: Producci√≥n sin variables (debe abortar)
NODE_ENV=production node -e "require('./src/config/env')"
```

## üîß C√≥mo A√±adir Nuevas Variables

### 1. Definir en ENV_CONFIG

```javascript
// src/config/env.js
const ENV_CONFIG = {
    // ... existing sections
    
    newService: {
        NEW_API_KEY: process.env.NEW_API_KEY || '',
        NEW_SECRET: process.env.NEW_SECRET || ''
    }
};
```

### 2. A√±adir Validaci√≥n

```javascript
// En validateEnvironment()
if (IS_PRODUCTION) {
    const prodRequired = [
        // ... existing
        { key: 'NEW_API_KEY', value: ENV_CONFIG.newService.NEW_API_KEY }
    ];
}
```

### 3. Actualizar Templates

```bash
# En .env.local.example
NEW_API_KEY=tu-new-api-key-aqui

# En .env.production.example  
NEW_API_KEY=tu-new-api-key-produccion
```

### 4. Documentar

```markdown
# En este archivo
| `NEW_API_KEY` | Descripci√≥n del servicio | `abc123...` |
```

## üö® Resoluci√≥n de Problemas

### Problema: "Falta SUPABASE_URL en .env.local"

**Soluci√≥n:**
1. Verificar que existe el archivo `.env.local`
2. Verificar que `SUPABASE_URL=` no est√° vac√≠o
3. Verificar que no hay espacios extra: `SUPABASE_URL=https://...`

### Problema: "Usando clave LIVE de Stripe en desarrollo"

**Soluci√≥n:**
1. En `.env.local` usar clave que empiece por `sk_test_`
2. Nunca usar claves `sk_live_` en desarrollo

### Problema: App arranca pero billing no funciona

**Verificar:**
1. `STRIPE_SECRET_KEY` configurado
2. `STRIPE_WEBHOOK_SECRET` del comando `stripe listen`
3. URLs de Stripe v√°lidas

### Problema: Tests fallan por variables de entorno

**Causa:** Los tests cargan el sistema de entorno  
**Soluci√≥n:** Los tests autom√°ticamente skipean validaci√≥n cuando detectan Jest

## üìö Arquitectura del Sistema

```
src/config/env.js
‚îú‚îÄ‚îÄ loadEnvironmentFiles()     # Carga .env.local/.env.production
‚îú‚îÄ‚îÄ ENV_CONFIG                 # Configuraci√≥n centralizada
‚îú‚îÄ‚îÄ validateEnvironment()      # Validaci√≥n por entorno
‚îú‚îÄ‚îÄ getDiagnostics()          # Debug info (solo development)
‚îî‚îÄ‚îÄ Auto-initialization       # Se ejecuta al importar
```

### Flujo de Carga

1. **Detectar entorno**: `NODE_ENV` y `VERCEL`
2. **Cargar archivo**: `.env.local` | `.env.production` | ninguno
3. **Construir config**: Mapear `process.env` a `ENV_CONFIG`
4. **Validar**: Verificar variables cr√≠ticas por entorno
5. **Abortar si error cr√≠tico**: `process.exit(1)` en producci√≥n

### Integraci√≥n con App

```javascript
// Uso en el c√≥digo
const { database, stripe, ai } = require('./config/env');

console.log(database.SUPABASE_URL);    // ‚úÖ Centralizado
console.log(process.env.SUPABASE_URL); // ‚ùå Evitar uso directo
```

---

## üîí Seguridad

- **‚ùå NUNCA** commitear archivos `.env*` al repositorio
- **‚úÖ SOLO** commitear archivos `.env*.example`
- **‚ö†Ô∏è VERIFICAR** que `.gitignore` excluye `.env.local` y `.env.production`
- **üîç REVISAR** que no hay claves hardcodeadas en el c√≥digo

---

üì¶ **Sistema de Variables de Entorno Roastr.ai v2.0**  
Validaci√≥n robusta ‚Ä¢ Detecci√≥n autom√°tica ‚Ä¢ Documentaci√≥n completa