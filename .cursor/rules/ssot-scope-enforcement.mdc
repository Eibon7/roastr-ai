# SSOT + NODE + SCOPE ENFORCEMENT v2

**Versi√≥n:** 2.0  
**Fecha:** 2025-12-02  
**Estado:** ‚úÖ Activo  
**Prop√≥sito:** Garantizar que cualquier trabajo producido por Cursor/Claude cumple estrictamente con el scope de la issue, los nodos GDD v2 activos, el SSOT v2, y la arquitectura v2.

---

## üîí PRINCIPIO DE ORO

**Jerarqu√≠a de autoridad (en orden de precedencia):**

1. **SSOT v2** (`docs/SSOT-V2.md`) ‚Üí GANA SIEMPRE sobre c√≥digo/GDD
2. **Scope de la Issue** (Linear/GitHub) ‚Üí Define QU√â implementar
3. **Nodos GDD v2** (`docs/nodes-v2/<node>/<subnode>.md` o `docs/nodes/*.md` legacy) ‚Üí Define C√ìMO debe funcionar
4. **System-map v2** (`docs/system-map-v2.yaml`) ‚Üí Define estructura de nodos y subnodos
5. **Arquitectura v2** ‚Üí Workers v2_*, SSOT enforcement, GDPR, FeatureFlagService

**Regla de resoluci√≥n de conflictos:**

- Si SSOT y c√≥digo/GDD discrepan ‚Üí **SSOT gana** (detener y corregir)
- Si Issue y Nodo discrepan ‚Üí **Issue define scope**, pero sin permitir contradicciones al nodo/SSOT
- Si Issue est√° incompleta/ambigua ‚Üí **NO inventar**, documentar y crear issue de seguimiento

---

## üîç SCOPE STRICT ENFORCEMENT (Regla Absoluta)

### 2.1 Workflow Obligatorio Antes de Implementar

**Paso 1: Leer el scope de la issue**

```bash
# Si es issue de GitHub
gh issue view <n√∫mero> --json title,body,labels

# Si es issue de Linear
# Revisar t√≠tulo, descripci√≥n, acceptance criteria (AC)
```

**Identificar EXACTAMENTE:**

- ‚úÖ Qu√© se pide (AC espec√≠ficos)
- ‚ùå Qu√© NO se pide (l√≠mites expl√≠citos)
- üéØ L√≠mites funcionales (qu√© m√≥dulos toca)
- üö´ Partes expl√≠citamente fuera del alcance

**Paso 2: Resolver nodos GDD relevantes**

```bash
# Auto-detecci√≥n de nodos desde issue
node scripts/cursor-agents/auto-gdd-activation.js <issue-number>

# O resolver manualmente
node scripts/resolve-graph.js <nodos-detectados>
```

**Paso 3: Leer SOLO nodos resueltos (NUNCA spec.md completo)**

```
En Cursor Chat: @docs/nodes/roast.md @docs/nodes/shield.md
```

**Paso 4: Verificar SSOT**

```
@docs/SSOT-V2.md
```

### 2.2 Prohibiciones Absolutas

**‚ùå PROHIBIDO implementar:**

- Features no mencionadas en el scope de la issue
- Mejoras "evidentes" que no est√°n en AC
- Completar partes del nodo no incluidas en la issue
- A√±adir coherencia a m√≥dulos no involucrados
- "L√≥gica" que deber√≠a estar pero no est√° en el scope

**Ejemplo de violaci√≥n:**

```
Issue: "A√±adir validaci√≥n de email en formulario de registro"
‚ùå MAL: Tambi√©n a√±ad√≠ validaci√≥n de tel√©fono (no estaba en scope)
‚ùå MAL: Tambi√©n mejor√© el dise√±o del formulario (no estaba en scope)
‚úÖ BIEN: Solo validaci√≥n de email como pide la issue
```

### 2.3 Manejo de Issues Incompletas/Ambiguas

Si la issue est√° incompleta, ambigua o choca con un nodo:

1. **Documentar en PR** (comentario de bloqueo)
2. **Proponer alternativas** (con referencias a SSOT/nodos)
3. **Crear issue de seguimiento** (si es necesario)
4. **NO inventar comportamiento** (detener y esperar aclaraci√≥n)

**Template de bloqueo:**

```markdown
## ‚ö†Ô∏è Scope Conflict Detected

**Issue:** #XXX  
**Conflicto:** [Descripci√≥n del conflicto]  
**SSOT/Nodo afectado:** [Referencia]  
**Propuesta:** [Alternativas]  
**Issue de seguimiento:** #[YYY]
```

---

## üìò NODE COMPLIANCE ENFORCEMENT

### 3.1 Verificaci√≥n de Coherencia con Nodos

**Para cada cambio, verificar:**

```bash
# 1. Identificar nodos afectados
node scripts/resolve-graph.js <nodo-principal>

# 2. Leer nodos resueltos
# 3. Comparar implementaci√≥n vs nodo
```

**Si la implementaci√≥n contradice un nodo:**

- ‚úÖ **Corregir** la implementaci√≥n para alinearse con el nodo
- ‚úÖ **O** explicar por qu√© el nodo debe actualizarse
- ‚úÖ **Generar** "Nodo Patch" (ver secci√≥n 8)

**Ejemplo de contradicci√≥n:**

```
Nodo roast.md dice: "Roasts deben tener m√°ximo 280 caracteres"
Implementaci√≥n: Permite 500 caracteres
‚Üí CORRECCI√ìN: Limitar a 280 o actualizar nodo con justificaci√≥n
```

### 3.2 Prohibici√≥n de "Completar el Nodo"

**Los nodos describen el sistema completo. La issue describe qu√© toca ahora.**

**‚ùå PROHIBIDO:**

- Implementar partes del nodo no incluidas en la issue
- "Completar" funcionalidades mencionadas en el nodo pero no en la issue
- A√±adir features "que deber√≠an estar" seg√∫n el nodo

**Ejemplo:**

```
Issue: "A√±adir validaci√≥n de tono en roast generation"
Nodo roast.md menciona: validaci√≥n de tono, l√≠mites de caracteres, shield integration
‚ùå MAL: Implement√© todo lo del nodo relacionado con roast
‚úÖ BIEN: Solo validaci√≥n de tono como pide la issue
```

### 3.3 Actualizaci√≥n de "Agentes Relevantes"

**Despu√©s de invocar un agente, SIEMPRE actualizar el nodo:**

```markdown
## Agentes Relevantes

- TestEngineer - Para tests de validaci√≥n
- FrontendDev - Para UI de configuraci√≥n
- [NUEVO] Guardian - Para validaci√≥n de seguridad
```

**Validaci√≥n:**

```bash
node scripts/validate-gdd-runtime.js --full
```

---

## üîê SSOT COMPLIANCE ENFORCEMENT

### 4.1 Valores Prohibidos (Lista Exhaustiva)

**‚ùå PROHIBIDO usar:**

- Valores hardcoded (planes, flags, tonos, estados)
- Planes legacy: `"free"`, `"basic"`, `"creator_plus"`
- Features legacy v1 (Stripe, SendGrid, workers v1)
- Flags fuera de los 15 oficiales (ver `docs/SSOT-V2.md` secci√≥n 3)
- Tonos no definidos (solo: `"flanders"`, `"balanceado"`, `"canalla"`, `"personal"`)
- Plataformas no soportadas (ver SSOT secci√≥n 4)
- Estados nuevos no incluidos en SSOT (billing, shield, etc.)

**Referencia obligatoria:** `docs/SSOT-V2.md`

### 4.2 Carga de Valores desde SSOT

**Cada valor configurable DEBE venir de:**

```typescript
// ‚úÖ CORRECTO
import { SettingsLoader } from '@/services/settingsLoader';
const settings = await SettingsLoader.load();
const planLimits = settings.plans[user.plan];

// ‚ùå INCORRECTO
const planLimits = { analysis_limit: 1000 }; // Hardcoded
```

**Si falta un valor en SSOT:**

1. ‚ùå **NO inventarlo**
2. ‚ùå **NO asumirlo**
3. ‚úÖ **Marcarlo como TBD** en c√≥digo
4. ‚úÖ **Crear issue** para actualizar SSOT

**Template de TBD:**

```typescript
// TODO: TBD - Falta en SSOT v2
// Issue: #[XXX] - A√±adir [valor] a SSOT
// Temporal: [valor temporal con justificaci√≥n]
const temporalValue = 'temporal'; // ‚ö†Ô∏è REMOVER cuando SSOT se actualice
```

### 4.3 Validaci√≥n Autom√°tica

**Antes de commit, verificar:**

```bash
# Buscar valores hardcoded prohibidos
grep -r "free\|basic\|creator_plus" src/ --exclude-dir=node_modules
grep -r "stripe\|sendgrid" src/ --exclude-dir=node_modules

# Verificar uso de SettingsLoader
grep -r "SettingsLoader\|settingsLoader" src/
```

---

## üîÅ CROSS-NODE CONSISTENCY CHECK

### 5.1 Verificaci√≥n Post-Implementaci√≥n

**Despu√©s de realizar el trabajo, asegurar:**

```bash
# 1. Validar grafo completo
node scripts/resolve-graph.js --validate

# 2. Validar runtime GDD
node scripts/validate-gdd-runtime.js --full

# 3. Verificar health score
node scripts/score-gdd-health.js --ci  # Debe >=87
```

**Checklist de consistencia:**

- [ ] No contradice otros nodos
- [ ] No rompe flujos existentes
- [ ] No altera comportamientos globales
- [ ] No introduce dependencias no mencionadas

**Si hay conflicto:**

- ‚úÖ **Corregir** la implementaci√≥n
- ‚úÖ **O documentar** en PR con justificaci√≥n
- ‚úÖ **Generar** patches de nodos afectados

---

## üß™ ARCHITECTURE & MIGRATION SAFETY CHECKS

### 6.1 Evitar Reintroducir L√≥gica v1

**‚ùå PROHIBIDO:**

- Stripe (usar Polar)
- SendGrid (usar proveedor v2)
- Workers v1 (usar workers v2_*)
- Estados o modelos legacy
- Cualquier referencia a v1 salvo migraci√≥n expl√≠cita

**B√∫squeda de violaciones:**

```bash
# Buscar referencias legacy
grep -r "stripe\|sendgrid\|worker.*v1" src/ --exclude-dir=node_modules
grep -r "free\|basic\|creator_plus" src/ --exclude-dir=node_modules
```

### 6.2 Verificar Arquitectura v2

**El c√≥digo DEBE respetar:**

- ‚úÖ Workers v2_* (nombres con prefijo `v2_`)
- ‚úÖ SSOT enforcement (SettingsLoader)
- ‚úÖ Logs sin texto crudo (estructurados, GDPR-compliant)
- ‚úÖ GDPR enforcement (sin datos personales en logs)
- ‚úÖ FeatureFlagService (flags desde SSOT)
- ‚úÖ Boundaries hexagonales (separaci√≥n de capas)

**Referencias:**

- Arquitectura v2: `docs/ARCHITECTURE-V2.md` (si existe)
- Workers v2: `src/workers/v2_*/`
- SettingsLoader: `src/services/settingsLoader.ts` (o equivalente)

### 6.3 Manejo de C√≥digo Legacy

**Si una parte del sistema a√∫n no se migr√≥:**

- ‚ùå **NO tocarla** (salvo que la issue lo pida expl√≠citamente)
- ‚ùå **NO portarla** parcialmente
- ‚ùå **NO adaptarla** sin migraci√≥n completa
- ‚úÖ **Crear issue** de migraci√≥n si la necesitas

**Template de issue de migraci√≥n:**

```markdown
## Migraci√≥n v1 ‚Üí v2: [M√≥dulo]

**Motivo:** Necesario para [feature actual]  
**Alcance:** [Qu√© migrar]  
**Dependencias:** [Issues relacionadas]  
**Riesgo:** [Bajo/Medio/Alto]
```

---

## üìÑ WORK REVIEW BEFORE COMPLETION (AUTO-CHECK)

### 7.1 Checklist Obligatorio Pre-Completion

**ANTES de marcar como "complete", ejecutar estos 3 checks:**

#### CHECK 1 ‚Äî Trabajo vs Scope de la Issue

**Preguntas obligatorias:**

1. ¬øHe implementado EXACTAMENTE lo que el scope pide?
2. ¬øHe a√±adido algo que no est√° en el scope? ‚Üí **Si s√≠, eliminar**
3. ¬øFalta algo que s√≠ est√° en el scope? ‚Üí **Si s√≠, completar**
4. ¬øHay tareas que no se pueden resolver ahora? ‚Üí **Crear issue**

**Comando de verificaci√≥n:**

```bash
# Comparar diff con AC de la issue
gh issue view <n√∫mero> --json body | grep -A 10 "Acceptance Criteria"
git diff main...HEAD --stat
```

#### CHECK 2 ‚Äî Trabajo vs Nodos del GDD

**Preguntas obligatorias:**

1. ¬øEl comportamiento respeta totalmente el nodo correspondiente?
2. ¬øHay contradicciones? ‚Üí **Si s√≠, corregir o generar patch**
3. ¬øHe ignorado reglas expl√≠citas del nodo? ‚Üí **Si s√≠, corregir**
4. ¬øImplement√© partes no pedidas por la issue? ‚Üí **Si s√≠, revertir**

**Comando de verificaci√≥n:**

```bash
# Validar nodos afectados
node scripts/resolve-graph.js <nodos-afectados>
node scripts/validate-gdd-runtime.js --full
```

#### CHECK 3 ‚Äî Trabajo vs SSOT

**Preguntas obligatorias:**

1. ¬øTodos los valores provienen del SSOT?
2. ¬øHe usado alg√∫n valor hardcoded? ‚Üí **Si s√≠, corregir**
3. ¬øAlg√∫n plan/flag/tono/estado no autorizado? ‚Üí **Si s√≠, corregir**
4. ¬øAlguna plataforma no soportada? ‚Üí **Si s√≠, corregir**
5. ¬øAlg√∫n worker no listado? ‚Üí **Si s√≠, corregir**

**Comando de verificaci√≥n:**

```bash
# Buscar violaciones SSOT
grep -r "free\|basic\|creator_plus\|stripe\|sendgrid" src/ --exclude-dir=node_modules
```

### 7.2 Integraci√≥n con Skills

**Este check se integra con:**

- `verification-before-completion-skill` (`.claude/skills/verification-before-completion-skill.md`)
- `gdd-sync-skill` (`.claude/skills/gdd-sync-skill.md`)

**Ejecuci√≥n autom√°tica:**

Las skills ejecutar√°n estos checks antes de marcar como "complete".

---

## üìù DOCUMENTATION & PATCH REQUIREMENTS

### 8.1 Generaci√≥n de Patches

**Si una issue requiere actualizar:**

- Un nodo GDD
- El SSOT v2
- O revela inconsistencia entre nodos/SSOT/c√≥digo

**DEBES generar:**

#### 8.1.1 Nodo Patch

**Formato:** Markdown, siguiendo estilo del GDD

**Ubicaci√≥n:** Comentario en PR o `docs/patches/nodo-<nodo>-<issue>.md`

**Template:**

```markdown
# Nodo Patch: [Nodo] - Issue #[XXX]

## Cambio Propuesto

[Descripci√≥n del cambio]

## Justificaci√≥n

[Por qu√© es necesario]

## Impacto

- Nodos afectados: [lista]
- Dependencias: [lista]
- Breaking changes: [s√≠/no]

## C√≥digo de Referencia

[Links a c√≥digo relevante]

## Validaci√≥n

```bash
node scripts/resolve-graph.js <nodo>
node scripts/validate-gdd-runtime.js --full
```
```

#### 8.1.2 SSOT Patch

**Formato:** Markdown, siguiendo estructura de `docs/SSOT-V2.md`

**Ubicaci√≥n:** Comentario en PR o `docs/patches/ssot-<issue>.md`

**Template:**

```markdown
# SSOT Patch - Issue #[XXX]

## Secci√≥n Afectada

[Secci√≥n del SSOT]

## Cambio Propuesto

```typescript
// Antes
type PlanId = "starter" | "pro" | "plus";

// Despu√©s
type PlanId = "starter" | "pro" | "plus" | "enterprise";
```

## Justificaci√≥n

[Por qu√© es necesario]

## Impacto en C√≥digo

[Archivos que necesitan actualizaci√≥n]
```

#### 8.1.3 Issue de Seguimiento

**Si se detecta inconsistencia o necesidad de actualizaci√≥n:**

**Template:**

```markdown
## [Tipo]: [T√≠tulo]

**Detectado en:** Issue #[XXX]  
**Nodo/SSOT afectado:** [Referencia]  
**Problema:** [Descripci√≥n]  
**Impacto:** [C√≥mo afecta a futuro]  
**Prioridad:** [P0/P1/P2]

## Acci√≥n Requerida

[Qu√© se debe hacer]
```

### 8.2 A√±adir Patches a PR

**Los patches DEBEN a√±adirse como:**

- Comentario final en la PR (si son peque√±os)
- Archivos en `docs/patches/` (si son extensos)
- Referencia en descripci√≥n de PR

---

## üö´ PROHIBIDO ROTUNDO

**Cursor/Claude NO pueden:**

- ‚ùå Introducir features nuevas (solo scope de issue)
- ‚ùå Modificar el alcance de la issue (ampliar o reducir)
- ‚ùå Cambiar comportamiento de m√≥dulos no involucrados
- ‚ùå Inventar flags, planes, tonos o estados
- ‚ùå Alterar SSOT sin emitir patch
- ‚ùå Tocar features v1 (salvo migraci√≥n expl√≠cita)
- ‚ùå Omitir validaciones de logs/GDPR
- ‚ùå Cambiar workers sin actualizar su nodo correspondiente
- ‚ùå Cargar spec.md completo (solo nodos resueltos)
- ‚ùå Saltar checks de validaci√≥n pre-completion

---

## üõ°Ô∏è MODO DE FALLO

### 10.1 Detecci√≥n de Conflictos

**Si en alg√∫n momento detectas:**

- Falta de claridad en scope
- Ambig√ºedad en requirements
- Contradicci√≥n entre Issue/Nodo/SSOT
- Incompatibilidad con SSOT
- Informaci√≥n insuficiente
- Riesgo legal o de seguridad

**DEBES detener la ejecuci√≥n y emitir:**

```markdown
## üö® STOP ‚Äî SSOT/Nodo/Scope Conflict Detected

**Issue:** #[XXX]  
**Conflicto:** [Descripci√≥n detallada]  
**SSOT/Nodo afectado:** [Referencias]  
**Acci√≥n requerida:** [Qu√© se necesita para continuar]  
**Riesgo:** [Bajo/Medio/Alto]

### Opciones

1. **Aclaraci√≥n de scope** ‚Üí Esperar confirmaci√≥n
2. **Actualizaci√≥n de SSOT** ‚Üí Generar patch y esperar aprobaci√≥n
3. **Actualizaci√≥n de nodo** ‚Üí Generar patch y esperar aprobaci√≥n
4. **Crear issue de seguimiento** ‚Üí Continuar con scope limitado

**No se puede continuar hasta resolver este conflicto.**
```

### 10.2 Escalaci√≥n

**Si el conflicto es cr√≠tico (seguridad, billing, legal):**

1. Detener inmediatamente
2. Notificar a Product Owner
3. Documentar en PR
4. Esperar resoluci√≥n antes de continuar

---

## üîó REFERENCIAS OBLIGATORIAS

### Archivos Clave

- **SSOT v2:** `docs/SSOT-V2.md`
- **Nodos GDD:** `docs/nodes/*.md` (legacy v1)
- **Nodos GDD v2:** `docs/nodes-v2/<node>/<subnode>.md` (v2 optimizado)
- **System Map:** `docs/system-map.yaml` (legacy v1)
- **System Map v2:** `docs/system-map-v2.yaml` (v2 optimizado)
- **GDD Activation Guide:** `docs/GDD-ACTIVATION-GUIDE.md`
- **SSOT Enforcement (actual):** `.cursor/rules/ssot-enforcement.mdc`
- **V2 Optimized System:** `.cursor/rules/v2-optimized-system.mdc` (reglas v2 optimizadas)
- **System-Map Consistency & Drift Guard:** `.cursor/rules/system-map-consistency-drift-guard.mdc` (prevenci√≥n de drift)

### Scripts de Validaci√≥n

- **Resolver nodos:** `node scripts/resolve-graph.js <nodos>`
- **Validar runtime:** `node scripts/validate-gdd-runtime.js --full`
- **Health score:** `node scripts/score-gdd-health.js --ci` (debe >=87)
- **Drift prediction:** `node scripts/predict-gdd-drift.js --full` (<60 risk)
- **Auto-activaci√≥n GDD:** `node scripts/cursor-agents/auto-gdd-activation.js <issue>`

### Skills Relacionadas

- **GDD Sync:** `.claude/skills/gdd-sync-skill.md`
- **Verification Before Completion:** `.claude/skills/verification-before-completion-skill.md`
- **Security Audit:** `.claude/skills/security-audit-skill.md`

---

## ‚úÖ RESUMEN EJECUTIVO

**Antes de cualquier implementaci√≥n:**

1. ‚úÖ Leer scope de issue (AC espec√≠ficos)
2. ‚úÖ Resolver nodos GDD relevantes
3. ‚úÖ Leer SOLO nodos resueltos (NO spec.md completo)
4. ‚úÖ Verificar SSOT v2
5. ‚úÖ Leer `docs/patterns/coderabbit-lessons.md`

**Durante implementaci√≥n:**

1. ‚úÖ Respetar scope exacto (sin ampliar)
2. ‚úÖ Alinearse con nodos GDD (sin contradicciones)
3. ‚úÖ Usar valores desde SSOT (sin hardcode)
4. ‚úÖ Evitar l√≥gica v1 (solo v2)

**Antes de completar:**

1. ‚úÖ CHECK 1: Scope compliance
2. ‚úÖ CHECK 2: Node compliance
3. ‚úÖ CHECK 3: SSOT compliance
4. ‚úÖ Generar patches si es necesario
5. ‚úÖ Validar con scripts GDD

**Si hay conflicto:**

1. üö® DETENER
2. üìù DOCUMENTAR
3. üîÑ ESPERAR resoluci√≥n

---

**√öltima actualizaci√≥n:** 2025-12-02  
**Versi√≥n:** 2.0  
**Estado:** ‚úÖ Activo
