---
description: System-Map Consistency & Drift Guard v2 - Prevenci√≥n de inconsistencias y drift entre SSOT, nodes y system-map
globs:
  - "docs/system-map-v2.yaml"
  - "docs/nodes-v2/**/*.md"
  - "docs/SSOT-V2.md"
  - "gdd-health-v2.json"
  - "scripts/**/*system-map*.js"
  - "scripts/**/*gdd*.js"
alwaysApply: true
---

# SYSTEM-MAP CONSISTENCY & DRIFT GUARD (v2)

**Versi√≥n:** 2.0  
**Fecha:** 2025-12-02  
**Estado:** ‚úÖ Activo  
**Prop√≥sito:** Prevenir inconsistencias y drift entre SSOT-V2, nodes-v2, system-map-v2.yaml y c√≥digo

---

## 0. Scope

**Esta regla aplica cuando se modifica:**

- ‚úÖ `docs/system-map-v2.yaml`
- ‚úÖ `docs/nodes-v2/**/*.md`
- ‚úÖ `docs/SSOT-V2.md`
- ‚úÖ `gdd-health-v2.json`
- ‚úÖ Scripts que leen/escriben estos archivos (`scripts/**/*system-map*.js`, `scripts/**/*gdd*.js`)
- ‚úÖ Archivos listados en `nodes.*.files` del system-map

**Tambi√©n aplica cuando:**

- Se detectan referencias a nodos/workers en c√≥digo
- Se crean nuevas dependencias entre nodos
- Se modifican valores que deben venir de SSOT

---

## 1. Source-of-Truth Hierarchy

### 1.1 Jerarqu√≠a de Autoridad

**Orden de precedencia (de mayor a menor):**

1. **SSOT-V2** (`docs/SSOT-V2.md`) ‚Üí **GANA SIEMPRE**
2. **nodes-v2** (`docs/nodes-v2/<node>/<subnode>.md`) ‚Üí Define implementaci√≥n
3. **system-map-v2.yaml** ‚Üí Define estructura y relaciones
4. **C√≥digo/comentarios** ‚Üí √öltima fuente, puede estar desactualizado

### 1.2 Regla de Resoluci√≥n

**Si un valor no existe en SSOT ‚Üí marcar TBD y STOP:**

```markdown
## üö® STOP ‚Äî Valor Faltante en SSOT

**Valor solicitado:** [Nombre del valor]  
**Ubicaci√≥n:** [Archivo/Secci√≥n donde se necesita]  
**Acci√≥n requerida:**
1. Verificar si existe en SSOT-V2.md
2. Si NO existe ‚Üí marcar como TBD
3. Crear issue para a√±adir valor a SSOT
4. NO inventar el valor

**Template de TBD:**
```typescript
// TODO: TBD - Falta en SSOT v2
// Issue: #[XXX] - A√±adir [valor] a SSOT
// Temporal: [valor temporal con justificaci√≥n]
const temporalValue = 'temporal'; // ‚ö†Ô∏è REMOVER cuando SSOT se actualice
```

**No se puede continuar hasta resolver este conflicto.**
```

### 1.3 Validaci√≥n de Jerarqu√≠a

**Antes de usar cualquier valor, verificar:**

```bash
# 1. Buscar en SSOT-V2
grep -r "<valor>" docs/SSOT-V2.md

# 2. Si no existe ‚Üí STOP y marcar TBD
# 3. Si existe ‚Üí usar valor de SSOT
```

---

## 2. Node & Worker ID Consistency

### 2.1 IDs V√°lidos

**SOLO usar IDs definidos en `system-map-v2.yaml`:**

```yaml
# ‚úÖ CORRECTO - IDs v√°lidos en system-map-v2.yaml
nodes:
  roast-generation:
    id: roast-generation
  shield-moderation:
    id: shield-moderation
```

### 2.2 IDs Legacy Prohibidos

**‚ùå PROHIBIDO usar estos IDs legacy:**

- ‚ùå `roast` ‚Üí Usar `roast-generation` o equivalente v2
- ‚ùå `shield` ‚Üí Usar `shield-moderation` o equivalente v2
- ‚ùå `social-platforms` ‚Üí Usar IDs espec√≠ficos por plataforma v2
- ‚ùå `frontend-dashboard` ‚Üí Usar `admin-dashboard` o equivalente v2
- ‚ùå `plan-features` ‚Üí Usar `plan-configuration` o equivalente v2
- ‚ùå `persona` ‚Üí Usar `persona-config` o equivalente v2
- ‚ùå Cualquier ID del `system-map.yaml` legacy (v1)

**Detecci√≥n de IDs Legacy:**

```bash
# Buscar IDs legacy prohibidos
grep -r "\"roast\"\|\"shield\"\|\"social-platforms\"\|\"frontend-dashboard\"\|\"plan-features\"\|\"persona\"" \
  docs/nodes-v2/ docs/system-map-v2.yaml src/

# Si se encuentra ‚Üí STOP y mapear a v2
```

### 2.3 Mapeo de IDs Legacy a v2

**Si se detecta ID legacy ‚Üí mapear a equivalente v2:**

```markdown
## ‚ö†Ô∏è ID Legacy Detectado ‚Äî Mapeo Requerido

**ID Legacy:** `roast`  
**Ubicaci√≥n:** [Archivo/L√≠nea]  
**Mapeo sugerido:** `roast-generation` (verificar en system-map-v2.yaml)

**Acci√≥n requerida:**
1. Verificar ID equivalente en system-map-v2.yaml
2. Reemplazar ID legacy por ID v2
3. Actualizar referencias en dependencias
4. Validar que el nuevo ID existe en system-map-v2.yaml
```

### 2.4 Workers Oficiales SSOT

**Workers referenciados DEBEN ser oficiales del SSOT:**

```typescript
// ‚úÖ CORRECTO - Worker oficial del SSOT
import { v2_FetchCommentsWorker } from '@/workers/v2_fetchComments';

// ‚ùå INCORRECTO - Worker no oficial
import { LegacyWorker } from '@/workers/legacy';
```

**Validaci√≥n de Workers:**

```bash
# 1. Verificar workers oficiales en SSOT-V2.md
grep -A 20 "Workers" docs/SSOT-V2.md

# 2. Verificar que el worker usado est√° listado
# 3. Si no est√° ‚Üí STOP y usar worker oficial
```

### 2.5 Flows/Integrations Nodes

**Flows e integraciones DEBEN usar:**

- ‚úÖ IDs de nodos v√°lidos de `system-map-v2.yaml`
- ‚úÖ Workers oficiales del SSOT
- ‚ùå NO IDs legacy
- ‚ùå NO workers no oficiales

**Ejemplo:**

```yaml
# ‚úÖ CORRECTO
flows:
  comment-analysis:
    nodes:
      - roast-generation  # ID v√°lido en system-map-v2.yaml
      - shield-moderation  # ID v√°lido en system-map-v2.yaml
    workers:
      - v2_FetchCommentsWorker  # Worker oficial SSOT

# ‚ùå INCORRECTO
flows:
  comment-analysis:
    nodes:
      - roast  # ID legacy prohibido
      - shield  # ID legacy prohibido
    workers:
      - LegacyWorker  # Worker no oficial
```

---

## 3. Strong/Soft Concepts (System-Map View)

### 3.1 Strong Concepts en System-Map

**Strong concepts tienen un solo nodo due√±o:**

```yaml
# ‚úÖ CORRECTO - Strong Concept con due√±o √∫nico
nodes:
  persona-config:
    description: Persona configuration (Strong Concept owner)
    strong_concept: persona
    # Solo este nodo puede definir Persona completamente

  roast-generation:
    description: Uses Persona (references, not redefines)
    depends_on:
      - persona-config  # Referencia, no redefinici√≥n
```

**‚ùå PROHIBIDO:**

```yaml
# ‚ùå VIOLACI√ìN - Duplicado de Strong Concept
nodes:
  persona-config:
    strong_concept: persona

  persona-settings:  # ‚ùå NO puede redefinir Persona
    strong_concept: persona  # Violaci√≥n
```

### 3.2 Soft Concepts en System-Map

**Soft concepts pueden aparecer en m√∫ltiples nodos sin duplicar contenido:**

```yaml
# ‚úÖ CORRECTO - Soft Concept dividido por responsabilidad
nodes:
  roast-generation:
    description: Genera roasts (parte del flujo de generaci√≥n)
    soft_concepts:
      - generation-flow

  shield-moderation:
    description: Modera roasts (parte del flujo de moderaci√≥n)
    soft_concepts:
      - moderation-flow
    depends_on:
      - roast-generation  # Referencia sin duplicar contenido
```

### 3.3 Validaci√≥n de Concepts

**Antes de crear/modificar un concepto, verificar:**

```bash
# 1. Verificar si es Strong Concept
grep -r "strong_concept.*<concept>" docs/system-map-v2.yaml

# 2. Si es Strong y ya tiene due√±o ‚Üí NO redefinir
# 3. Si es Soft ‚Üí puede aparecer en m√∫ltiples nodos
# 4. Validar que no hay duplicados de Strong Concepts
```

---

## 4. Editing Workflow

### 4.1 Before: Pre-Editing Checklist

**ANTES de editar, SIEMPRE:**

1. ‚úÖ **Leer SSOT-V2.md** - Verificar valores y definiciones
2. ‚úÖ **Leer nodes-v2 relevantes** - Entender implementaci√≥n actual
3. ‚úÖ **Leer system-map-v2.yaml** - Verificar estructura y relaciones
4. ‚úÖ **Verificar que el concepto existe** - No inventar nuevos conceptos sin SSOT

**Comandos:**

```bash
# 1. Leer SSOT
cat docs/SSOT-V2.md | grep -A 10 "<secci√≥n-relevante>"

# 2. Leer nodos relevantes
cat docs/nodes-v2/<node>/<subnode>.md

# 3. Leer system-map
cat docs/system-map-v2.yaml | grep -A 20 "<node>"

# 4. Verificar concepto
grep -r "<concept>" docs/SSOT-V2.md docs/nodes-v2/ docs/system-map-v2.yaml
```

### 4.2 During: Reglas Durante la Edici√≥n

**DURANTE la edici√≥n, mantener:**

1. ‚úÖ **Symmetry `depends_on` / `required_by`**
   - Si A depende de B ‚Üí B debe tener A en `required_by`
   - Si A requiere B ‚Üí B debe tener A en `depends_on`

2. ‚úÖ **Subnodos existen**
   - Cada subnodo referenciado debe existir f√≠sicamente
   - Verificar: `ls docs/nodes-v2/<node>/<subnode>.md`

3. ‚úÖ **No valores inventados**
   - Todos los valores deben venir de SSOT
   - Si falta ‚Üí marcar TBD

4. ‚úÖ **Respetar Strong/Soft rules**
   - No duplicar Strong Concepts
   - Soft Concepts pueden aparecer en m√∫ltiples nodos

5. ‚úÖ **Usar solo IDs v√°lidos**
   - Solo IDs de system-map-v2.yaml
   - NO IDs legacy

**Ejemplo de Symmetry:**

```yaml
# ‚úÖ CORRECTO - Symmetry mantenida
nodes:
  roast-generation:
    depends_on:
      - persona-config
    required_by: []  # Se llena autom√°ticamente

  persona-config:
    depends_on: []
    required_by:
      - roast-generation  # Symmetry con roast-generation.depends_on
```

### 4.3 After: Post-Editing Checklist

**DESPU√âS de editar, validar:**

```markdown
## ‚úÖ Post-Editing Checklist

- [ ] **No IDs legacy** - Verificado con grep
- [ ] **Symmetry enforced** - `depends_on` y `required_by` son sim√©tricos
- [ ] **Subnodos presentes** - Todos los subnodos referenciados existen
- [ ] **No invenciones** - Todos los valores vienen de SSOT
- [ ] **TBD para gaps** - Valores faltantes marcados como TBD
- [ ] **Strong/Soft respetados** - No duplicados de Strong Concepts
- [ ] **IDs v√°lidos** - Solo IDs de system-map-v2.yaml
```

**Comandos de validaci√≥n:**

```bash
# 1. Verificar IDs legacy
grep -r "\"roast\"\|\"shield\"\|\"social-platforms\"" docs/nodes-v2/ docs/system-map-v2.yaml

# 2. Verificar symmetry
node scripts/validate-system-map-symmetry.js

# 3. Verificar subnodos
node scripts/validate-subnodes-exist.js

# 4. Verificar valores SSOT
node scripts/validate-ssot-compliance.js

# 5. Verificar Strong Concepts
node scripts/validate-strong-concepts.js
```

---

## 5. Drift Handling

### 5.1 Detecci√≥n de Drift

**Drift ocurre cuando:**

- SSOT define un valor pero nodes/system-map tienen otro
- Nodes definen comportamiento pero c√≥digo no lo implementa
- System-map tiene relaciones pero nodes no las reflejan
- C√≥digo usa valores que no est√°n en SSOT

### 5.2 Regla de Alineaci√≥n

**Si SSOT define valor ‚Üí alinear nodes/system-map a SSOT:**

```markdown
## üîÑ Drift Detectado ‚Äî Alineaci√≥n Requerida

**Valor en SSOT:** `plan.starter.analysis_limit = 1000`  
**Valor en nodes/system-map:** `plan.starter.analysis_limit = 500`  
**Alineaci√≥n requerida:** Actualizar nodes/system-map a 1000 (valor de SSOT)

**Acci√≥n:**
1. Actualizar nodes-v2 con valor de SSOT
2. Actualizar system-map-v2.yaml si es necesario
3. Actualizar c√≥digo si usa valor hardcoded
4. Validar que todo est√° alineado
```

### 5.3 Si SSOT No Define Valor

**Si SSOT no define valor ‚Üí marcar TBD y STOP:**

```markdown
## üö® STOP ‚Äî Valor Faltante en SSOT

**Valor necesario:** `plan.enterprise.custom_limit`  
**SSOT actual:** No define `enterprise` plan  
**Acci√≥n requerida:**
1. Marcar como TBD en c√≥digo/nodes
2. Crear issue para a√±adir a SSOT
3. NO inventar el valor
4. Esperar actualizaci√≥n de SSOT antes de continuar
```

### 5.4 Mapeo de IDs Legacy

**Si aparecen IDs legacy ‚Üí mapear a equivalente v2:**

```markdown
## üîÑ Mapeo Legacy ‚Üí v2

**ID Legacy detectado:** `roast`  
**Ubicaci√≥n:** `docs/nodes-v2/roast/generation.md`  
**Mapeo:** `roast` ‚Üí `roast-generation` (verificar en system-map-v2.yaml)

**Acci√≥n:**
1. Buscar todas las referencias a `roast`
2. Reemplazar por `roast-generation`
3. Actualizar system-map-v2.yaml si es necesario
4. Validar que `roast-generation` existe en system-map-v2.yaml
```

**Script de mapeo:**

```bash
# Mapear IDs legacy a v2
node scripts/map-legacy-ids-to-v2.js \
  --input docs/nodes-v2/ \
  --mapping docs/legacy-id-mapping.json \
  --output docs/nodes-v2/
```

---

## 6. Guardian Node

### 6.1 Prohibici√≥n Permanente

**‚ö†Ô∏è CR√çTICO: El nodo "guardian" est√° eliminado permanentemente.**

- ‚ùå **No puede existir** en system-map-v2.yaml
- ‚ùå **No puede referenciarse** en nodes-v2
- ‚ùå **No puede recrearse** bajo ning√∫n concepto
- ‚ùå **Si aparece referencia** ‚Üí STOP inmediato

### 6.2 Detecci√≥n de Referencias

**Buscar referencias a guardian:**

```bash
# Buscar en system-map-v2.yaml
grep -r "guardian" docs/system-map-v2.yaml

# Buscar en nodes-v2
grep -r "guardian" docs/nodes-v2/

# Buscar en c√≥digo
grep -r "guardian" src/ --exclude-dir=node_modules

# Si se encuentra ‚Üí STOP
```

### 6.3 Mensaje de Aviso

**Si se detecta referencia a guardian:**

```markdown
## üö® STOP ‚Äî Referencia a Nodo Guardian Detectada

**Ubicaci√≥n:** [Ruta del archivo]  
**Tipo:** [Referencia directa / Comportamiento similar / ID legacy]  
**Acci√≥n:** El nodo "guardian" est√° deprecated y no puede recrearse.

**Mensaje obligatorio:**
> "guardian node is deprecated and cannot be recreated."

**Alternativa sugerida:**
- Usar validaciones en otros nodos (ej: `shield-moderation` para moderaci√≥n)
- Usar `admin-dashboard` para gobernanza de producto
- Crear nodo espec√≠fico si es necesario (con autorizaci√≥n expl√≠cita)

**No se puede continuar hasta eliminar la referencia.**
```

---

## 7. Validaciones Autom√°ticas

### 7.1 Scripts de Validaci√≥n

**Ejecutar antes de commit:**

```bash
# 1. Validar consistencia de IDs
node scripts/validate-node-ids.js --system-map docs/system-map-v2.yaml

# 2. Validar workers oficiales
node scripts/validate-workers-ssot.js --ssot docs/SSOT-V2.md

# 3. Validar drift
node scripts/validate-drift.js \
  --ssot docs/SSOT-V2.md \
  --nodes docs/nodes-v2/ \
  --system-map docs/system-map-v2.yaml

# 4. Validar symmetry
node scripts/validate-symmetry.js --system-map docs/system-map-v2.yaml

# 5. Validar Strong Concepts
node scripts/validate-strong-concepts.js \
  --system-map docs/system-map-v2.yaml \
  --nodes docs/nodes-v2/

# 6. Detectar IDs legacy
node scripts/detect-legacy-ids.js \
  --system-map docs/system-map-v2.yaml \
  --nodes docs/nodes-v2/ \
  --code src/

# 7. Detectar referencias a guardian
node scripts/detect-guardian-references.js \
  --system-map docs/system-map-v2.yaml \
  --nodes docs/nodes-v2/ \
  --code src/
```

### 7.2 Integraci√≥n con CI

**Estos checks deben ejecutarse en CI:**

```yaml
# .github/workflows/system-map-consistency.yml
name: System-Map Consistency Check

on:
  pull_request:
    paths:
      - 'docs/system-map-v2.yaml'
      - 'docs/nodes-v2/**'
      - 'docs/SSOT-V2.md'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate System-Map Consistency
        run: |
          node scripts/validate-node-ids.js
          node scripts/validate-workers-ssot.js
          node scripts/validate-drift.js
          node scripts/validate-symmetry.js
          node scripts/validate-strong-concepts.js
          node scripts/detect-legacy-ids.js
          node scripts/detect-guardian-references.js
```

---

## 8. Referencias Obligatorias

### 8.1 Archivos Clave

- **SSOT-V2:** `docs/SSOT-V2.md`
- **System-map v2:** `docs/system-map-v2.yaml`
- **Nodes v2:** `docs/nodes-v2/<node>/<subnode>.md`
- **Health v2:** `gdd-health-v2.json`

### 8.2 Reglas Relacionadas

- **V2 Optimized System:** `.cursor/rules/v2-optimized-system.mdc`
- **SSOT Scope Enforcement:** `.cursor/rules/ssot-scope-enforcement.mdc`

---

## 9. Resumen Ejecutivo

### 9.1 Antes de Editar

1. ‚úÖ Leer SSOT-V2.md
2. ‚úÖ Leer nodes-v2 relevantes
3. ‚úÖ Leer system-map-v2.yaml
4. ‚úÖ Verificar que el concepto existe

### 9.2 Durante la Edici√≥n

1. ‚úÖ Mantener symmetry `depends_on` / `required_by`
2. ‚úÖ Asegurar que subnodos existen
3. ‚úÖ No inventar valores (usar SSOT)
4. ‚úÖ Respetar Strong/Soft rules
5. ‚úÖ Usar solo IDs v√°lidos (no legacy)

### 9.3 Despu√©s de Editar

1. ‚úÖ Verificar no hay IDs legacy
2. ‚úÖ Verificar symmetry
3. ‚úÖ Verificar subnodos presentes
4. ‚úÖ Verificar no hay invenciones
5. ‚úÖ Marcar TBD para gaps
6. ‚úÖ Validar con scripts

### 9.4 Si Hay Drift

1. üîÑ Si SSOT define valor ‚Üí alinear a SSOT
2. üö® Si SSOT no define ‚Üí marcar TBD y STOP
3. üîÑ Si hay IDs legacy ‚Üí mapear a v2

### 9.5 Si Hay Referencia a Guardian

1. üö® **STOP inmediato**
2. üìù **Eliminar referencia**
3. ‚ö†Ô∏è **Avisar:** "guardian node is deprecated and cannot be recreated."

---

**√öltima actualizaci√≥n:** 2025-12-02  
**Versi√≥n:** 2.0  
**Estado:** ‚úÖ Activo
