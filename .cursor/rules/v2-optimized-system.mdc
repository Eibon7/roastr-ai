---
description: Reglas v2 Optimizadas - Sistema de Nodos y Subnodos con Gobernanza Strong/Soft
globs:
  - "docs/nodes-v2/**/*"
  - "docs/system-map-v2.yaml"
  - "docs/SSOT-V2.md"
alwaysApply: true
---

# ‚≠ê CURSOR RULES ‚Äî v2 Optimized Edition (Machine-Friendly)

**Versi√≥n:** 2.0  
**Fecha:** 2025-12-02  
**Estado:** ‚úÖ Activo  
**Prop√≥sito:** Sistema optimizado de nodos y subnodos con gobernanza estricta de Strong/Soft concepts

---

## 0. Terminolog√≠a

- **Node**: Nodo maestro definido en `system-map-v2.yaml`
- **Subnode**: Archivo en `docs/nodes-v2/<node>/<subnode>.md`
- **Strong Concept**: Concepto con due√±o √∫nico (no se puede duplicar ni redefinir)
- **Soft Concept**: Concepto repartido entre nodos sin duplicaci√≥n
- **Allowed Sources**: Subnodo activo, nodo maestro, SSOT-V2, Spec v2, dependencias de system-map

---

## 1. Activaci√≥n de Subnodos

### 1.1 Requisitos Obligatorios

Para activar un subnodo, **TODOS** estos requisitos deben cumplirse:

1. ‚úÖ Debe aparecer en `system-map-v2.yaml` ‚Üí `nodes.<node>.subnodes`
2. ‚úÖ Debe existir f√≠sicamente en `docs/nodes-v2/<node>/<subnode>.md`
3. ‚úÖ El nodo maestro debe estar declarado en el `system-map-v2.yaml`
4. ‚úÖ Debe respetar ownership (Strong/Soft concepts)

### 1.2 Workflow de Activaci√≥n

```bash
# 1. Verificar existencia en system-map
grep -A 5 "nodes:" docs/system-map-v2.yaml | grep "<node>"

# 2. Verificar existencia f√≠sica del subnodo
ls docs/nodes-v2/<node>/<subnode>.md

# 3. Verificar ownership de Strong Concepts
# (ver secci√≥n 2.1)
```

### 1.3 Detecci√≥n de Faltantes

**Si alguno falta ‚Üí STOP + pedir confirmaci√≥n al usuario:**

```markdown
## üö® STOP ‚Äî Subnodo Incompleto

**Subnodo solicitado:** `<node>/<subnode>`  
**Faltante detectado:**
- [ ] No existe en system-map-v2.yaml
- [ ] No existe f√≠sicamente en docs/nodes-v2/
- [ ] Nodo maestro no declarado
- [ ] Violaci√≥n de ownership Strong Concept

**Acci√≥n requerida:** [Especificar qu√© falta y c√≥mo resolverlo]

**No se puede continuar hasta resolver este conflicto.**
```

---

## 2. Gobernanza Strong/Soft

### 2.1 Strong Concepts (Due√±o √önico)

**No se pueden duplicar ni redefinir.** Solo un nodo/subnodo puede poseerlos.

#### Lista de Strong Concepts

1. **Persona** - Configuraci√≥n de personalidad del usuario
2. **Tones** - Definici√≥n de tonos de roast (flanders, balanceado, canalla, personal)
3. **Prompt Architecture** - Estructura y plantillas de prompts de IA
4. **Workers oficiales SSOT** - Workers v2_* definidos en SSOT
5. **Shield thresholds & weights** - Valores de umbrales y pesos de moderaci√≥n
6. **Billing state machine** - M√°quina de estados de facturaci√≥n
7. **SSOT loader & feature flags** - Carga de configuraci√≥n y flags desde SSOT
8. **Queue system & RLS** - Sistema de colas y Row Level Security
9. **Platform constraints** - Restricciones espec√≠ficas por plataforma
10. **GDPR retention rules** - Reglas de retenci√≥n de datos GDPR

#### Reglas de Strong Concepts

- ‚úÖ **Solo el due√±o puede definir** el concepto completo
- ‚úÖ **Otros nodos solo pueden referenciar** (no redefinir)
- ‚ùå **PROHIBIDO** crear duplicados (ej: `Persona-II`, `Tones-v2`)
- ‚ùå **PROHIBIDO** redefinir en otro nodo

#### Ejemplo de Violaci√≥n

```markdown
# ‚ùå VIOLACI√ìN
# En docs/nodes-v2/roast/persona.md
## Persona Configuration
[Definici√≥n completa de Persona]

# En docs/nodes-v2/settings/persona.md (DUPLICADO)
## Persona Settings
[Otra definici√≥n de Persona]

# ‚úÖ CORRECTO
# En docs/nodes-v2/persona/core.md (due√±o √∫nico)
## Persona Configuration
[Definici√≥n completa de Persona]

# En docs/nodes-v2/roast/persona-integration.md (referencia)
## Persona Integration
See: [Persona Core](../persona/core.md)
Uses: Persona configuration from persona/core.md
```

### 2.2 Soft Concepts

- ‚úÖ **Pueden aparecer en varios nodos** sin duplicar contenido
- ‚úÖ **Si un concepto cae en dos nodos** ‚Üí dividir por responsabilidad
- ‚ùå **Si la divisi√≥n no es obvia** ‚Üí STOP y pedir aclaraci√≥n

#### Ejemplo de Soft Concept

```markdown
# ‚úÖ CORRECTO - Soft Concept dividido por responsabilidad

# docs/nodes-v2/roast/generation.md
## Roast Generation
- Genera roasts usando Persona (referencia a persona/core.md)
- Aplica l√≠mites de caracteres seg√∫n plataforma (referencia a platform-constraints/core.md)

# docs/nodes-v2/shield/moderacion.md
## Shield Moderation
- Analiza roasts generados (referencia a roast/generation.md)
- Aplica thresholds definidos en shield/thresholds.md (Strong Concept)
```

#### Manejo de Divisi√≥n Ambigua

**Si la divisi√≥n no es obvia ‚Üí STOP:**

```markdown
## üö® STOP ‚Äî Divisi√≥n Ambigua de Soft Concept

**Concepto:** [Nombre del concepto]  
**Nodos afectados:** `<node1>`, `<node2>`  
**Problema:** No est√° claro c√≥mo dividir la responsabilidad

**Opciones:**
1. Asignar a un solo nodo (convertir en Strong Concept)
2. Dividir por [criterio espec√≠fico]
3. Crear nodo intermedio

**Acci√≥n requerida:** Aclaraci√≥n del usuario sobre c√≥mo proceder
```

---

## 3. Restricci√≥n de Contexto

### 3.1 Allowed Sources (√öNICAS Fuentes Permitidas)

Cursor **SOLO** puede usar estas fuentes:

1. ‚úÖ **Subnodo activo** - `docs/nodes-v2/<node>/<subnode>.md`
2. ‚úÖ **Nodo maestro** - Definici√≥n en `system-map-v2.yaml`
3. ‚úÖ **SSOT-V2** - `docs/SSOT-V2.md`
4. ‚úÖ **Spec v2** - `docs/spec-v2.md` (si existe)
5. ‚úÖ **Nodos listados en `depends_on`** - Dependencias del system-map

### 3.2 Fuentes Prohibidas

**‚ùå PROHIBIDO usar:**

- ‚ùå `docs/nodes/*.md` (nodos legacy v1)
- ‚ùå `docs/spec.md` (spec legacy v1)
- ‚ùå Cualquier archivo fuera de Allowed Sources
- ‚ùå C√≥digo fuente como fuente de verdad (solo SSOT/nodos)
- ‚ùå Documentaci√≥n no oficial

### 3.3 Validaci√≥n de Fuentes

**Antes de usar cualquier fuente, verificar:**

```bash
# 1. Verificar que el subnodo est√° en system-map
grep -r "<subnode>" docs/system-map-v2.yaml

# 2. Verificar que el nodo est√° en depends_on si se referencia
grep -A 10 "depends_on:" docs/system-map-v2.yaml | grep "<node>"

# 3. Verificar que SSOT-V2 existe
test -f docs/SSOT-V2.md && echo "SSOT-V2 exists" || echo "SSOT-V2 missing"
```

### 3.4 Violaci√≥n de Restricci√≥n

**Si se intenta usar fuente prohibida ‚Üí STOP:**

```markdown
## üö® STOP ‚Äî Fuente Prohibida Detectada

**Fuente intentada:** [Ruta del archivo]  
**Tipo:** [Legacy v1 / Fuera de scope / No autorizada]  
**Allowed Sources:**
- Subnodo activo
- Nodo maestro (system-map-v2.yaml)
- SSOT-V2
- Spec v2
- Dependencias del system-map

**Acci√≥n requerida:** Usar solo fuentes permitidas o solicitar actualizaci√≥n del system-map
```

---

## 4. Prohibiciones

### 4.1 Inventar Contenido

**Si algo no est√° en Allowed Sources ‚Üí marcar como TBD + pedir confirmaci√≥n:**

```markdown
# ‚ùå PROHIBIDO
## Feature X
[Implementaci√≥n inventada sin base en SSOT/nodos]

# ‚úÖ CORRECTO
## Feature X
<!-- TODO: TBD - Falta en SSOT v2 / Nodos v2 -->
<!-- Issue: #[XXX] - A√±adir Feature X a SSOT/Nodos -->
<!-- Temporal: [valor temporal con justificaci√≥n] -->
const temporalValue = 'temporal'; // ‚ö†Ô∏è REMOVER cuando SSOT/Nodos se actualice
```

### 4.2 Reorganizar Estructura (PROHIBIDO)

**‚ùå PROHIBIDO:**

- ‚ùå Mover subnodos entre nodos
- ‚ùå Crear duplicados (ej: `Persona-II`, `Tones-v2`)
- ‚ùå Fusionar nodos sin autorizaci√≥n expl√≠cita
- ‚ùå Cambiar dependencias del system-map sin aprobaci√≥n
- ‚ùå Renombrar nodos/subnodos existentes

**Violaci√≥n ‚Üí STOP inmediato:**

```markdown
## üö® STOP ‚Äî Reorganizaci√≥n No Autorizada

**Acci√≥n detectada:** [Mover/Fusionar/Renombrar/Crear duplicado]  
**Elemento afectado:** `<node>/<subnode>`  
**Raz√≥n:** Reorganizaci√≥n de estructura requiere autorizaci√≥n expl√≠cita

**Acci√≥n requerida:** 
1. Obtener autorizaci√≥n expl√≠cita del usuario
2. Actualizar system-map-v2.yaml con aprobaci√≥n
3. Documentar cambio en PR/issue

**No se puede continuar sin autorizaci√≥n.**
```

### 4.3 Eliminaci√≥n Permanente del Nodo "guardian"

**‚ö†Ô∏è CR√çTICO: El nodo "guardian" est√° eliminado permanentemente.**

- ‚ùå **No puede existir** ni recrearse
- ‚ùå **Si aparece referencia directa o indirecta** ‚Üí STOP
- ‚ùå **Si un comportamiento lo imita** ‚Üí Avisar

**Detecci√≥n de Referencias:**

```bash
# Buscar referencias a guardian
grep -r "guardian" docs/nodes-v2/ docs/system-map-v2.yaml

# Si se encuentra ‚Üí STOP
```

**Mensaje de Aviso:**

```markdown
## ‚ö†Ô∏è AVISO ‚Äî Referencia a Nodo Guardian Detectada

**Ubicaci√≥n:** [Ruta del archivo]  
**Tipo:** [Referencia directa / Comportamiento similar]  
**Acci√≥n:** El nodo "guardian" est√° deprecated y no puede recrearse.

**Alternativa sugerida:** [Proponer alternativa seg√∫n contexto]
```

---

## 5. Validaciones Obligatorias

### 5.1 Checklist Pre-Implementaci√≥n

**ANTES de producir c√≥digo o documentaci√≥n, validar SIEMPRE:**

1. ‚úÖ **Subnodo ‚Üî Nodo maestro**
   - Subnodo existe en system-map-v2.yaml
   - Nodo maestro est√° declarado
   - Dependencias est√°n listadas

2. ‚úÖ **Nodo maestro ‚Üî SSOT-V2**
   - Valores usados est√°n en SSOT-V2
   - No hay valores hardcoded prohibidos
   - Feature flags vienen de SSOT

3. ‚úÖ **Nodo maestro ‚Üî system-map**
   - Dependencias son correctas
   - No hay ciclos
   - Relaciones bidireccionales son consistentes

4. ‚úÖ **Dependencias del nodo**
   - Todas las dependencias est√°n resueltas
   - No hay dependencias faltantes
   - Orden de carga es correcto

5. ‚úÖ **Ownership de Strong Concepts**
   - No hay duplicados
   - Solo el due√±o define el concepto
   - Referencias son correctas

### 5.2 Comandos de Validaci√≥n

```bash
# 1. Validar estructura de system-map
node scripts/validate-system-map-v2.js

# 2. Validar subnodos vs system-map
node scripts/validate-subnodes.js

# 3. Validar Strong Concepts (no duplicados)
node scripts/validate-strong-concepts.js

# 4. Validar dependencias
node scripts/validate-dependencies.js

# 5. Validar SSOT compliance
grep -r "free\|basic\|creator_plus\|stripe\|sendgrid" src/ --exclude-dir=node_modules
```

### 5.3 Manejo de Contradicciones

**Si hay contradicci√≥n ‚Üí STOP + explicar el conflicto:**

```markdown
## üö® STOP ‚Äî Contradicci√≥n Detectada

**Validaci√≥n fallida:** [Nombre de la validaci√≥n]  
**Conflicto:**
- [Descripci√≥n detallada del conflicto]
- [Elementos en conflicto]

**Opciones:**
1. Corregir implementaci√≥n para alinearse con nodo/SSOT
2. Actualizar nodo/SSOT con justificaci√≥n
3. Crear issue de seguimiento

**No se puede continuar hasta resolver este conflicto.**
```

---

## 6. Mantenimiento Autom√°tico

### 6.1 Actualizaci√≥n de Subnodos

**Cuando un subnodo cambia:**

1. ‚úÖ **Actualizar secci√≥n relevante del nodo maestro**
   - Sincronizar cambios en system-map-v2.yaml
   - Actualizar metadata (last_updated, coverage, etc.)

2. ‚úÖ **A√±adir referencias a system-map si aparecen nuevas dependencias o flujos**
   - Actualizar `depends_on` si es necesario
   - Actualizar `used_by` si otros nodos lo usan

3. ‚ö†Ô∏è **Si toca un Strong Concept ‚Üí SOLO si el usuario lo ordena expl√≠citamente**
   - No modificar Strong Concepts sin autorizaci√≥n
   - Documentar cambio en PR/issue

### 6.2 Workflow de Mantenimiento

```bash
# 1. Detectar cambios en subnodo
git diff docs/nodes-v2/<node>/<subnode>.md

# 2. Actualizar nodo maestro si es necesario
# (editar system-map-v2.yaml)

# 3. Validar cambios
node scripts/validate-system-map-v2.js
node scripts/validate-strong-concepts.js

# 4. Si toca Strong Concept ‚Üí Verificar autorizaci√≥n
# (verificar en PR/issue si hay autorizaci√≥n expl√≠cita)
```

### 6.3 Sincronizaci√≥n Autom√°tica

**Despu√©s de cambios, ejecutar:**

```bash
# Sincronizar system-map con subnodos
node scripts/sync-system-map-v2.js

# Validar coherencia
node scripts/validate-system-map-v2.js --full
```

---

## 7. Logging Interno

### 7.1 Registro de Operaciones

**Cada operaci√≥n debe registrar internamente (no se imprime a menos que el usuario lo pida):**

- ‚úÖ **Nodo maestro activado** - `system-map-v2.yaml ‚Üí nodes.<node>`
- ‚úÖ **Subnodo activado** - `docs/nodes-v2/<node>/<subnode>.md`
- ‚úÖ **Dependencias validadas** - Lista de `depends_on` verificadas
- ‚úÖ **Secciones SSOT usadas** - Referencias a `docs/SSOT-V2.md`
- ‚úÖ **Cambios aplicados** - Diff de modificaciones

### 7.2 Formato de Log Interno

```json
{
  "timestamp": "2025-12-02T10:30:00Z",
  "operation": "subnode_activation",
  "node": "roast",
  "subnode": "generation",
  "dependencies_validated": ["persona", "tone", "platform-constraints"],
  "ssot_sections_used": ["1. Plans and Limits", "3. Feature Flags"],
  "strong_concepts_referenced": ["Persona", "Tones"],
  "changes_applied": {
    "files_modified": ["src/services/roastEngine.js"],
    "lines_changed": 45
  }
}
```

### 7.3 Acceso al Log

**El log es interno por defecto. Para acceder:**

```bash
# Ver log de √∫ltima operaci√≥n
node scripts/get-internal-log.js --last

# Ver log de operaciones de un nodo
node scripts/get-internal-log.js --node=<node>

# Ver log completo (solo si usuario lo solicita)
node scripts/get-internal-log.js --full
```

---

## 8. Integraci√≥n con Reglas Existentes

### 8.1 Compatibilidad con SSOT Enforcement

**Estas reglas se integran con:**

- ‚úÖ `.cursor/rules/ssot-scope-enforcement.mdc` - SSOT compliance
- ‚úÖ `.cursor/rules/system-map-consistency-drift-guard.mdc` - Consistencia y prevenci√≥n de drift
- ‚úÖ `.cursor/rules/v2-development.mdc` - Desarrollo v2 limpio
- ‚úÖ `.cursor/rules/shadcn-ui-migration.mdc` - Migraci√≥n UI

### 8.2 Precedencia

**Jerarqu√≠a de autoridad (en orden de precedencia):**

1. **SSOT v2** (`docs/SSOT-V2.md`) ‚Üí GANA SIEMPRE
2. **System-map v2** (`docs/system-map-v2.yaml`) ‚Üí Define estructura
3. **Subnodos activos** (`docs/nodes-v2/<node>/<subnode>.md`) ‚Üí Define implementaci√≥n
4. **Scope de la Issue** ‚Üí Define QU√â implementar

### 8.3 Conflictos con Reglas Legacy

**Si hay conflicto entre reglas v2 y legacy:**

- ‚úÖ **Reglas v2 ganan** sobre legacy
- ‚úÖ **Migrar referencias legacy** a v2 cuando sea posible
- ‚ùå **NO mezclar** sistemas v1 y v2

---

## 9. Referencias Obligatorias

### 9.1 Archivos Clave

- **System-map v2:** `docs/system-map-v2.yaml`
- **Subnodos:** `docs/nodes-v2/<node>/<subnode>.md`
- **SSOT v2:** `docs/SSOT-V2.md`
- **Spec v2:** `docs/spec-v2.md` (si existe)

### 9.2 Scripts de Validaci√≥n

```bash
# Validar system-map v2
node scripts/validate-system-map-v2.js

# Validar subnodos
node scripts/validate-subnodes.js

# Validar Strong Concepts
node scripts/validate-strong-concepts.js

# Validar dependencias
node scripts/validate-dependencies.js

# Sincronizar system-map
node scripts/sync-system-map-v2.js
```

---

## 10. Resumen Ejecutivo

### 10.1 Antes de Cualquier Operaci√≥n

1. ‚úÖ Verificar que el subnodo existe en system-map-v2.yaml
2. ‚úÖ Verificar que el subnodo existe f√≠sicamente
3. ‚úÖ Verificar ownership de Strong Concepts
4. ‚úÖ Validar dependencias
5. ‚úÖ Verificar SSOT compliance

### 10.2 Durante la Operaci√≥n

1. ‚úÖ Usar solo Allowed Sources
2. ‚úÖ Respetar Strong/Soft concepts
3. ‚úÖ No inventar contenido (marcar TBD)
4. ‚úÖ No reorganizar estructura sin autorizaci√≥n
5. ‚úÖ Registrar operaciones internamente

### 10.3 Despu√©s de la Operaci√≥n

1. ‚úÖ Actualizar nodo maestro si es necesario
2. ‚úÖ Sincronizar system-map
3. ‚úÖ Validar cambios
4. ‚úÖ Documentar en PR/issue si toca Strong Concept

### 10.4 Si Hay Conflicto

1. üö® **DETENER** inmediatamente
2. üìù **DOCUMENTAR** el conflicto
3. üîÑ **ESPERAR** resoluci√≥n del usuario

---

**√öltima actualizaci√≥n:** 2025-12-02  
**Versi√≥n:** 2.0  
**Estado:** ‚úÖ Activo
