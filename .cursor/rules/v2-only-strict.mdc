---
description: Blindaje V2-only estricto - Bloquea acceso a artefactos legacy en desarrollo nuevo
globs:
  - "scripts/loop/**/*"
  - "docs/prd/**/*"
  - "docs/autonomous-progress/**/*"
alwaysApply: false
---

# V2-ONLY STRICT ENFORCEMENT

**VersiÃ³n:** 1.0  
**Fecha:** 2025-01-22  
**Estado:** âœ… Activo  
**PropÃ³sito:** Garantizar que cualquier desarrollo nuevo (incluido Loop AutÃ³nomo Supervisado) SOLO opere sobre artefactos Roastr V2, bloqueando acceso a legacy V1

---

## 0. Principio Fundamental

**TODO desarrollo nuevo DEBE usar EXCLUSIVAMENTE artefactos V2.**

- âœ… **Lectura pasiva permitida**: Inspeccionar archivos legacy para contexto NO es violaciÃ³n
- âŒ **ModificaciÃ³n/import bloqueado**: Cualquier modificaciÃ³n o import de legacy â†’ BLOCK inmediato
- âŒ **Referencias activas bloqueadas**: Uso de rutas/IDs/workers legacy en cÃ³digo nuevo â†’ BLOCK inmediato

---

## 1. Fuentes Permitidas (V2 ONLY)

**SOLO estas fuentes pueden usarse en desarrollo nuevo:**

### 1.1 DocumentaciÃ³n V2

- âœ… `docs/SSOT-V2.md` - Single Source of Truth V2
- âœ… `docs/nodes-v2/**/*.md` - Nodos GDD V2
- âœ… `docs/system-map-v2.yaml` - System Map V2
- âœ… `docs/SSOT/` - Archivos SSOT auxiliares (disclaimers.yaml, etc.)

### 1.2 CÃ³digo V2

- âœ… `apps/backend-v2/**/*` - Backend V2
- âœ… `apps/frontend-v2/**/*` - Frontend V2 (cuando exista)
- âœ… `apps/shared/**/*` - CÃ³digo compartido V2

### 1.3 Scripts V2

- âœ… `scripts/loop/**/*` - Scripts del Loop AutÃ³nomo
- âœ… `scripts/ci/**/*` - Scripts de CI (con excepciones documentadas)
- âœ… `scripts/shared/**/*` - Utilidades compartidas

### 1.4 ConfiguraciÃ³n V2

- âœ… `.cursor/rules/**/*.mdc` - Reglas Cursor V2
- âœ… `docs/prd/**/*` - PRDs del Loop

---

## 2. Fuentes Prohibidas (LEGACY V1)

**ESTAS fuentes estÃ¡n BLOQUEADAS para modificaciÃ³n/import:**

### 2.1 DocumentaciÃ³n Legacy

- âŒ `docs/legacy/**/*` - DocumentaciÃ³n archivada V1
- âŒ `docs/nodes/**/*.md` - Nodos GDD V1 (sin `-v2` en path)
- âŒ `docs/system-map.yaml` - System Map V1 (sin `-v2` en nombre)
- âŒ `spec.md` - Spec legacy V1

### 2.2 CÃ³digo Legacy

- âŒ `src/**/*` - Backend V1 (excepto si explÃ­citamente en migraciÃ³n)
- âŒ `frontend/**/*` - Frontend V1 (excepto si explÃ­citamente en migraciÃ³n)

### 2.3 Workers/Servicios Legacy

**SegÃºn `system-map-v2.yaml` â†’ `legacy.workers` y `legacy.services`:**

- âŒ `GenerateReplyWorker` â†’ Usar `GenerateRoast`
- âŒ `PublisherWorker` â†’ Usar `SocialPosting`
- âŒ `BillingWorker` â†’ Usar `BillingUpdate`
- âŒ `stripeService` â†’ Usar Polar billing

### 2.4 IDs/Referencias Legacy

**Prohibido en cÃ³digo ejecutable, imports, paths, constantes:**

- âŒ Referencias a `"v1"`, `"legacy"`, `"old"` en cÃ³digo activo
- âŒ IDs legacy: `roast`, `shield`, `social-platforms`, `frontend-dashboard`, `plan-features`, `persona` (sin sufijo v2)
- âŒ Plan IDs legacy: `free`, `basic`, `creator_plus` (usar equivalentes Polar)
- âŒ Billing provider legacy: `stripe` (usar `polar`)

**Permitido:**

- âœ… Comentarios histÃ³ricos: `// Legacy V1 behavior was...`
- âœ… DocumentaciÃ³n: `"Migrated from V1"`
- âœ… Strings de UI: `"Upgrade from legacy plan"`

---

## 3. DetecciÃ³n Activa vs Lectura Pasiva

### 3.1 Lectura Pasiva (PERMITIDA)

**Estas acciones NO son violaciones:**

- âœ… Leer archivo legacy para entender contexto
- âœ… Navegar repo sin modificar
- âœ… Inspeccionar cÃ³digo legacy en IDE
- âœ… Copiar snippet de legacy como referencia (sin ejecutar)
- âœ… Analizar comportamiento legacy para replicar en V2

### 3.2 Acceso Activo (BLOQUEADO)

**Estas acciones SÃ son violaciones:**

- âŒ Modificar archivo legacy
- âŒ Importar mÃ³dulo legacy en cÃ³digo nuevo
- âŒ Referenciar ruta legacy en cÃ³digo ejecutable
- âŒ Usar worker/servicio legacy en cÃ³digo nuevo
- âŒ AÃ±adir dependencia a mÃ³dulo legacy
- âŒ Ejecutar cÃ³digo legacy desde cÃ³digo nuevo

---

## 4. Enforcement TÃ©cnico

### 4.1 Validador del Loop

**Script:** `scripts/loop/validators/v2-only.js`

**Ejecuta en:**

- Pre-task (antes de comenzar tarea)
- Post-task (despuÃ©s de completar tarea)

**Detecta:**

- Archivos modificados que tocan rutas legacy
- Imports desde mÃ³dulos legacy
- Referencias a IDs/workers legacy en cÃ³digo nuevo

**AcciÃ³n:**

- `BLOCK` inmediato si detecta violaciÃ³n
- Exit code 1 + mensaje de error detallado
- NO permite continuar hasta resolver

### 4.2 Validador de CI

**Script:** `scripts/ci/detect-legacy-v1.js` (reforzado)

**Ejecuta en:**

- CI workflow (GitHub Actions)
- Pre-commit hook (opcional)

**Detecta:**

- Todas las violaciones de v2-only.js
- AnÃ¡lisis global del repo
- Drift entre V2 y legacy

**AcciÃ³n:**

- Reporte de violaciones
- Warning o error segÃºn severidad
- NO bloquea Loop (es observabilidad)

---

## 5. Casos de BLOCK Inmediato

**El validador del Loop DEBE bloquear si detecta:**

### 5.1 ModificaciÃ³n de Archivos Legacy

```bash
# âŒ VIOLACIÃ“N - Modificar archivo legacy
git diff --name-only | grep "docs/legacy/"
git diff --name-only | grep "docs/nodes/[^-].*\.md$"  # No docs/nodes-v2/
git diff --name-only | grep "docs/system-map\.yaml$"  # No system-map-v2.yaml
git diff --name-only | grep "^spec\.md$"
```

### 5.2 Imports Desde Legacy

```javascript
// âŒ VIOLACIÃ“N - Import desde legacy
import { something } from '../../../docs/legacy/...';
import { RoastService } from '../../../src/services/roastService'; // V1
const legacySpec = require('../../../spec.md');
```

### 5.3 Referencias a IDs Legacy

```javascript
// âŒ VIOLACIÃ“N - IDs legacy en cÃ³digo nuevo
const node = 'roast'; // Debe ser 'roast-generation' o 'roasting-engine'
const plan = 'free'; // Debe ser plan Polar
const worker = 'GenerateReplyWorker'; // Debe ser 'GenerateRoast'
```

### 5.4 Uso de Workers/Servicios Legacy

```javascript
// âŒ VIOLACIÃ“N - Worker legacy
const { GenerateReplyWorker } = require('../../src/workers/GenerateReplyWorker');

// âŒ VIOLACIÃ“N - Servicio legacy
const stripeService = require('../../src/services/stripeService');
```

---

## 6. Casos Permitidos

### 6.1 Lectura para Contexto

```javascript
// âœ… PERMITIDO - Leer para entender comportamiento
// (NO ejecutar, solo inspecciÃ³n)
// Lectura pasiva en IDE: src/services/roastService.js
// Objetivo: Entender cÃ³mo funcionaba V1 antes de implementar V2
```

### 6.2 Comentarios HistÃ³ricos

```javascript
// âœ… PERMITIDO - Comentario histÃ³rico
/**
 * Migrated from V1 roastService.js
 * Legacy behavior: Used OpenAI directly without cost control
 * V2 behavior: Uses costControl + Polar billing
 */
```

### 6.3 DocumentaciÃ³n de MigraciÃ³n

```markdown
# âœ… PERMITIDO - Documentar origen legacy
## MigraciÃ³n desde V1

El worker `GenerateReplyWorker` (V1) fue reemplazado por `GenerateRoast` (V2).
```

---

## 7. Workflow de Enforcement

### 7.1 Pre-Task Validation

**Antes de comenzar cualquier tarea del Loop:**

```bash
# 1. Ejecutar validador V2-only
node scripts/loop/validators/v2-only.js --pre-task

# 2. Si BLOCK â†’ detener inmediatamente
# 3. Si PASS â†’ continuar con tarea
```

### 7.2 Post-Task Validation

**DespuÃ©s de completar cualquier tarea del Loop:**

```bash
# 1. Ejecutar validador V2-only
node scripts/loop/validators/v2-only.js --post-task

# 2. Si BLOCK â†’ revertir cambios + detener
# 3. Si PASS â†’ continuar con commit
```

### 7.3 CI Validation

**En cada PR/commit:**

```bash
# 1. Ejecutar detect-legacy-v1.js (reforzado)
node scripts/ci/detect-legacy-v1.js --full

# 2. Reportar violaciones (warning/error)
# 3. Bloquear merge si errores crÃ­ticos
```

---

## 8. Excepciones Documentadas

### 8.1 Scripts de MigraciÃ³n

**Solo scripts explÃ­citamente marcados como "migraciÃ³n" pueden acceder a legacy:**

- âœ… `scripts/migrate-*.js` - Scripts de migraciÃ³n documentados
- âœ… `scripts/compare-v1-v2.js` - Scripts de comparaciÃ³n V1/V2

**Requisitos:**

- Debe tener comentario al inicio: `// MIGRATION SCRIPT - Legacy access permitted`
- Debe estar documentado en `docs/migrations/`
- Debe tener aprobaciÃ³n explÃ­cita en PR

### 8.2 Tests de IntegraciÃ³n

**Tests que validan comportamiento legacy vs V2:**

- âœ… `tests/integration/v1-v2-parity.test.js`
- âœ… `tests/integration/migration-*.test.js`

**Requisitos:**

- Debe tener comentario: `// INTEGRATION TEST - Legacy access for validation`
- NO debe ejecutarse en producciÃ³n
- Debe validar equivalencia, no usar legacy activamente

---

## 9. Mensajes de Error

### 9.1 ModificaciÃ³n de Archivo Legacy

```
ğŸš¨ BLOCK - ModificaciÃ³n de Archivo Legacy Detectada

Archivo: docs/legacy/v1/roast-flow.md
AcciÃ³n: ModificaciÃ³n
RazÃ³n: Archivos legacy estÃ¡n protegidos y no deben modificarse

AcciÃ³n requerida:
1. Revertir cambios en archivo legacy
2. Si necesitas informaciÃ³n, lÃ©elo pasivamente (sin modificar)
3. Implementa cambios en artefactos V2 equivalentes

Equivalente V2: docs/nodes-v2/06-motor-roasting.md
```

### 9.2 Import desde Legacy

```
ğŸš¨ BLOCK - Import desde MÃ³dulo Legacy Detectado

Archivo: scripts/loop/task-processor.js
LÃ­nea: 15
Import: import { RoastService } from '../../../src/services/roastService';
RazÃ³n: Imports desde src/ (V1) estÃ¡n prohibidos en cÃ³digo nuevo

AcciÃ³n requerida:
1. Remover import legacy
2. Usar mÃ³dulo V2 equivalente: apps/backend-v2/src/services/roastService.ts
3. Si no existe equivalente V2, crear issue para implementarlo

Equivalente V2: apps/backend-v2/src/services/roastService.ts
```

### 9.3 Referencia a ID Legacy

```
ğŸš¨ BLOCK - ID Legacy Detectado en CÃ³digo Nuevo

Archivo: scripts/loop/node-resolver.js
LÃ­nea: 42
CÃ³digo: const node = 'roast';
RazÃ³n: ID legacy 'roast' prohibido, usar ID V2

AcciÃ³n requerida:
1. Reemplazar ID legacy por ID V2
2. Verificar en system-map-v2.yaml el ID correcto

Mapeo:
  'roast' â†’ 'roasting-engine' (system-map-v2.yaml)
  'shield' â†’ 'shield-engine'
  'persona' â†’ 'analysis-engine' (subnode: persona-integration)
```

---

## 10. IntegraciÃ³n con Reglas Existentes

### 10.1 Compatibilidad

**Esta regla se integra con:**

- âœ… `.cursor/rules/v2-development.mdc` - Desarrollo V2 limpio
- âœ… `.cursor/rules/system-map-consistency-drift-guard.mdc` - Consistency V2
- âœ… `.cursor/rules/v2-optimized-system.mdc` - Sistema optimizado V2

### 10.2 Precedencia

**JerarquÃ­a de autoridad:**

1. **SSOT-V2** â†’ Gana siempre
2. **system-map-v2.yaml** â†’ Define estructura V2
3. **v2-only-strict.mdc** (esta regla) â†’ Define quÃ© es legacy
4. **Otras reglas V2** â†’ Refinan comportamiento

---

## 11. ValidaciÃ³n del Validador

### 11.1 Tests del Validador

**El validador `v2-only.js` DEBE tener tests que verifiquen:**

```javascript
// Test 1: Detecta modificaciÃ³n de archivo legacy
test('detecta modificaciÃ³n de docs/legacy/', () => {
  const files = ['docs/legacy/v1/roast.md'];
  expect(detectLegacyViolations(files)).toContain('docs/legacy/');
});

// Test 2: Detecta import desde legacy
test('detecta import desde src/ (V1)', () => {
  const content = "import { X } from '../../../src/services/X';";
  expect(detectLegacyImports(content)).toHaveLength(1);
});

// Test 3: Detecta ID legacy
test('detecta ID legacy en cÃ³digo', () => {
  const content = "const node = 'roast';";
  expect(detectLegacyIDs(content)).toContain('roast');
});

// Test 4: NO detecta lectura pasiva
test('NO bloquea lectura pasiva', () => {
  const comment = "// Ver src/services/roastService.js para contexto";
  expect(detectLegacyViolations(comment)).toHaveLength(0);
});
```

---

## 12. Resumen Ejecutivo

### 12.1 Antes de Cualquier Tarea

1. âœ… Ejecutar `v2-only.js --pre-task`
2. âœ… Verificar que NO hay violaciones
3. âœ… Si BLOCK â†’ resolver antes de continuar

### 12.2 Durante la Tarea

1. âœ… Usar SOLO artefactos V2
2. âœ… Leer legacy pasivamente si necesario (sin modificar)
3. âœ… NO importar ni modificar legacy

### 12.3 DespuÃ©s de la Tarea

1. âœ… Ejecutar `v2-only.js --post-task`
2. âœ… Verificar que NO hay violaciones
3. âœ… Si BLOCK â†’ revertir + corregir

### 12.4 Si Hay BLOCK

1. ğŸš¨ **DETENER** inmediatamente
2. ğŸ“ **LEER** mensaje de error detallado
3. ğŸ”„ **CORREGIR** violaciÃ³n
4. âœ… **REVALIDAR** antes de continuar

---

## 13. Referencias Obligatorias

### 13.1 Archivos Clave

- **SSOT V2:** `docs/SSOT-V2.md`
- **System-map V2:** `docs/system-map-v2.yaml`
- **Validador Loop:** `scripts/loop/validators/v2-only.js`
- **Validador CI:** `scripts/ci/detect-legacy-v1.js`

### 13.2 DocumentaciÃ³n

- **Plan de issue:** `docs/plan/issue-ROA-538.md`
- **Tests:** `tests/validators/v2-only.test.js`

---

**Ãšltima actualizaciÃ³n:** 2025-01-22  
**VersiÃ³n:** 1.0  
**Estado:** âœ… Activo  
**Issue:** ROA-538
