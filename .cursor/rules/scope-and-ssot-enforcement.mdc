# SCOPE & SSOT ENFORCEMENT RULE (v2.1)

**Versi√≥n:** 2.1 (versi√≥n de la regla, no de los nodos GDD)  
**Fecha:** 2025-12-02  
**Estado:** ‚úÖ Activo  
**Prop√≥sito:** Garantizar que ning√∫n agente (Cursor/Claude) se salga del scope de una issue, ni contradiga los nodos del GDD, ni contradiga el SSOT, con protocolo seguro para manejar ideas nuevas sin romper nada.

**‚ö†Ô∏è IMPORTANTE:** Esta regla referencia `docs/SSOT-V2.md` extensivamente. Este archivo debe existir en el repositorio para que la regla funcione correctamente. Si no existe, debe crearse o las referencias deben actualizarse a la ubicaci√≥n correcta del SSOT.

---

## üîí 1. PRINCIPIO DE ORO

**Jerarqu√≠a de autoridad (en orden de precedencia):**

1. **SSOT v2** (`docs/SSOT-V2.md` ‚ö†Ô∏è debe existir) ‚Üí GANA SIEMPRE sobre c√≥digo/GDD
2. **Nodos GDD** (`docs/nodes/*.md` - nodos actuales) ‚Üí Define C√ìMO debe funcionar
3. **Scope de la Issue** (Linear/GitHub) ‚Üí Define QU√â implementar

**Regla de resoluci√≥n de conflictos:**

- Si SSOT y c√≥digo/GDD discrepan ‚Üí **SSOT gana** (detener y corregir)
- Si GDD contradice SSOT ‚Üí **STOP + comunicar** (no se puede resolver autom√°ticamente)
- Si Issue y Nodo/SSOT discrepan ‚Üí **Alinearse con SSOT/GDD**, incluso si la issue est√° mal definida
- Si Issue est√° incompleta/ambigua ‚Üí **NO inventar**, usar Safe-Invention Protocol

**El c√≥digo debe alinearse con SSOT y Nodos activos, incluso si la issue est√° mal definida.**

---

## üö´ 2. PROHIBICIONES ABSOLUTAS

**El agente NO puede:**

- ‚ùå Inventar features sin declararlo expl√≠citamente (usar Safe-Invention Protocol)
- ‚ùå Modificar comportamiento no solicitado
- ‚ùå Cambiar APIs sin estar en la issue
- ‚ùå Crear nuevas entidades, planes, flags o thresholds no existentes en SSOT
- ‚ùå Ignorar los nodos GDD activos
- ‚ùå Alterar l√≥gica distribuida en m√∫ltiples nodos sin validaci√≥n global
- ‚ùå Introducir breaking changes sin aprobaci√≥n expl√≠cita
- ‚ùå Cargar spec.md completo (solo nodos resueltos)
- ‚ùå Saltar checks de validaci√≥n pre-completion

---

## üîç 3. WORKFLOW DE VALIDACI√ìN ANTES DE APLICAR CAMBIOS

**Antes de escribir c√≥digo o modificar archivos, el agente DEBE ejecutar esta validaci√≥n obligatoria:**

### 3.1 CHECK A ‚Äî Validaci√≥n Pre-Implementaci√≥n

#### 3.1.A.1 ‚Äî Scope Alignment

**El agente debe verificar expl√≠citamente:**

1. ¬øEl trabajo solicitado est√° 100% dentro del scope de la issue? (S/N)
2. ¬øEl trabajo afecta a partes del sistema no incluidas en el scope? (S/N)

**Comandos de verificaci√≥n:**

```bash
# Leer scope de issue
gh issue view <n√∫mero> --json title,body,labels

# Identificar AC espec√≠ficos
# Revisar: ‚úÖ Qu√© se pide, ‚ùå Qu√© NO se pide, üéØ L√≠mites funcionales
```

**Si la respuesta es S√ç a la pregunta 2 ‚Üí el cambio queda prohibido salvo aprobaci√≥n humana expl√≠cita.**

#### 3.1.A.2 ‚Äî Validaci√≥n Nodos GDD

**El agente debe comprobar:**

1. ¬øEl cambio contradice alg√∫n nodo del GDD activo? (S/N)
2. ¬øExisten reglas en nodos que afecten esta PR? (listar)

**Comandos de verificaci√≥n:**

```bash
# Auto-detecci√≥n de nodos desde issue
node scripts/cursor-agents/auto-gdd-activation.js <issue-number>

# Resolver nodos relevantes
node scripts/resolve-graph.js <nodos-detectados>

# Leer SOLO nodos resueltos (NUNCA spec.md completo)
# En Cursor Chat: @docs/nodes/roast.md @docs/nodes/shield.md
```

**Si contradice un nodo ‚Üí ajustar c√≥digo o proponer actualizaci√≥n del nodo (ver secci√≥n 8).**

#### 3.1.A.3 ‚Äî Validaci√≥n SSOT

**El agente debe verificar:**

1. ¬øEl trabajo usa valores desde SSOT y NO hardcoded?
2. ¬øExisten valores requeridos no definidos en SSOT?
3. ¬øEl cambio respeta los identificadores oficiales?

**Comandos de verificaci√≥n:**

```bash
# Leer SSOT (verificar que existe primero)
# @docs/SSOT-V2.md
# ‚ö†Ô∏è Si el archivo no existe, debe crearse o actualizarse la referencia

# Buscar violaciones SSOT
grep -r "free\|basic\|creator_plus\|stripe\|sendgrid" src/ --exclude-dir=node_modules
```

**Si requiere introducir un nuevo valor ‚Üí STOP + solicitar actualizaci√≥n SSOT (ver secci√≥n 8).**

### 3.1.1 ‚Äî SAFE-INVENTION PROTOCOL (Protocolo Anti-Ocurrencias)

**El agente puede sugerir ideas pero NUNCA implementarlas sin aprobaci√≥n humana expl√≠cita.**

#### A) Declaraci√≥n Expl√≠cita

**Toda idea fuera del scope DEBE indicarse en bloque separado:**

```markdown
## üîç Propuesta Inventada Detectada

**Tipo:** {mejora | correcci√≥n | dependencia | riesgo | optimizaci√≥n}

**Origen:** NO aparece en la issue, SSOT ni nodos GDD

**Descripci√≥n:**
[Qu√© se propone y por qu√©]

**Raz√≥n:**
[Por qu√© ser√≠a beneficioso]

**Impacto:**
- Archivos afectados: [lista]
- Dependencias: [lista]
- Riesgo: [Bajo/Medio/Alto]

**C√≥digo de Referencia:**
[Links a c√≥digo relevante si aplica]
```

#### B) Acciones Prohibidas

**Hasta aprobaci√≥n humana expl√≠cita:**

- ‚ùå No modificar c√≥digo
- ‚ùå No crear PRs
- ‚ùå No mover a otra issue
- ‚ùå No cambiar tests ni workflows
- ‚ùå No actualizar documentaci√≥n

#### C) Opciones que Debe Ofrecer al Usuario

**El agente DEBE presentar estas opciones:**

1. **Incluir la propuesta en esta PR** ‚Üí Expandir scope de issue
2. **Crear issue nueva** ‚Üí Se proporciona borrador completo
3. **Descartarla** ‚Üí Continuar sin la propuesta

**Template de borrador de issue:**

```markdown
## [T√≠tulo de la propuesta]

**Origen:** Detectada durante implementaci√≥n de Issue #[XXX]

**Descripci√≥n:**
[Descripci√≥n completa]

**Justificaci√≥n:**
[Por qu√© es necesaria]

**Alcance:**
- Archivos afectados: [lista]
- Dependencias: [lista]
- Breaking changes: [s√≠/no]

**AC:**
- [ ] AC 1
- [ ] AC 2

**Prioridad:** [P0/P1/P2]
```

#### D) No Contaminar el Scope

**La propuesta inventada NO cuenta como parte del trabajo realizado hasta que el humano lo apruebe.**

**En el output final de PR:**

```markdown
## Propuestas Inventadas Declaradas

- ‚úÖ [Propuesta 1] - Estado: [Pendiente aprobaci√≥n | Aprobada | Descartada]
- ‚úÖ [Propuesta 2] - Estado: [Pendiente aprobaci√≥n | Aprobada | Descartada]
```

#### E) Si el Humano Aprueba

**Solo entonces:**

- ‚úÖ Se integra al scope de la issue
- ‚úÖ Se a√±aden actualizaciones de nodos/SSOT si aplica
- ‚úÖ Se contin√∫a el flujo normal de implementaci√≥n
- ‚úÖ Se documenta en PR como "Scope expandido con aprobaci√≥n"

---

## üìÑ 4. VALIDACI√ìN DESPU√âS DE COMPLETAR EL TRABAJO

**Antes de anunciar que el trabajo est√° terminado, el agente DEBE ejecutar:**

### 4.1 CHECK B ‚Äî Trabajo realizado vs Issue Scope

**Preguntas obligatorias:**

1. ¬øLa implementaci√≥n cumple EXACTAMENTE con el scope?
2. ¬øSe a√±adi√≥ algo no solicitado?
3. ¬øSe omiti√≥ algo que s√≠ estaba en el scope?

**Comandos de verificaci√≥n:**

```bash
# Comparar diff con AC de la issue
gh issue view <n√∫mero> --json body | grep -A 10 "Acceptance Criteria"
git diff main...HEAD --stat
```

**Si hay diferencia:**

- ‚úÖ **Corregir autom√°ticamente** si es posible
- ‚úÖ **O crear una issue de seguimiento** documentada

**Template de issue de seguimiento:**

```markdown
## [T√≠tulo] - Seguimiento de Issue #[XXX]

**Origen:** Detectado durante validaci√≥n post-implementaci√≥n

**Problema:**
[Qu√© se detect√≥ que falta o sobra]

**Acci√≥n requerida:**
[Qu√© se debe hacer]

**Prioridad:** [P0/P1/P2]
```

### 4.2 CHECK C ‚Äî Trabajo realizado vs Nodos GDD

**Preguntas obligatorias:**

1. ¬øAlg√∫n nodo contradice la implementaci√≥n?
2. ¬øRequiere actualizar documentaci√≥n GDD?
3. ¬øSe actualiz√≥ "Agentes Relevantes" si se invocaron agentes?

**Comandos de verificaci√≥n:**

```bash
# Validar nodos afectados
node scripts/resolve-graph.js <nodos-afectados>
node scripts/validate-gdd-runtime.js --full
node scripts/score-gdd-health.js --ci  # Debe >=87
```

**Si s√≠ ‚Üí crear secci√≥n "Propuesta de actualizaci√≥n nodo" con parche/borrador (ver secci√≥n 8).**

### 4.3 CHECK D ‚Äî Trabajo realizado vs SSOT

**Preguntas obligatorias:**

1. ¬øTodos los valores vienen de SSOT?
2. ¬øSe us√≥ alg√∫n valor hardcoded que debe ser SSOT?
3. ¬øSe ha violado alguna regla SSOT?

**Comandos de verificaci√≥n:**

```bash
# Buscar violaciones SSOT
grep -r "free\|basic\|creator_plus\|stripe\|sendgrid" src/ --exclude-dir=node_modules

# Verificar uso de SettingsLoader
grep -r "SettingsLoader\|settingsLoader" src/
```

**Si hay violaci√≥n ‚Üí corregir inmediatamente.**

---

## ‚úÖ 5. OUTPUT FORMAL DE CIERRE DE PR

**Cuando termine la PR, el agente DEBE entregar este bloque obligatorio:**

```markdown
## ‚úî Validaci√≥n Final de PR

### 1. Scope Compliance
**Estado:** {‚úÖ OK | ‚ö†Ô∏è Ajustado | ‚ùå Incompleto}

**Detalles:**
- AC cumplidos: [X/Y]
- Cambios fuera de scope: [Ninguno | Listados abajo]
- Issues de seguimiento: [Ninguna | #[XXX], #[YYY]]

### 2. GDD Compliance
**Estado:** {‚úÖ OK | ‚ö†Ô∏è Ajustado | ‚ùå Requiere cambios}

**Detalles:**
- Nodos validados: [lista]
- Contradicciones detectadas: [Ninguna | Listadas abajo]
- Patches de nodos generados: [Ninguno | docs/patches/nodo-*.md]

### 3. SSOT Compliance
**Estado:** {‚úÖ OK | ‚ö†Ô∏è Ajustado | ‚ùå Requiere actualizaci√≥n}

**Detalles:**
- Valores desde SSOT: [‚úÖ Todos | ‚ö†Ô∏è Algunos hardcoded]
- Violaciones detectadas: [Ninguna | Listadas abajo]
- Patches SSOT generados: [Ninguno | docs/patches/ssot-*.md]

### 4. Cambios Detectados Fuera de Scope
**Estado:** {‚úÖ Ninguno | ‚ö†Ô∏è Listados abajo}

[Si hay cambios fuera de scope, listarlos aqu√≠ con justificaci√≥n]

### 5. Propuestas Inventadas Declaradas
**Estado:** {‚úÖ Ninguna | ‚ö†Ô∏è Listadas abajo}

[Si hay propuestas inventadas, listarlas con estado de aprobaci√≥n]

### 6. Issues de Seguimiento Necesarias
**Estado:** {‚úÖ Ninguna | ‚ö†Ô∏è Creadas: #[XXX], #[YYY]}

[Links a issues de seguimiento creadas]

### 7. Validaci√≥n T√©cnica
**Estado:** {‚úÖ OK | ‚ùå Failing}

**Comandos ejecutados:**
```bash
node scripts/validate-gdd-runtime.js --full  # [Exit code]
node scripts/score-gdd-health.js --ci         # [Score] (debe >=87)
npm test                                      # [Exit code]
```

**Resultados:**
- GDD Health Score: [X/100] (threshold: >=87)
- Tests: [Passing/Failing]
- Coverage: [X%] (threshold: >=90%)
```

---

## ‚ùå 6. EJEMPLOS DE VIOLACIONES

### Ejemplo 1: Crear un nuevo flag sin SSOT

**Violaci√≥n:**
```typescript
// ‚ùå INCORRECTO
const ENABLE_NEW_FEATURE = true; // Flag no existe en SSOT
```

**Acci√≥n:**
```markdown
üö® STOP: "Feature flag 'ENABLE_NEW_FEATURE' no existe en SSOT v2."

**Acci√≥n requerida:**
1. Actualizar SSOT v2 (docs/SSOT-V2.md secci√≥n 3)
2. O usar flag existente desde SSOT
3. O crear issue para a√±adir flag a SSOT
```

### Ejemplo 2: A√±adir un nuevo par√°metro a un endpoint

**Violaci√≥n:**
```typescript
// ‚ùå INCORRECTO - No aparece en issue ni nodos
app.post('/api/roast', async (req, res) => {
  const { comment, tone, newParam } = req.body; // newParam no est√° en scope
});
```

**Acci√≥n:**
```markdown
üîç Propuesta Inventada Detectada

**Tipo:** mejora

**Origen:** NO aparece en la issue ni en nodos

**Descripci√≥n:**
A√±adir par√°metro 'newParam' al endpoint /api/roast

**Raz√≥n:**
Permitir√≠a [beneficio]

**Opciones:**
1. Incluir en esta PR (expandir scope)
2. Crear issue nueva
3. Descartar
```

### Ejemplo 3: Meter optimizaciones no solicitadas

**Violaci√≥n:**
```typescript
// ‚ùå INCORRECTO - Optimizaci√≥n no solicitada
// Issue solo pide: "A√±adir validaci√≥n de email"
// Pero tambi√©n optimic√© la query de base de datos
const users = await db.query('SELECT * FROM users WHERE email = $1', [email]);
// Optimizaci√≥n: a√±ad√≠ √≠ndice (no estaba en scope)
```

**Acci√≥n:**
```markdown
üîç Propuesta Inventada Detectada

**Tipo:** optimizaci√≥n

**Origen:** NO aparece en la issue

**Descripci√≥n:**
Optimizaci√≥n de query de base de datos con √≠ndice

**Raz√≥n:**
Mejorar√≠a performance

**Opciones:**
1. Incluir en esta PR
2. Crear issue #[YYY] - Optimizaci√≥n de queries
3. Descartar
```

---

## üõ°Ô∏è 7. MODO DE FALLO SEGURO

**Si el agente detecta cualquier imposibilidad de cumplir la regla:**

```markdown
## üö® Rule Enforcement Triggered

**Motivo:**
[Descripci√≥n detallada del conflicto]

**Conflicto detectado:**
- Tipo: {SSOT | GDD | Scope | Arquitectura}
- Severidad: {CRITICAL | HIGH | MEDIUM | LOW}
- Archivos afectados: [lista]

**Propuesta:**
[Qu√© se propone para resolver]

**Bloqueo realizado:**
- [ ] C√≥digo no modificado
- [ ] PR no creada
- [ ] Tests no ejecutados
- [ ] Documentaci√≥n no actualizada

**Acci√≥n recomendada:**
1. **Si es SSOT:** Actualizar `docs/SSOT-V2.md` y generar patch
2. **Si es GDD:** Actualizar nodo correspondiente y generar patch
3. **Si es Scope:** Aclarar issue o crear issue de seguimiento
4. **Si es Arquitectura:** Consultar con Product Owner

**No se puede continuar hasta resolver este conflicto.**
```

**Si el conflicto es CRITICAL (seguridad, billing, legal):**

1. üö® **Detener inmediatamente**
2. üìß **Notificar a Product Owner**
3. üìù **Documentar en PR**
4. ‚è∏Ô∏è **Esperar resoluci√≥n antes de continuar**

---

## üìù 8. DOCUMENTATION & PATCH REQUIREMENTS

### 8.1 Generaci√≥n de Patches

**Si una issue requiere actualizar:**

- Un nodo GDD
- El SSOT v2
- O revela inconsistencia entre nodos/SSOT/c√≥digo

**DEBES generar:**

#### 8.1.1 Nodo Patch

**Formato:** Markdown, siguiendo estilo del GDD

**Ubicaci√≥n:** Comentario en PR o `docs/patches/nodo-<nodo>-<issue>.md`

**Template:**

```markdown
# Nodo Patch: [Nodo] - Issue #[XXX]

## Cambio Propuesto

[Descripci√≥n del cambio]

## Justificaci√≥n

[Por qu√© es necesario]

## Impacto

- Nodos afectados: [lista]
- Dependencias: [lista]
- Breaking changes: [s√≠/no]

## C√≥digo de Referencia

[Links a c√≥digo relevante]

## Validaci√≥n

```bash
node scripts/resolve-graph.js <nodo>
node scripts/validate-gdd-runtime.js --full
```
```

#### 8.1.2 SSOT Patch

**Formato:** Markdown, siguiendo estructura de `docs/SSOT-V2.md`

**Ubicaci√≥n:** Comentario en PR o `docs/patches/ssot-<issue>.md`

**Template:**

```markdown
# SSOT Patch - Issue #[XXX]

## Secci√≥n Afectada

[Secci√≥n del SSOT]

## Cambio Propuesto

```typescript
// Antes
type PlanId = "starter" | "pro" | "plus";

// Despu√©s
type PlanId = "starter" | "pro" | "plus" | "enterprise";
```

## Justificaci√≥n

[Por qu√© es necesario]

## Impacto en C√≥digo

[Archivos que necesitan actualizaci√≥n]
```

### 8.2 A√±adir Patches a PR

**Los patches DEBEN a√±adirse como:**

- Comentario final en la PR (si son peque√±os)
- Archivos en `docs/patches/` (si son extensos)
- Referencia en descripci√≥n de PR

---

## üîó 9. REFERENCIAS OBLIGATORIAS

### Archivos Clave

- **SSOT v2:** `docs/SSOT-V2.md` ‚ö†Ô∏è **Nota:** Este archivo debe existir en el repositorio. Si no existe, debe crearse o actualizarse la referencia a la ubicaci√≥n correcta del SSOT.
- **Nodos GDD:** `docs/nodes/*.md` (nodos v1 actuales - la versi√≥n "v2.1" de esta regla se refiere a la versi√≥n de la regla, no a los nodos)
- **System Map:** `docs/system-map.yaml`
- **GDD Activation Guide:** `docs/GDD-ACTIVATION-GUIDE.md`
- **SSOT Enforcement (legacy):** `.cursor/rules/ssot-enforcement.mdc`

### Scripts de Validaci√≥n

- **Resolver nodos:** `node scripts/resolve-graph.js <nodos>`
- **Validar runtime:** `node scripts/validate-gdd-runtime.js --full`
- **Health score:** `node scripts/score-gdd-health.js --ci` (debe >=87)
- **Drift prediction:** `node scripts/predict-gdd-drift.js --full` (<60 risk)
- **Auto-activaci√≥n GDD:** `node scripts/cursor-agents/auto-gdd-activation.js <issue>`

### Skills Relacionadas

- **GDD Sync:** `.claude/skills/gdd-sync-skill.md`
- **Verification Before Completion:** `.claude/skills/verification-before-completion-skill.md`
- **Security Audit:** `.claude/skills/security-audit-skill.md`

---

## ‚úÖ 10. RESUMEN EJECUTIVO

### Antes de cualquier implementaci√≥n:

1. ‚úÖ **CHECK A.1:** Leer scope de issue (AC espec√≠ficos)
2. ‚úÖ **CHECK A.2:** Resolver nodos GDD relevantes
3. ‚úÖ **CHECK A.3:** Leer SOLO nodos resueltos (NO spec.md completo)
4. ‚úÖ **CHECK A.3:** Verificar SSOT v2
5. ‚úÖ **Safe-Invention:** Declarar cualquier propuesta fuera de scope

### Durante implementaci√≥n:

1. ‚úÖ Respetar scope exacto (sin ampliar sin aprobaci√≥n)
2. ‚úÖ Alinearse con nodos GDD (sin contradicciones)
3. ‚úÖ Usar valores desde SSOT (sin hardcode)
4. ‚úÖ Evitar l√≥gica v1 (solo v2)
5. ‚úÖ Declarar propuestas inventadas si surgen

### Antes de completar:

1. ‚úÖ **CHECK B:** Scope compliance
2. ‚úÖ **CHECK C:** Node compliance
3. ‚úÖ **CHECK D:** SSOT compliance
4. ‚úÖ Generar patches si es necesario
5. ‚úÖ Validar con scripts GDD
6. ‚úÖ Generar Output Formal de Cierre de PR

### Si hay conflicto:

1. üö® **DETENER** (modo de fallo seguro)
2. üìù **DOCUMENTAR** (Rule Enforcement Triggered)
3. üîÑ **ESPERAR** resoluci√≥n

---

**√öltima actualizaci√≥n:** 2025-12-02  
**Versi√≥n:** 2.1  
**Estado:** ‚úÖ Activo  
**Safe-Invention Protocol:** ‚úÖ Integrado
